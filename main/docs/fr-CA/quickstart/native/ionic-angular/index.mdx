---
title: "Ionic & Capacitor (Angular)"
permalink: "01-login"
---

import {AuthCodeBlock} from "/snippets/fr-CA/AuthCodeBlock.jsx";

<div id="by-steve-hobbs">
  ##### Par Steve Hobbs
</div>

Ce tutoriel montre comment ajouter la fonctionnalité de connexion des utilisateurs avec Auth0 à une application Ionic Angular &amp; Capacitor. Nous vous recommandons de vous connecter afin de suivre ce Démarrage rapide avec des exemples configurés pour votre compte.

{/* <Card title="Afficher sur GitHub" href="https://github.com/auth0-samples/auth0-ionic-samples/tree/main/angular" icon="github">
  Configuration requise : Node et Npm (LTS) | XCode 12+ (pour iOS) | Android Studio 4+ (pour Android)
  </Card> */}

<div id="getting-started">
  ## Mise en route
</div>

Ce démarrage rapide suppose que vous disposez déjà d’une application [Ionic](https://ionicframework.com/) opérationnelle utilisant [Capacitor](https://capacitorjs.com/). Sinon, consultez le guide [Using Capacitor with Ionic Framework](https://capacitorjs.com/docs/getting-started/with-ionic) pour démarrer avec une application simple, ou clonez [nos applications d’exemple](https://github.com/auth0-samples/auth0-ionic-samples).

Vous devriez aussi être à l’aise avec le [flux de développement de Capacitor](https://capacitorjs.com/docs/basics/workflow).

<Info>
  **Vous débutez avec l’authentification?** Découvrez [comment Auth0 fonctionne](/docs/fr-CA/get-started/auth0-overview), comment Auth0 [s’intègre aux applications natives](/docs/fr-CA/get-started/architecture-scenarios/mobile-api) et quel [protocole](/docs/fr-CA/get-started/authentication-and-authorization-flow/authorization-code-flow-with-pkce) il utilise.
</Info>

<div id="configure-auth0">
  ## Configurer Auth0
</div>

<div id="get-your-application-keys">
  ### Obtenir les clés de votre Application
</div>

Lorsque vous vous êtes inscrit à Auth0, une nouvelle Application a été créée pour vous, ou vous avez peut-être choisi d&#39;en créer une nouvelle. Vous aurez besoin de certaines informations sur cette Application pour communiquer avec Auth0. Vous pouvez obtenir ces informations dans la section [Application Settings](https://manage.auth0.com/#/applications) de l&#39;Auth0 Dashboard.

<Frame>![Tableau de bord de l'application](https://cdn2.auth0.com/docs/1.14550.0/media/articles/dashboard/client_settings.png)</Frame>

<Info>
  Lorsque vous utilisez l&#39;Application par défaut avec une application native ou une application monopage, assurez-vous de mettre à jour le paramètre **Token Endpoint Authentication Method** sur `None` et de définir **Application Type** sur `SPA` ou `Native`.
</Info>

Vous avez besoin des informations suivantes :

* **Domaine**
* **ID client**

<Info>
  Si vous téléchargez l&#39;exemple en haut de cette page, ces informations sont déjà renseignées pour vous.
</Info>

<div id="configure-callback-urls">
  ### Configurer les URL de redirection (callback)
</div>

Une URL de redirection (callback) est une URL de votre application vers laquelle Auth0 redirige l’utilisateur après son authentification. L’URL de redirection pour votre application doit être ajoutée au champ **Allowed Callback URLs** dans vos [Application Settings](https://manage.auth0.com/#/applications). Si ce champ n’est pas défini, les utilisateurs ne pourront pas se connecter à l’application et recevront une erreur.

<Info>
  Tout au long de cet article, `YOUR_PACKAGE_ID` est l’identifiant de package de votre application. Vous pouvez le trouver et le configurer dans le champ `appId` de votre fichier `capacitor.config.ts`. Consultez le [schéma de configuration de Capacitor](https://capacitorjs.com/docs/config#schema) pour plus d’informations.
</Info>

Accédez à la section [Application Settings](https://manage.auth0.com/#/applications/\{yourClientId}/settings) dans votre Auth0 Dashboard et définissez votre **Callback URL** dans le champ **Allowed Callback URLs**.

Vous devez définir la valeur de **Allowed Callback URL** sur :

```
YOUR_PACKAGE_ID://{yourDomain}/capacitor/YOUR_PACKAGE_ID/callback
```

<div id="configure-logout-urls">
  ### Configurer les URL de déconnexion
</div>

Une URL de déconnexion est une URL dans votre application vers laquelle Auth0 peut vous rediriger après que l’utilisateur a été déconnecté du Serveur d’autorisation. Celle-ci est spécifiée dans le paramètre de requête `returnTo`. L’URL de déconnexion de votre application doit être ajoutée au champ **URL de déconnexion autorisées** dans la section **Application Settings** de votre [Application](https://manage.auth0.com/#/applications). Si ce champ n’est pas défini, les utilisateurs ne pourront pas se déconnecter de l’application et recevront une erreur.

Vous devez définir le champ **URL de déconnexion autorisées** sur

```
YOUR_PACKAGE_ID://{yourDomain}/capacitor/YOUR_PACKAGE_ID/callback
```

<div id="configure-origins">
  ### Configurer les origines
</div>

Pour pouvoir effectuer des requêtes depuis votre Application vers Auth0, définissez les **origines autorisées** suivantes dans vos [Application Settings](https://manage.auth0.com/#/applications/\{yourClientId}/settings).

```
capacitor://localhost, http://localhost
```

Ces origines sont requises respectivement pour iOS et Android.

Enfin, assurez-vous que le champ **Application Type** de votre application est réglé sur **Native** dans les [Application Settings](https://manage.auth0.com/#/applications/\{yourClientId}/settings).

<div id="install-the-auth0-angular-sdk">
  ## Installer la trousse de développement logiciel (SDK) Auth0 pour Angular
</div>

Exécutez la commande suivante dans le répertoire de votre projet pour installer la trousse de développement logiciel (SDK) Auth0 pour Angular :

```bash lines
npm install @auth0/auth0-angular
```

La trousse de développement logiciel (SDK) met à votre disposition plusieurs types qui vous permettent d’intégrer Auth0 à votre application Angular de manière idiomatique, y compris un module et un service d’authentification.

<div id="install-capacitor-plugins">
  ### Installer les plugins Capacitor
</div>

Ce démarrage rapide et l’exemple utilisent certains des plugins officiels de Capacitor. Installez-les dans votre application à l’aide de la commande suivante :

```bash lines
npm install @capacitor/browser @capacitor/app
```

* [`@capacitor/browser`](https://capacitorjs.com/docs/apis/browser) - vous permet d’interagir avec le navigateur système de l’appareil et sert à ouvrir l’URL du point de terminaison d’autorisation Auth0
* [`@capacitor/app`](https://capacitorjs.com/docs/apis/app) - vous permet de vous abonner aux événements généraux de l’application, utile pour gérer les callbacks provenant d’Auth0

<Info>
  Le plugin Browser de Capacitor sur iOS utilise [`SFSafariViewController`](https://developer.apple.com/documentation/safariservices/sfsafariviewcontroller) qui, sur iOS 11+, ne partage pas les témoins (cookies) avec Safari sur l’appareil. Cela signifie que le [SSO](https://auth0.com/docs/sso) ne fonctionnera pas sur ces appareils. Si vous avez besoin de SSO, utilisez plutôt un plugin compatible qui repose sur [ASWebAuthenticationSession](https://developer.apple.com/documentation/authenticationservices/aswebauthenticationsession).
</Info>

<div id="configure-your-app-module">
  ### Configurer le module de votre application
</div>

La trousse de développement logiciel (SDK) exporte `AuthModule`, un module qui contient tous les services requis pour que la trousse fonctionne. Pour l’enregistrer dans votre application :

* Ouvrez le fichier `app.module.ts`
* Importez le type `AuthModule` à partir du package `@auth0/auth0-angular`
* Ajoutez `AuthModule` à l’application en appelant `AuthModule.forRoot` et en l’ajoutant au tableau `imports` de votre module d’application
* Spécifiez la configuration du SDK Auth0 Angular

export const codeExample1 = `// Importer les types de la trousse de développement logiciel (SDK)
import { AuthModule } from '@auth0/auth0-angular';
import config from '../../capacitor.config';

// ..

// Construire l'URL vers laquelle Auth0 doit rediriger
const redirect_uri = \`\${config.appId}://{yourDomain}/capacitor/\${config.appId}/callback\`;

// Enregistrer AuthModule auprès de votre AppModule
@NgModule({
  declarations: [AppComponent],
  entryComponents: [],
  imports: [
    BrowserModule,
    IonicModule.forRoot(),
    AppRoutingModule,
    AuthModule.forRoot({
      domain: "{yourDomain}",
      clientId: "{yourClientId}",
      useRefreshTokens: true,
      useRefreshTokensFallback: false,
      authorizationParams: {
        redirect_uri,
      }
    }),
  ],
  providers: [{ provide: RouteReuseStrategy, useClass: IonicRouteStrategy }],
  bootstrap: [AppComponent],
})`;

<AuthCodeBlock children={codeExample1} language="javascript" />

La fonction `AuthModule.forRoot` prend les paramètres de configuration suivants :

* `domain` : la valeur « domain » présente sous « Settings » de l’application que vous avez créée dans votre Auth0 Dashboard, ou votre domaine personnalisé si vous utilisez la fonctionnalité « Custom Domains » d’Auth0]([https://auth0.com/docs/custom-domains](https://auth0.com/docs/custom-domains))
* `clientId` : la valeur « client ID » présente sous « Settings » de l’application que vous avez créée dans votre Auth0 Dashboard
* `useRefreshTokens` : pour utiliser auth0-angular avec Ionic sur Android et iOS, vous devez activer les jetons d’actualisation (Refresh Tokens).
* `useRefreshTokensFallback` : pour utiliser auth0-angular avec Ionic sur Android et iOS, vous devez désactiver la solution de repli via iframe.
* `authorizationParams.redirect_uri` : l’URL vers laquelle vous souhaitez rediriger vos utilisateurs après leur authentification auprès d’Auth0.

<Warning>
  Pour conserver l’authentification après la fermeture et la réouverture de l’application, vous pouvez définir `cacheLocation` sur `localstorage` lors de la configuration du SDK, mais sachez qu’il existe [des risques liés au stockage de jetons dans localstorage](https://auth0.com/docs/libraries/auth0-single-page-app-sdk#change-storage-options). De plus, localstorage doit être considéré comme **transitoire** dans une application Capacitor, puisque les données pourraient être récupérées de façon inattendue dans certaines circonstances. Veuillez lire les [directives sur le stockage dans la documentation de Capacitor](https://capacitorjs.com/docs/guides/storage#why-cant-i-just-use-localstorage-or-indexeddb).

  De plus, le SDK permet [d’utiliser une implémentation personnalisée de cache](https://github.com/auth0/auth0-spa-js/blob/master/EXAMPLES.md#creating-a-custom-cache) pour stocker les jetons, si vous devez utiliser un mécanisme de stockage plus sécurisé et plus persistant.

  **Remarque** : nous déconseillons fortement d’utiliser le [plugin Storage de Capacitor](https://capacitorjs.com/docs/apis/storage) pour stocker des jetons, car il repose sur [UserDefaults](https://developer.apple.com/documentation/foundation/userdefaults) et [SharedPreferences](https://developer.android.com/reference/android/content/SharedPreferences) sur iOS et Android, respectivement. Les données stockées à l’aide de ces API ne sont pas chiffrées, ne sont pas sécurisées et peuvent aussi être synchronisées dans le nuage.
</Warning>

<Note>
  ### Point de contrôle

  Maintenant que vous avez configuré votre application avec le SDK Auth0 Angular, exécutez votre application pour vérifier que le SDK s’initialise sans erreur et que votre application fonctionne comme avant.
</Note>

<div id="add-login-to-your-application">
  ## Ajouter la connexion à votre Application
</div>

Dans une application Capacitor, le [module externe Browser de Capacitor](https://capacitorjs.com/docs/apis/browser) effectue une redirection vers la [page Universal Login](https://auth0.com/universal-login) d’Auth0. Définissez le paramètre `openUrl` de la fonction `loginWithRedirect` pour utiliser `Browser.open`, afin que l’URL soit ouverte à l’aide du composant de navigateur système de l’appareil ([SFSafariViewController](https://developer.apple.com/documentation/safariservices/sfsafariviewcontroller) sur iOS et [Chrome Custom Tabs](https://developer.chrome.com/docs/android/custom-tabs) sur Android).

<Info>
  Par défaut, la méthode `loginWithRedirect` du SDK utilise `window.location.href` pour accéder à la page de connexion dans le navigateur par défaut de l’appareil de l’utilisateur plutôt que dans le composant de navigateur système approprié pour la plateforme. L’utilisateur quitterait alors votre application pour s’authentifier, ce qui pourrait entraîner une expérience utilisateur sous‑optimale.
</Info>

Ajoutez un nouveau composant `LoginButton` à votre application avec le code suivant :

```javascript lines
import { Component, OnInit } from '@angular/core';
import { AuthService } from '@auth0/auth0-angular';
import { Browser } from '@capacitor/browser';
import { mergeMap } from 'rxjs/operators';

@Component({
  selector: 'app-login-button',
  template: `<ion-button (click)="login()">Connexion</ion-button>`,
})
export class LoginButtonComponent {
  constructor(public auth: AuthService) {}

  login() {
    this.auth
      .loginWithRedirect({
        async openUrl(url: string) {
          await Browser.open({ url, windowName: '_self' });
        }
      })
      .subscribe();
  }
}
```

Ce composant :

* définit un modèle avec un simple bouton qui connecte l’utilisateur lorsqu’on clique dessus
* utilise `loginWithRedirect` pour effectuer la connexion en utilisant la page Universal Login d’Auth0
* utilise le callback `openUrl` pour s’appuyer sur le plugin Browser de Capacitor afin d’ouvrir l’URL et d’afficher la page de connexion à l’utilisateur

<div id="handling-the-callback">
  ### Gestion du callback
</div>

Une fois que les utilisateurs se sont connectés avec la page Universal Login, ils sont redirigés vers votre application au moyen d’une URL avec un schéma d’URL personnalisé. L’événement `appUrlOpen` doit être géré dans votre application. Vous pouvez appeler la méthode `handleRedirectCallback` de la Trousse de développement logiciel (SDK) Auth0 pour initialiser l’état d’authentification.

Vous pouvez uniquement utiliser cette méthode lors d’une redirection depuis Auth0. Pour vérifier que tout s’est bien passé, vérifiez la présence des paramètres `code` et `state` dans l’URL.

La méthode `Browser.close()` doit fermer le navigateur lorsque cet événement est déclenché.

Modifiez votre composant `App` et utilisez la méthode `ngOnInit` pour gérer le callback depuis Auth0.

export const codeExample2 = `import { Component, OnInit, NgZone } from '@angular/core';
import { AuthService } from '@auth0/auth0-angular';
import { mergeMap } from 'rxjs/operators';
import { Browser } from '@capacitor/browser';
import { App } from '@capacitor/app';

const callbackUri = \`\${config.appId}://{yourDomain}/capacitor/\${config.appId}/callback\`;

@Component({
  selector: 'app-root',
  templateUrl: 'app.component.html',
  styleUrls: ['app.component.scss'],
})
export class AppComponent implements OnInit {
  // Importez le module AuthService de la Trousse de développement logiciel (SDK) Auth0 Angular
  constructor(public auth: AuthService, private ngZone: NgZone) {}

  ngOnInit(): void {
    // Utilisez le plugin App de Capacitor pour vous abonner à l'événement \`appUrlOpen\`
    App.addListener('appUrlOpen', ({ url }) => {
      // Doit s'exécuter dans un NgZone pour qu'Angular prenne en compte les changements
      // https://capacitorjs.com/docs/guides/angular
      ngZone.run(() => {
        if (url?.startsWith(callbackUri)) {
          // Si l'URL est une URL de rappel d'authentification...
          if (
            url.includes('state=') &&
            (url.includes('error=') || url.includes('code='))
          ) {
            // Appelez handleRedirectCallback et fermez le navigateur
            this.auth
              .handleRedirectCallback(url)
              .pipe(mergeMap(() => Browser.close()))
              .subscribe();
          } else {
            Browser.close();
          }
        }
      });
    });
  }
}`;

<AuthCodeBlock children={codeExample2} language="javascript" />

Notez que la fonction de rappel (callback) de l’événement `appUrlOpen` est encapsulée dans `ngZone.run`, ce qui signifie que les modifications apportées aux observables lorsque `handleRedirectCallback` s’exécute sont prises en compte par l’application Angular. Veuillez lire [Using Angular with Capacitor](https://capacitorjs.com/docs/guides/angular) pour plus de détails. Sinon, l’écran ne se mettra pas à jour pour afficher l’état authentifié après votre connexion.

<Info>
  Cet article part du principe que vous utiliserez des schémas d’URL personnalisés (Custom URL Schemes) pour gérer le callback dans votre application. Pour ce faire, enregistrez votre `YOUR_PACKAGE_ID` comme schéma d’URL pour la plateforme que vous avez choisie. Pour en savoir plus, consultez [Defining a Custom URL Scheme](https://developer.apple.com/documentation/xcode/defining-a-custom-url-scheme-for-your-app) pour iOS, ou [Create Deep Links to App Content](https://developer.android.com/training/app-links/deep-linking) pour Android.
</Info>

<Note>
  ### Point de contrôle

  Ajoutez le composant `LoginButton` à votre application, ainsi que le gestionnaire pour l’événement &quot;appUrlOpen&quot; à votre composant `App`. Lorsque vous cliquez sur le bouton de connexion, vérifiez que votre application vous redirige vers la page Universal Login d’Auth0 et que vous pouvez maintenant ouvrir une session ou vous inscrire à l’aide d’un nom d’utilisateur et d’un mot de passe ou d’un fournisseur d’identité sociale.

  Une fois terminé, vérifiez qu’Auth0 vous redirige vers votre application.
</Note>

<div id="add-logout-to-your-application">
  ## Ajouter la déconnexion à votre Application
</div>

Maintenant que les utilisateurs peuvent se connecter, vous devez configurer [un moyen de se déconnecter](https://auth0.com/docs/logout/guides/logout-auth0). Les utilisateurs doivent être redirigés vers le endpoint de déconnexion Auth0 dans le navigateur pour effacer leur session de navigateur. Encore une fois, le plug-in Browser de Capacitor doit effectuer cette redirection pour que l’utilisateur ne quitte pas votre application et ne subisse pas une expérience utilisateur de moindre qualité.

Pour y parvenir avec Ionic et Capacitor en conjonction avec la Trousse de développement logiciel (SDK) Auth0 :

* Construisez l’URL que votre application Auth0 doit utiliser pour rediriger après la déconnexion. Il s’agit d’une URL qui utilise votre schéma personnalisé enregistré et votre Domaine Auth0. Ajoutez-la à votre configuration **URL de déconnexion autorisées** dans l’Auth0 Dashboard.
* Effectuez la déconnexion à partir du SDK en appelant `logout`, et passez votre URL de redirection en tant que paramètre `logoutParams.returnTo`.
* Définissez le paramètre `openUrl` sur une fonction de rappel qui utilise le plug-in Browser de Capacitor pour ouvrir l’URL à l’aide de `Browser.open`.

<Info>
  Comme pour l’étape de connexion, si vous ne définissez pas `openUrl` lors de l’appel à `logout`, le SDK redirige l’utilisateur vers l’URL de déconnexion à l’aide de l’application de navigateur par défaut sur l’appareil, ce qui donne une expérience utilisateur de moindre qualité.
</Info>

Créez un nouveau composant `LogoutButton` et ajoutez le code suivant au fichier. Ajoutez ensuite le composant `LogoutButton` à votre application.

export const codeExample3 = `import { Component, OnInit } from '@angular/core';
import { AuthService } from '@auth0/auth0-angular';
import { Browser } from '@capacitor/browser';
import { tap } from 'rxjs/operators';

// Construire l’URL qui permet de revenir à votre application après la déconnexion
const returnTo = \`\${config.appId}://{yourDomain}/capacitor/\${config.appId}/callback\`;

@Component({
  selector: 'app-logout-button',
  template: \`<ion-button (click)="logout()">Se déconnecter</ion-button>\`,
})
export class LogoutButtonComponent {
  // Importer le module AuthService à partir du SDK Auth0 Angular
  constructor(public auth: AuthService) {}

   logout() {
    this.auth
      .logout({ 
        logoutParams: {
          returnTo,
        },
        async openUrl(url: string) {
          await Browser.open({ url });
        } 
      })
      .subscribe();
  }
}`;

<AuthCodeBlock children={codeExample3} language="javascript" />

<Note>
  ### Point de contrôle

  Ajoutez le composant `LogoutButton` à votre application. Lorsque vous cliquez dessus, vérifiez que votre application Ionic vous redirige vers l’adresse que vous avez spécifiée comme l’une des « URL de déconnexion autorisées » dans les « Paramètres » et que vous n’êtes plus connecté à votre application.
</Note>

<div id="show-user-profile-information">
  ## Afficher les renseignements de profil de l’utilisateur
</div>

La Trousse de développement logiciel (SDK) Auth0 vous aide à récupérer rapidement, dans n’importe quel composant où vous en avez besoin, les [renseignements de profil](https://auth0.com/docs/users/concepts/overview-user-profile) associés aux utilisateurs connectés, comme leur nom ou leur photo de profil, pour personnaliser l’interface utilisateur. Les renseignements de profil sont disponibles par l’entremise de la propriété `user$` exposée par `AuthService`.

Créez un nouveau composant `Profile`, puis utilisez le code suivant pour afficher les renseignements de profil de l’utilisateur dans votre application.

```javascript lines
import { Component, OnInit } from '@angular/core';
import { AuthService } from '@auth0/auth0-angular';

@Component({
  selector: 'app-profile',
  template: `
  <div *ngIf="auth.user$ | async as user">
    <ion-avatar class="avatar">
      <Frame><img [src]="user.picture" [alt]="user.name" /></Frame>
    </ion-avatar>
    <h2>{{ user.name }}</h2>
    <p>{{ user.email }}</p>
  </div>`,
})
export class ProfileComponent {
  constructor(public auth: AuthService) {}
}
```

<Note>
  ### Point de contrôle

  Ajoutez `ProfileComponent` à votre application et vérifiez que vous pouvez afficher `user.name` ou [n&#39;importe quelle autre propriété de `user`](https://auth0.com/docs/users/references/user-profile-structure#user-profile-attributes) correctement dans un composant après vous être authentifié.
</Note>

<Info>
  ##### Que pouvez-vous faire ensuite ?

  <table>
    <tr>
      <td><a href="/docs/fr-CA/authenticate/identity-providers">Configurer d&#39;autres fournisseurs d&#39;identité</a></td>
      <td><a href="/docs/fr-CA/secure/multi-factor-authentication">Activer l&#39;authentification multifacteur</a></td>
    </tr>

    <tr>
      <td><a href="/docs/fr-CA/secure/attack-protection">En savoir plus sur la protection contre les attaques</a></td>
      <td><a href="/docs/fr-CA/customize/rules">En savoir plus sur Rules</a></td>
    </tr>
  </table>

  [Modifier sur GitHub](https://github.com/auth0/docs/edit/master/articles/quickstart/backend/aspnet-core-webapi/01-authorization.md)
</Info>

***
