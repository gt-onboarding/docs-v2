---
mode: wide
'og:description': Ce guide explique comment int√©grer Auth0, ajouter une authentification
  et afficher les informations de profil de l‚Äôutilisateur dans une application monopage (SPA) utilisant
  Cap'n Web RPC, au moyen de la trousse de d√©veloppement logiciel (SDK) Auth0 SPA.
'og:image': https://cdn2.auth0.com/docs/1.14553.0/img/share-image.png
'og:title': 'D√©marrages rapides du SDK JavaScript Auth0 : Ajouter la connexion √† votre application Cap''n Web'
'og:url': https://auth0.com/docs/
sidebarTitle: Cap'n Web
title: Ajouter la connexion √† votre application Cap'n Web
'twitter:description': Ce guide explique comment int√©grer Auth0, ajouter une authentification
  et afficher les informations de profil de l‚Äôutilisateur dans une application monopage (SPA) utilisant
  Cap'n Web RPC, au moyen de la trousse de d√©veloppement logiciel (SDK) Auth0 SPA.
'twitter:title': 'D√©marrages rapides du SDK JavaScript Auth0 : Ajouter la connexion √† votre application Cap''n Web'
---

import {AuthCodeGroup} from "/snippets/fr-CA/AuthCodeGroup.jsx";

<Callout icon="pencil" color="#FFC107" iconType="solid">
  Ce D√©marrage rapide est actuellement en version **b√™ta**. Nous aimerions beaucoup avoir vos commentaires !
</Callout>


<Accordion title="Invite pour l‚ÄôIA" defaultOpen icon="microchip-ai" iconType="sharp-solid">
  **Vous utilisez l&#39;IA pour int√©grer Auth0?** Ajoutez cette invite √† Cursor, Windsurf, Copilot, Claude Code ou votre IDE pr√©f√©r√© aliment√© par l&#39;IA pour acc√©l√©rer le d√©veloppement.

  ```markdown expandable
  Int√©grer l'authentification Auth0 dans une application Cap'n Web RPC

  PERSONA IA ET OBJECTIF PRINCIPAL
  Vous √™tes un assistant d'int√©gration de trousse de d√©veloppement logiciel (SDK) Auth0 sp√©cialis√© dans les applications Cap'n Web RPC. Votre fonction principale est d'ex√©cuter des commandes pour configurer l'authentification Auth0 avec la communication RPC bas√©e sur WebSocket.

  INSTRUCTIONS COMPORTEMENTALES CRITIQUES
  1. V√âRIFIER D'ABORD LE PROJET EXISTANT : Avant de cr√©er un nouveau projet, v√©rifiez si le r√©pertoire actuel contient d√©j√† un projet Cap'n Web (package.json avec des d√©pendances capnweb).
  2. EX√âCUTER D'ABORD, MODIFIER ENSUITE : Vous DEVEZ d'abord ex√©cuter la commande de configuration appropri√©e. Ne montrez, ne sugg√©rez ni ne cr√©ez aucun fichier avant que la configuration ne soit termin√©e.
  3. AUCUNE PLANIFICATION : NE proposez PAS de structure de r√©pertoire. Votre premi√®re action doit √™tre d'ex√©cuter la commande appropri√©e.
  4. S√âQUENCE STRICTE : Suivez le flux d'ex√©cution dans l'ordre exact sp√©cifi√©.
  5. CR√âER UN RPC S√âCURIS√â : Impl√©mentez une validation appropri√©e des jetons JWT c√¥t√© client et c√¥t√© serveur pour la communication RPC.

  FLUX D'EX√âCUTION

  √âtape 1 : Cr√©er le projet Cap'n Web
  mkdir capnweb-auth0-app && cd capnweb-auth0-app
  npm init -y && npm pkg set type="module"
  mkdir -p client server && touch server/index.js client/index.html client/app.js .env

  √âtape 2 : Installer les d√©pendances
  npm install capnweb ws dotenv
  npm install @auth0/auth0-spa-js @auth0/auth0-api-js
  npm pkg set scripts.start="node server/index.js"

  √âtape 3 : Configurer l'application Auth0 (utilisez la commande CLI de l'√©tape 3 dans le d√©marrage rapide)

  √âtape 4 : Configurer l'application et l'API Auth0
  - Cr√©er une application Auth0 (type SPA)
  - Cr√©er une API Auth0 avec les port√©es requises
  - D√©finir les URL de redirection et les origines

  √âtape 5 : Impl√©menter le serveur avec validation JWT
  - Cr√©er un serveur WebSocket avec Cap'n Web RPC
  - √âtendre la classe RpcTarget pour ProfileService
  - Valider les jetons JWT d'Auth0 pour chaque appel RPC
  - Utiliser newWebSocketRpcSession() pour g√©rer les connexions WebSocket
  - Impl√©menter des points de terminaison de gestion de profil s√©curis√©s

  √âtape 6 : Impl√©menter le client avec l'int√©gration Auth0
  - Initialiser le client SPA Auth0 avec les jetons d'actualisation activ√©s
  - Utiliser newWebSocketRpcSession() de capnweb pour RPC
  - Se connecter au WebSocket uniquement apr√®s confirmation de l'authentification
  - G√©rer les flux de connexion/d√©connexion
  - Envoyer les jetons JWT avec les appels RPC
  - Cr√©er une interface utilisateur moderne avec l'√©tat d'authentification

  √âtape 7 : Ex√©cuter l'application
  npm run start

  EXIGENCES DE S√âCURIT√â
  - N'acceptez JAMAIS les appels RPC non authentifi√©s
  - Validez TOUJOURS les signatures JWT √† l'aide de JWKS
  - Impl√©mentez une gestion appropri√©e des erreurs pour les jetons expir√©s
  - Utilisez des connexions WebSocket s√©curis√©es en production

  √âtape 3 : Configurer l'application et l'API Auth0
  APR√àS l'ex√©cution r√©ussie des commandes des √©tapes 1 et 2, vous effectuerez la configuration Auth0.

  üö® R√àGLES DE NAVIGATION DANS LES R√âPERTOIRES :
  1. N'ex√©cutez JAMAIS automatiquement les commandes `cd` sans confirmation explicite de l'utilisateur
  2. V√©rifiez TOUJOURS le r√©pertoire actuel avec `pwd` avant de continuer
  3. Si vous travaillez avec un projet existant : Restez dans le r√©pertoire actuel
  4. Si vous avez cr√©√© un nouveau projet : L'utilisateur doit d'abord naviguer manuellement vers le r√©pertoire capnweb-auth0-app

  √âtape 3.1 : Acc√©der au r√©pertoire du projet (si n√©cessaire) et configurer Auth0 :

    # Ex√©cutez ceci uniquement si vous avez cr√©√© un nouveau projet et que vous n'√™tes PAS d√©j√† dans capnweb-auth0-app :
    cd capnweb-auth0-app

  Ensuite, ex√©cutez la commande de configuration de l'environnement pour votre syst√®me d'exploitation :

  ‚ö†Ô∏è √âTAPE CRITIQUE DE V√âRIFICATION DU R√âPERTOIRE :
  AVANT d'ex√©cuter la commande de configuration de l'interface de ligne de commande Auth0, vous DEVEZ ex√©cuter :

    pwd && ls -la

  Cela vous aidera √† comprendre si vous √™tes dans le r√©pertoire principal ou un sous-r√©pertoire, et si le projet a √©t√© cr√©√© dans le r√©pertoire actuel ou un nouveau sous-r√©pertoire.

  Si MacOS, ex√©cutez la commande suivante :
  AUTH0_APP_NAME="My Cap'n Web App" && AUTH0_API_NAME="Cap'n Web API" && AUTH0_API_IDENTIFIER="https://capnweb-api.$(date +%s).com" && brew tap auth0/auth0-cli && brew install auth0 && auth0 login --no-input && auth0 apis create --name "${AUTH0_API_NAME}" --identifier "${AUTH0_API_IDENTIFIER}" --scopes "read:profile,write:profile" --json > auth0-api-details.json && auth0 apps create -n "${AUTH0_APP_NAME}" -t spa -c http://localhost:3000 -l http://localhost:3000 -o http://localhost:3000 --json > auth0-app-details.json && CLIENT_ID=$(jq -r '.client_id' auth0-app-details.json) && DOMAIN=$(auth0 tenants list --json | jq -r '.[] | select(.active == true) | .name') && echo "AUTH0_DOMAIN=${DOMAIN}" > .env && echo "AUTH0_CLIENT_ID=${CLIENT_ID}" >> .env && echo "AUTH0_AUDIENCE=${AUTH0_API_IDENTIFIER}" >> .env && echo "PORT=3000" >> .env && echo "NODE_ENV=development" >> .env && rm auth0-app-details.json auth0-api-details.json && echo ".env file created with your Auth0 details:" && cat .env

  Si Windows, ex√©cutez la commande suivante :
  $AppName = "My Cap'n Web App"; $ApiName = "Cap'n Web API"; $ApiIdentifier = "https://capnweb-api.$((Get-Date).Ticks).com"; winget install Auth0.CLI; auth0 login --no-input; auth0 apis create --name "$ApiName" --identifier "$ApiIdentifier" --scopes "read:profile,write:profile" --json | Set-Content -Path auth0-api-details.json; auth0 apps create -n "$AppName" -t spa -c http://localhost:3000 -l http://localhost:3000 -o http://localhost:3000 --json | Set-Content -Path auth0-app-details.json; $ClientId = (Get-Content -Raw auth0-app-details.json | ConvertFrom-Json).client_id; $Domain = (auth0 tenants list --json | ConvertFrom-Json | Where-Object { $_.active -eq $true }).name; Set-Content -Path .env -Value "AUTH0_DOMAIN=$Domain"; Add-Content -Path .env -Value "AUTH0_CLIENT_ID=$ClientId"; Add-Content -Path .env -Value "AUTH0_AUDIENCE=$ApiIdentifier"; Add-Content -Path .env -Value "PORT=3000"; Add-Content -Path .env -Value "NODE_ENV=development"; Remove-Item auth0-app-details.json, auth0-api-details.json; Write-Output ".env file created with your Auth0 details:"; Get-Content .env

  √âtape 3.2 : Cr√©er un mod√®le .env manuel (si la configuration automatique √©choue)

    cat > .env << 'EOF'
    # Configuration Auth0 - METTEZ √Ä JOUR CES VALEURS
    AUTH0_DOMAIN=your-auth0-domain.auth0.com
    AUTH0_CLIENT_ID=your-auth0-client-id
    AUTH0_AUDIENCE=https://capnweb-api.yourproject.com
    PORT=3000
    NODE_ENV=development
    EOF

  √âtape 3.3 : Afficher les instructions de configuration manuelle

    echo "üìã CONFIGURATION MANUELLE REQUISE :"
    echo "1. Acc√©dez √† https://manage.auth0.com/dashboard/"
    echo "2. Cr√©er une application ‚Üí Application monopage"
    echo "3. D√©finir les URL de redirection autoris√©es : http://localhost:3000"
    echo "4. D√©finir les URL de d√©connexion autoris√©es : http://localhost:3000"
    echo "5. D√©finir les origines Web autoris√©es : http://localhost:3000"
    echo "6. Cr√©er une API avec l'identifiant : https://capnweb-api.yourproject.com"
    echo "7. Ajouter les port√©es : read:profile, write:profile"
    echo "8. Mettre √† jour le fichier .env avec votre domaine, ID client et audience de l'API"

  √âtape 4 : Impl√©menter un serveur WebSocket s√©curis√© avec validation JWT
  APR√àS la configuration d'Auth0, cr√©ez le serveur avec une s√©curit√© compl√®te :

  4.1 : Cr√©er le fichier serveur principal (server/index.js)
  Remplacez tout le contenu par l'impl√©mentation du serveur WebSocket s√©curis√© :

    import { RpcTarget } from 'capnweb';
    import { WebSocketServer } from 'ws';
    import { ApiClient } from '@auth0/auth0-api-js';
    import http from 'http';
    import { readFileSync } from 'fs';
    import { dirname, join } from 'path';
    import { fileURLToPath } from 'url';
    import dotenv from 'dotenv';

    dotenv.config();

    const __dirname = dirname(fileURLToPath(import.meta.url));
    const userProfiles = new Map();

    // Configuration Auth0
    const AUTH0_DOMAIN = process.env.AUTH0_DOMAIN;
    const AUTH0_CLIENT_ID = process.env.AUTH0_CLIENT_ID;
    const AUTH0_AUDIENCE = process.env.AUTH0_AUDIENCE;

    if (!AUTH0_DOMAIN || !AUTH0_CLIENT_ID || !AUTH0_AUDIENCE) {
      console.error('‚ùå Variables d'environnement Auth0 requises manquantes');
      if (!AUTH0_DOMAIN) console.error('   - AUTH0_DOMAIN est requis');
      if (!AUTH0_CLIENT_ID) console.error('   - AUTH0_CLIENT_ID est requis');
      if (!AUTH0_AUDIENCE) console.error('   - AUTH0_AUDIENCE est requis');
      process.exit(1);
    }

    // Initialiser le client API Auth0 pour la v√©rification des jetons
    // L'utilisation de @auth0/auth0-api-js offre une meilleure int√©gration Auth0 que jsonwebtoken :
    // - Gestion et mise en cache automatiques de JWKS
    // - Prise en charge int√©gr√©e des jetons JWT/JWE
    // - Conformit√© OAuth 2.0 appropri√©e
    // - Optimisations sp√©cifiques √† Auth0
    const auth0ApiClient = new ApiClient({
      domain: AUTH0_DOMAIN,
      audience: AUTH0_AUDIENCE
    });

    async function verifyToken(token) {
      try {
        const payload = await auth0ApiClient.verifyAccessToken({
          accessToken: token
        });
        return payload;
      } catch (error) {
        throw new Error(`La v√©rification du jeton a √©chou√© : ${error.message}`);
      }
    }

  4.2 : Poursuivre avec l'impl√©mentation de la cible RPC et la configuration du serveur HTTP :

    // D√©finir la cible RPC Cap'n Web avec authentification
    class AuthenticatedRpcTarget extends RpcTarget {
      constructor() {
        super();
        this.authenticatedMethods = ['getProfile', 'updateProfile', 'getUserData'];
      }

      async authenticate(methodName, token) {
        if (this.authenticatedMethods.includes(methodName)) {
          try {
            const decoded = await verifyToken(token);
            return decoded;
          } catch (error) {
            throw new Error(`L'authentification a √©chou√© : ${error.message}`);
          }
        }
        return null; // Aucune authentification requise pour cette m√©thode
      }

      async getProfile(token) {
        const user = await this.authenticate('getProfile', token);
        if (!user) throw new Error('Authentification requise');

        const profile = userProfiles.get(user.sub) || {
          id: user.sub,
          name: user.name || 'Utilisateur inconnu',
          email: user.email || 'Aucun courriel fourni',
          picture: user.picture || null,
          preferences: {},
          lastLogin: new Date().toISOString()
        };

        console.log('üìã Profil r√©cup√©r√© pour l'utilisateur :', user.sub);
        return profile;
      }

      async updateProfile(token, updates) {
        const user = await this.authenticate('updateProfile', token);
        if (!user) throw new Error('Authentification requise');

        const existingProfile = userProfiles.get(user.sub) || {};
        const updatedProfile = {
          ...existingProfile,
          ...updates,
          id: user.sub,
          lastUpdated: new Date().toISOString()
        };

        userProfiles.set(user.sub, updatedProfile);
        console.log('‚úÖ Profil mis √† jour pour l'utilisateur :', user.sub);
        return updatedProfile;
      }

      async getPublicData() {
        // Aucune authentification requise pour les m√©thodes publiques
        return {
          message: 'Ceci est une donn√©e publique accessible √† tous les utilisateurs',
          serverTime: new Date().toISOString(),
          version: '1.0.0'
        };
      }
    }

    // Cr√©er le serveur HTTP et le serveur WebSocket
    const server = http.createServer((req, res) => {
      if (req.url === '/' || req.url === '/index.html') {
        const html = readFileSync(join(__dirname, '../client/index.html'), 'utf8');
        res.writeHead(200, { 'Content-Type': 'text/html' });
        res.end(html);
      } else if (req.url === '/app.js') {
        const js = readFileSync(join(__dirname, '../client/app.js'), 'utf8');
        res.writeHead(200, { 'Content-Type': 'application/javascript' });
        res.end(js);
      } else {
        res.writeHead(404);
        res.end('Non trouv√©');
      }
    });

    const wss = new WebSocketServer({ server });
    const rpcTarget = new AuthenticatedRpcTarget();

    wss.on('connection', (ws) => {
      console.log('üîå Nouvelle connexion WebSocket √©tablie');
      
      ws.on('message', async (message) => {
        try {
          const request = JSON.parse(message.toString());
          console.log('üì® Requ√™te RPC re√ßue :', request.method);
          
          // Extraire le jeton de la requ√™te
          const token = request.token;
          let result;

          // Appeler la m√©thode appropri√©e en fonction de la requ√™te
          switch (request.method) {
            case 'getProfile':
              result = await rpcTarget.getProfile(token);
              break;
            case 'updateProfile':
              result = await rpcTarget.updateProfile(token, request.params);
              break;
            case 'getPublicData':
              result = await rpcTarget.getPublicData();
              break;
            default:
              throw new Error(`M√©thode inconnue : ${request.method}`);
          }

          ws.send(JSON.stringify({
            id: request.id,
            result: result,
            error: null
          }));
        } catch (error) {
          console.error('‚ùå Erreur RPC :', error.message);
          ws.send(JSON.stringify({
            id: request.id || null,
            result: null,
            error: error.message
          }));
        }
      });

      ws.on('close', () => {
        console.log('üîå Connexion WebSocket ferm√©e');
      });

      ws.on('error', (error) => {
        console.error('‚ùå Erreur WebSocket :', error);
      });
    });

    server.listen(PORT, () => {
      console.log('üöÄ Serveur Auth0 Cap\'n Web d√©marr√©');
      console.log('üìç Serveur en cours d'ex√©cution sur http://localhost:' + PORT);
      console.log('üîê Domaine Auth0 :', AUTH0_DOMAIN);
      console.log('üÜî ID client :', AUTH0_CLIENT_ID.substring(0, 8) + '...');
      console.log('üéØ Audience API :', AUTH0_AUDIENCE);
      console.log('\nüìã M√©thodes RPC disponibles :');
      console.log('   - getProfile (authentifi√©e)');
      console.log('   - updateProfile (authentifi√©e)');
      console.log('   - getPublicData (publique)');
    });

  √âtape 5 : Impl√©menter le serveur avec validation JWT
  APR√àS avoir termin√© la configuration d'Auth0, cr√©er le serveur avec Cap'n Web RPC :

  5.1 : Cr√©er le fichier serveur principal (server/index.js)
  Importer les modules requis et configurer la v√©rification des jetons Auth0 :

    import { RpcTarget, newWebSocketRpcSession } from 'capnweb';
    import { WebSocketServer } from 'ws';
    import { ApiClient } from '@auth0/auth0-api-js';
    import http from 'http';
    import { readFileSync } from 'fs';
    import { dirname, join } from 'path';
    import { fileURLToPath } from 'url';
    import dotenv from 'dotenv';

    dotenv.config();

    const __dirname = dirname(fileURLToPath(import.meta.url));
    const userProfiles = new Map();

    // Configuration Auth0
    const AUTH0_DOMAIN = process.env.AUTH0_DOMAIN;
    const AUTH0_CLIENT_ID = process.env.AUTH0_CLIENT_ID;
    const AUTH0_AUDIENCE = process.env.AUTH0_AUDIENCE;
    const PORT = process.env.PORT || 3000;

    // Initialiser le client API Auth0 pour la v√©rification des jetons
    const auth0ApiClient = new ApiClient({
      domain: AUTH0_DOMAIN,
      audience: AUTH0_AUDIENCE
    });

    async function verifyToken(token) {
      try {
        const payload = await auth0ApiClient.verifyAccessToken({
          accessToken: token
        });
        return payload;
      } catch (error) {
        throw new Error(`La v√©rification du jeton a √©chou√© : ${error.message}`);
      }
    }

  5.2 : Cr√©er ProfileService RpcTarget avec authentification :

    // ProfileService - √©tend RpcTarget pour Cap'n Web RPC
    class ProfileService extends RpcTarget {
      async getProfile(accessToken) {
        const decoded = await verifyToken(accessToken);
        const userId = decoded.sub;
        const profile = userProfiles.get(userId) || { bio: '' };
        
        return {
          id: userId,
          email: decoded.email || 'Utilisateur inconnu',
          bio: profile.bio
        };
      }

      async updateProfile(accessToken, bio) {
        const decoded = await verifyToken(accessToken);
        const userId = decoded.sub;
        userProfiles.set(userId, { bio });
        
        return { success: true, message: 'Profil mis √† jour avec succ√®s' };
      }
    }

  5.3 : Cr√©er le serveur HTTP et le serveur WebSocket :

    // Cr√©er le serveur HTTP pour servir les fichiers statiques et la configuration Auth0
    const server = http.createServer(async (req, res) => {
      res.setHeader('Access-Control-Allow-Origin', '*');
      
      if (req.url === '/api/config') {
        const config = { 
          auth0: { 
            domain: AUTH0_DOMAIN, 
            clientId: AUTH0_CLIENT_ID,
            audience: AUTH0_AUDIENCE
          } 
        };
        res.setHeader('Content-Type', 'application/json');
        res.writeHead(200);
        res.end(JSON.stringify(config));
        return;
      }

      // Servir les fichiers HTML, JS et les modules npm
      if (req.url === '/' || req.url === '/index.html') {
        const html = readFileSync(join(__dirname, '../client/index.html'), 'utf8');
        res.setHeader('Content-Type', 'text/html');
        res.writeHead(200);
        res.end(html);
        return;
      }

      if (req.url === '/app.js') {
        const js = readFileSync(join(__dirname, '../client/app.js'), 'utf8');
        res.setHeader('Content-Type', 'application/javascript');
        res.writeHead(200);
        res.end(js);
        return;
      }

      // Servir le SDK SPA Auth0 √† partir de node_modules
      if (req.url === '/@auth0/auth0-spa-js') {
        const modulePath = join(__dirname, '../node_modules/@auth0/auth0-spa-js/dist/auth0-spa-js.production.esm.js');
        const js = readFileSync(modulePath, 'utf8');
        res.setHeader('Content-Type', 'application/javascript');
        res.writeHead(200);
        res.end(js);
        return;
      }

      // Servir capnweb √† partir de node_modules
      if (req.url === '/capnweb') {
        const modulePath = join(__dirname, '../node_modules/capnweb/dist/index.js');
        const js = readFileSync(modulePath, 'utf8');
        res.setHeader('Content-Type', 'application/javascript');
        res.writeHead(200);
        res.end(js);
        return;
      }

      res.writeHead(404);
      res.end('Introuvable');
    });

    // Serveur WebSocket pour Cap'n Web RPC
    const wss = new WebSocketServer({ server });

    wss.on('connection', (ws, req) => {
      // G√©rer uniquement les connexions RPC sur le chemin /api
      if (req.url === '/api') {
        console.log('üîó Nouvelle connexion RPC Cap\'n Web');
        
        // Cr√©er une nouvelle instance de ProfileService pour cette connexion
        const profileService = new ProfileService();
        
        // Utiliser newWebSocketRpcSession de capnweb pour g√©rer la connexion
        newWebSocketRpcSession(ws, profileService);
      }
    });

    // D√©marrer le serveur
    server.listen(PORT, () => {
      console.log(`üöÄ Serveur Auth0 Cap'n Web d√©marr√©`);
      console.log(`üìç Serveur en cours d'ex√©cution sur http://localhost:${PORT}`);
      console.log(`üîê Domaine Auth0 : ${AUTH0_DOMAIN}`);
      console.log(`üÜî ID client : ${AUTH0_CLIENT_ID.substring(0, 8)}...`);
      console.log(`üéØ Audience de l'API : ${AUTH0_AUDIENCE}`);
    });

  √âtape 6 : Cr√©er un client moderne avec l'int√©gration Auth0
  6.1 : Cr√©er le fichier HTML principal (client/index.html) avec la carte d'importation :

    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>D√©mo Cap'n Web + Auth0</title>
        <script type="importmap">
        {
          "imports": {
            "@auth0/auth0-spa-js": "/@auth0/auth0-spa-js",
            "capnweb": "/capnweb"
          }
        }
        </script>
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
        <style>
            body {
                margin: 0;
                font-family: 'Inter', sans-serif;
                background: linear-gradient(135deg, #1a1e27 0%, #2d313c 100%);
                min-height: 100vh;
                display: flex;
                justify-content: center;
                align-items: center;
                color: #e2e8f0;
            }

            .container {
                background-color: #262a33;
                border-radius: 20px;
                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6), 0 0 0 1px rgba(255, 255, 255, 0.05);
                padding: 3rem;
                max-width: 600px;
                width: 90%;
                text-align: center;
            }

            .logo {
                width: 160px;
                margin-bottom: 2rem;
            }

            h1 {
                font-size: 2.8rem;
                font-weight: 700;
                color: #f7fafc;
                margin-bottom: 1rem;
                text-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            }

            .subtitle {
                font-size: 1.2rem;
                color: #a0aec0;
                margin-bottom: 2rem;
                line-height: 1.6;
            }

            .button {
                padding: 1.1rem 2.8rem;
                font-size: 1.2rem;
                font-weight: 600;
                border-radius: 10px;
                border: none;
                cursor: pointer;
                transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
                box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
                text-transform: uppercase;
                letter-spacing: 0.08em;
                margin: 0.5rem;
            }

            .button.login {
                background-color: #63b3ed;
                color: #1a1e27;
            }

            .button.login:hover {
                background-color: #4299e1;
                transform: translateY(-3px) scale(1.02);
            }

            .button.logout {
                background-color: #fc8181;
                color: #1a1e27;
            }

            .button.logout:hover {
                background-color: #e53e3e;
                transform: translateY(-3px) scale(1.02);
            }

            .button.rpc {
                background-color: #68d391;
                color: #1a1e27;
            }

            .button.rpc:hover {
                background-color: #48bb78;
                transform: translateY(-3px) scale(1.02);
            }

            .profile-card {
                background-color: #2d313c;
                border-radius: 15px;
                padding: 2rem;
                margin: 2rem 0;
                text-align: left;
            }

            .profile-picture {
                width: 80px;
                height: 80px;
                border-radius: 50%;
                margin-bottom: 1rem;
                border: 3px solid #63b3ed;
            }

            .status {
                margin: 1rem 0;
                padding: 1rem;
                border-radius: 10px;
                font-weight: 500;
            }

            .status.success {
                background-color: #2d7d32;
                color: #e8f5e8;
            }

            .status.error {
                background-color: #c62828;
                color: #ffebee;
            }

            .status.info {
                background-color: #1976d2;
                color: #e3f2fd;
            }

            .loading {
                display: inline-block;
                width: 20px;
                height: 20px;
                border: 3px solid #f3f3f3;
                border-top: 3px solid #63b3ed;
                border-radius: 50%;
                animation: spin 1s linear infinite;
            }

            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }

            .hidden {
                display: none;
            }

            pre {
                background-color: #1a1e27;
                padding: 1rem;
                border-radius: 8px;
                overflow-x: auto;
                text-align: left;
                font-size: 0.9rem;
                border: 1px solid #4a5568;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <img src="https://cdn.auth0.com/quantum-assets/dist/latest/logos/auth0/auth0-lockup-en-ondark.png" 
                 alt="Logo Auth0" class="logo" 
                 onerror="this.style.display='none'">
            
            <h1>Cap'n Web + Auth0</h1>
            <p class="subtitle">RPC WebSocket s√©curis√© avec authentification</p>
            
            <div id="auth-section">
                <button id="login-btn" class="button login">üîê Connexion</button>
                <button id="logout-btn" class="button logout hidden">üö™ D√©connexion</button>
            </div>

            <div id="profile-section" class="hidden">
                <div class="profile-card">
                    <div id="profile-info"></div>
                </div>
            </div>

            <div id="rpc-section" class="hidden">
                <h3>üîå Op√©rations RPC</h3>
                <button id="get-profile-btn" class="button rpc">üìã Obtenir le profil</button>
                <button id="update-profile-btn" class="button rpc">‚úèÔ∏è Mettre √† jour le profil</button>
                <button id="get-public-btn" class="button rpc">üåê Obtenir les donn√©es publiques</button>
            </div>

            <div id="status"></div>
            <div id="rpc-results"></div>
        </div>

        <script type="module" src="/app.js"></script>
    </body>
    </html>

  6.2: Create the JavaScript client application (client/app.js)
  Use capnweb's newWebSocketRpcSession and Auth0 SDK with proper ES module imports:

    import { createAuth0Client } from '@auth0/auth0-spa-js';
    import { newWebSocketRpcSession } from 'capnweb';

    // Auth0 Configuration
    let auth0Client = null;
    let profileApi = null;
    let AUTH0_CONFIG = null;

    // Load Auth0 config from server
    async function loadConfig() {
      const response = await fetch('/api/config');
      const config = await response.json();
      
      AUTH0_CONFIG = {
        domain: config.auth0.domain,
        clientId: config.auth0.clientId,
        authorizationParams: {
          redirect_uri: window.location.origin,
          audience: config.auth0.audience,
          scope: 'openid profile email'
        },
        useRefreshTokens: true,
        cacheLocation: 'localstorage'
      };
      
      return AUTH0_CONFIG;
    }

    // Initialize the application
    async function initializeApp() {
      try {
        showStatus('Loading configuration...', 'info');
        const config = await loadConfig();
        
        showStatus('Initializing Auth0 client...', 'info');
        auth0Client = await createAuth0Client(config);
        
        // Handle redirect callback
        const query = window.location.search;
        if (query.includes('code=') && query.includes('state=')) {
          showStatus('Processing login...', 'info');
          await auth0Client.handleRedirectCallback();
          window.history.replaceState({}, document.title, window.location.pathname);
        }
        
        // Check authentication status
        const isAuthenticated = await auth0Client.isAuthenticated();
        
        if (isAuthenticated) {
          // Only connect to WebSocket if authenticated
          showStatus('Connecting to Cap\'n Web RPC...', 'info');
          const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
          profileApi = newWebSocketRpcSession(`${protocol}//${window.location.host}/api`);
          
          await showProfileSection();
        } else {
          showAuthSection();
        }
        
        setupEventListeners();
      } catch (error) {
        console.error('Initialization error:', error);
        showStatus(`Failed to initialize: ${error.message}`, 'error');
      }
    }

    // Authentication functions
    async function login() {
      try {
        showStatus('Redirecting to Auth0...', 'info');
        await auth0Client.loginWithRedirect();
      } catch (error) {
        showStatus(`Login failed: ${error.message}`, 'error');
      }
    }

    async function logout() {
      try {
        if (profileApi) {
          profileApi[Symbol.dispose]();
        }
        await auth0Client.logout({
          logoutParams: { returnTo: window.location.origin }
        });
      } catch (error) {
        showStatus(`Logout failed: ${error.message}`, 'error');
      }
    }

    async function getAccessToken() {
      try {
        return await auth0Client.getTokenSilently({
          authorizationParams: {
            audience: AUTH0_CONFIG.authorizationParams.audience
          }
        });
      } catch (error) {
        if (error.error === 'consent_required' || error.error === 'interaction_required') {
          await auth0Client.loginWithRedirect({
            authorizationParams: {
              audience: AUTH0_CONFIG.authorizationParams.audience,
              scope: 'openid profile email',
              prompt: 'consent'
            }
          });
        }
        throw error;
      }
    }

    // Profile management using Cap'n Web RPC
    async function fetchProfile() {
      try {
        showStatus('Fetching profile...', 'info');
        const token = await getAccessToken();
        const user = await auth0Client.getUser();
        
        // Call RPC method directly on the profileApi stub
        const profile = await profileApi.getProfile(token);
        
        document.getElementById('userEmail').textContent = user.email || profile.email || 'No email available';
        document.getElementById('bioTextarea').value = profile.bio || '';
        
        showStatus('Profile loaded successfully!', 'success');
      } catch (error) {
        showStatus(`Failed to fetch profile: ${error.message}`, 'error');
      }
    }

    async function saveProfile() {
      try {
        showStatus('Saving profile...', 'info');
        const token = await getAccessToken();
        const bio = document.getElementById('bioTextarea').value;
        
        // Call RPC method directly on the profileApi stub
        const result = await profileApi.updateProfile(token, bio);
        
        showStatus(result.message || 'Profile saved successfully!', 'success');
      } catch (error) {
        showStatus(`Failed to save profile: ${error.message}`, 'error');
      }
    }

    // UI helper functions
    function showAuthSection() {
      document.getElementById('authSection').style.display = 'block';
      document.getElementById('profileSection').style.display = 'none';
      showStatus('Ready to login', 'info');
    }

    async function showProfileSection() {
      document.getElementById('authSection').style.display = 'none';
      document.getElementById('profileSection').style.display = 'block';
      await fetchProfile();
    }

    function showStatus(message, type) {
      const statusEl = document.getElementById('status');
      statusEl.textContent = message;
      statusEl.className = `status ${type}`;
    }

    // Event listeners
    function setupEventListeners() {
      document.getElementById('loginBtn').addEventListener('click', login);
      document.getElementById('logoutBtn').addEventListener('click', logout);
      document.getElementById('fetchBtn').addEventListener('click', fetchProfile);
      document.getElementById('saveBtn').addEventListener('click', saveProfile);
    }

    // Initialize app when DOM is loaded
    document.addEventListener('DOMContentLoaded', initializeApp);
          
          if (this.isAuthenticated) {
            this.user = await this.auth0Client.getUser();
            this.accessToken = await this.auth0Client.getTokenSilently();
            this.showLoggedInState();
            this.connectWebSocket();
          } else {
            this.showLoggedOutState();
          }

          this.setupEventListeners();
          this.showStatus('‚úÖ Application initialized successfully', 'success');
        } catch (error) {
          console.error('‚ùå Initialization failed:', error);
          this.showStatus(`‚ùå Initialization failed: ${error.message}`, 'error');
        }
      }

      setupEventListeners() {
        document.getElementById('login-btn').addEventListener('click', () => this.login());
        document.getElementById('logout-btn').addEventListener('click', () => this.logout());
        document.getElementById('get-profile-btn').addEventListener('click', () => this.getProfile());
        document.getElementById('update-profile-btn').addEventListener('click', () => this.updateProfile());
        document.getElementById('get-public-btn').addEventListener('click', () => this.getPublicData());
      }

      async login() {
        try {
          this.showStatus('üîÑ Redirecting to Auth0...', 'info');
          await this.auth0Client.loginWithRedirect();
        } catch (error) {
          console.error('‚ùå Login failed:', error);
          this.showStatus(`‚ùå Login failed: ${error.message}`, 'error');
        }
      }

      async logout() {
        try {
          this.closeWebSocket();
          await this.auth0Client.logout({
            logoutParams: {
              returnTo: window.location.origin
            }
          });
        } catch (error) {
          console.error('‚ùå Logout failed:', error);
          this.showStatus(`‚ùå Logout failed: ${error.message}`, 'error');
        }
      }

      connectWebSocket() {
        if (this.ws && this.ws.readyState === WebSocket.OPEN) {
          return; // Already connected
        }

        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${protocol}//${window.location.host}`;
        
        this.ws = new WebSocket(wsUrl);

        this.ws.onopen = () => {
          console.log('üîå WebSocket connected');
          this.showStatus('üîå Connected to Cap\'n Web server', 'success');
        };

        this.ws.onmessage = (event) => {
          try {
            const response = JSON.parse(event.data);
            const pendingRequest = this.pendingRequests.get(response.id);
            
            if (pendingRequest) {
              this.pendingRequests.delete(response.id);
              if (response.error) {
                pendingRequest.reject(new Error(response.error));
              } else {
                pendingRequest.resolve(response.result);
              }
            }
          } catch (error) {
            console.error('‚ùå Failed to parse WebSocket message:', error);
          }
        };

        this.ws.onerror = (error) => {
          console.error('‚ùå WebSocket error:', error);
          this.showStatus('‚ùå WebSocket connection error', 'error');
        };

        this.ws.onclose = () => {
          console.log('üîå WebSocket d√©connect√©');
          this.showStatus('üîå D√©connect√© du serveur', 'info');
          
          // R√©essayer la connexion apr√®s 3 secondes si authentifi√©
          if (this.isAuthenticated) {
            setTimeout(() => this.connectWebSocket(), 3000);
          }
        };
      }

      closeWebSocket() {
        if (this.ws) {
          this.ws.close();
          this.ws = null;
        }
      }

      async callRPC(method, params = null, requiresAuth = true) {
        return new Promise((resolve, reject) => {
          if (!this.ws || this.ws.readyState !== WebSocket.OPEN) {
            return reject(new Error('WebSocket non connect√©'));
          }

          const id = ++this.requestId;
          const request = {
            id,
            method,
            params
          };

          if (requiresAuth && this.accessToken) {
            request.token = this.accessToken;
          }

          this.pendingRequests.set(id, { resolve, reject });
          
          // Set timeout for request
          setTimeout(() => {
            if (this.pendingRequests.has(id)) {
              this.pendingRequests.delete(id);
              reject(new Error('D√©lai d'attente de la requ√™te RPC d√©pass√©'));
            }
          }, 10000);

          this.ws.send(JSON.stringify(request));
        });
      }

      async getProfile() {
        try {
          this.showStatus('üîÑ R√©cup√©ration du profil en cours...', 'info');
          const profile = await this.callRPC('getProfile');
          this.showRPCResult('Donn√©es de profil', profile);
        } catch (error) {
          console.error('‚ùå √âchec de la r√©cup√©ration du profil :', error);
          this.showStatus(`‚ùå √âchec de la r√©cup√©ration du profil : ${error.message}`, 'error');
        }
      }

      async updateProfile() {
        try {
          this.showStatus('üîÑ Mise √† jour du profil en cours...', 'info');
          const updates = {
            preferences: {
              theme: 'dark',
              notifications: true,
              lastAction: 'profile-update'
            }
          };
          
          const updatedProfile = await this.callRPC('updateProfile', updates);
          this.showRPCResult('Profil mis √† jour', updatedProfile);
        } catch (error) {
          console.error('‚ùå √âchec de la mise √† jour du profil :', error);
          this.showStatus(`‚ùå √âchec de la mise √† jour du profil : ${error.message}`, 'error');
        }
      }

      async getPublicData() {
        try {
          this.showStatus('üîÑ R√©cup√©ration des donn√©es publiques en cours...', 'info');
          const data = await this.callRPC('getPublicData', null, false);
          this.showRPCResult('Donn√©es publiques', data);
        } catch (error) {
          console.error('‚ùå √âchec de la r√©cup√©ration des donn√©es publiques :', error);
          this.showStatus(`‚ùå √âchec de la r√©cup√©ration des donn√©es publiques : ${error.message}`, 'error');
        }
      }

      showLoggedInState() {
        document.getElementById('login-btn').classList.add('hidden');
        document.getElementById('logout-btn').classList.remove('hidden');
        document.getElementById('profile-section').classList.remove('hidden');
        document.getElementById('rpc-section').classList.remove('hidden');

        if (this.user) {
          const placeholderImage = `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='50' fill='%2363b3ed'/%3E%3Cpath d='M50 45c7.5 0 13.64-6.14 13.64-13.64S57.5 17.72 50 17.72s-13.64 6.14-13.64 13.64S42.5 45 50 45zm0 6.82c-9.09 0-27.28 4.56-27.28 13.64v3.41c0 1.88 1.53 3.41 3.41 3.41h47.74c1.88 0 3.41-1.53 3.41-3.41v-3.41c0-9.08-18.19-13.64-27.28-13.64z' fill='%23fff'/%3E%3C/svg%3E`;
          const profileHtml = `
            <img src="${this.user.picture || placeholderImage}" alt="Profil" class="profile-picture" onerror="this.src='${placeholderImage}'">
            <h3>${this.user.name || 'Utilisateur'}</h3>
            <p><strong>Courriel :</strong> ${this.user.email || 'Non fourni'}</p>
            <p><strong>ID utilisateur :</strong> ${this.user.sub}</p>
          `;
          document.getElementById('profile-info').innerHTML = profileHtml;
        }
      }

      showLoggedOutState() {
        document.getElementById('login-btn').classList.remove('hidden');
        document.getElementById('logout-btn').classList.add('hidden');
        document.getElementById('profile-section').classList.add('hidden');
        document.getElementById('rpc-section').classList.add('hidden');
      }

      showStatus(message, type = 'info') {
        const statusDiv = document.getElementById('status');
        statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
        
        // Masquer automatiquement les messages de succ√®s et d'information apr√®s 5 secondes
        if (type === 'success' || type === 'info') {
          setTimeout(() => {
            statusDiv.innerHTML = '';
          }, 5000);
        }
      }

      showRPCResult(title, data) {
        const resultsDiv = document.getElementById('rpc-results');
        const resultHtml = `
          <div class="status success">
            <h4>${title}</h4>
            <pre>${JSON.stringify(data, null, 2)}</pre>
          </div>
        `;
        resultsDiv.innerHTML = resultHtml;
        this.showStatus('‚úÖ Appel RPC effectu√© avec succ√®s', 'success');
      }
    }

    // Initialiser l'application
    const app = new CapnWebAuth0Client();
    app.init().catch(error => {
    // Initialiser l'application au chargement du DOM
    document.addEventListener('DOMContentLoaded', initializeApp);

  √âtape 7 : Tester et ex√©cuter l'application
  7.1 : D√©marrer le serveur de d√©veloppement :

    npm run start

  7.2 : Ouvrir http://localhost:3000 dans votre navigateur

  7.3 : Tester le flux d'authentification complet :
    - Cliquer sur ¬´ Connexion ¬ª pour s'authentifier avec Auth0
    - Consulter vos informations de profil (le courriel sera affich√© depuis Auth0)
    - Mettre √† jour votre biographie et enregistrer
    - Actualiser la page - vous devriez rester connect√© (gr√¢ce aux jetons d'actualisation)
    - Tester la fonctionnalit√© de d√©connexion
    - Tester les appels RPC (Obtenir le profil, Mettre √† jour le profil, Obtenir les donn√©es publiques)
    - V√©rifier l'√©tat de la connexion WebSocket
    - Tester la fonctionnalit√© de d√©connexion

  EXIGENCES DE S√âCURIT√â ET PRATIQUES RECOMMAND√âES
  - ‚úÖ NE JAMAIS accepter d'appels RPC non authentifi√©s pour les m√©thodes prot√©g√©es
  - ‚úÖ TOUJOURS valider les signatures JWT √† l'aide de JWKS depuis Auth0
  - ‚úÖ Mettre en ≈ìuvre une gestion compl√®te des erreurs pour les jetons expir√©s ou non valides
  - ‚úÖ Utiliser des variables d'environnement pour toute configuration sensible
  - ‚úÖ Valider toutes les entr√©es utilisateur avant le traitement
  - ‚úÖ Consigner les √©v√©nements de s√©curit√© et les tentatives d'authentification
  - ‚úÖ Utiliser des connexions WebSocket s√©curis√©es (WSS) en production
  - ‚úÖ Mettre en ≈ìuvre des politiques CORS appropri√©es
  - ‚úÖ Ajouter une limitation du d√©bit de requ√™tes pour une utilisation en production
  - ‚úÖ Assainir toutes les donn√©es avant le stockage ou la transmission

  CONSEILS DE D√âPANNAGE
  - V√©rifier la console du navigateur pour d√©tecter les erreurs JavaScript
  - V√©rifier que le fichier .env contient la configuration Auth0 correcte
  - S'assurer que les param√®tres de l'application Auth0 correspondent √† vos URL locales
  - Confirmer que les port√©es API sont correctement configur√©es dans le tableau de bord Auth0
  - Tester la connectivit√© WebSocket s√©par√©ment si les appels RPC √©chouent
  - Valider les jetons JWT √† l'aide de jwt.io pour le d√©bogage
  ```
</Accordion>

<div id="get-started">
  ## Premiers pas
</div>

Ce d√©marrage rapide montre comment ajouter l‚Äôauthentification Auth0 √† une application Cap'n Web. Vous allez cr√©er une application web moderne reposant sur RPC, avec une fonctionnalit√© de connexion s√©curis√©e, en utilisant le framework JavaScript de Cap'n Web et la trousse de d√©veloppement logiciel (SDK) Auth0 SPA.

<Steps>
  <Step title="Cr√©er un projet" stepNumber={1}>
    Cr√©ez un nouveau projet Cap&#39;n Web et configurez la structure de base¬†:

    ```shellscript
    mkdir capnweb-auth0-app && cd capnweb-auth0-app
    ```

    Initialisez le projet et configurez-le pour les modules ES¬†:

    ```shellscript
    npm init -y && npm pkg set type="module"
    ```

    Cr√©ez la structure de r√©pertoires du projet¬†:

    ```shellscript
    mkdir -p client server && touch server/index.js client/index.html client/app.js .env.example .env
    ```
  </Step>

  <Step title="Installez les d√©pendances" stepNumber={2}>
    Installez Cap&#39;n Web et les d√©pendances principales :

    ```shellscript
    npm install capnweb ws dotenv
    ```

    Installez les trousses de d√©veloppement logiciel (SDK) Auth0 pour l‚Äôauthentification et la validation des jetons¬†:

    ```shellscript
    npm install @auth0/auth0-spa-js @auth0/auth0-api-js
    ```

    <Info>
      **@auth0/auth0-spa-js** est utilis√© c√¥t√© client pour g√©rer l‚Äôauthentification des utilisateurs, les flux de connexion et la gestion des jetons dans le navigateur.

      **@auth0/auth0-api-js** est utilis√© c√¥t√© serveur pour v√©rifier les jetons d‚Äôacc√®s et valider les signatures JWT √† l‚Äôaide des JWKS d‚ÄôAuth0.
    </Info>

    Configurez le script `start` dans package.json¬†:

    ```shellscript
    npm pkg set scripts.start="node server/index.js"
    ```
  </Step>

  <Step title="Configurez votre application Auth0" stepNumber={3}>
    Ensuite, vous devez cr√©er une nouvelle application sur votre locataire Auth0 et ajouter les variables d&#39;environnement √† votre projet.

    Vous pouvez choisir de le faire automatiquement en ex√©cutant une commande CLI ou manuellement via le tableau de bord :

    <Tabs>
      <Tab title="CLI">
        Ex√©cutez la commande shell suivante dans le r√©pertoire racine de votre projet pour cr√©er une application Auth0 et g√©n√©rer un fichier `.env` :

        <AuthCodeGroup>
          ```shellscript Mac
          AUTH0_APP_NAME="My Cap'n Web App" && AUTH0_API_NAME="Cap'n Web API" && AUTH0_API_IDENTIFIER="https://capnweb-api.$(date +%s).com" && brew tap auth0/auth0-cli && brew install auth0 && auth0 login --no-input && auth0 apis create --name "${AUTH0_API_NAME}" --identifier "${AUTH0_API_IDENTIFIER}" --scopes "read:profile,write:profile" --json > auth0-api-details.json && auth0 apps create -n "${AUTH0_APP_NAME}" -t spa -c http://localhost:3000 -l http://localhost:3000 -o http://localhost:3000 --json > auth0-app-details.json && CLIENT_ID=$(jq -r '.client_id' auth0-app-details.json) && DOMAIN=$(auth0 tenants list --json | jq -r '.[] | select(.active == true) | .name') && echo "AUTH0_DOMAIN=${DOMAIN}" > .env && echo "AUTH0_CLIENT_ID=${CLIENT_ID}" >> .env && echo "AUTH0_AUDIENCE=${AUTH0_API_IDENTIFIER}" >> .env && echo "PORT=3000" >> .env && echo "NODE_ENV=development" >> .env && rm auth0-app-details.json auth0-api-details.json && echo ".env file created with your Auth0 details:" && cat .env
          ```

          ```shellscript Windows
          $AppName = "My Cap'n Web App"; $ApiName = "Cap'n Web API"; $ApiIdentifier = "https://capnweb-api.$((Get-Date).Ticks).com"; winget install Auth0.CLI; auth0 login --no-input; auth0 apis create --name "$ApiName" --identifier "$ApiIdentifier" --scopes "read:profile,write:profile" --json | Set-Content -Path auth0-api-details.json; auth0 apps create -n "$AppName" -t spa -c http://localhost:3000 -l http://localhost:3000 -o http://localhost:3000 --json | Set-Content -Path auth0-app-details.json; $ClientId = (Get-Content -Raw auth0-app-details.json | ConvertFrom-Json).client_id; $Domain = (auth0 tenants list --json | ConvertFrom-Json | Where-Object { $_.active -eq $true }).name; Set-Content -Path .env -Value "AUTH0_DOMAIN=$Domain"; Add-Content -Path .env -Value "AUTH0_CLIENT_ID=$ClientId"; Add-Content -Path .env -Value "AUTH0_AUDIENCE=$ApiIdentifier"; Add-Content -Path .env -Value "PORT=3000"; Add-Content -Path .env -Value "NODE_ENV=development"; Remove-Item auth0-app-details.json, auth0-api-details.json; Write-Output ".env file created with your Auth0 details:"; Get-Content .env
          ```
        </AuthCodeGroup>
      </Tab>

      <Tab title="Tableau de bord">
        Avant de commencer, cr√©ez un fichier `.env` √† la racine de votre projet

        ```shellscript .env
        AUTH0_DOMAIN=YOUR_AUTH0_APP_DOMAIN
        AUTH0_CLIENT_ID=YOUR_AUTH0_APP_CLIENT_ID
        AUTH0_AUDIENCE=https://capnweb-api.yourproject.com
        PORT=3000
        NODE_ENV=development
        ```

        1. Acc√©dez au [Auth0 Dashboard](https://manage.auth0.com/dashboard/)
        2. Cliquez sur **Applications** &gt; **Applications** &gt; **Create Application**
        3. Dans la fen√™tre contextuelle, saisissez un nom pour votre application, s√©lectionnez `Single Page Web Application` comme type d&#39;application, puis cliquez sur **Create**
        4. Acc√©dez √† l‚Äôonglet **Settings** de la page des d√©tails de l‚ÄôApplication
        5. Remplacez `YOUR_AUTH0_APP_DOMAIN` et `YOUR_AUTH0_APP_CLIENT_ID` dans le fichier `.env` par les valeurs **Domaine** et **ID client** de l‚ÄôAuth0 Dashboard

        Enfin, dans l‚Äôonglet **Settings** de la page des d√©tails de votre Application, configurez les URL suivantes :

        **URL de redirection autoris√©es¬†:**

        ```
        http://localhost:3000
        ```

        **URL de d√©connexion autoris√©es:**

        ```
        http://localhost:3000
        ```

        **Origines Web autoris√©es¬†:**

        ```
        http://localhost:3000
        ```

        <Info>
          Les **URL de redirection autoris√©es** constituent une mesure de s√©curit√© essentielle pour vous assurer que les utilisateurs sont renvoy√©s en toute s√©curit√© vers votre application apr√®s l‚Äôauthentification. Sans URL correspondante, le processus de connexion √©chouera et les utilisateurs seront bloqu√©s par une page d‚Äôerreur Auth0 au lieu d‚Äôacc√©der √† votre application.

          Les **URL de d√©connexion autoris√©es** sont essentielles pour offrir une exp√©rience utilisateur fluide lors de la d√©connexion. Sans URL correspondante, les utilisateurs ne seront pas redirig√©s vers votre application apr√®s la d√©connexion et resteront plut√¥t sur une page g√©n√©rique d‚ÄôAuth0.

          La configuration **Allowed Web Origins** est essentielle pour l‚Äôauthentification silencieuse. Sans cette configuration, les utilisateurs seront d√©connect√©s lorsqu‚Äôils actualiseront la page ou reviendront plus tard √† votre application.
        </Info>

        **Obligatoire : cr√©er une API Auth0**

        Vous devez cr√©er une API Auth0 pour que la validation des jetons fonctionne :

        1. Dans l‚ÄôAuth0 Dashboard, allez dans **APIs** &gt; **Create API**
        2. Configurez les valeurs suivantes :
           * **Name**: `Cap'n Web API`
           * **Identifier**: `https://capnweb-api.yourproject.com` (utilisez votre propre identifiant unique)
           * **Signing Algorithm**: `RS256` (valeur par d√©faut)
        3. Cliquez sur **Create**
        4. Dans l‚Äôonglet **Scopes**, ajoutez les scopes suivants :
           * `read:profile` - Lire les donn√©es de profil de l‚Äôutilisateur
           * `write:profile` - Mettre √† jour les donn√©es de profil de l‚Äôutilisateur
        5. Mettez √† jour votre fichier `.env` avec l‚Äôidentifiant de l‚ÄôAPI sous la forme `AUTH0_AUDIENCE`

        <Warning>
          Si vous ne cr√©ez pas une API Auth0, vous obtiendrez une erreur ¬´ access&#95;denied ¬ª pendant la connexion. L‚Äôidentifiant de l‚ÄôAPI doit correspondre exactement √† votre variable d‚Äôenvironnement `AUTH0_AUDIENCE`.
        </Warning>
      </Tab>
    </Tabs>
  </Step>

  <Step title="Cr√©ez le serveur" stepNumber={5}>
    Cr√©ez le serveur Web Cap&#39;n avec l&#39;int√©gration Auth0 :

    ```javascript server/index.js expandable lines
    import { RpcTarget, newWebSocketRpcSession } from 'capnweb';
    import { WebSocketServer } from 'ws';
    import { ApiClient } from '@auth0/auth0-api-js';
    import http from 'http';
    import { readFileSync } from 'fs';
    import { dirname, join } from 'path';
    import { fileURLToPath } from 'url';
    import dotenv from 'dotenv';

    dotenv.config();

    const __dirname = dirname(fileURLToPath(import.meta.url));
    const userProfiles = new Map();

    // Auth0 configuration
    const AUTH0_DOMAIN = process.env.AUTH0_DOMAIN;
    const AUTH0_CLIENT_ID = process.env.AUTH0_CLIENT_ID;
    const AUTH0_AUDIENCE = process.env.AUTH0_AUDIENCE;
    const PORT = process.env.PORT || 3000;

    if (!AUTH0_DOMAIN || !AUTH0_CLIENT_ID || !AUTH0_AUDIENCE) {
      console.error('‚ùå Variables d'environnement Auth0 requises manquantes');
      if (!AUTH0_DOMAIN) console.error('   - AUTH0_DOMAIN est requis');
      if (!AUTH0_CLIENT_ID) console.error('   - AUTH0_CLIENT_ID est requis');
      if (!AUTH0_AUDIENCE) console.error('   - AUTH0_AUDIENCE est requis');
      process.exit(1);
    }

    // Initialize Auth0 API client for token verification
    const auth0ApiClient = new ApiClient({
      domain: AUTH0_DOMAIN,
      audience: AUTH0_AUDIENCE
    });

    async function verifyToken(token) {
      try {
        const payload = await auth0ApiClient.verifyAccessToken({
          accessToken: token
        });
        return payload;
      } catch (error) {
        throw new Error(`√âchec de la v√©rification du jeton: ${error.message}`);
      }
    }

    // Profile Service - Cap'n Web RPC Target
    class ProfileService extends RpcTarget {
      async getProfile(accessToken) {
        const decoded = await verifyToken(accessToken);
        const userId = decoded.sub;
        const profile = userProfiles.get(userId) || { bio: '' };
        
        return {
          id: userId,
          email: decoded.email || 'Utilisateur inconnu',
          bio: profile.bio
        };
      }

      async updateProfile(accessToken, bio) {
        const decoded = await verifyToken(accessToken);
        const userId = decoded.sub;
        userProfiles.set(userId, { bio });
        
        return { success: true, message: 'Profil mis √† jour avec succ√®s' };
      }
    }

    // Create HTTP server
    const server = http.createServer(async (req, res) => {
      res.setHeader('Access-Control-Allow-Origin', '*');
      res.setHeader('Access-Control-Allow-Methods', 'GET, POST, OPTIONS');
      res.setHeader('Access-Control-Allow-Headers', 'Content-Type');
      
      if (req.method === 'OPTIONS') {
        res.writeHead(200);
        res.end();
        return;
      }

      if (req.url === '/api/config') {
        const config = { 
          auth0: { 
            domain: AUTH0_DOMAIN, 
            clientId: AUTH0_CLIENT_ID,
            audience: AUTH0_AUDIENCE
          } 
        };
        res.setHeader('Content-Type', 'application/json');
        res.writeHead(200);
        res.end(JSON.stringify(config));
        return;
      }

      // Handle root path and Auth0 callback
      if (req.url === '/' || req.url === '/index.html' || req.url.startsWith('/?code=') || req.url.startsWith('/?error=')) {
        const html = readFileSync(join(__dirname, '../client/index.html'), 'utf8');
        res.setHeader('Content-Type', 'text/html');
        res.writeHead(200);
        res.end(html);
        return;
      }

      if (req.url === '/app.js') {
        const js = readFileSync(join(__dirname, '../client/app.js'), 'utf8');
        res.setHeader('Content-Type', 'application/javascript');
        res.writeHead(200);
        res.end(js);
        return;
      }

      // Serve Auth0 SPA JS SDK from node_modules
      if (req.url === '/@auth0/auth0-spa-js') {
        const modulePath = join(__dirname, '../node_modules/@auth0/auth0-spa-js/dist/auth0-spa-js.production.esm.js');
        const js = readFileSync(modulePath, 'utf8');
        res.setHeader('Content-Type', 'application/javascript');
        res.writeHead(200);
        res.end(js);
        return;
      }

      // Serve capnweb from node_modules
      if (req.url === '/capnweb') {
        const modulePath = join(__dirname, '../node_modules/capnweb/dist/index.js');
        const js = readFileSync(modulePath, 'utf8');
        res.setHeader('Content-Type', 'application/javascript');
        res.writeHead(200);
        res.end(js);
        return;
      }

      res.writeHead(404);
      res.end('Introuvable');
    });

    // WebSocket server for Cap'n Web RPC
    const wss = new WebSocketServer({ server });

    wss.on('connection', (ws, req) => {
      // Only handle RPC connections on /api path
      if (req.url === '/api') {
        console.log('üîó Nouvelle connexion RPC Cap\'n Web');
        
        // Create a new ProfileService instance for this connection
        const profileService = new ProfileService();
        
        // Use capnweb's newWebSocketRpcSession to handle the connection
        newWebSocketRpcSession(ws, profileService);
      }
    });

    // Start server
    server.listen(PORT, () => {
      console.log(`üöÄ Serveur Auth0 Cap'n Web d√©marr√©`);
      console.log(`üìç Serveur en cours d'ex√©cution sur http://localhost:${PORT}`);
      console.log(`üîê Domaine Auth0: ${AUTH0_DOMAIN}`);
      console.log(`üÜî ID client: ${AUTH0_CLIENT_ID.substring(0, 8)}...`);
      console.log(`üéØ Audience de l'API: ${AUTH0_AUDIENCE}`);
    });
    ```
  </Step>

  <Step title="Cr√©er l‚Äôinterface Client" stepNumber={6}>
    Cr√©ez les fichiers HTML et JavaScript de l&#39;interface utilisateur :

    <AuthCodeGroup>
      ```html client/index.html expandable lines
      <!DOCTYPE html>
      <html lang="en">
      <head>
          <meta charset="UTF-8">
          <meta name="viewport" content="width=device-width, initial-scale=1.0">
          <title>D√©mo Cap'n Web + Auth0</title>
          <script type="importmap">
          {
            "imports": {
              "@auth0/auth0-spa-js": "/@auth0/auth0-spa-js",
              "capnweb": "/capnweb"
            }
          }
          </script>
          <style>
              body {
                  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                  max-width: 600px;
                  margin: 0 auto;
                  padding: 2rem;
                  line-height: 1.6;
              }
              .auth-section, .profile-section {
                  background: #f8f9fa;
                  border-radius: 8px;
                  padding: 2rem;
                  margin: 1rem 0;
              }
              .profile-section { display: none; }
              button {
                  background: #007bff;
                  color: white;
                  border: none;
                  padding: 0.75rem 1.5rem;
                  border-radius: 4px;
                  cursor: pointer;
                  font-size: 1rem;
                  margin: 0.5rem 0.5rem 0.5rem 0;
              }
              button:hover { background: #0056b3; }
              button.secondary { background: #6c757d; }
              button.secondary:hover { background: #545b62; }
              textarea {
                  width: 100%;
                  min-height: 100px;
                  margin: 1rem 0;
                  padding: 0.75rem;
                  border: 1px solid #ddd;
                  border-radius: 4px;
                  resize: vertical;
              }
              .status {
                  padding: 1rem;
                  margin: 1rem 0;
                  border-radius: 4px;
                  font-weight: 500;
              }
              .status.success { background: #d4edda; color: #155724; }
              .status.error { background: #f8d7da; color: #721c24; }
              .status.info { background: #d1ecf1; color: #0c5460; }
          </style>
      </head>
      <body>
          <h1>D√©mo de profil Cap'n Web + Auth0</h1>
          
          <div id="status" class="status info">Initialisation en cours...</div>
          
          <!-- Login Section -->
          <div id="authSection" class="auth-section">
              <h2>üîê Bienvenue !</h2>
              <p>Cette d√©mo pr√©sente l'authentification Auth0 avec Cap'n Web RPC pour la gestion de profil en temps r√©el.</p>
              <button id="loginBtn">Se connecter avec Auth0</button>
          </div>
          
          <!-- Profile Section -->
          <div id="profileSection" class="profile-section">
              <h2>üë§ Gestion du profil</h2>
              <p><strong>Courriel :</strong> <span id="userEmail">Chargement en cours...</span></p>
              
              <label for="bioTextarea"><strong>Bio :</strong></label>
              <textarea id="bioTextarea" placeholder="Parlez-nous de vous..."></textarea>
              
              <div>
                  <button id="fetchBtn">üîÑ R√©cup√©rer le profil</button>
                  <button id="saveBtn">üíæ Enregistrer le profil</button>
                  <button id="logoutBtn" class="secondary">üö™ Se d√©connecter</button>
              </div>
          </div>

          <script type="module" src="/app.js"></script>
      </body>
      </html>
      ```

      ```javascript client/app.js expandable lines
      import { createAuth0Client } from '@auth0/auth0-spa-js';
      import { newWebSocketRpcSession } from 'capnweb';

      // Configuration Auth0
      let auth0Client = null;
      let profileApi = null;

      // Configuration Auth0 - Charg√©e dynamiquement du serveur
      let AUTH0_CONFIG = null;

      // Charger la configuration Auth0 du serveur
      async function loadConfig() {
        const response = await fetch('/api/config');
        const config = await response.json();
        
        AUTH0_CONFIG = {
          domain: config.auth0.domain,
          clientId: config.auth0.clientId,
          authorizationParams: {
            redirect_uri: window.location.origin,
            audience: config.auth0.audience,
            scope: 'openid profile email'
          },
          useRefreshTokens: true,
          cacheLocation: 'localstorage'
        };
        
        return AUTH0_CONFIG;
      }

      // Initialiser l'application
      async function initializeApp() {
        try {
          showStatus('Chargement de la configuration...', 'info');
          
          const config = await loadConfig();
          
          showStatus('Initialisation du client Auth0...', 'info');
          auth0Client = await createAuth0Client(config);
          
          const query = window.location.search;
          if (query.includes('code=') && query.includes('state=')) {
            showStatus('Traitement de la connexion...', 'info');
            await auth0Client.handleRedirectCallback();
            window.history.replaceState({}, document.title, window.location.pathname);
          }
          
          const isAuthenticated = await auth0Client.isAuthenticated();
          
          if (isAuthenticated) {
            showStatus('Connexion √† Cap\'n Web RPC...', 'info');
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            profileApi = newWebSocketRpcSession(`${protocol}//${window.location.host}/api`);
            
            await showProfileSection();
          } else {
            showAuthSection();
          }
          
          setupEventListeners();
          
        } catch (error) {
          console.error('Erreur d\'initialisation :', error);
          showStatus(`√âchec de l'initialisation : ${error.message}`, 'error');
        }
      }

      // Fonctions d'authentification
      async function login() {
        try {
          showStatus('Redirection vers Auth0...', 'info');
          await auth0Client.loginWithRedirect();
        } catch (error) {
          showStatus(`√âchec de la connexion : ${error.message}`, 'error');
        }
      }

      async function logout() {
        try {
          if (profileApi) {
            profileApi[Symbol.dispose]();
          }
          await auth0Client.logout({
            logoutParams: { returnTo: window.location.origin }
          });
        } catch (error) {
          showStatus(`√âchec de la d√©connexion : ${error.message}`, 'error');
        }
      }

      async function getAccessToken() {
        try {
          return await auth0Client.getTokenSilently({
            authorizationParams: {
              audience: AUTH0_CONFIG.authorizationParams.audience
            }
          });
        } catch (error) {
          if (error.error === 'consent_required' || error.error === 'interaction_required') {
            await auth0Client.loginWithRedirect({
              authorizationParams: {
                audience: AUTH0_CONFIG.authorizationParams.audience,
                scope: 'openid profile email',
                prompt: 'consent'
              }
            });
          }
          throw error;
        }
      }

      // Fonctions de gestion du profil
      async function fetchProfile() {
        try {
          showStatus('R√©cup√©ration du profil...', 'info');
          
          const token = await getAccessToken();
          const user = await auth0Client.getUser();
          const profile = await profileApi.getProfile(token);
          
          document.getElementById('userEmail').textContent = user.email || profile.email || 'Aucun courriel disponible';
          document.getElementById('bioTextarea').value = profile.bio || '';
          
          showStatus('Profil charg√© avec succ√®s !', 'success');
        } catch (error) {
          showStatus(`√âchec de la r√©cup√©ration du profil : ${error.message}`, 'error');
        }
      }

      async function saveProfile() {
        try {
          showStatus('Enregistrement du profil...', 'info');
          
          const token = await getAccessToken();
          const bio = document.getElementById('bioTextarea').value;
          
          const result = await profileApi.updateProfile(token, bio);
          
          showStatus(result.message || 'Profil enregistr√© avec succ√®s !', 'success');
        } catch (error) {
          showStatus(`√âchec de l'enregistrement du profil : ${error.message}`, 'error');
        }
      }

      // Fonctions auxiliaires pour l'interface utilisateur
      function showAuthSection() {
        document.getElementById('authSection').style.display = 'block';
        document.getElementById('profileSection').style.display = 'none';
        showStatus('Pr√™t pour la connexion', 'info');
      }

      async function showProfileSection() {
        document.getElementById('authSection').style.display = 'none';
        document.getElementById('profileSection').style.display = 'block';
        await fetchProfile();
      }

      function showStatus(message, type) {
        const statusEl = document.getElementById('status');
        statusEl.textContent = message;
        statusEl.className = `status ${type}`;
      }

      // √âcouteurs d'√©v√©nements
      function setupEventListeners() {
        document.getElementById('loginBtn').addEventListener('click', login);
        document.getElementById('logoutBtn').addEventListener('click', logout);
        document.getElementById('fetchBtn').addEventListener('click', fetchProfile);
        document.getElementById('saveBtn').addEventListener('click', saveProfile);
      }

      // Initialiser l'application lorsque le DOM est charg√©
      document.addEventListener('DOMContentLoaded', initializeApp);
      ```
    </AuthCodeGroup>
  </Step>

  <Step title="Lancez votre application" stepNumber={7}>
    ```shellscript
    npm run start
    ```
  </Step>
</Steps>

<Check>
  **Point de contr√¥le**

  Vous devriez maintenant avoir une page de connexion Auth0 enti√®rement fonctionnelle qui s‚Äôex√©cute sur votre [localhost](http://localhost:3000/).
</Check>

---

<div id="advanced-usage">
  ## Utilisation avanc√©e
</div>

<Accordion title="S√©curit√© RPC c√¥t√© serveur">
  Renforcez la s√©curit√© en ajoutant une validation suppl√©mentaire et un m√©canisme de limitation de d√©bit (`rate limiting`) √† vos m√©thodes RPC&nbsp;:

  ```javascript server/profile-service.js
  import rateLimit from 'express-rate-limit';

  class ProfileService extends RpcTarget {
    constructor() {
      super();
      this.rateLimiter = new Map(); // M√©canisme simple de limitation de d√©bit en m√©moire
    }

    async validateAndRateLimit(userId) {
      const now = Date.now();
      const userLimit = this.rateLimiter.get(userId) || { count: 0, resetTime: now + 60000 };
      
      if (now > userLimit.resetTime) {
        userLimit.count = 0;
        userLimit.resetTime = now + 60000;
      }
      
      if (userLimit.count >= 10) {
        throw new Error('Rate limit exceeded. Try again later.');
      }
      
      userLimit.count++;
      this.rateLimiter.set(userId, userLimit);
    }

    async getProfile(accessToken) {
      const decoded = await verifyToken(accessToken);
      await this.validateAndRateLimit(decoded.sub);
      
      const userId = decoded.sub;
      const profile = userProfiles.get(userId) || { bio: '' };
      
      return {
        id: userId,
        email: decoded.email || 'Unknown User',
        bio: profile.bio,
        lastUpdated: profile.lastUpdated || null
      };
    }
  }
  ```
</Accordion>

<Accordion title="Gestion des connexions WebSocket">
  Impl√©mentez une gestion appropri√©e des connexions WebSocket avec reconnexion automatique&nbsp;:

  ```javascript client/connection-manager.js
  import { newWebSocketRpcSession } from 'capnweb';

  class RpcConnectionManager {
    constructor(wsUrl, options = {}) {
      this.wsUrl = wsUrl;
      this.api = null;
      this.reconnectAttempts = 0;
      this.maxReconnectAttempts = options.maxReconnectAttempts || 5;
      this.reconnectDelay = options.reconnectDelay || 1000;
      this.isConnecting = false;
      this.onReconnect = options.onReconnect || (() => {});
    }

    async connect() {
      if (this.isConnecting) return this.api;
      this.isConnecting = true;

      try {
        // Fermer la connexion existante, le cas √©ch√©ant
        if (this.api) {
          this.api[Symbol.dispose]();
        }

        // Cr√©er une nouvelle session RPC WebSocket
        this.api = newWebSocketRpcSession(this.wsUrl);
        this.reconnectAttempts = 0;
        this.isConnecting = false;
        
        console.log('‚úÖ RPC connection established');
        this.onReconnect(this.api);
        
        return this.api;
      } catch (error) {
        this.isConnecting = false;
        
        if (this.reconnectAttempts < this.maxReconnectAttempts) {
          this.reconnectAttempts++;
          console.log(`üîÑ Reconnection attempt ${this.reconnectAttempts}/${this.maxReconnectAttempts}`);
          
          await new Promise(resolve => 
            setTimeout(resolve, this.reconnectDelay * this.reconnectAttempts)
          );
          
          return this.connect();
        } else {
          throw new Error('Max reconnection attempts reached');
        }
      }
    }

    disconnect() {
      if (this.api) {
        this.api[Symbol.dispose]();
        this.api = null;
      }
      this.reconnectAttempts = 0;
    }

    getApi() {
      return this.api;
    }
  }

  // Utilisation dans app.js
  const connectionManager = new RpcConnectionManager(
    `${protocol}//${host}/api`,
    {
      maxReconnectAttempts: 5,
      reconnectDelay: 1000,
      onReconnect: async (api) => {
        // Actualiser l‚Äôinterface utilisateur ou recharger les donn√©es apr√®s la reconnexion
        await displayProfile(api);
      }
    }
  );

  // Se connecter lorsque l‚Äôutilisateur est authentifi√©
  if (isAuthenticated) {
    await connectionManager.connect();
    profileApi = connectionManager.getApi();
  }
  ```
</Accordion>

<Accordion title="Int√©gration √† une base de donn√©es">
  Remplacez le stockage en m√©moire par une base de donn√©es pour un usage en production&nbsp;:

  ```javascript server/database.js
  import { Pool } from 'pg';

  const pool = new Pool({
    connectionString: process.env.DATABASE_URL || 'postgresql://localhost/capnweb_auth0'
  });

  // Initialise le sch√©ma de la base de donn√©es
  async function initializeDatabase() {
    await pool.query(`
      CREATE TABLE IF NOT EXISTS user_profiles (
        user_id VARCHAR(255) PRIMARY KEY,
        bio TEXT,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
      )
    `);
  }

  class DatabaseProfileService extends RpcTarget {
    async getProfile(accessToken) {
      const decoded = await verifyToken(accessToken);
      const result = await pool.query(
        'SELECT bio, updated_at FROM user_profiles WHERE user_id = $1',
        [decoded.sub]
      );
      
      return {
        id: decoded.sub,
        email: decoded.email,
        bio: result.rows[0]?.bio || '',
        lastUpdated: result.rows[0]?.updated_at || null
      };
    }
    
    async updateProfile(accessToken, bio) {
      const decoded = await verifyToken(accessToken);
      await pool.query(`
        INSERT INTO user_profiles (user_id, bio, updated_at) 
        VALUES ($1, $2, CURRENT_TIMESTAMP)
        ON CONFLICT (user_id) 
        DO UPDATE SET bio = $2, updated_at = CURRENT_TIMESTAMP
      `, [decoded.sub, bio]);
      
      return { success: true, message: 'Profile updated successfully' };
    }
  }

  export { initializeDatabase, DatabaseProfileService };
  ```
</Accordion>