---
title: Ajouter une connexion à votre application Ruby on Rails
sidebarTitle: Ruby on Rails

---

import { Recipe, Content, Section, SideMenu, SideMenuSectionItem, SignUpForm } from "/snippets/fr-CA/recipe.jsx";
import { LoggedInForm } from "/snippets/fr-CA/Login.jsx";
import Auth0Yml from "/snippets/fr-CA/quickstart/webapp/rails/auth0.yml.mdx";
import Auth0 from "/snippets/fr-CA/quickstart/webapp/rails/auth0.rb.mdx";
import Auth0Controller from "/snippets/fr-CA/quickstart/webapp/rails/auth0_controller.rb.mdx";
import Routes from "/snippets/fr-CA/quickstart/webapp/rails/routes.rb.mdx";
import Secured from "/snippets/fr-CA/quickstart/webapp/rails/secured.rb.mdx";

import {AuthCodeGroup} from "/snippets/fr-CA/AuthCodeGroup.jsx";

export const sections = [
      { id: "configure-auth0", title: "Configurer Auth0" },
      { id: "add-dependencies", title: "Ajouter des dépendances" },
      { id: "configure-the-sdk", title: "Configurer la trousse de développement logiciel (SDK)" },
      { id: "configure-the-omniauth-middleware", title: "Configurer le middleware OmniAuth" },
      { id: "add-an-auth0-controller", title: "Ajouter un contrôleur Auth0" },
      { id: "configure-routes", title: "Configurer les routes" },
      { id: "add-login-to-your-application", title: "Ajouter la connexion à votre application" },
      { id: "add-logout-to-your-application", title: "Ajouter la déconnexion à votre application" },
      { id: "show-user-profile-information", title: "Afficher les informations du profil de l'utilisateur" }
]


<Recipe isSingleColumn>
  <Content>
    <Section id={sections[0].id} title={sections[0].title} stepNumber="1" isSingleColumn>
      Pour utiliser les services Auth0, vous devez d’abord configurer une application dans Auth0 Dashboard. C’est dans cette application Auth0 que vous définirez le fonctionnement de l’authentification pour le projet que vous développez.

      ### Configurer une application

      Utilisez le sélecteur interactif pour créer une nouvelle application Auth0 ou sélectionner une application existante qui représente le projet que vous voulez intégrer. Chaque application dans Auth0 se voit attribuer un ID client unique alphanumérique que le code de votre application utilisera pour appeler les API Auth0 via la trousse de développement logiciel (SDK).

      Tous les paramètres que vous configurez à l’aide de ce Démarrage rapide seront automatiquement mis à jour pour votre Application dans le [Dashboard](https://manage.auth0.com/#/), où vous pourrez gérer vos Applications par la suite.

      Si vous préférez explorer une configuration complète, vous pouvez plutôt consulter une application d’exemple.

      ### Configurer les URL de rappel (Callback)

      Une URL de rappel (callback) est une URL de votre application vers laquelle Auth0 doit rediriger les utilisateurs après leur authentification. Si elle n’est pas définie, les utilisateurs ne seront pas renvoyés vers votre application après leur connexion.

      <Info>
        Si vous suivez notre projet d’exemple, définissez cette valeur sur
        `http://localhost:3000/auth/auth0/callback`.
      </Info>

      ### Configurer les URL de déconnexion

      Une URL de déconnexion est une URL de votre application vers laquelle Auth0 doit rediriger les utilisateurs après leur déconnexion. Si elle n’est pas définie, les utilisateurs ne pourront pas se déconnecter de votre application et recevront une erreur.

      <Info>
        Si vous suivez notre projet d’exemple, définissez cette valeur sur `http://localhost:3000`.
      </Info>

      ### Configurer les origines Web autorisées

      Une origine Web autorisée (Allowed Web Origin) est une URL à laquelle vous voulez autoriser l’accès à votre flux d’authentification. Elle doit contenir l’URL de votre projet. Si elle n’est pas correctement définie, votre projet ne pourra pas actualiser les jetons d’authentification de façon silencieuse, de sorte que vos utilisateurs seront déconnectés lors de leur prochaine visite de votre application ou du rafraîchissement d’une page.

      <Info>
        Si vous suivez notre projet d’exemple, définissez cette valeur sur `http://localhost:3000`.
      </Info>

      <LoggedInForm />
    </Section>

    <Section id={sections[1].id} title={sections[1].title} stepNumber="2" isSingleColumn>
      Utilisez `omniauth-auth0`, une [stratégie OmniAuth](https://github.com/intridea/omniauth#omniauth-standardized-multi-provider-authentication) personnalisée, pour gérer le flux d’authentification.

      Ajoutez les dépendances suivantes à votre `Gemfile` :

      ```gem lines
      gem 'omniauth-auth0', '~> 3.0'
      gem 'omniauth-rails_csrf_protection', '~> 1.0' # empêche les demandes d'authentification falsifiées
      ```

      Une fois vos gems ajoutées, installez-les avec `bundle install`.

      <LoggedInForm />
    </Section>

    <Section id={sections[2].id} title={sections[2].title} stepNumber="3" isSingleColumn>
      Créez un fichier de configuration `./config/auth0.yml` pour spécifier votre Domaine Auth0, votre ID client et votre secret client, dont les valeurs se trouvent dans votre Auth0 Dashboard, sous l’onglet **Settings** de votre Application.

      <AuthCodeGroup>
        <Auth0Yml />

        <Auth0 />

        <Auth0Controller />

        <Routes />

        <Secured />
      </AuthCodeGroup>
    </Section>

    <Section id={sections[3].id} title={sections[3].title} stepNumber="4" isSingleColumn>
      Créez le fichier d&#39;initialisation suivant `./config/initializers/auth0.rb` et [configurez](https://github.com/auth0/omniauth-auth0/blob/master/EXAMPLES.md#send-additional-authentication-parameters) le middleware **OmniAuth** avec le fichier de configuration
      que vous avez créé à l&#39;étape précédente.

      Assurez-vous que `callback_path` correspond à la valeur indiquée dans le paramètre &quot;URL de redirection autorisées&quot; de votre
      Application Auth0.

      <AuthCodeGroup>
        <Auth0 />

        <Auth0Yml />

        <Auth0Controller />

        <Routes />

        <Secured />
      </AuthCodeGroup>
    </Section>

    <Section id={sections[4].id} title={sections[4].title} stepNumber="5" isSingleColumn>
      Créez un contrôleur Auth0 pour gérer le rappel d’authentification, l’action `logout` et les méthodes
      pour construire l’URL de déconnexion.

      Exécutez la commande :
      `rails generate controller auth0 callback failure logout --skip-assets --skip-helper --skip-routes --skip-template-engine`.

      Dans la méthode de rappel, affectez à la session active la structure de hachage contenant les informations de l’utilisateur — retournée par
      `request.env['omniauth.auth']`.

      Pour configurer la déconnexion, effacez tous les objets stockés dans la session en appelant la méthode
      `reset_session` dans l’action `logout`. Ensuite, redirigez vers le point de terminaison de déconnexion d’Auth0. Pour en savoir plus sur
      `reset_session`, consultez la [documentation Ruby on Rails ActionController](http://api.rubyonrails.org/classes/ActionController/Base.html#M000668).

      <AuthCodeGroup>
        <Auth0Controller />

        <Auth0Yml />

        <Auth0 />

        <Routes />

        <Secured />
      </AuthCodeGroup>
    </Section>

    <Section id={sections[5].id} title={sections[5].title} stepNumber="6" isSingleColumn>
      Ajoutez ces routes à votre fichier `./config/routes.rb`.

      Les routes doivent être définies pour que Rails sache comment acheminer les différentes URL de rappel Auth0 vers le contrôleur Auth0 que vous avez créé à l’étape précédente.

      <Info>
        ##### Point de contrôle

        Exécutez votre application pour vérifier qu’elle continue de fonctionner comme prévu et que vous ne recevez aucune erreur liée à Auth0.
      </Info>

      <AuthCodeGroup>
        <Routes />

        <Auth0Yml />

        <Auth0 />

        <Auth0Controller />

        <Secured />
      </AuthCodeGroup>
    </Section>

    <Section id={sections[6].id} title={sections[6].title} stepNumber="7" isSingleColumn>
      Un utilisateur peut maintenant ouvrir une session dans votre application en accédant au point de terminaison `/auth/auth0`.

      <Warning>
        Pour [empêcher les demandes d&#39;authentification forgées](https://github.com/cookpad/omniauth-rails_csrf_protection), utilisez les méthodes d’assistance `link_to` ou
        `button_to` avec la méthode `:post`.
      </Warning>

      ```ruby lines
      <!-- Placez un bouton de connexion n'importe où sur votre application -->
      <%= button_to 'Login', '/auth/auth0', method: :post %>
      ```

      <Note>
        ##### Point de contrôle

        Ajoutez un bouton à votre application qui redirige l’utilisateur vers le point de terminaison `/auth/auth0`
        lorsque l’utilisateur clique dessus. Remarquez que vous êtes redirigé vers Auth0 pour vous connecter, puis
        renvoyé à votre application une fois l’authentification réussie.
      </Note>

      <LoggedInForm />
    </Section>

    <Section id={sections[7].id} title={sections[7].title} stepNumber="8" isSingleColumn>
      Maintenant que vous pouvez ouvrir une session dans votre application Rails, vous avez besoin d’un
      moyen de vous déconnecter. Déconnectez un utilisateur en le redirigeant vers l’action `auth/logout`, qui le redirige
      vers le point de terminaison de déconnexion Auth0.

      <Info>
        Pour tester cela après l’étape précédente, vous devrez peut-être effacer votre session, puis rediriger l’utilisateur
        vers le point de terminaison de déconnexion Auth0.
      </Info>

      ```ruby lines
      <!-- Placez un bouton de déconnexion n'importe où sur votre application -->
      <%= button_to 'Logout', 'auth/logout', method: :get %>
      ```

      <Note>
        ##### Point de contrôle

        Ajoutez un bouton dans votre application qui redirige l&#39;utilisateur vers le point de terminaison `/auth/logout` lorsqu&#39;il est sélectionné. Vérifiez que vous êtes redirigé vers Auth0, puis rapidement de retour vers votre application, et que vous n&#39;êtes plus connecté.
      </Note>

      <LoggedInForm />
    </Section>

    <Section id={sections[8].id} title={sections[8].title} stepNumber="9" isSingleColumn>
      Pour afficher le profil de l&#39;utilisateur, votre application doit fournir une route protégée. Vous pouvez utiliser un [Concern](https://guides.rubyonrails.org/getting_started.html#using-concerns) pour contrôler l&#39;accès aux routes qui peuvent être partagées par plusieurs contrôleurs. Le Concern doit rediriger automatiquement vers Auth0 lorsque l&#39;utilisateur n&#39;est pas authentifié. Sinon, le Concern doit retourner le profil de l&#39;utilisateur actuel.

      Une fois que vous avez un Concern, incluez-le dans tout contrôleur qui requiert qu&#39;un utilisateur soit connecté. Vous pouvez ensuite accéder à l&#39;utilisateur à partir de la session `session[:userinfo]`, comme dans l&#39;exemple suivant :

      ```ruby lines
      class DashboardController < ApplicationController
      include Secured
      def show
      @user = session[:userinfo]

      end
      end
      ```

      Une fois que l&#39;utilisateur a été chargé à partir de la session, utilisez-le pour afficher des informations dans votre interface frontend :

      ```html lines
      <div>
      <p>Normalized User Profile:<%= JSON.pretty_generate(@user[:info])%></p>
      <p>Profil utilisateur complet :<%= JSON.pretty_generate(@user[:extra][:raw_info])%></p>
      </div>
      ```

      <Note>
        ##### Point de contrôle

        Ajoutez le module `Secured` à votre application, puis incluez-le dans le contrôleur pour lequel
        l’accès nécessite un utilisateur authentifié. Vérifiez qu’un utilisateur authentifié a accès aux actions
        de ce contrôleur et que les utilisateurs non authentifiés sont redirigés vers Auth0 pour
        s’authentifier.
      </Note>

      <AuthCodeGroup>
        <Secured />

        <Auth0Yml />

        <Auth0 />

        <Auth0Controller />

        <Routes />
      </AuthCodeGroup>
    </Section>

    ## Prochaines étapes

    Excellent travail! Si vous vous êtes rendu jusqu&#39;ici, vous devriez maintenant avoir la connexion, la déconnexion et les informations de profil utilisateur qui fonctionnent dans votre application.

    Ce tutoriel de démarrage rapide est maintenant terminé, mais il reste encore beaucoup à découvrir. Pour en savoir plus sur ce que vous pouvez faire avec Auth0, consultez :

    * [Auth0 Dashboard](https://manage.auth0.com/dashboard/us/dev-gja8kxz4ndtex3rq) - Découvrez comment configurer et gérer votre locataire Auth0 et vos applications
    * [omniauth-auth0 SDK](https://github.com/auth0/omniauth-auth0) - Explorez plus en détail la trousse de développement logiciel (SDK) utilisée dans ce tutoriel.
    * [Auth0 Marketplace](https://marketplace.auth0.com/) - Découvrez les intégrations que vous pouvez activer afin d’étendre les fonctionnalités d’Auth0
  </Content>
</Recipe>