---
title: "Ruby on Rails : Connexion"
permalink: "01-login"
---

import {AuthCodeBlock} from "/snippets/fr-CA/AuthCodeBlock.jsx";

<div id="by-david-patrick">
  ##### Par David Patrick
</div>

Ce tutoriel explique comment ajouter la connexion des utilisateurs à une application Ruby on Rails. Nous vous recommandons de vous connecter pour suivre ce Démarrage rapide avec des exemples déjà configurés pour votre compte.

{/* <Card title="Afficher sur GitHub" href="https://github.com/auth0-samples/auth0-rubyonrails-sample/tree/master/sample" icon="github">
  Configuration requise : Ruby 2.5.0+ | Rails 6.0+ ou Rails 5.0+ ou Rails 4.2+
  </Card> */}

<Info>
  **Vous débutez en authentification ?** Découvrez [comment fonctionne Auth0](/docs/fr-CA/get-started/auth0-overview), comment Auth0 [s’intègre aux applications Web classiques](/docs/fr-CA/get-started/architecture-scenarios/sso-for-regular-web-apps) et quel [protocole](/docs/fr-CA/get-started/authentication-and-authorization-flow) il utilise.
</Info>

<div id="configure-auth0">
  ## Configurer Auth0
</div>

<div id="get-your-application-keys">
  ### Obtenir les clés de votre Application
</div>

Au moment de votre inscription à Auth0, une nouvelle Application a été créée pour vous, ou vous en avez peut-être créé une vous-même. Vous aurez besoin de certaines informations concernant cette Application pour communiquer avec Auth0. Vous trouverez ces informations dans la section [Application Settings](https://manage.auth0.com/#/applications) de l&#39;Auth0 Dashboard.

<Frame>![Tableau de bord de l'application](https://cdn2.auth0.com/docs/1.14550.0/media/articles/dashboard/client_settings.png)</Frame>

Vous avez besoin des informations suivantes :

* **Domaine**
* **ID client**
* **Secret client**

<Info>
  Si vous téléchargez l&#39;exemple proposé en haut de cette page, ces informations sont déjà renseignées pour vous.
</Info>

<div id="configure-callback-urls">
  ### Configurer les URL de rappel
</div>

Une URL de rappel est une URL dans votre application vers laquelle Auth0 redirige l&#39;utilisateur après qu&#39;il s&#39;est authentifié. L&#39;URL de rappel de votre application doit être ajoutée au champ **URL de redirection autorisées** dans vos [Application Settings](https://manage.auth0.com/#/applications). Si ce champ n&#39;est pas configuré, les utilisateurs ne pourront pas se connecter à l&#39;application et recevront une erreur.

<Info>
  Si vous suivez le projet d&#39;exemple que vous avez téléchargé en haut de cette page, l&#39;URL de rappel que vous devez ajouter au champ **URL de redirection autorisées** est `http://localhost:3000/auth/auth0/callback`.
</Info>

<div id="configure-logout-urls">
  ### Configurer les URL de déconnexion
</div>

Une URL de déconnexion est une URL dans votre application vers laquelle Auth0 peut revenir après que l’utilisateur a été déconnecté du serveur d’autorisation. Cette URL est spécifiée dans le paramètre de requête `returnTo`. L’URL de déconnexion de votre application doit être ajoutée au champ **URL de déconnexion autorisées** dans vos [paramètres d’Application](https://manage.auth0.com/#/applications). Si ce champ n’est pas défini, les utilisateurs ne pourront pas se déconnecter de l’application et recevront un message d’erreur.

<Info>
  Si vous suivez le projet d’exemple que vous avez téléchargé en haut de cette page, l’URL de déconnexion que vous devez ajouter au champ **URL de déconnexion autorisées** est `http://localhost:3000`.
</Info>

<div id="install-the-auth0-sdk">
  ## Installez la trousse de développement logiciel (SDK) Auth0
</div>

<div id="install-dependencies">
  ### Installer les dépendances
</div>

Ce tutoriel utilise `omniauth-auth0`, une [stratégie OmniAuth](https://github.com/intridea/omniauth#omniauth-standardized-multi-provider-authentication) personnalisée pour gérer le flux d&#39;authentification. Ajoutez les dépendances suivantes à votre `Gemfile` :

```bash lines
gem 'omniauth-auth0', '~> 3.0'
gem 'omniauth-rails_csrf_protection', '~> 1.0' # prévient les requêtes d'authentification contrefaites
```

Une fois vos gems ajoutées, installez-les à l’aide de `bundle install` :

<div id="initialize-auth0-configuration">
  ### Initialiser la configuration Auth0
</div>

Créez un fichier de configuration pour Auth0 `./config/auth0.yml`

export const codeExample = `# ./config/auth0.yml
development:
  auth0_domain: {yourDomain}
  auth0_client_id: {yourClientId}
  auth0_client_secret: <VOTRE SECRET CLIENT AUTH0>`;

<AuthCodeBlock children={codeExample} language="yml" />

Créez le fichier d’initialisation suivant `./config/initializers/auth0.rb`, puis [configurez](https://github.com/auth0/omniauth-auth0/blob/master/EXAMPLES.md#send-additional-authentication-parameters) le middleware **OmniAuth**.

```rb lines
# ./config/initializers/auth0.rb
AUTH0_CONFIG = Rails.application.config_for(:auth0)

Rails.application.config.middleware.use OmniAuth::Builder do
  provider(
    :auth0,
    AUTH0_CONFIG['auth0_client_id'],
    AUTH0_CONFIG['auth0_client_secret'],
    AUTH0_CONFIG['auth0_domain'],
    callback_path: '/auth/auth0/callback',
    authorize_params: {
      scope: 'openid profile'
    }
  )
end
```

<div id="add-an-auth0-controller">
  ### Ajouter un contrôleur Auth0
</div>

Créez un contrôleur Auth0 pour gérer le callback d’authentification. Exécutez la commande `rails generate controller auth0 callback failure logout --skip-assets --skip-helper --skip-routes --skip-template-engine`.

Dans la méthode de callback, affectez le hachage des informations de l’utilisateur, retourné sous la forme `request.env['omniauth.auth']`, à la session active.

```rb lines
# ./app/controllers/auth0_controller.rb
class Auth0Controller < ApplicationController
  def callback
    # OmniAuth stocke les informations renvoyées par Auth0 et l'IdP dans request.env['omniauth.auth'].
    # Dans ce code, vous extrairez le raw_info fourni par l'id_token et l'assignerez à la session.
    # Consultez https://github.com/auth0/omniauth-auth0/blob/master/EXAMPLES.md#example-of-the-resulting-authentication-hash pour obtenir des informations complètes sur le contenu de 'omniauth.auth'.
    auth_info = request.env['omniauth.auth']
    session[:userinfo] = auth_info['extra']['raw_info']

    # Redirigez vers l'URL souhaitée après une authentification réussie
    redirect_to '/dashboard'
  end

  def failure
    # Gère l'échec de l'authentification -- Affiche une page d'erreur (vous pouvez également gérer cela avec une redirection)
    @error_msg = request.params['message']
  end

  def logout
    # vous compléterez ceci dans une étape ultérieure
  end
end
```

Ajoutez les routes suivantes dans votre fichier `./config/routes.rb` :

```rb lines
# ./config/routes.rb
Rails.application.routes.draw do
  # ..
  get '/auth/auth0/callback' => 'auth0#callback'
  get '/auth/failure' => 'auth0#failure'
  get '/auth/logout' => 'auth0#logout'
end
```

<div id="add-login-to-your-application">
  ## Ajouter la connexion à votre application
</div>

Un utilisateur peut maintenant se connecter à votre application en accédant au point de terminaison `/auth/auth0`.

<Warning>
  Pour [empêcher les requêtes d’authentification falsifiées](https://github.com/cookpad/omniauth-rails_csrf_protection), utilisez les méthodes helper `link_to` ou `button_to` avec la méthode `:post`.
</Warning>

```erb lines
<!-- Placez un bouton de connexion n'importe où dans votre application -->
  <%= button_to 'Connexion', '/auth/auth0', method: :post, data: { turbo: false } %>
```

<div id="add-logout-to-your-application">
  ## Ajouter la déconnexion à votre application
</div>

Maintenant que vous pouvez ouvrir une session dans votre application Rails, vous avez besoin [d’un moyen de vous déconnecter](https://auth0.com/docs/logout/guides/logout-auth0). Revenez à Auth0Controller que vous avez créé plus tôt et terminez la méthode de déconnexion (`logout`) qui y a été ajoutée.

Vous devrez vider votre session, puis rediriger l’utilisateur vers le point de terminaison de déconnexion (`logout`) d’Auth0.

Pour supprimer tous les objets stockés dans la session, appelez la méthode `reset_session` dans la méthode `auth0_controller/logout`. [En savoir plus sur reset&#95;session ici](http://api.rubyonrails.org/classes/ActionController/Base.html#M000668). Ajoutez le code suivant à `./app/controllers/auth0_controller.rb`:

```rb lines
# ./app/controllers/auth0_controller.rb
class Auth0Controller < ApplicationController
  # ..
  # ..Insérer le code ci-dessous
  def logout
    reset_session
    redirect_to logout_url, allow_other_host: true
  end

  private

  def logout_url
    request_params = {
      returnTo: root_url,
      client_id: AUTH0_CONFIG['auth0_client_id']
    }

    URI::HTTPS.build(host: AUTH0_CONFIG['auth0_domain'], path: '/v2/logout', query: request_params.to_query).to_s
  end
end
```

<Info>
  L’URL de destination finale (la valeur `returnTo`) doit figurer dans la liste des `URL de déconnexion autorisées`. Consultez la [documentation sur la déconnexion](/docs/fr-CA/authenticate/login/logout/redirect-users-after-logout) pour en savoir plus.
</Info>

L’utilisateur pourra maintenant se déconnecter de votre application en accédant au point de terminaison `/auth/logout`.

```erb lines
<!-- Placez un bouton de déconnexion n'importe où dans votre application -->
  <%= button_to 'Logout', 'auth/logout', method: :get, data: { turbo: false } %>
```

<div id="show-user-profile-information">
  ## Afficher les renseignements du profil de l&#39;utilisateur
</div>

Pour afficher le profil de l&#39;utilisateur, votre application doit définir une route protégée. Vous pouvez utiliser un `concern` de contrôleur pour contrôler l&#39;accès aux routes. Créez le fichier suivant : `./app/controllers/concerns/secured.rb`

```rb lines
# ./app/controllers/concerns/secured.rb
module Secured
  extend ActiveSupport::Concern

  included do
    before_action :logged_in_using_omniauth?
  end

  def logged_in_using_omniauth?
    redirect_to '/' unless session[:userinfo].present?
  end
end
```

Après avoir créé le concern de contrôleur sécurisé, incluez-le dans tout contrôleur qui requiert un utilisateur connecté. Vous pouvez ensuite accéder à l’utilisateur à partir de la session `session[:userinfo]`.

```rb lines
# ./app/controllers/dashboard_controller.rb
class DashboardController < ApplicationController
  include Secured

  def show
    # session[:userinfo] a été enregistré plus tôt dans Auth0Controller#callback
    @user = session[:userinfo]
  end
end
```

Maintenant que vous avez récupéré l’utilisateur à partir de la session, vous pouvez l’utiliser pour afficher des informations dans votre interface front-end.

```erb lines
<!-- ./app/views/dashboard/show.html.erb -->
<div>
  <p>Normalized User Profile:<%= JSON.pretty_generate(@user[:info])%></p>
  <p>Full User Profile:<%= JSON.pretty_generate(@user[:extra][:raw_info])%></p>
</div>
```

<Note>
  ##### Que faire ensuite ?

  <table>
    <tr>
      <td><a href="/docs/fr-CA/authenticate/identity-providers">Configurer d&#39;autres fournisseurs d&#39;identité</a></td>
      <td><a href="/docs/fr-CA/secure/multi-factor-authentication">Activer l&#39;authentification multifacteur</a></td>
    </tr>

    <tr>
      <td><a href="/docs/fr-CA/secure/attack-protection">En savoir plus sur la protection contre les attaques</a></td>
      <td><a href="/docs/fr-CA/customize/rules">En savoir plus sur les Rules</a></td>
    </tr>
  </table>

  [Modifier sur GitHub](https://github.com/auth0/docs/edit/master/articles/quickstart/native/flutter/01-login.md)
</Note>
