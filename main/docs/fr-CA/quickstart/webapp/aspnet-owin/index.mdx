---
title: "ASP.NET (OWIN)"
permalink: "01-login"
---

<div id="by-frederik-prijck">
  ##### Par Frederik Prijck
</div>

Ce tutoriel explique comment ajouter la connexion des utilisateurs à une application ASP.NET OWIN. Nous vous recommandons de vous connecter afin de suivre ce Démarrage rapide avec des exemples configurés pour votre compte.

{/* <Card title="Voir sur GitHub" href="https://github.com/auth0-samples/auth0-aspnet-owin-mvc-samples/tree/master/Quickstart/Sample" icon="github">
  Configuration système requise : Microsoft Visual Studio 2017 | Microsoft.Owin.Security.OpenIdConnect v4.1.0 ou version ultérieure
  </Card> */}

<div id="configure-auth0">
  ## Configurer Auth0
</div>

<div id="get-your-application-keys">
  ### Obtenir les clés de votre Application
</div>

Lorsque vous vous êtes inscrit à Auth0, une nouvelle Application a été créée pour vous, ou vous avez pu en créer une nouvelle. Vous aurez besoin de certaines informations sur cette Application pour communiquer avec Auth0. Vous pouvez obtenir ces informations dans la section [Application Settings](https://manage.auth0.com/#/applications) d’Auth0 Dashboard.

<Frame>![Tableau de bord de l'application](https://cdn2.auth0.com/docs/1.14550.0/media/articles/dashboard/client_settings.png)</Frame>

Vous avez besoin des informations suivantes :

* **Domaine**
* **ID client**
* **Secret client**

<Info>
  Si vous téléchargez l’exemple en haut de cette page, ces informations sont déjà renseignées pour vous.
</Info>

<div id="configure-callback-urls">
  ## Configurer les URL de rappel
</div>

L’URL de rappel de votre application est l’URL vers laquelle Auth0 redirigera après l’authentification de l’utilisateur, afin que le middleware OWIN OpenID Connect puisse terminer le processus d’authentification.

Vous devez ajouter cette URL à la liste des URL autorisées pour votre application. L’URL de rappel pour le projet seed est `http://localhost:3000/callback`; assurez-vous donc de l’ajouter à la section **URL de redirection autorisées** de votre application. Ajoutez également `http://localhost:3000/` aux **URL de déconnexion autorisées**.

Si vous déployez votre application sur une URL différente, vous devez aussi vous assurer d’ajouter cette URL aux **URL de redirection autorisées** et aux **URL de déconnexion autorisées**. Le fichier `web.config` des projets d’exemple contient également deux clés nommées `auth0:RedirectUri` et `auth0:PostLogoutRedirectUri` avec ces URL. Assurez-vous de les modifier aussi.

C’est tout ce dont vous avez besoin pour commencer à travailler avec Auth0!

<div id="install-and-configure-the-openid-connect-middleware">
  ## Installer et configurer le middleware OpenID Connect
</div>

<Info>
  Ce démarrage rapide utilise le middleware OWIN et, par conséquent, vous devez utiliser OWIN dans votre application. Si votre application n’utilise pas actuellement OWIN, consultez la [documentation OWIN de Microsoft](https://docs.microsoft.com/en-us/aspnet/aspnet/overview/owin-and-katana/) pour l’activer dans votre application.
</Info>

La façon la plus simple d’activer l’authentification avec Auth0 dans votre application ASP.NET MVC consiste à utiliser le middleware OWIN OpenID Connect. Pour ce faire, installez d’abord le package NuGet `Microsoft.Owin.Security.OpenIdConnect` :

```bash lines
Install-Package Microsoft.Owin.Security.OpenIdConnect
```

Vous devez également installer la bibliothèque de middleware suivante pour activer l’authentification par cookies dans votre projet :

```bash lines
Install-Package Microsoft.Owin.Security.Cookies
```

<Info>
  Des problèmes peuvent survenir lorsque vous configurez simultanément le middleware de témoins (cookies) OWIN et les témoins System.Web. Pour en savoir plus sur la façon d’atténuer ces problèmes, consultez la [documentation sur les problèmes d’intégration des témoins System.Web](https://github.com/aspnet/AspNetKatana/wiki/System.Web-response-cookie-integration-issues).
</Info>

Accédez maintenant à la méthode `Configuration` de votre classe `Startup` et configurez le middleware de témoins ainsi que le middleware Auth0.

```cs lines
// Startup.cs
using Microsoft.IdentityModel.Protocols.OpenIdConnect;
using Microsoft.IdentityModel.Tokens;
using Microsoft.Owin;
using Microsoft.Owin.Host.SystemWeb;
using Microsoft.Owin.Security;
using Microsoft.Owin.Security.Cookies;
using Microsoft.Owin.Security.OpenIdConnect;
using MvcApplication.Support;
using Owin;

public void Configuration(IAppBuilder app)
{
    // Configurer les paramètres Auth0
    string auth0Domain = ConfigurationManager.AppSettings["auth0:Domain"];
    string auth0ClientId = ConfigurationManager.AppSettings["auth0:ClientId"];
    string auth0RedirectUri = ConfigurationManager.AppSettings["auth0:RedirectUri"];
    string auth0PostLogoutRedirectUri = ConfigurationManager.AppSettings["auth0:PostLogoutRedirectUri"];

    // Définir les cookies comme type d'authentification par défaut
    app.SetDefaultSignInAsAuthenticationType(CookieAuthenticationDefaults.AuthenticationType);
    app.UseCookieAuthentication(new CookieAuthenticationOptions
    {
        AuthenticationType = CookieAuthenticationDefaults.AuthenticationType,
        LoginPath = new PathString("/Account/Login"),

        // Configurer SameSite selon les besoins de votre application. Lax fonctionne bien dans la plupart des scénarios, mais
        // vous pouvez définir SameSiteMode.None pour HTTPS
        CookieSameSite = SameSiteMode.Lax,

        // Plus d'informations sur la raison pour laquelle le CookieManager doit être défini se trouvent ici : 
        // https://github.com/aspnet/AspNetKatana/wiki/System.Web-response-cookie-integration-issues
        CookieManager = new SameSiteCookieManager(new SystemWebCookieManager())
    });

    // Configurer l'authentification Auth0
    app.UseOpenIdConnectAuthentication(new OpenIdConnectAuthenticationOptions
    {
        AuthenticationType = "Auth0",

        Authority = $"https://{auth0Domain}",

        ClientId = auth0ClientId,

        RedirectUri = auth0RedirectUri,
        PostLogoutRedirectUri = auth0PostLogoutRedirectUri,
        Scope = "openid profile email",
        TokenValidationParameters = new TokenValidationParameters
        {
            NameClaimType = "name"
        },

        // Plus d'informations sur la raison pour laquelle le CookieManager doit être défini se trouvent ici : 
        // https://docs.microsoft.com/en-us/aspnet/samesite/owin-samesite
        CookieManager = new SameSiteCookieManager(new SystemWebCookieManager()),

        // Configurer l'URL de déconnexion d'Auth0 en interceptant la notification RedirectToIdentityProvider, 
        // qui est déclenchée avant toute redirection vers Auth0.
        Notifications = new OpenIdConnectAuthenticationNotifications
        {
            RedirectToIdentityProvider = notification =>
            {
                // Configurer l'URL de déconnexion uniquement lorsque le RequestType est OpenIdConnectRequestType.Logout.
                // Tout autre RequestType signifie un type d'interaction différent avec Auth0 qui n'est pas une déconnexion.
                if (notification.ProtocolMessage.RequestType == OpenIdConnectRequestType.Logout)
                {
                    var logoutUri = $"https://{auth0Domain}/v2/logout?client_id={auth0ClientId}";

                    var postLogoutUri = notification.ProtocolMessage.PostLogoutRedirectUri;
                    if (!string.IsNullOrEmpty(postLogoutUri))
                    {
                        if (postLogoutUri.StartsWith("/"))
                        {
                            // transformer en URL absolue
                            var request = notification.Request;
                            postLogoutUri = request.Scheme + "://" + request.Host + request.PathBase + postLogoutUri;
                        }
                        logoutUri += $"&returnTo={ Uri.EscapeDataString(postLogoutUri)}";
                    }

                    notification.Response.Redirect(logoutUri);
                    notification.HandleResponse();
                }
                return Task.FromResult(0);
            }
        }
    });
}
```

Il est essentiel d’enregistrer à la fois le middleware de cookies et le middleware OpenID Connect, puisqu’ils sont requis (dans cet ordre) pour que l’authentification fonctionne. Le middleware OpenID Connect gérera l’authentification avec Auth0. Une fois que l’utilisateur s’est authentifié, son identité sera stockée dans le middleware de cookies.

Dans l’extrait de code ci-dessus, notez que `AuthenticationType` est défini sur **Auth0**. Cela sera utilisé dans la prochaine section pour déclencher le middleware OpenID Connect et démarrer le flux d’authentification. Notez également le code dans l’événement de notification `RedirectToIdentityProvider`, qui construit la bonne [URL de déconnexion](/docs/fr-CA/authenticate/login/logout).

<div id="add-login-to-your-aspnet-owin-application">
  ## Ajouter la connexion à votre application ASP.NET OWIN
</div>

Pour permettre aux utilisateurs de se connecter à votre application ASP.NET OWIN, ajoutez une action `Login` à votre contrôleur.

Appelez `HttpContext.GetOwinContext().Authentication.Challenge` et passez `"Auth0"` comme schéma d’authentification. Cela invoque le gestionnaire d’authentification OIDC qui a été enregistré précédemment. Assurez-vous de préciser les `AuthenticationProperties` correspondantes, y compris un `RedirectUri`.

Après l’appel réussi à `HttpContext.GetOwinContext().Authentication.Challenge`, l’utilisateur est redirigé vers Auth0 et est connecté à la fois par le middleware OIDC et le middleware de cookies lorsqu’il est redirigé vers votre application. Cela permettra aux utilisateurs d’être authentifiés lors des requêtes suivantes.

```cs lines
public class AccountController : Controller
{
    public ActionResult Login(string returnUrl)
    {
        HttpContext.GetOwinContext().Authentication.Challenge(new AuthenticationProperties
            {
                RedirectUri = returnUrl ?? Url.Action("Index", "Home")
            },
            "Auth0");
        return new HttpUnauthorizedResult();
    }
}
```

<div id="add-logout-to-your-aspnet-owin-application">
  ## Ajouter la déconnexion à votre application ASP.NET OWIN
</div>

Depuis l’action de votre contrôleur, appelez `HttpContext.GetOwinContext().Authentication.SignOut` avec le schéma d’authentification `CookieAuthenticationDefaults.AuthenticationType` pour déconnecter l’utilisateur de votre application.

De plus, si vous voulez déconnecter l’utilisateur d’Auth0 (ce qui peut aussi le déconnecter d’autres applications qui s’appuient sur l’authentification unique), appelez `HttpContext.GetOwinContext().Authentication.SignOut` avec le schéma d’authentification `"Auth0"`.

```cs lines
public class AccountController : Controller
{
    [Authorize]
    public void Logout()
    {
        HttpContext.GetOwinContext().Authentication.SignOut(CookieAuthenticationDefaults.AuthenticationType);
        HttpContext.GetOwinContext().Authentication.SignOut("Auth0");
    }
}
```

<div id="display-the-user-profile">
  ## Afficher le profil de l’utilisateur
</div>

Une fois que le middleware a récupéré les jetons d’Auth0 avec succès, il extrait les renseignements et les revendications de l’utilisateur à partir du jeton ID et les rend disponibles sous forme de `ClaimsIdentity`. Accédez aux renseignements extraits en utilisant la propriété `User` du contrôleur.

Pour créer un profil d’utilisateur, récupérez le nom, l’adresse de courriel et l’image de profil d’un utilisateur à partir de `User.Identity` et transmettez-les à la vue à partir de votre contrôleur.

```cs lines
// Controllers/AccountController.cs

[Authorize]
public ActionResult UserProfile()
{
    var claimsIdentity = User.Identity as ClaimsIdentity;

    return View(new
    {
        Name = claimsIdentity?.FindFirst(c => c.Type == claimsIdentity.NameClaimType)?.Value,
        EmailAddress = claimsIdentity?.FindFirst(c => c.Type == ClaimTypes.Email)?.Value,
        ProfileImage = claimsIdentity?.FindFirst(c => c.Type == "picture")?.Value
    });
}
```

<div id="what-can-you-do-next">
  ##### Que pouvez-vous faire ensuite?
</div>

<Note>
  ##### Que pouvez-vous faire ensuite?

  <table>
    <tr>
      <td><a href="/docs/fr-CA/authenticate/identity-providers">Configurer d&#39;autres fournisseurs d&#39;identité</a></td>
      <td><a href="/docs/fr-CA/secure/multi-factor-authentication">Activer l&#39;authentification multifacteur</a></td>
    </tr>

    <tr>
      <td><a href="/docs/fr-CA/secure/attack-protection">En savoir plus sur la protection contre les attaques</a></td>
      <td><a href="/docs/fr-CA/customize/rules">En savoir plus sur Rules</a></td>
    </tr>
  </table>

  [Modifier sur GitHub](https://github.com/auth0/docs/edit/master/articles/quickstart/native/flutter/01-login.md)
</Note>