---
title: "API PHP"
permalink: "01-authorization"
---

import {AuthCodeBlock} from "/snippets/fr-CA/AuthCodeBlock.jsx";

<div id="by-evan-sims">
  ##### Par Evan Sims
</div>

Ce guide montre comment int√©grer Auth0 √† une API backend PHP √† l&#39;aide de la trousse de d√©veloppement logiciel (SDK) Auth0 pour PHP. Nous vous recommandons de vous connecter afin de suivre ce d√©marrage rapide avec des exemples configur√©s pour votre compte.

{/* <Card title="Voir sur GitHub" href="https://github.com/auth0-samples/auth0-php-api-samples/tree/main/app" icon="github">
  Configuration syst√®me requise : PHP 7.4+ (8.0 recommand√©) | Auth0-PHP 8.0 | Composer
  </Card> */}

<Info>
  **Vous d√©butez avec Auth0?** Apprenez [comment fonctionne Auth0](/docs/fr-CA/get-started/auth0-overview) et d√©couvrez comment [impl√©menter l‚Äôauthentification et l‚Äôautorisation d‚ÄôAPI](/docs/fr-CA/get-started/authentication-and-authorization-flow) √† l‚Äôaide du cadre OAuth 2.0.
</Info>

<div id="configure-auth0-apis">
  ## Configurer les API d‚ÄôAuth0
</div>

<div id="create-an-api">
  ### Cr√©er une API
</div>

Dans la section [APIs](https://manage.auth0.com/#/apis) de l‚ÄôAuth0 Dashboard, cliquez sur **Create API**. Indiquez un nom et un identifiant pour votre API, par exemple `https://quickstarts/api`. Vous utiliserez cet identifiant comme `audience` plus tard, lorsque vous configurerez la v√©rification du jeton d‚Äôacc√®s. Laissez **Signing Algorithm** sur **RS256**.

<Frame>![Cr√©er une API](https://cdn2.auth0.com/docs/1.14550.0/media/articles/server-apis/create-api.png)</Frame>

Par d√©faut, votre API utilise RS256 comme algorithme de signature des jetons. √âtant donn√© que RS256 utilise une paire de cl√©s priv√©e/publique, il v√©rifie les jetons √† l‚Äôaide de la cl√© publique de votre compte Auth0. La cl√© publique est au format [JSON Web Key Set (JWKS)](/docs/fr-CA/secure/tokens/json-web-tokens/json-web-key-sets) et est accessible [ici](https://\{yourDomain}/.well-known/jwks.json).

<div id="define-permissions">
  ### D√©finir des permissions
</div>

Les permissions vous permettent de d√©finir comment des ressources peuvent √™tre accessibles au nom de l‚Äôutilisateur √† l‚Äôaide d‚Äôun jeton d‚Äôacc√®s donn√©. Par exemple, vous pourriez choisir d‚Äôaccorder un acc√®s en lecture √† la ressource `messages` si les utilisateurs ont le niveau d‚Äôacc√®s gestionnaire, et un acc√®s en √©criture √† cette ressource s‚Äôils ont le niveau d‚Äôacc√®s administrateur.

Vous pouvez d√©finir les permissions autoris√©es dans la vue **Permissions** de la section [APIs](https://manage.auth0.com/#/apis) dans Auth0 Dashboard.

<Frame>![Configurer les permissions](https://cdn2.auth0.com/docs/1.14550.0/media/articles/server-apis/configure-permissions.png)</Frame>

<Info>
  Cet exemple utilise la port√©e `read:messages`.
</Info>

Cet exemple montre :

* Comment v√©rifier la pr√©sence d‚Äôun JSON Web Token (JWT) dans l‚Äôen-t√™te `Authorization` d‚Äôune requ√™te HTTP entrante.
* Comment v√©rifier si le jeton est valide en utilisant le [JSON Web Key Set (JWKS)](/docs/fr-CA/secure/tokens/json-web-tokens/json-web-key-sets) de votre compte Auth0. Pour en savoir plus sur la validation des jetons d‚Äôacc√®s, consultez [Valider les jetons d‚Äôacc√®s](/docs/fr-CA/secure/tokens/access-tokens/validate-access-tokens).

<div id="integrating-your-php-backend-api">
  ## Int√©grer votre API backend PHP
</div>

Cr√©ons une application d‚Äôexemple qui valide un jeton sign√© par Auth0 pour une API backend que nous avons √©crite en PHP. Nous allons adopter ici une approche simple, adapt√©e √† ce format √©crit. Consultez √©galement l‚Äô[application de D√©marrage rapide sur GitHub](https://github.com/auth0-samples/auth0-php-api-samples/) pour un exemple plus complet.

<div id="installing-http-client-and-messaging-factories">
  ### Installation des fabriques de client HTTP et de messagerie
</div>

La Trousse de d√©veloppement logiciel (SDK) Auth0 pour PHP prend en charge de nombreux standards PHP-FIG afin d‚Äôoffrir une interop√©rabilit√© maximale avec l‚Äôarchitecture de votre projet, mais deux sont particuli√®rement importants : [PSR-17](https://www.php-fig.org/psr/psr-17/) et [PSR-18](https://www.php-fig.org/psr/psr-18/). Ces standards vous permettent de ¬´ brancher ¬ª les composants r√©seau de votre choix pour g√©rer la messagerie et les requ√™tes. Vous devrez installer des biblioth√®ques compatibles dans votre projet pour que le SDK puisse les utiliser.

La biblioth√®que r√©seau la plus r√©pandue pour PHP est Guzzle, bien que plusieurs autres soient disponibles dans la communaut√© PHP. Utilisons Guzzle pour cette application d‚Äôexemple :

```bash
composer require guzzlehttp/guzzle guzzlehttp/psr7 http-interop/http-factory-guzzle
```

<div id="installing-the-php-sdk">
  ### Installation de la trousse de d√©veloppement logiciel (SDK) PHP
</div>

La trousse de d√©veloppement logiciel (SDK) PHP Auth0 n√©cessite [Composer](https://getcomposer.org/doc/00-intro.md#installation-linux-unix-macos), un outil de gestion des d√©pendances en PHP. Composer vous permet de d√©clarer les biblioth√®ques dont votre projet a besoin et de les installer pour vous. Assurez-vous que Composer est install√© et accessible √† partir de votre shell avant de continuer.

Ex√©cutez la commande shell suivante dans le r√©pertoire de votre projet pour installer le SDK PHP Auth0¬†:

```bash
composer require auth0/auth0-php
```

Cela cr√©era un dossier `vendor` dans votre projet et t√©l√©chargera toutes les d√©pendances n√©cessaires pour utiliser la trousse de d√©veloppement logiciel (SDK) Auth0 pour PHP. Un fichier `vendor/autoload.php` sera √©galement cr√©√©; il est utilis√© dans l‚Äôexemple pour charger toutes les classes n√©cessaires au bon fonctionnement de votre application. Il est important d‚Äôinclure ce fichier d‚Äôautoload dans votre projet pour que le SDK fonctionne.

<div id="configure-the-sdk">
  ### Configurer la trousse de d√©veloppement logiciel (SDK)
</div>

Pour commencer, cr√©ons un fichier `.env` √† la racine du r√©pertoire de votre projet pour y stocker la configuration de notre application d‚Äôexemple et y d√©finir les variables d‚Äôenvironnement‚ÄØ:

export const codeExample = `# L‚ÄôURL du domaine Auth0 de notre locataire.
# Si nous utilisons un domaine personnalis√©, veillons √† lui attribuer plut√¥t cette valeur.
AUTH0_DOMAIN='https://{yourDomain}'

# L‚ÄôID client de notre Application Auth0.
AUTH0_CLIENT_ID='{yourClientId}'

# Le Secret client de notre Application Auth0.
AUTH0_CLIENT_SECRET='{yourClientSecret}'

# L‚Äôidentifiant de notre API Auth0.
AUTH0_AUDIENCE='YOUR_API_IDENTIFIER'`;

<AuthCodeBlock children={codeExample} language="env" />

Puisque PHP ne peut pas lire directement notre fichier `.env`, nous allons installer une biblioth√®que pour nous aider. M√™me si nous utilisons une biblioth√®que particuli√®re pour les besoins de notre application d‚Äôexemple, n‚Äôimporte quel chargeur ¬´ dotenv ¬ª de votre choix fonctionnera dans une application r√©elle. Depuis le r√©pertoire de notre projet, ex√©cutez la commande shell suivante pour installer la biblioth√®que¬†:

```bash lines
composer require vlucas/phpdotenv
```

Ensuite, cr√©ons le fichier source PHP que nous utiliserons pour ces exemples de code, `index.php`, et configurons une instance de la trousse de d√©veloppement logiciel (SDK) PHP Auth0 pour notre application d&#39;exemple¬†:

```php lines
<?php

// Importer le chargeur automatique Composer pour rendre les classes du SDK accessibles :
require 'vendor/autoload.php';

// Charger nos variables d'environnement √† partir du fichier .env :
(Dotenv\Dotenv::createImmutable(__DIR__))->load();

// Maintenant, instancier la classe Auth0 avec notre configuration :
$auth0 = new \Auth0\SDK\Auth0([
    'strategy' => \Auth0\SDK\Configuration\SdkConfiguration::STRATEGY_API,
    'domain' => $_ENV['AUTH0_DOMAIN'],
    'clientId' => $_ENV['AUTH0_CLIENT_ID'],
    'clientSecret' => $_ENV['AUTH0_CLIENT_SECRET'],
    'audience' => ($_ENV['AUTH0_AUDIENCE'] ?? null) !== null ? [trim($_ENV['AUTH0_AUDIENCE'])] : null,
]);
```

<div id="authenticating-the-user">
  ### Authentifier l&#39;utilisateur
</div>

Pour cette application d&#39;exemple, nous nous concentrons sur l&#39;[autorisation](https://auth0.com/intro-to-iam/authentication-vs-authorization/). Il existe de nombreuses fa√ßons d&#39;authentifier vos utilisateurs avant qu&#39;ils n&#39;atteignent votre API backend pour l&#39;autorisation, par exemple en utilisant la [biblioth√®que SPA.js d&#39;Auth0](https://github.com/auth0/auth0-spa-js). Cette approche est d√©montr√©e dans [cette application de D√©marrage rapide et son projet Github associ√©](https://github.com/auth0-samples/auth0-php-api-samples/). Quelle que soit l&#39;approche que vous adoptez, cette application d&#39;exemple s&#39;attend √† ce que vous lui transmettiez votre jeton d&#39;acc√®s au moyen d&#39;un param√®tre de requ√™te ou d&#39;un en-t√™te pour fonctionner.

<div id="authorizing-an-access-token">
  ### Autoriser un jeton d‚Äôacc√®s
</div>

Tout d&#39;abord, nous devons extraire le JSON Web Token (JWT) de la requ√™te HTTP entrante. Nous allons rechercher un param√®tre `?token` dans une requ√™te GET ou un en-t√™te `HTTP_AUTHORIZATION` ou `Authorization`.

```php lines
// üëÜ Nous poursuivons √† partir des √©tapes ci-dessus. Ajoutez ce code √† votre fichier index.php.

$jwt = $_GET['token'] ?? $_SERVER['HTTP_AUTHORIZATION'] ?? $_SERVER['Authorization'] ?? null;
```

Ensuite, d√©codons le jeton, s‚Äôil y en a un¬†:

```php lines
// üëÜ We're continuing from the steps above. Append this to your index.php file.

// If a token is present, process it.
if ($jwt !== null) {
    // Trim whitespace from token string.
    $jwt = trim($jwt);

    // Remove the 'Bearer ' prefix, if present, in the event we're getting an Authorization header that's using it.
    if (substr($jwt, 0, 7) === 'Bearer ') {
        $jwt = substr($jwt, 7);
    }

    // Attempt to decode the token:
    try {
        $token = $auth0->decode($jwt, null, null, null, null, null, null, \Auth0\SDK\Token::TYPE_TOKEN);
        define('ENDPOINT_AUTHORIZED', true);
    } catch (\Auth0\SDK\Exception\InvalidTokenException $exception) {
        // Le jeton n'√©tait pas valide. Affichons le message d'erreur du SDK Auth0.
        // Nous voudrions probablement afficher une erreur personnalis√©e ici pour une application r√©elle.
        die($exception->getMessage());
    }
}
```

Selon la fa√ßon dont vous configurez le routage de votre API, la mani√®re pr√©cise d‚Äôint√©grer ces v√©rifications peut l√©g√®rement varier, mais le principe reste le m√™me : v√©rifier le jeton et, si votre point de terminaison d‚ÄôAPI exige une autorisation, refuser l‚Äôacc√®s si le jeton n‚Äôest pas valide ou acceptable :

```php lines
// üëÜ Nous poursuivons √† partir des √©tapes ci-dessus. Ajoutez ceci √† votre fichier index.php.

// Is the request authorized?
if (defined('ENDPOINT_AUTHORIZED')) {
    // Respond with a JSON response:
    echo json_encode([
        'authorized' => true,
        'data' => $token->toArray()
    ], JSON_PRETTY_PRINT);

    exit;
}

// Issue a HTTP 401 Unauthorized status:
http_response_code(401);

// Respond with a JSON response:
echo json_encode([
    'authorized' => false,
    'error' => [
        'message' => 'You are NOT authorized to be here!'
    ]
], JSON_PRETTY_PRINT);
```

<div id="caching">
  ### Mise en cache
</div>

Cette approche fonctionne, mais dans une application concr√®te, nous voudrons utiliser la mise en cache pour nous assurer de ne pas atteindre les limites de d√©bit (rate limits) d‚ÄôAuth0 ni de ralentir notre application avec des requ√™tes r√©seau inutiles. La Trousse de d√©veloppement logiciel (SDK) PHP Auth0 prend en charge une interface de mise en cache appel√©e [PSR-6](https://www.php-fig.org/psr/psr-6), √† laquelle vous pouvez raccorder [n‚Äôimporte quelle biblioth√®que de mise en cache compatible](https://packagist.org/providers/psr/cache-implementation), ce qui permet au SDK de bien s‚Äôint√©grer √† votre architecture.

Pour notre exemple, utilisons la biblioth√®que [composant de mise en cache Symfony](https://symfony.com/doc/current/components/cache.html). √Ä partir du r√©pertoire racine de notre projet, ex√©cutez la commande shell suivante :

```bash lines
composer require symfony/cache
```

Ensuite, nous devons mettre √† jour notre SdkConfiguration pour indiquer au SDK de l‚Äôutiliser :

```php lines
// ‚úã Ins√©rez ceci AVANT la gestion des jetons que nous avons ajout√©e √† l'√©tape pr√©c√©dente, afin que le SDK utilise le cache.

$tokenCache = new \Symfony\Component\Cache\Adapter\FilesystemAdapter();
$auth0->configuration()->setTokenCache($tokenCache);
```

Notre application d&#39;exemple va maintenant mettre en cache nos requ√™tes r√©seau li√©es au jeton.

<Info>
  ##### Que pouvez-vous faire ensuite?

  <table>
    <tr>
      <td><a href="/docs/fr-CA/authenticate/identity-providers">Configurer d&#39;autres fournisseurs d&#39;identit√©</a></td>
      <td><a href="/docs/fr-CA/secure/multi-factor-authentication">Activer l&#39;authentification multifacteur</a></td>
    </tr>

    <tr>
      <td><a href="/docs/fr-CA/secure/attack-protection">En savoir plus sur la protection contre les attaques</a></td>
      <td><a href="/docs/fr-CA/customize/rules">En savoir plus sur Rules</a></td>
    </tr>
  </table>

  [Modifier sur GitHub](https://github.com/auth0/docs/edit/master/articles/quickstart/backend/aspnet-core-webapi/01-authorization.md)
</Info>

***
