---
title: "API Laravel"
permalink: "01-authorization"
---

<div id="by-evan-sims">
  ##### Par Evan Sims
</div>

La trousse de développement logiciel (SDK) Laravel d&#39;Auth0 vous permet d’ajouter rapidement une autorisation basée sur des jetons et un contrôle d’accès aux routes à votre application Laravel. Ce guide explique comment intégrer Auth0 à une application Laravel 9 ou 10, nouvelle ou existante. Nous vous recommandons de vous connecter pour suivre ce Démarrage rapide avec des exemples configurés pour votre compte.

{/* <Card title="Voir sur GitHub" href="https://github.com/auth0-samples/laravel/tree/7.x/sample" icon="github">
  Configuration système requise : Laravel 9 / 10 | PHP 8.0+ | Composer
  </Card> */}

**Les applications backend diffèrent des applications web traditionnelles en ce qu’elles ne gèrent pas l’authentification des utilisateurs et n’ont pas d’interface utilisateur. Elles fournissent une API avec laquelle d’autres applications peuvent interagir. Elles acceptent des [jetons d’accès](https://auth0.com/docs/secure/tokens/access-tokens) à partir des en-têtes `Authorization` des requêtes pour contrôler l’accès aux routes.**

Des applications front-end distinctes sont habituellement créées pour interagir avec ce type de backend. Il peut s’agir, par exemple, d’[applications monopage](https://auth0.com/docs/quickstart/spa) ou d’[applications natives ou mobiles](https://auth0.com/docs/quickstart/native) (pour lesquelles Auth0 fournit aussi des SDK !)

Lorsque les utilisateurs doivent interagir avec votre application backend, ils s’authentifient d’abord auprès d’Auth0 au moyen de l’application front-end. L’application front-end récupère ensuite un jeton d’accès auprès d’Auth0, qu’elle peut utiliser pour envoyer des requêtes à votre application backend au nom de l’utilisateur.

Comme leur nom l’indique, les [jetons d’accès](https://auth0.com/docs/secure/tokens/access-tokens) sont conçus pour traiter les questions de contrôle d’accès (autorisation) et ne contiennent pas d’information sur l’utilisateur. **Les applications backend fonctionnent exclusivement avec des jetons d’accès.** Vous pouvez récupérer de l’information sur l’utilisateur qui a créé le jeton au moyen de la [Management API](https://auth0.com/docs/api/management/v2), ce que nous verrons plus loin.


<div id="laravel-installation">
  ## Installation de Laravel
</div>

**Si vous n&#39;avez pas encore de Application Laravel configurée**, ouvrez un terminal dans un répertoire approprié pour un nouveau projet et exécutez la commande suivante :

```bash lines
composer create-project --prefer-dist laravel/laravel auth0-laravel-api ^9.0
```

Toutes les commandes de ce guide partent du principe que vous les exécutez à partir de la racine de votre projet Laravel. Vous devez donc vous placer dans le nouveau répertoire du projet avec la commande `cd` :

```bash lines
cd auth0-laravel-api
```


<div id="sdk-installation">
  ## Installation de la trousse de développement logiciel (SDK)
</div>

Exécutez la commande suivante dans le répertoire de votre projet pour installer le [Auth0 Laravel SDK](https://github.com/auth0/laravel-auth0) :

```bash lines
composer require auth0/login:^7.8 --update-with-all-dependencies
```

Générez ensuite un fichier de configuration pour la trousse de développement logiciel (SDK) de votre application :

```bash lines
php artisan vendor:publish --tag auth0
```


<div id="sdk-configuration">
  ## Configuration de la trousse de développement logiciel (SDK)
</div>

Exécutez la commande suivante dans le répertoire de votre projet pour télécharger l’interface de ligne de commande Auth0 ([Auth0 CLI](https://github.com/auth0/auth0-cli)) :

```bash lines
curl -sSfL https://raw.githubusercontent.com/auth0/auth0-cli/main/install.sh | sh -s -- -b .
```

Authentifiez ensuite le CLI auprès de votre compte Auth0 et choisissez &quot;en tant qu’utilisateur&quot; lorsque vous y êtes invité.

```bash lines
./auth0 login
```

Ensuite, créez une nouvelle Application dans Auth0 :

```bash lines
./auth0 apps create \
  --name "My Laravel Backend" \
  --type "regular" \
  --auth-method "post" \
  --callbacks "http://localhost:8000/callback" \
  --logout-urls "http://localhost:8000" \
  --reveal-secrets \
  --no-input \
  --json > .auth0.app.json
```

Vous devez également créer une nouvelle API :

```bash lines
./auth0 apis create \
  --name "Mon API Backend Laravel" \
  --identifier "https://github.com/auth0/laravel-auth0" \
  --offline-access \
  --no-input \
  --json > .auth0.api.json
```

Cela produit deux fichiers dans le répertoire de votre projet qui configurent la trousse de développement logiciel (SDK).

Comme ces fichiers contiennent des informations d’identification, il est important de les traiter comme des données sensibles. Assurez-vous de ne pas les valider dans votre système de contrôle de version. Si vous utilisez Git, vous devez les ajouter à votre fichier `.gitignore` :

```bash lines
echo ".auth0.*.json" >> .gitignore
```


<div id="access-control">
  ## Contrôle d&#39;accès
</div>

Vous pouvez utiliser le guard d’autorisation de la Trousse de développement logiciel (SDK) Auth0 pour restreindre l’accès aux routes de votre application.

Pour rejeter les requêtes qui ne contiennent pas de jeton d’accès valide dans l’en-tête `Authorization`, vous pouvez utiliser le middleware `auth` de Laravel :

```php lines
Route::get('/private', function () {
  return response()->json([
    'message' => 'Your token is valid; you are authorized.',
  ]);
})->middleware('auth');
```

Vous pouvez également exiger que le jeton fourni contienne des [autorisations](https://auth0.com/docs/manage-users/access-control/rbac) spécifiques en le combinant avec le middleware `can` de Laravel :

```php lines
Route::get('/scope', function () {
    return response()->json([
      'message' => 'Your token is valid and has the `read:messages` permission; you are authorized.',
    ]);
})->middleware('auth')->can('read:messages');
```


<div id="token-information">
  ## Informations sur le jeton
</div>

Les informations sur le jeton d’accès fourni sont disponibles via la façade `Auth` de Laravel ou la fonction utilitaire `auth()`.

Par exemple, pour obtenir l’identifiant et l’adresse de courriel de l’utilisateur :

```php lines
Route::get('/', function () {
  if (! auth()->check()) {
    return response()->json([
      'message' => 'You did not provide a valid token.',
    ]);
  }

  return response()->json([
    'message' => 'Your token is valid; you are authorized.',
    'id' => auth()->id(),
    'token' => auth()?->user()?->getAttributes(),
  ]);
});
```


<div id="retrieve-user-information">
  ## Récupérer les informations de l’utilisateur
</div>

Vous pouvez récupérer des informations sur l’utilisateur qui a créé le jeton d’accès à partir d’Auth0 en utilisant la [Auth0 Management API](https://github.com/auth0/laravel-auth0/blob/main/docs/Management.md). La trousse de développement logiciel (SDK) fournit une enveloppe pratique pour cette API, accessible via la méthode `management()` de la trousse.

**Avant d’effectuer des appels à la Management API, vous devez permettre à votre application de communiquer avec la Management API.** Vous pouvez le faire à partir de la [page API de l’Auth0 Dashboard](https://manage.auth0.com/#/apis/), en choisissant `Auth0 Management API`, puis en sélectionnant l’onglet « Machine to Machine Applications ». Autorisez votre application Laravel, puis cliquez sur la flèche vers le bas pour choisir les scopes que vous souhaitez accorder.

Pour l’exemple suivant, vous devez accorder le scope `read:users`. Vous trouverez une liste des points de terminaison de l’API et des scopes requis dans [la documentation de la Management API](https://auth0.com/docs/api/management/v2).

```php lines
use Auth0\Laravel\Facade\Auth0;

Route::get('/me', function () {
  $user = auth()->id();
  $profile = cache()->get($user);

  if (null === $profile) {
    $endpoint = Auth0::management()->users();
    $profile = $endpoint->get($user);
    $profile = Auth0::json($profile);

    cache()->put($user, $profile, 120);
  }

  $name = $profile['name'] ?? 'Inconnu';
  $email = $profile['email'] ?? 'Inconnu';

  return response()->json([
    'name' => $name,
    'email' => $email,
  ]);
})->middleware('auth');
```

<Info>
  **Il est préférable de mettre en cache les informations sur l’utilisateur dans votre application pour de courtes périodes.** Cela réduit le nombre de requêtes que votre application envoie à Auth0 et améliore les performances. Vous devriez éviter de conserver les informations sur l’utilisateur dans votre application sur de longues périodes, car cela peut entraîner des données périmées. Vous devriez également éviter d’enregistrer des informations sur l’utilisateur, au-delà de son identifiant, dans des bases de données persistantes.
</Info>


<div id="run-the-application">
  ## Exécuter l’application
</div>

Vous êtes maintenant prêt à démarrer votre application Laravel afin qu’elle puisse recevoir des requêtes :

```bash lines
php artisan serve
```


<div id="retrieve-a-test-token">
  ## Récupérer un jeton de test
</div>

Vous pouvez en apprendre davantage sur [la récupération de jetons d’accès ici](https://auth0.com/docs/secure/tokens/access-tokens/get-access-tokens). Pour ce démarrage rapide, toutefois, vous pouvez simplement utiliser un jeton d’accès à partir de [la vue « test » des paramètres de votre API](https://manage.auth0.com/#/apis).

<Info>
La route `/me` que nous avons créée plus haut ne fonctionnera pas avec un jeton de test, puisqu’aucun utilisateur réel n’y est associé.
</Info>

<div id="checkpoint">
  ## Point de contrôle
</div>

Ouvrez un terminal et essayez d’envoyer des requêtes à votre application.

Commencez par appeler la route publique :

```bash lines
curl --request GET \
  --url http://localhost:8000/api \
  --header 'Accept: application/json'
```

Ensuite, utilisez votre jeton d’accès dans l’en-tête `Authorization` pour appeler une route protégée :

```bash lines
curl --request GET \
  --url http://localhost:8000/api/private \
  --header 'Accept: application/json' \
  --header 'Authorization: Bearer YOUR_ACCESS_TOKEN'
```

Enfin, tentez d’appeler la route protégée par une portée, ce qui ne réussira que si le jeton d’accès s’est vu accorder la portée `read:messages` :

```bash lines
curl --request GET \
  --url http://localhost:8000/api/scope \
  --header 'Accept: application/json' \
  --header 'Authorization: Bearer YOUR_ACCESS_TOKEN'
```

Si vous rencontrez des problèmes, voici quelques pistes à essayer :

* Essayez d’exécuter `php artisan optimize:clear` pour vider le cache de Laravel.
* Assurez-vous que vos fichiers `.auth0.app.json` et `.auth0.api.json` se trouvent à la racine de votre projet.
* Assurez-vous que votre application Laravel est activée en tant qu’application Machine-to-Machine et qu’elle possède tous les scopes nécessaires pour Auth0 Management API à partir du [Auth0 Dashboard](https://manage.auth0.com/#/apis/).

Vous rencontrez des problèmes ? Consultez la [documentation](https://github.com/auth0/laravel-auth0) du SDK ou notre [centre de documentation](https://auth0.com/docs). Vous pouvez également visiter [la communauté](https://community.auth0.com) où notre équipe et d’autres membres de la communauté peuvent vous aider à répondre à vos questions.


<div id="additional-reading">
  ### Lectures supplémentaires
</div>

* [Référentiels et modèles d’utilisateurs](https://github.com/auth0/laravel-auth0/blob/main/docs/Users.md) explique comment étendre Auth0 Laravel SDK pour utiliser des modèles d’utilisateur personnalisés, ainsi que comment stocker et récupérer des utilisateurs à partir d’une base de données.
* [Gestion des événements](https://github.com/auth0/laravel-auth0/blob/main/docs/Events.md) décrit comment écouter les événements déclenchés par Auth0 Laravel SDK afin de personnaliser entièrement le comportement de votre intégration.
* La prise en charge de [Management API](https://github.com/auth0/laravel-auth0/blob/main/docs/Management.md) est intégrée à Auth0 Laravel SDK, ce qui vous permet d’interagir avec Management API à partir de votre application Laravel.

[Modifier sur GitHub](https://github.com/auth0/docs/edit/master/articles/quickstart/backend/laravel/01-authorization.md)