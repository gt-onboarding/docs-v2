---
description: Migrez votre Connexion de fédération SAML existante d’un ancien domaine personnalisé Auth0 vers un nouveau domaine, afin de permettre à vos tenants de tirer parti des fonctionnalités Multiple Custom Domains (MCD).
'og:image': https://cdn2.auth0.com/docs/1.14553.0/img/share-image.png
'og:title': Migration SAML pour Multiple Custom Domains (MCD) en accès anticipé
'og:url': https://auth0.com/docs/
permalink: saml-migration
title: Migration SAML pour les domaines personnalisés
'twitter:description': Migrez votre Connexion de fédération SAML existante d’un ancien domaine personnalisé Auth0 vers un nouveau domaine, afin de permettre à vos tenants de tirer parti des fonctionnalités Multiple Custom Domains (MCD).
'twitter:title': Migration SAML pour les domaines personnalisés
---

import {AuthCodeBlock} from "/snippets/fr-CA/AuthCodeBlock.jsx";

import {AuthCodeGroup} from "/snippets/fr-CA/AuthCodeGroup.jsx";

<Warning>
  La fonctionnalité Multiple Custom Domains est actuellement offerte en accès anticipé (Early Access). Pour l’utiliser, vous devez avoir un forfait Enterprise. En utilisant cette fonctionnalité, vous acceptez les modalités d’essai gratuit applicables prévues dans la [Convention d’abonnement principal](https://www.okta.com/legal) d’Okta. Pour en savoir plus sur le cycle de publication des produits Auth0, consultez la page [Étapes de publication des produits](https://auth0.com/docs/troubleshoot/product-lifecycle/product-release-stages).
</Warning>

Migrez votre connexion de fédération SAML existante d’un ancien domaine personnalisé Auth0 hérité vers un nouveau domaine personnalisé, afin de permettre à vos tenants de tirer parti des fonctionnalités de Multiple Custom Domains (MCD).

Les fournisseurs d’identité (IdP) externes sont souvent codés en dur pour utiliser votre ancien domaine, ce qui vous oblige à déployer un proxy inverse intelligent qui intercepte la réponse SAML envoyée à votre ancien domaine et la redirige de façon sécurisée vers un nouveau domaine personnalisé.

Cela garantit une migration transparente pour les utilisateurs fédérés et vous permet d’utiliser immédiatement votre nouveau domaine sans attendre les mises à jour de configuration obligatoires de votre IdP.


<div id="prerequisites">
  ## Prérequis
</div>

Ce processus nécessite une configuration à l’aide de Terraform pour mettre en place les composants Auth0, ainsi que le déploiement d’un Cloudflare Worker pour la logique de proxy.

Avant de commencer la migration, passez en revue les exigences ci-dessous :

* Un tenant avec un forfait Enterprise et MCD activé.
* Deux domaines personnalisés vérifiés configurés dans votre tenant Auth0 :
    1.  **Ancien domaine (hérité)** (pour le proxy)
    2.  **Nouveau domaine cible** (pour l’application)
* Terraform CLI et `Node.js/npm` installés.
* Un compte Cloudflare avec accès au domaine qui héberge vos domaines personnalisés.

<div id="how-it-works">
  ## Fonctionnement
</div>

Cette stratégie de migration utilise un proxy inverse intelligent pour établir une passerelle entre votre ancien domaine personnalisé et votre nouveau Domaine. Ce proxy est déployé sur l'ancien Domaine afin d'intercepter la réponse d'authentification SAML envoyée par votre fournisseur d'identité (IdP) externe. 

Cela est nécessaire, car la configuration de l'IdP est figée pour le point de terminaison de votre ancien Domaine. Le proxy modifie les champs de contrôle de la charge utile SAML (comme `Destination` et `Recipient`) afin de refléter avec exactitude le nouveau Domaine personnalisé. 

Enfin, le proxy transmet cette charge utile corrigée au point de terminaison de connexion du nouveau Domaine. Cela permet un basculement vers votre nouveau Domaine sans interruption de service et sans nécessiter de changements de configuration manuels de la part de vos partenaires IdP.

<div id="setup-and-configuration">
  ## Configuration et installation
</div>

Pour configurer et préparer votre migration :

1. Clonez le dépôt de migration :

```bash
git clone <repository-url>
cd auth0-mcd-federation-migration
```

2. Installez les dépendances :

```bash
npm install
```

3. Créez un fichier `terraform.auto.tfvars` dans votre répertoire `tf` avec les identifiants requis et les renseignements sur le domaine :

```bash
# Auth0 Service Provider (SP) variables
auth0_domain = "your-sp-tenant.auth0.com"
auth0_existing_custom_domain = "oldfed.example.com"
auth0_new_custom_domain = "id.example2.com"
auth0_tf_client_id = "your-sp-client-id"
auth0_tf_client_secret = "your-sp-client-secret"

# Variables du fournisseur d'identité (IdP) Auth0
auth0_idp_domain = "your-idp-tenant.auth0.com"
auth0_idp_tf_client_id = "your-idp-client-id"
auth0_idp_tf_client_secret = "your-idp-client-secret"

# Cloudflare variables
cloudflare_api_key = "your-cloudflare-api-key"
cloudflare_email = "your-cloudflare-email"
cloudflare_zone_id = "your-cloudflare-zone-id"
```

4. Initialisez et appliquez la configuration Terraform :

```bash
cd tf
terraform init
terraform apply
```

Cela crée l’Application et la connexion SAML nécessaires, configure le DNS via Cloudflare et prépare les variables d’environnement nécessaires au worker.


<div id="deploy-the-cloudflare-worker">
  ### Déployer le worker Cloudflare
</div>

Ce proxy gère l’interception de la réponse SAML et la logique de redirection. Pour le déployer :

1. Déployez le proxy Cloudflare :

```bash
cd ..
npx wrangler deploy
```

2. Le worker reçoit automatiquement les variables d&#39;environnement nécessaires (comme `AUTH0_EDGE_LOCATION` et `NEW_SP_DOMAIN`) à partir des sorties Terraform.


<div id="temporarily-update-saml-connection-parameters">
  ### Mettre à jour temporairement les paramètres de la connexion SAML
</div>

Votre ancien domaine reçoit la réponse SAML avant qu’elle ne soit renvoyée vers le nouveau domaine. Par conséquent, les paramètres de validation attendus de la Connexion SAML doivent temporairement pointer vers l’URL de rappel de l’ancien domaine pour éviter les erreurs d’incohérence.

1.  Obtenez un jeton d’accès pour la Management API de votre tenant fournisseur de services, avec les scopes `read:connections` et `update:connections` :

    ```bash
    cd bin/
    export access_token='<your-sp-management-api-token>'
    ```

2.  Mettez à jour l’URL de destination :

    ```bash
    ./sp-set-destination-url.sh -i <saml-connection-id> -d [https://oldfed.example.com/login/callback](https://oldfed.example.com/login/callback)
    ```

3.  Mettez à jour l’URL du destinataire :

    ```bash
    ./sp-set-recipient-url.sh -i <saml-connection-id> -r [https://oldfed.example.com/login/callback](https://oldfed.example.com/login/callback)
    ```