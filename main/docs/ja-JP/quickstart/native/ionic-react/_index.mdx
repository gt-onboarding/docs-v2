---
title: Capacitor を使用する Ionic React アプリにログイン機能を追加する
sidebarTitle: Ionic & Capacitor（React）

---

import { Recipe, Content, Section, SideMenu, SideMenuSectionItem, SignUpForm } from "/snippets/ja-JP/recipe.jsx";
import { LoggedInForm } from "/snippets/ja-JP/Login.jsx";
import Index from "/snippets/ja-JP/quickstart/native/ionic-react/index.tsx.mdx";
import Loginbutton from "/snippets/ja-JP/quickstart/native/ionic-react/login-button.tsx.mdx";
import Logoutbutton from "/snippets/ja-JP/quickstart/native/ionic-react/logout-button.tsx.mdx";
import App from "/snippets/ja-JP/quickstart/native/ionic-react/app.tsx.mdx";
import Userprofile from "/snippets/ja-JP/quickstart/native/ionic-react/user-profile.tsx.mdx";

import {AuthCodeGroup} from "/snippets/ja-JP/AuthCodeGroup.jsx";

export const sections = [
  { id: "getting-started", title: "はじめに" },
  { id: "configure-auth0", title: "Auth0 を設定する" },
  { id: "install-the-auth0-react-sdk", title: "Auth0 React ソフトウェア開発キット (SDK) をインストールする" },
  { id: "configure-the-auth0provider-component", title: "Auth0Provider コンポーネントを構成する" },
  { id: "add-login-to-your-application", title: "アプリケーションにログイン機能を追加する" },
  { id: "handle-the-login-callback", title: "ログインコールバックを処理する" },
  { id: "add-logout-to-your-application", title: "アプリケーションにログアウト機能を追加する" },
  { id: "show-the-user-profile", title: "ユーザー プロファイルを表示する" }
]

<Recipe isSingleColumn>
  <Content>
    Auth0を使用すると、アプリケーションに認証を素早く追加し、ユーザープロファイル情報へのアクセスを取得できます。
    このガイドでは、[Auth0 React ソフトウェア開発キット (SDK)](https://github.com/auth0/auth0-react)を使用して、Auth0をIonic (React) &amp; Capacitorアプリケーションに統合する方法を説明します。

    <Section id={sections[0].id} title={sections[0].title} stepNumber="1" isSingleColumn>
      このクイックスタートでは、[Capacitor](https://capacitorjs.com/) を使用した [Ionic](https://ionicframework.com/) アプリケーションがすでに動作していることを前提としています。まだそのような環境がない場合は、シンプルなアプリを作成して始めるために [Using Capacitor with Ionic Framework ガイド](https://capacitorjs.com/docs/getting-started/with-ionic) を参照するか、[サンプルアプリ](https://github.com/auth0-samples/auth0-ionic-samples) をクローンしてください。

      [Capacitor development workflow](https://capacitorjs.com/docs/basics/workflow) にもあらかじめ慣れておいてください。

      <LoggedInForm />
    </Section>

    <Section id={sections[1].id} title={sections[1].title} stepNumber="2" isSingleColumn>
      Auth0 のサービスを利用するには、Auth0 Dashboard でアプリケーションをセットアップする必要があります。Auth0 アプリケーションは、
      プロジェクトで認証をどのように動作させるかを設定する場所です。

      <Info>
        本記事を通して、`YOUR_PACKAGE_ID` はアプリケーションのパッケージ ID を表します。これは
        `capacitor.config.ts` ファイル内の `appId` フィールドで確認および設定できます。詳細は
        [Capacitor の Config schema](https://capacitorjs.com/docs/config#schema) を参照してください。
      </Info>

      ### アプリケーションを設定する

      インタラクティブ セレクターを使用して新しい Auth0 アプリケーションを作成するか、統合したいプロジェクトを表す既存のアプリケーションを選択します。
      Auth0 内の各アプリケーションには英数字で構成された一意のクライアント ID が割り当てられ、
      アプリケーションのコードはこのクライアント ID を使用してソフトウェア開発キット (SDK) 経由で Auth0 API を呼び出します。

      このクイックスタートで設定した内容はすべて、[Dashboard](https://manage.auth0.com/#/) 上の該当アプリケーションに自動的に反映されます。今後は
      ここからアプリケーションを管理できます。

      完全な設定例を確認したい場合は、代わりにサンプルアプリケーションを参照できます。

      ### コールバック URL を設定する

      コールバック URL は、ユーザーが認証を完了した後に Auth0 からリダイレクトさせたい
      アプリケーション内の URL です。設定しない場合、ユーザーはログイン後にアプリケーションへ戻ることができません。

      <Info>
        サンプルプロジェクトに沿って進めている場合は、次のように設定してください:

        `YOUR_PACKAGE_ID://{yourTenant}.auth0.com/capacitor/YOUR_PACKAGE_ID/callback`
      </Info>

      ### ログアウト URL を設定する

      ログアウト URL は、ユーザーがログアウトした後に Auth0 からリダイレクトさせたい
      アプリケーション内の URL です。設定しない場合、ユーザーはアプリケーションからログアウトできず、エラーが返されます。

      <Info>
        サンプルプロジェクトに沿って進めている場合は、次のように設定してください:

        `YOUR_PACKAGE_ID://{yourTenant}.auth0.com/capacitor/YOUR_PACKAGE_ID/callback`.
      </Info>

      ### 許可されたオリジンを設定する

      ネイティブアプリケーションから Auth0 へリクエストを送信できるようにするには、
      [Application Settings](https://manage.auth0.com/dashboard/#/applications/\{yourClientId}/settings) で次の **Allowed Origins** を設定します。

      <Info>
        サンプルプロジェクトに沿って進めている場合は、iOS と Android それぞれに対して
        `capacitor://localhost, http://localhost` を設定してください。
      </Info>

      最後に、[Application Settings](https://manage.auth0.com/dashboard/#/applications/\{yourClientId}/settings) で、アプリケーションの **Application Type** が **Native** に設定されていることを確認してください。

      <LoggedInForm />
    </Section>

    <Section id={sections[2].id} title={sections[2].title} stepNumber="3" isSingleColumn>
      プロジェクト ディレクトリで次のコマンドを実行し、Auth0 React ソフトウェア開発キット (SDK) をインストールします。

      ```bash
      npm install @auth0/auth0-react
      ```

      このソフトウェア開発キット (SDK) は、[React Hooks](https://reactjs.org/docs/hooks-overview.html) や [高階コンポーネント](https://reactjs.org/docs/higher-order-components.html) を使って、React の流儀に沿って React アプリケーションに Auth0 を統合できるようにするメソッドや変数を提供します。

      ### Capacitor プラグインをインストールする

      このクイックスタートとサンプルでは、いくつかの Capacitor の公式プラグインを使用します。次のコマンドを使って、これらをアプリにインストールします。

      ```bash
      npm install @capacitor/browser @capacitor/app
      ```

      * [@capacitor/browser](https://capacitorjs.com/docs/apis/browser): デバイスのシステムブラウザーと連携し、Auth0 の認可エンドポイントの URL を開くために使用します。
      * [@capacitor/app](https://capacitorjs.com/docs/apis/app): アプリの高レベルのイベントをサブスクライブでき、Auth0 からのコールバックを処理するのに便利です。

      <Info>
        iOS 上の Capacitor の Browser プラグインは [SFSafariViewController](https://developer.apple.com/documentation/safariservices/sfsafariviewcontroller) を使用しますが、iOS 11 以降では、デバイス上の Safari と Cookie を共有しません。これは、これらのデバイスでは SSO が機能しないことを意味します。SSO が必要な場合は、代わりに [ASWebAuthenticationSession](https://developer.apple.com/documentation/authenticationservices/aswebauthenticationsession) を使用する互換性のあるプラグインを利用してください。
      </Info>

      <LoggedInForm />
    </Section>

    <Section id={sections[3].id} title={sections[3].title} stepNumber="4" isSingleColumn>
      内部的には、Auth0 React SDK は [React Context](https://reactjs.org/docs/context.html) を使用してユーザーの認証 state を管理します。React アプリに Auth0 を統合する方法の 1 つは、SDK からインポートできる `Auth0Provider` でルートコンポーネントをラップすることです。

      `Auth0Provider` コンポーネントは、次の props を受け取ります。

      * `domain`: Auth0 Dashboard で作成したアプリケーションの **Settings** にある `domain` の値、または Auth0 の Custom Domains 機能を使用している場合はカスタムドメイン。
      * `clientId`: Auth0 Dashboard で作成したアプリケーションの **Settings** にある Client ID の値。
      * `useRefreshTokens`: Android および iOS 上の Ionic と auth0-react を併用するには、リフレッシュトークンを有効にする必要があります。
      * `useRefreshTokensFallback`: Android および iOS 上の Ionic と auth0-react を併用するには、iframe フォールバックを無効にする必要があります。
      * `authorizationParams.redirect_uri`: ユーザーが Auth0 で認証した後にリダイレクトしたい URL。

      <Info>
        アプリケーションを閉じて再度開いたあとも認証状態を保持したい場合は、SDK を構成する際に `cacheLocation` を `localstorage` に設定するとよいでしょう。ただし、
        [localstorage にトークンを保存するリスク](/docs/ja-JP/libraries/auth0-single-page-app-sdk#change-storage-options) を必ず理解しておいてください。また、Capacitor アプリでは、特定の状況でデータが予期せず復元される可能性があるため、localstorage は **一時的な** ものとして扱う必要があります。[Capacitor ドキュメントにおけるストレージに関するガイダンス](https://capacitorjs.com/docs/guides/storage#why-cant-i-just-use-localstorage-or-indexeddb) も参照してください。

        さらに、より安全で永続的なストレージメカニズムを使用する必要がある場合、SDK にはトークンを保存するために [カスタムキャッシュ実装を使用する](https://github.com/auth0/auth0-spa-js/blob/master/EXAMPLES.md#creating-a-custom-cache) 機能があります。

        **注意**: トークンの保存に [Capacitor の Storage プラグイン](https://capacitorjs.com/docs/apis/storage) を使用することは **推奨しません**。これは iOS では [UserDefaults](https://developer.apple.com/documentation/foundation/userdefaults)、Android では [SharedPreferences](https://developer.android.com/reference/android/content/SharedPreferences) をバックエンドとして実装しているためです。これらの API を使用して保存されたデータは暗号化されず、安全ではなく、クラウドに同期される可能性もあります。
      </Info>

      <Note>
        ##### チェックポイント

        `App` コンポーネントをラップする形で `Auth0Provider` コンポーネントを追加し、その後アプリケーションを実行して、SDK が正しく初期化されていること、および Auth0 に関連するエラーがアプリケーションで発生していないことを確認してください。
      </Note>

      <AuthCodeGroup>
        <Index />

        <Loginbutton />

        <Logoutbutton />

        <App />

        <Userprofile />
      </AuthCodeGroup>
    </Section>

    <Section id={sections[4].id} title={sections[4].title} stepNumber="5" isSingleColumn>
      Capacitor アプリケーションでは、[Capacitor の Browser プラグイン](https://capacitorjs.com/docs/apis/browser) が Auth0 の [Universal Login Page](https://auth0.com/universal-login) へのリダイレクトを行います。`loginWithRedirect` 関数の `openUrl`
      パラメーターを設定して `Browser.open` を使用し、URL がデバイスのシステムブラウザーコンポーネント（iOS の [SFSafariViewController](https://developer.apple.com/documentation/safariservices/sfsafariviewcontroller)、Android の [Chrome
      Custom Tabs](https://developer.chrome.com/docs/android/custom-tabs)）で開かれるようにします。

      <Info>
        デフォルトでは、ソフトウェア開発キット (SDK) の `loginWithRedirect` メソッドは `window.location.href` を使用して、
        プラットフォームに適したシステムブラウザーコンポーネントではなく、ユーザーのデバイス上のデフォルトのブラウザーアプリケーションで
        ログインページへ遷移します。これにより、ユーザーはいったんアプリケーションを離れて認証することになり、ユーザーエクスペリエンスが最適とは言えない場合があります。
      </Info>

      <Note>
        ##### チェックポイント

        `loginWithRedirect` 関数は、`openUrl` パラメーターを設定して `Browser.open` 関数を使用し、
        プラットフォームのシステムブラウザーコンポーネントでログイン用 URL を開くことで、SDK にログインフローを開始するよう指示します。
        これにより、ユーザーがアプリケーションにログインできるようになります。ユーザーは Auth0 上のログインページにリダイレクトされ、
        エラーは発生しません。
      </Note>

      <AuthCodeGroup>
        <Loginbutton />

        <Index />

        <Logoutbutton />

        <App />

        <Userprofile />
      </AuthCodeGroup>
    </Section>

    <Section id={sections[5].id} title={sections[5].title} stepNumber="6" isSingleColumn>
      ユーザーが Universal Login ページでログインすると、カスタム URL スキーム付きの URL を介してアプリにリダイレクトされます。`appUrlOpen` イベントはアプリ内で処理する必要があります。認証の state を初期化するには、Auth0 のソフトウェア開発キット (SDK) から `handleRedirectCallback` メソッドを呼び出せます。

      このメソッドは、Auth0 からのリダイレクト時にのみ使用できます。成功したことを確認するには、URL に `code` と `state` パラメーターが存在するかを確認してください。

      このイベントが発生したときは、`Browser.close()` メソッドでブラウザーを閉じる必要があります。

      <Info>
        この記事では、コールバックをアプリケーション内で処理するために Custom URL Schemes を使用することを前提としています。これを行うには、選択したプラットフォームで `YOUR_PACKAGE_ID` を URL スキームとして登録してください。詳しくは、iOS の場合は [Defining a Custom URL Scheme](https://developer.apple.com/documentation/xcode/defining-a-custom-url-scheme-for-your-app)、Android の場合は [Create Deep Links to App Content](https://developer.android.com/training/app-links/deep-linking) を参照してください。
      </Info>

      <Note>
        ##### チェックポイント

        `appUrlOpen` をアプリケーションの `App` コンポーネントに追加してログインしてください。ユーザーが認証されてアプリにログインすると、ブラウザーウィンドウが閉じるはずです。
      </Note>

      <AuthCodeGroup>
        <App />

        <Index />

        <Loginbutton />

        <Logoutbutton />

        <Userprofile />
      </AuthCodeGroup>
    </Section>

    <Section id={sections[6].id} title={sections[6].title} stepNumber="7" isSingleColumn>
      ユーザーがログインできるようになったので、次は[ログアウト手段](https://auth0.com/docs/logout/guides/logout-auth0)を設定する必要があります。ブラウザーセッションを消去するには、ユーザーをブラウザーで Auth0 のログアウトエンドポイントにリダイレクトしなければなりません。ここでも、ユーザーがアプリから離れてしまい望ましくないユーザー体験にならないように、Capacitor の Browser プラグインを使ってこのリダイレクトを実行する必要があります。

      Ionic と Capacitor を Auth0 のソフトウェア開発キット (SDK) と組み合わせて使用してこれを実現するには、次のようにします。

      * Auth0 がログアウト後のリダイレクト先として使用する、アプリ向けの URL を構築します。これは、登録済みのカスタムスキームと Auth0 ドメインを使用する URL です。この URL を Auth0 Dashboard の **Allowed Logout URLs** 設定に追加します。
      * `logout` を呼び出して SDK からログアウトし、リダイレクト用の URL を `logoutParams.returnTo` パラメーターとして渡します。
      * `openUrl` パラメーターに、Capacitor の Browser プラグインを使用して `Browser.open` で URL を開くコールバックを設定します。

      <Info>
        ログイン手順と同様に、`logout` を呼び出すときに `openUrl` を設定しない場合、SDK はデバイスのデフォルトブラウザーアプリケーションを使用してログアウト URL にユーザーをリダイレクトしますが、これは望ましくないユーザー体験となります。
      </Info>

      <Note>
        ##### チェックポイント

        ユーザーがアプリケーションからログアウトできる手段を提供してください。まず Auth0 にリダイレクトされ、その後で `returnTo` パラメーターで指定したアドレスにリダイレクトされることを確認してください。アプリケーションにログインしたままになっていないことを確認してください。
      </Note>

      <AuthCodeGroup>
        <Logoutbutton />

        <Index />

        <Loginbutton />

        <App />

        <Userprofile />
      </AuthCodeGroup>
    </Section>

    <Section id={sections[7].id} title={sections[7].title} stepNumber="8" isSingleColumn>
      Auth0 React ソフトウェア開発キット (SDK) は、ログインしているユーザーに関連付けられたプロファイル（名前やプロフィール画像など）を、必要なコンポーネント内から取得してユーザーインターフェイスをパーソナライズできるようにします。プロファイル情報は、`useAuth0()` フックによって公開される `user` プロパティから利用できます。

      SDK の初期化は非同期で行われるため、`isLoading` と `user` プロパティを確認してからユーザープロファイルを扱う必要があります。`isLoading` が `false` で、`user` に値が設定されていれば、ユーザープロファイルを使用できます。

      <Note>
        ##### チェックポイント

        アプリ内でユーザーが自分のユーザープロファイルの詳細を確認できる方法を用意し、ログイン後に画面上で自分のプロファイル情報を取得して表示できることを確認してください。
      </Note>

      <AuthCodeGroup>
        <Userprofile />

        <Index />

        <Loginbutton />

        <Logoutbutton />

        <App />
      </AuthCodeGroup>
    </Section>

    ## 次のステップ

    素晴らしい!ここまで進めたなら、アプリケーションでログイン、ログアウト、およびユーザープロファイル情報が実装されているはずです。

    これでクイックスタートチュートリアルは終了ですが、他にも多くの機能があります。Auth0でできることの詳細については、以下をご確認ください:

    * [Auth0 Dashboard](https://manage.auth0.com/dashboard/us/dev-gja8kxz4ndtex3rq) - Auth0 テナントおよびアプリケーションの設定と管理方法
    * [Auth0 Marketplace](https://marketplace.auth0.com/) - Auth0 の機能を拡張できるインテグレーションを探す
  </Content>
</Recipe>