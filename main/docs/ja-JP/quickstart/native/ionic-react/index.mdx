---
title: "Ionic & Capacitor（React）"
permalink: "01-login"
---

import {AuthCodeBlock} from "/snippets/ja-JP/AuthCodeBlock.jsx";

<div id="by-steve-hobbs">
  ##### Steve Hobbs による作成
</div>

このチュートリアルでは、Auth0 を使用してユーザーログイン機能を Ionic React と Capacitor アプリケーションに追加する方法を説明します。お使いのアカウント向けにサンプルが構成された状態でこのクイックスタートを進められるよう、事前にログインしておくことをお勧めします。

{/* <Card title="GitHub で表示" href="https://github.com/auth0-samples/auth0-ionic-samples/tree/main/react" icon="github">
  システム要件: Node.js & npm (LTS) | Xcode 12 以上 (iOS 用) | Android Studio 4 以上 (Android 用) | React 18
  </Card> */}

<div id="getting-started">
  ## はじめに
</div>

このクイックスタートでは、すでに [Capacitor](https://capacitorjs.com/) を使用して実行中の [Ionic](https://ionicframework.com/) アプリケーションがあることを前提としています。まだ用意していない場合は、シンプルなアプリから始めるには [&quot;Using Capacitor with Ionic Framework&quot; ガイド](https://capacitorjs.com/docs/getting-started/with-ionic) を参照するか、[サンプルアプリ](https://github.com/auth0-samples/auth0-ionic-samples) をクローンしてください。

また、[Capacitor の開発ワークフロー](https://capacitorjs.com/docs/basics/workflow) にも精通している必要があります。

<Info>
  **認証は初めてですか？** [Auth0 の仕組み](/docs/ja-JP/get-started/auth0-overview)、[ネイティブアプリケーションとの統合方法](/docs/ja-JP/get-started/architecture-scenarios/mobile-api)、および使用している[プロトコル](/docs/ja-JP/get-started/authentication-and-authorization-flow/authorization-code-flow-with-pkce)について学んでください。
</Info>

<div id="configure-auth0">
  ## Auth0 を設定する
</div>

<div id="get-your-application-keys">
  ### アプリケーションキーを取得する
</div>

Auth0 にサインアップしたときに、自動的に新しいアプリケーションが作成されているか、または自分で新しいアプリケーションを作成しているはずです。Auth0 と通信するには、そのアプリケーションに関するいくつかの情報が必要です。これらの情報は Auth0 Dashboard の [Application Settings](https://manage.auth0.com/#/applications) セクションから取得できます。

<Frame>![App Dashboard](https://cdn2.auth0.com/docs/1.14550.0/media/articles/dashboard/client_settings.png)</Frame>

<Info>
  Default App をネイティブ アプリケーションまたはシングルページアプリケーションで使用する場合は、**Token Endpoint Authentication Method** を `None` に更新し、**Application Type** を `SPA` または `Native` のいずれかに設定してください。
</Info>

次の情報が必要です。

* **ドメイン**
* **クライアントID**

<Info>
  このページ上部からサンプルをダウンロードした場合、これらの情報はすでに設定されています。
</Info>

<div id="configure-callback-urls">
  ### コールバックURLを設定する
</div>

コールバックURLは、Auth0 がユーザーを認証したあとにリダイレクトする、アプリケーション内のURLです。アプリのコールバックURLは、[Application Settings](https://manage.auth0.com/#/applications) の **Allowed Callback URLs** フィールドに追加する必要があります。このフィールドが設定されていない場合、ユーザーはアプリケーションにログインできず、エラーが発生します。

<Info>
  本記事を通じて、`YOUR_PACKAGE_ID` はアプリケーションのパッケージIDを指します。これは `capacitor.config.ts` ファイル内の `appId` フィールドで確認および設定できます。詳細は [Capacitors Config schema](https://capacitorjs.com/docs/config#schema) を参照してください。
</Info>

Auth0 Dashboard の [Application Settings](https://manage.auth0.com/#/applications/\{yourClientId}/settings) セクションに移動して、**Allowed Callback URLs** ボックスに **Callback URL** を設定します。

**Allowed Callback URL** を次の値に設定します。

```
YOUR_PACKAGE_ID://{yourDomain}/capacitor/YOUR_PACKAGE_ID/callback
```

<div id="configure-logout-urls">
  ### ログアウトURLを設定する
</div>

ログアウトURLは、ユーザーが認可サーバーからログアウトされた後に、Auth0 がアプリケーションにリダイレクトできる、アプリケーション内の URL です。これは `returnTo` クエリパラメーターで指定します。アプリのログアウトURLは、[Application Settings](https://manage.auth0.com/#/applications) の **許可されたログアウトURL** フィールドに追加する必要があります。このフィールドが設定されていない場合、ユーザーはアプリケーションからログアウトできず、エラーが発生します。

**許可されたログアウトURL** を次のように設定する必要があります

```
YOUR_PACKAGE_ID://{yourDomain}/capacitor/YOUR_PACKAGE_ID/callback
```

<div id="configure-origins">
  ### オリジンを構成する
</div>

アプリケーションから Auth0 へリクエストを送信できるようにするには、[Application Settings](https://manage.auth0.com/#/applications/\{yourClientId}/settings) で次の **Allowed Origins** を設定します。

```
capacitor://localhost, http://localhost
```

これらのオリジンは、それぞれ iOS および Android 向けに必要です。

最後に、[Application Settings](https://manage.auth0.com/#/applications/\{yourClientId}/settings) で、このアプリケーションの **Application Type** が **Native** に設定されていることを必ず確認してください。

<div id="install-the-auth0-react-sdk">
  ## Auth0 React ソフトウェア開発キット (SDK) をインストールする
</div>

プロジェクトディレクトリで次のコマンドを実行して、Auth0 React SDK をインストールします。

```bash lines
npm install @auth0/auth0-react
```

このソフトウェア開発キット (SDK) は、[React Hooks](https://react.dev/reference/react/hooks) や [Higher-Order Components](https://reactjs.org/docs/higher-order-components.html) を使用して、Auth0 を React アプリケーションと React の流儀に沿って統合するのに役立つメソッドや変数を提供します。

<div id="install-capacitor-plugins">
  ### Capacitor プラグインをインストールする
</div>

このクイックスタートとサンプルでは、いくつかの Capacitor 公式プラグインを使用します。次のコマンドで、これらをアプリにインストールしてください。

```bash lines
npm install @capacitor/browser @capacitor/app
```

* [`@capacitor/browser`](https://capacitorjs.com/docs/apis/browser) - デバイスのシステムブラウザーと連携でき、Auth0 の認可エンドポイントの URL を開くために使用されます
* [`@capacitor/app`](https://capacitorjs.com/docs/apis/app) - アプリの高レベルなイベントをサブスクライブでき、Auth0 からのコールバックを処理する際に便利です

<Info>
  iOS 上の Capacitor の Browser プラグインは [`SFSafariViewController`](https://developer.apple.com/documentation/safariservices/sfsafariviewcontroller) を使用しますが、iOS 11 以降ではデバイス上の Safari と Cookie を共有しません。これは、該当するデバイスでは [SSO](https://auth0.com/docs/sso) が機能しないことを意味します。SSO が必要な場合は、代わりに [ASWebAuthenticationSession](https://developer.apple.com/documentation/authenticationservices/aswebauthenticationsession) を使用する互換プラグインを利用してください。
</Info>

<div id="configure-the-auth0provider-component">
  ### Auth0Provider コンポーネントを設定する
</div>

内部的には、Auth0 React ソフトウェア開発キット (SDK) は [React Context](https://reactjs.org/docs/context.html) を使用してユーザーの認証 state を管理します。Auth0 を React アプリに統合する方法の 1 つは、SDK からインポートできる `Auth0Provider` でルートコンポーネントをラップすることです。

`src/index.tsx` を開き、`App` コンポーネントを `Auth0Provider` コンポーネントでラップします。

export const codeExample1 = `import React from 'react';
import { createRoot } from 'react-dom/client';
import { Auth0Provider } from '@auth0/auth0-react';
import App from './App';

const root = createRoot(document.getElementById('root'));

root.render(
  <Auth0Provider
    domain="{yourDomain}"
    clientId="{yourClientId}"
    useRefreshTokens={true}
    useRefreshTokensFallback={false}
    authorizationParams={{
      redirect_uri: "YOUR_PACKAGE_ID://{yourDomain}/capacitor/YOUR_PACKAGE_ID/callback"
    }}
  >
    <App />
  </Auth0Provider>
);`;

<AuthCodeBlock children={codeExample1} language="js" />

`Auth0Provider` コンポーネントは、次の props を受け取ります。

* `domain`: Auth0 Dashboard で作成したアプリケーションの「Settings」に表示されている「domain」の値、または Auth0 の [Custom Domains 機能](https://auth0.com/docs/custom-domains)を使用している場合はカスタムドメイン
* `clientId`: Auth0 Dashboard で作成したアプリケーションの「Settings」に表示されている「client ID」の値
* `useRefreshTokens`: Android および iOS 上の Ionic で auth0-react を使用するには、リフレッシュトークンを有効にする必要があります。
* `useRefreshTokensFallback`: Android および iOS 上の Ionic で auth0-react を使用するには、iframe フォールバックを無効にする必要があります。
* `authorizationParams.redirect_uri`: ユーザーが Auth0 で認証したあとにリダイレクトしたい URL。

<Warning>
  アプリケーションを閉じて再度開いたあとも認証状態を保持するには、SDK を構成する際に `cacheLocation` を `localstorage` に設定することを検討してください。ただし、[localstorage にトークンを保存する際のリスク](https://auth0.com/docs/libraries/auth0-single-page-app-sdk#change-storage-options)を必ず把握しておいてください。また、Capacitor アプリでは、ある種の状況で想定外にデータが復元される可能性があるため、localstorage は **一時的な** ものとして扱う必要があります。[Capacitor ドキュメントのストレージに関するガイダンス](https://capacitorjs.com/docs/guides/storage#why-cant-i-just-use-localstorage-or-indexeddb)も参照してください。

  さらに、より安全で永続的なストレージメカニズムを使用する必要がある場合、SDK にはトークンを保存するために[カスタムキャッシュ実装を使用する](https://github.com/auth0/auth0-spa-js/blob/master/EXAMPLES.md#creating-a-custom-cache)機能もあります。

  **注意:** トークンを保存する用途で [Capacitor の Storage プラグイン](https://capacitorjs.com/docs/apis/storage)を使用することは **推奨しません**。これは iOS および Android でそれぞれ [UserDefaults](https://developer.apple.com/documentation/foundation/userdefaults) と [SharedPreferences](https://developer.android.com/reference/android/content/SharedPreferences) をバックエンドとして使用しているためです。これらの API を使って保存されたデータは暗号化されず、安全ではなく、クラウドに同期される可能性もあります。
</Warning>

<Note>
  ### チェックポイント

  `Auth0Provider` の設定が完了したら、アプリケーションを実行し、SDK が正しく初期化されていることと、Auth0 に関連するエラーがアプリケーションで発生していないことを確認してください。
</Note>

<div id="add-login-to-your-application">
  ## アプリケーションにログイン機能を追加する
</div>

Capacitor アプリケーションでは、[Capacitor Browser プラグイン](https://capacitorjs.com/docs/apis/browser) が Auth0 の [Universal Login ページ](https://auth0.com/universal-login) へのリダイレクトを実行します。`loginWithRedirect` 関数の `openUrl` パラメーターを設定して `Browser.open` を使用し、URL がデバイスのシステムブラウザーコンポーネント（iOS では [SFSafariViewController](https://developer.apple.com/documentation/safariservices/sfsafariviewcontroller)、Android では [Chrome Custom Tabs](https://developer.chrome.com/docs/android/custom-tabs)）で開くようにします。

<Info>
  デフォルトでは、SDK の `loginWithRedirect` メソッドは `window.location.href` を使用して、ユーザーのデバイス上の既定のブラウザーアプリケーションでログインページへ遷移します。これはプラットフォームに適したシステムブラウザーコンポーネントではないため、ユーザーは認証のためにアプリケーションを離れることになり、ユーザーエクスペリエンスが最適でなくなる可能性があります。
</Info>

次のコードを含む新しいファイル `LoginButton.tsx` を追加します。

```js lines
import { useAuth0 } from '@auth0/auth0-react';
import { Browser } from '@capacitor/browser';
import { IonButton } from '@ionic/react';

const LoginButton: React.FC = () => {
  const { loginWithRedirect } = useAuth0();

  const login = async () => {
    await loginWithRedirect({
      async openUrl(url) {
         // Capacitor の Browser プラグインを使用してリダイレクト
        await Browser.open({
          url,
          windowName: "_self"
        });
      }
    });
  };

  return <IonButton onClick={login}>ログイン</IonButton>;
};

export default LoginButton;
```

このコンポーネントでは、次の処理を行います。

* クリックされたときにユーザーをログインさせるシンプルなボタンを持つテンプレートを定義します
* `loginWithRedirect` を使用して、Auth0 の Universal Login ページ経由でログインします
* `openUrl` コールバックを使用して、Capacitor の Browser プラグインで URL を開き、ユーザーにログインページを表示します

<Info>
  このガイドでは、`useAuth0()` カスタム React Hook の使用に焦点を当てます。クラスコンポーネントを使用している場合は、[`withAuth0()` 高階コンポーネントを使用したサンプル](https://github.com/auth0/auth0-react/blob/master/EXAMPLES.md#use-with-a-class-component)を参照してください。
</Info>

<div id="handling-the-callback">
  ### コールバックの処理
</div>

ユーザーが Universal Login ページでログインすると、カスタム URL スキームを持つ URL を経由してアプリにリダイレクトされます。`appUrlOpen` イベントはアプリ内で処理する必要があります。認証状態を初期化するには、Auth0 ソフトウェア開発キット (SDK) の `handleRedirectCallback` メソッドを呼び出すことができます。

このメソッドは、Auth0 からのリダイレクト時にのみ使用してください。成功を確認するには、URL に `code` と `state` パラメーターが含まれていることを確認します。

`Browser.close()` メソッドは、このイベントが発生したときにブラウザーを閉じる必要があります。

次の `useEffect` フックをメインの `App` コンポーネントに追加します。

```javascript lines
// Capacitorのappおよびbrowserプラグインをインポートし、`addListener`と`appUrlOpen`へのアクセスを提供します。
// また、Auth0とReactに必要な要素もインポートします。
import { App as CapApp } from '@capacitor/app';
import { Browser } from '@capacitor/browser';
import { useEffect } from 'react';
import { useAuth0 } from '@auth0/auth0-react';

// ...

const App: React.FC = () => {
  // Get the callback handler from the Auth0 React hook
  const { handleRedirectCallback } = useAuth0();

  useEffect(() => {
    // Handle the 'appUrlOpen' event and call `handleRedirectCallback`
    CapApp.addListener('appUrlOpen', async ({ url }) => {
      if (url.includes('state') && (url.includes('code') || url.includes('error'))) {
        await handleRedirectCallback(url);
      }
      // No-op on Android
      await Browser.close();
    });
  }, [handleRedirectCallback]);

  // ..
};
```

<Info>
  この記事では、アプリケーション内でコールバックを処理するためにカスタムURLスキームを使用することを前提としています。そのためには、選択したプラットフォーム向けに `YOUR_PACKAGE_ID` をURLスキームとして登録してください。詳細については、iOS の場合は [Defining a Custom URL Scheme](https://developer.apple.com/documentation/xcode/defining-a-custom-url-scheme-for-your-app)、Android の場合は [Create Deep Links to App Content](https://developer.android.com/training/app-links/deep-linking) を参照してください。
</Info>

<Note>
  ### チェックポイント

  `LoginButton` コンポーネントをアプリケーションに追加し、`App` コンポーネントに &quot;appUrlOpen&quot; イベント用のハンドラーも追加します。ログインボタンをクリックしたときに、アプリケーションが Auth0 の Universal Login ページにリダイレクトされ、ユーザー名とパスワード、またはソーシャルプロバイダーを使用してログインまたはサインアップできることを確認してください。

  それが完了したら、Auth0 が再びアプリケーションにリダイレクトすることを確認してください。
</Note>

<div id="add-logout-to-your-application">
  ## アプリケーションにログアウト機能を追加する
</div>

ユーザーがログインできるようになったので、次に[ログアウトする方法](https://auth0.com/docs/logout/guides/logout-auth0)を設定する必要があります。ユーザーはブラウザーで Auth0 のログアウトエンドポイントにリダイレクトされ、ブラウザーセッションをクリアする必要があります。ここでも、ユーザーがアプリを離れてしまい望ましくないエクスペリエンスにならないように、Capacitor の Browser プラグインを使ってこのリダイレクトを行う必要があります。

Ionic と Capacitor を Auth0 のソフトウェア開発キット (SDK) と組み合わせて使用してこれを実現するには、次のようにします。

* ログアウト後に Auth0 がリダイレクト先として使用する、アプリ用の URL を作成します。これは、登録済みのカスタムスキームと Auth0 ドメインを使用する URL です。この URL を Auth0 Dashboard の **許可されたログアウトURL** 設定に追加します。
* `logout` を呼び出して SDK からログアウトし、リダイレクト URL を `logoutParams.returnTo` パラメーターとして渡します。
* `openUrl` パラメーターを、Capacitor の Browser プラグインを使用して `Browser.open` で URL を開くコールバックに設定します。

<Info>
  ログイン手順と同様に、`logout` を呼び出す際に `openUrl` を設定しない場合、SDK はデバイス上の標準ブラウザーアプリケーションを使用してユーザーをログアウト URL にリダイレクトするため、ユーザーエクスペリエンスが低下します。
</Info>

新しいファイル `LogoutButton.tsx` を作成し、次のコードをそのファイルに追加します。その後、`LogoutButton` コンポーネントをアプリケーションに追加します。

export const codeExample2 = `import { useAuth0 } from '@auth0/auth0-react';
import { Browser } from '@capacitor/browser';
import { IonButton } from '@ionic/react';

// Auth0 Dashboard の「許可されたログアウトURL」設定に先ほど追加した URL を反映する必要があります。
const logoutUri = 'YOUR_PACKAGE_ID://{yourDomain}/capacitor/YOUR_PACKAGE_ID/callback';

const LogoutButton: React.FC = () => {
  const { logout } = useAuth0();

  const doLogout = async () => {
    await logout({
      logoutParams: {
        returnTo: logoutUri,
      },
      async openUrl(url) {
         // Capacitor の Browser プラグインを使用してリダイレクトします
        await Browser.open({
          url,
          windowName: "_self"
        });
      }
    });
  };

  return <IonButton onClick={doLogout}>ログアウト</IonButton>;
};

export default LogoutButton;`;

<AuthCodeBlock children={codeExample2} language="js" />

<Note>
  ### チェックポイント

  `LogoutButton` コンポーネントをアプリケーションに追加してください。クリックしたときに、Ionic アプリケーションが「設定」の「許可されたログアウトURL」の 1 つとして指定したアドレスにリダイレクトされること、またアプリケーションにログインしていないことを確認してください。
</Note>

<div id="show-user-profile-information">
  ## ユーザーのプロファイル情報を表示する
</div>

Auth0 React ソフトウェア開発キット (SDK) を使用すると、ログインしているユーザーに関連付けられた[プロファイル情報](https://auth0.com/docs/users/concepts/overview-user-profile)（UI をパーソナライズするために使用する名前やプロフィール画像など）を、任意のコンポーネントからすばやく取得できます。プロファイル情報は、`useAuth0()` フックによって公開される `user` プロパティを通じて利用できます。次の `Profile` コンポーネントは、その利用方法を示す例です。

```js lines
import { useAuth0 } from '@auth0/auth0-react';

const Profile: React.FC = () => {
  const { user, isLoading } = useAuth0();

  // SDK の準備ができていない場合、またはユーザーが認証されていない場合は終了します。
  if (isLoading || !user) return null;

  return (
    <div>
      <Frame><img 
        src={user.picture || `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='50' fill='%2363b3ed'/%3E%3Cpath d='M50 45c7.5 0 13.64-6.14 13.64-13.64S57.5 17.72 50 17.72s-13.64 6.14-13.64 13.64S42.5 45 50 45zm0 6.82c-9.09 0-27.28 4.56-27.28 13.64v3.41c0 1.88 1.53 3.41 3.41 3.41h47.74c1.88 0 3.41-1.53 3.41-3.41v-3.41c0-9.08-18.19-13.64-27.28-13.64z' fill='%23fff'/%3E%3C/svg%3E`}
        alt={user.name} 
        onError={(e) => {
          const target = e.target as HTMLImageElement;
          target.src = `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='50' fill='%2363b3ed'/%3E%3Cpath d='M50 45c7.5 0 13.64-6.14 13.64-13.64S57.5 17.72 50 17.72s-13.64 6.14-13.64 13.64S42.5 45 50 45zm0 6.82c-9.09 0-27.28 4.56-27.28 13.64v3.41c0 1.88 1.53 3.41 3.41 3.41h47.74c1.88 0 3.41-1.53 3.41-3.41v-3.41c0-9.08-18.19-13.64-27.28-13.64z' fill='%23fff'/%3E%3C/svg%3E`;
        }}
      /></Frame>
      <h2>{user.name}</h2>
      <p>{user.email}</p>
    </div>
  );
};

export default Profile;
```

`user` プロパティには、ユーザーのアイデンティティに関する機微情報や関連データが含まれます。そのため、その利用可否はユーザーの認証状態に依存します。レンダリング エラーを防ぐため、`user` プロパティを利用するコンポーネントを React がレンダーする前に、`useAuth0()` の `isAuthenticated` プロパティを使って Auth0 がユーザーを認証済みかどうかを確認してください。ソフトウェア開発キット (SDK) の読み込みが完了していることを確認するには、`isAuthenticated` プロパティへアクセスする前に、`isLoading` が `false` であることをチェックしてください。

<Note>
  ### チェックポイント

  `Profile` コンポーネントをアプリケーションに追加し、ログイン後にコンポーネント内で `user.name` または[他の任意の `user` プロパティ](https://auth0.com/docs/users/references/user-profile-structure#user-profile-attributes)を正しく表示できることを確認してください。
</Note>

<Info>
  ##### 次のステップ

  <table>
    <tr>
      <td><a href="/docs/ja-JP/authenticate/identity-providers">他のアイデンティティ プロバイダーを設定する</a></td>
      <td><a href="/docs/ja-JP/secure/multi-factor-authentication">多要素認証を有効化する</a></td>
    </tr>

    <tr>
      <td><a href="/docs/ja-JP/secure/attack-protection">攻撃からの保護について学ぶ</a></td>
      <td><a href="/docs/ja-JP/customize/rules">Rules について学ぶ</a></td>
    </tr>
  </table>

  [GitHub で編集](https://github.com/auth0/docs/edit/master/articles/quickstart/backend/aspnet-core-webapi/01-authorization.md)
</Info>

***