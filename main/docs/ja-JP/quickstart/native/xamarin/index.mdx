---
title: ".NET Android と iOS"
permalink: "01-login"
---

import {AuthCodeBlock} from "/snippets/ja-JP/AuthCodeBlock.jsx";

<div id="by-frederik-prijck">
  ##### Frederik Prijck による
</div>

このチュートリアルでは、Auth0 を使用して Xamarin アプリケーションにユーザーのログイン機能を追加する方法を説明します。アカウント向けに構成されたサンプルを使ってこのクイックスタートを進められるよう、事前にログインしておくことをお勧めします。

{/* <Card title="GitHub で表示" href="https://github.com/auth0-samples/auth0-xamarin-oidc-samples/tree/master/Quickstart/01-Login" icon="github">
  システム要件：Visual Studio 2022 または Visual Studio for Mac | Xamarin for Visual Studio | .NET 6 以降
  </Card> */}

<Info>
  このクイックスタートでは、`Xamarin.Android` と `Xamarin.iOS` の次世代である .NET Android と iOS に焦点を当てています。現在も `Xamarin.Android` と `Xamarin.iOS` を使用している場合でも、統合方法は同一で SDK も互換性があるため、このガイドにそのまま従って問題ありません。
</Info>

<Info>
  **認証は初めてですか？** [Auth0 の仕組み](/docs/ja-JP/get-started/auth0-overview)、[ネイティブアプリケーションとの統合方法](/docs/ja-JP/get-started/architecture-scenarios/mobile-api)、および使用される [プロトコル](/docs/ja-JP/get-started/authentication-and-authorization-flow/authorization-code-flow-with-pkce)について学んでください。
</Info>

<div id="configure-auth0">
  ## Auth0 を設定する
</div>

<div id="get-your-application-keys">
  ### アプリケーションキーを取得する
</div>

Auth0 にサインアップすると、新しいアプリケーションが自動的に作成されるか、または自分で新しいアプリケーションを作成できます。Auth0 と通信するには、そのアプリケーションに関するいくつかの情報が必要です。これらの情報は Auth0 Dashboard の [Application Settings](https://manage.auth0.com/#/applications) セクションで確認できます。

<Frame>![App Dashboard](https://cdn2.auth0.com/docs/1.14550.0/media/articles/dashboard/client_settings.png)</Frame>

<Info>
  Default App をネイティブ アプリケーションまたはシングルページアプリケーションで使用する場合は、**Token Endpoint Authentication Method** を `None` に変更し、**Application Type** を `SPA` または `Native` のいずれかに設定してください。
</Info>

次の情報が必要です：

* **Domain**
* **Client ID**

<Info>
  このページの上部からサンプルをダウンロードした場合、これらの情報はあらかじめ入力されています。
</Info>

<div id="configure-callback-urls">
  ### コールバックURLを設定する
</div>

コールバックURLは、ユーザーが認証された後に Auth0 がリダイレクトする、アプリケーション内の URL です。アプリのコールバックURLは、[Application Settings](https://manage.auth0.com/#/applications) の **許可されたコールバックURL** フィールドに追加する必要があります。このフィールドが設定されていない場合、ユーザーはアプリケーションにログインできず、エラーが発生します。

コールバックURLは、認証処理の完了後に Auth0 が呼び出す URL です。Auth0 は処理をこの URL にリダイレクトし、その URL に、IDトークン、アクセストークン、リフレッシュトークンと交換されるアクセスコードを含む追加のパラメーターを付加します。

コールバックURLは書き換えられる可能性があるため、セキュリティ上の理由から、アプリケーションの URL をアプリケーションの *許可されたコールバックURL* に追加する必要があります。これにより、Auth0 はそれらの URL を有効なものとして認識できるようになります。設定しない場合、認証は成功しません。

* Android の場合、コールバックURLは次の形式になります

  ```
  YOUR_ANDROID_PACKAGE_NAME://{yourDomain}/android/YOUR_ANDROID_PACKAGE_NAME/callback
  ```

  ここで `YOUR_ANDROID_PACKAGE_NAME` は、`com.mycompany.myapplication` のような、アプリケーションのパッケージ名 (Package Name) です。
* iOS の場合、コールバックURLは次の形式になります

  ```
  YOUR_BUNDLE_IDENTIFIER://{yourDomain}/ios/YOUR_BUNDLE_IDENTIFIER/callback
  ```

  ここで `YOUR_BUNDLE_IDENTIFIER` は、`com.mycompany.myapplication` のような、アプリケーションのバンドル識別子 (Bundle Identifier) です。

コールバックURLはすべて小文字にしてください。

<div id="configure-logout-urls">
  ### ログアウトURLの設定
</div>

ログアウトURLは、ユーザーが認可サーバーからログアウトされた後に、Auth0 がリダイレクト先として戻ることができるアプリケーション内の URL です。これは `returnTo` クエリパラメーターで指定します。アプリのログアウトURLは、[Application Settings](https://manage.auth0.com/#/applications) の **許可されたログアウトURL** フィールドに追加する必要があります。このフィールドが設定されていない場合、ユーザーはアプリケーションからログアウトできず、エラーが発生します。

<Info>
  このページの先頭からダウンロードしたサンプルプロジェクトに沿って作業している場合は、**許可されたログアウトURL** フィールドに追加する必要があるログアウトURLは、コールバックURLと同じ値です。
</Info>

<div id="install-dependencies">
  ## 依存関係をインストールする
</div>

Visual Studio を使用している場合は、[表示] → [その他のウィンドウ] → [Package Manager Console] の順に選択して Package Manager Console を開き、パッケージをインストールします。

**Android の場合:**

```
Install-Package Auth0.OidcClient.AndroidX
```

**iOS の場合:**

```
Install-Package Auth0.OidcClient.iOS
```

または、Visual Studio for Mac を使用している場合は、次の手順を実行してください。

1. Visual Studio for Mac でプロジェクトを読み込んだ状態で、**Solution Pad** 内のプロジェクトの **Packages** フォルダーを Ctrl+クリック（または右クリック）し、**Add Packages...** を選択します。
2. **Add Packages** ダイアログが表示されます。使用しているプラットフォームに応じて、`Auth0.OidcClient.AndroidX` または `Auth0.OidcClient.iOS` というパッケージを検索して見つけます。
3. パッケージの横にあるチェックボックスをオンにして選択し、**Add Package** ボタンをクリックします。

<div id="trigger-authentication">
  ## 認証を開始する
</div>

アプリケーションに Auth0 のログインを統合するには、`Auth0Client` クラスのインスタンスを作成し、Auth0 ドメインとクライアントIDを設定します。

export const codeExample1 = `using Auth0.OidcClient;

var client = new Auth0Client(new Auth0ClientOptions
{
    Domain = "{yourDomain}",
    ClientId = "{yourClientId}"
}, this);`;

<AuthCodeBlock children={codeExample1} language="cs" />

次に `LoginAsync` メソッドを呼び出します。これにより、ユーザーはログイン画面にリダイレクトされます。通常、この呼び出しは Login ボタンなどの UI コントロールのイベントハンドラー内で行います。

```cs lines
var loginResult = await client.LoginAsync();
```

<div id="handing-the-callback-url">
  ### コールバック URL の処理
</div>

ユーザーがログインすると、事前に登録しておいた **Callback URL** でアプリケーションにリダイレクトされます。Android と iOS の両方で、このコールバックを処理して、認証フローを完了させる必要があります。

<div id="android">
  ### Android
</div>

このコールバック URL を処理するインテントを登録します。もっとも簡単なのは、認証フローを開始するために `LoginAsync` メソッドを呼び出したのと同じアクティビティに、そのインテントを登録する方法です。

export const codeExample2 = `[Activity(Label = "AndroidSample", MainLauncher = true, Icon = "@drawable/icon",
    LaunchMode = LaunchMode.SingleTask)]
[IntentFilter(
    new[] { Intent.ActionView },
    Categories = new[] { Intent.CategoryDefault, Intent.CategoryBrowsable },
    DataScheme = "YOUR_ANDROID_PACKAGE_NAME",
    DataHost = "{yourDomain}",
    DataPathPrefix = "/android/YOUR_ANDROID_PACKAGE_NAME/callback")]
public class MainActivity : Activity
{
    // コード省略
}`;

<AuthCodeBlock children={codeExample2} language="cs" />

上記のコードサンプル内の `YOUR_ANDROID_PACKAGE_NAME` を、`com.mycompany.myapplication` のような実際のアプリケーションのパッケージ名に置き換えます。また、`DataScheme`、`DataHost`、`DataPathPrefix` の文字列はすべて小文字で指定してください。さらに、`Activity` に対して `LaunchMode = LaunchMode.SingleTask` を設定します。これを行わないと、コールバック URL が呼び出されるたびにシステムが新しい Activity インスタンスを作成してしまいます。

次に、インテントを処理するコードを記述します。これは、`OnNewIntent` メソッドをオーバーライドすることで行えます。メソッド内で、認証フローを完了するために `ActivityMediator` の `Send` メソッドを呼び出す必要があります。

```cs lines
protected override async void OnNewIntent(Intent intent)
{
    base.OnNewIntent(intent);

    Auth0.OidcClient.ActivityMediator.Instance.Send(intent.DataString);
}
```

<div id="ios">
  ### iOS
</div>

アプリケーションで処理する必要があるコールバック URL 用の URL スキームを登録します。

1. Visual Studio for Mac でアプリケーションの `Info.plist` ファイルを開き、**Advanced** タブに移動します。
2. **URL Types** の下にある **Add URL Type** ボタンをクリックします。
3. **Identifier** を `Auth0`、**URL Schemes** をアプリケーションの **Bundle Identifier** と同じ値、**Role** を `None` に設定します。

URL Type を追加した後の `info.plist` ファイルの XML 表記の例を次に示します。

```xml lines
<key>CFBundleURLTypes</key>
<array>
    <dict>
        <key>CFBundleTypeRole</key>
        <string>None</string>
        <key>CFBundleURLName</key>
        <string>Auth0</string>
        <key>CFBundleURLSchemes</key>
        <array>
            <string>YOUR_BUNDLE_IDENTIFIER</string>
        </array>
    </dict>
</array>
```

`AppDelegate` クラスの `OpenUrl` イベント内で Callback URL を処理する必要があります。`ActivityMediator` シングルトンの `Send` メソッドを呼び出し、送信されてきた URL を渡して、Auth0 OIDC クライアントに認証フローを完了するよう通知する必要があります。

```cs lines
using Auth0.OidcClient;

[Register("AppDelegate")]
public class AppDelegate : UIApplicationDelegate
{
    public override bool OpenUrl(UIApplication application, NSUrl url, string sourceApplication, NSObject annotation)
    {
        ActivityMediator.Instance.Send(url.AbsoluteString);

        return true;
    }
}
```

<div id="run-the-application">
  ### アプリケーションを実行する
</div>

上記のコードを実装すると、ユーザーは Auth0 を使用してアプリケーションにログインできるようになります。

<Frame>![Universal Login](https://cdn2.auth0.com/docs/1.14550.0/media/articles/native-platforms/android/login-android.png)</Frame>

<div id="accessing-the-users-information">
  ## ユーザー情報へのアクセス
</div>

返されるログイン結果は、認証が成功したかどうかを示し、成功していればユーザーのトークンとクレームを含みます。

<div id="authentication-error">
  ### 認証エラー
</div>

結果の `IsError` プロパティを確認すると、ログインが失敗したかどうかを判別できます。`ErrorMessage` には、発生したエラーの内容に関する詳細な情報が含まれます。

```cs lines
var loginResult = await client.LoginAsync();

if (loginResult.IsError)
{
    Debug.WriteLine($"ログイン中にエラーが発生しました: {loginResult.Error}")
}
```

<div id="accessing-the-tokens">
  ### トークンの取得
</div>

ログインに成功すると、ログイン結果には `IdentityToken` プロパティにIDトークンが、`AccessToken` プロパティにアクセストークンがそれぞれ含まれます。

```cs lines
var loginResult = await client.LoginAsync();

if (!loginResult.IsError)
{
    Debug.WriteLine($"id_token: {loginResult.IdentityToken}");
    Debug.WriteLine($"access_token: {loginResult.AccessToken}");
}
```

<div id="obtaining-the-user-information">
  ### ユーザー情報の取得
</div>

ログインに成功すると、ログイン結果の `User` プロパティ（[ClaimsPrincipal](https://msdn.microsoft.com/en-us/library/system.security.claims.claimsprincipal\(v=vs.110\).aspx) 型）にユーザー情報が含まれます。

ユーザーに関する情報を取得するには、クレームを参照します。たとえば、`name` および `email` クレームから、ユーザーの名前とメールアドレスを取得できます。

```cs lines
if (!loginResult.IsError)
{
    Debug.WriteLine($"name: {loginResult.User.FindFirst(c => c.Type == "name")?.Value}");
    Debug.WriteLine($"email: {loginResult.User.FindFirst(c => c.Type == "email")?.Value}");
}
```

<Info>
  返されるクレームの内容は、要求したスコープによって異なります。詳細については、Auth0 OIDC アプリケーションのドキュメント内の [Using Scopes](https://auth0.github.io/auth0-oidc-client-net/documentation/advanced-scenarios/scopes.html) を参照してください。
</Info>

`Claims` コレクションを列挙すると、IDトークンに含まれるすべてのクレームの一覧を取得できます。

```cs lines
if (!loginResult.IsError)
{
    foreach (var claim in loginResult.User.Claims)
    {
        Debug.WriteLine($"{claim.Type} = {claim.Value}");
    }
}
```

<div id="logout">
  ## ログアウト
</div>

ユーザーをログアウトさせるには、`LogoutAsync` メソッドを呼び出します。

```cs lines
BrowserResultType browserResult = await client.LogoutAsync();
```

<Info>
  ##### 次のステップ

  <table>
    <tr>
      <td><a href="/docs/ja-JP/authenticate/identity-providers">他のアイデンティティ プロバイダーを設定する</a></td>
      <td><a href="/docs/ja-JP/secure/multi-factor-authentication">多要素認証を有効にする</a></td>
    </tr>

    <tr>
      <td><a href="/docs/ja-JP/secure/attack-protection">攻撃保護について詳しく知る</a></td>
      <td><a href="/docs/ja-JP/customize/rules">Rules について学ぶ</a></td>
    </tr>
  </table>

  [GitHub で編集](https://github.com/auth0/docs/edit/master/articles/quickstart/backend/aspnet-core-webapi/01-authorization.md)
</Info>
