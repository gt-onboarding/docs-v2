---
title: "MAUI"
permalink: "01-login"
---

import {AuthCodeBlock} from "/snippets/ja-JP/AuthCodeBlock.jsx";

<div id="by-frederik-prijck">
  ##### Frederik Prijck による解説
</div>

このチュートリアルでは、.NET MAUI アプリケーションに Auth0 を用いたユーザーログイン機能を追加する方法を説明します。ご利用のアカウント向けに構成されたサンプルを使ってこのクイックスタートを進められるよう、事前にログインしておくことをおすすめします。

{/* <Card title="GitHub で表示" href="https://github.com/auth0-samples/auth0-maui-samples/tree/master/Sample" icon="github">
  システム要件: Visual Studio 2022 以降 または Visual Studio for Mac | .NET 6 以降
  </Card> */}

<Info>
  MAUI SDK は Android、iOS、macOS、Windows をサポートしています。プラットフォームごとの設定については、このまま読み進めてください。
</Info>

<Info>
  **Auth や認証が初めての方は**、[Auth0 の仕組み](/docs/ja-JP/get-started/auth0-overview)、[ネイティブアプリケーションとの統合方法](/docs/ja-JP/get-started/architecture-scenarios/mobile-api)、および使用される[プロトコル](/docs/ja-JP/get-started/authentication-and-authorization-flow/authorization-code-flow-with-pkce)について学んでください。
</Info>

<div id="configure-auth0">
  ## Auth0 の設定
</div>

<div id="get-your-application-keys">
  ### アプリケーションキーを取得する
</div>

Auth0 にサインアップすると、新しいアプリケーションが自動的に作成されるか、自分で新しいアプリケーションを作成しているはずです。Auth0 と連携するには、そのアプリケーションに関するいくつかの情報が必要になります。これらの情報は、Auth0 Dashboard の [Application Settings](https://manage.auth0.com/#/applications) セクションで確認できます。

<Frame>![App Dashboard](https://cdn2.auth0.com/docs/1.14550.0/media/articles/dashboard/client_settings.png)</Frame>

<Info>
  Default App をネイティブアプリケーションまたはシングルページアプリケーションで使用する場合は、**Token Endpoint Authentication Method** を `None` に変更し、**Application Type** を `SPA` または `Native` に設定してください。
</Info>

次の情報が必要です。

* **ドメイン (Domain)**
* **クライアントID (Client ID)**

<Info>
  このページの上部からサンプルをダウンロードした場合、これらの値はあらかじめ入力されています。
</Info>

<div id="configure-callback-urls">
  ### コールバックURLの設定
</div>

コールバックURLは、ユーザーが認証を完了した後に、Auth0 がユーザーをリダイレクトするアプリケーション内の URL です。アプリケーションのコールバックURLは、[Application Settings](https://manage.auth0.com/#/applications) の **Allowed Callback URLs** フィールドに追加する必要があります。このフィールドが設定されていない場合、ユーザーはアプリケーションにログインできず、エラーが発生します。

コールバックURLは、認証処理の後に Auth0 が呼び出す URL です。Auth0 はアプリケーションをこの URL に戻し、IDトークン、アクセストークン、リフレッシュトークンと交換されるアクセスコードを含む追加のパラメーターを付加します。

コールバックURLは改ざんされる可能性があるため、セキュリティ上、アプリケーションの URL をアプリケーションの *Allowed Callback URLs* に追加する必要があります。これにより、Auth0 はこれらの URL を有効なものとして認識できるようになります。設定しない場合、認証は成功しません。

<Info>
  このクイックスタートに沿って作業する場合、*Allowed Callback URLs* として `myapp://callback` を設定してください。
</Info>

<div id="configure-logout-urls">
  ### ログアウトURLを設定する
</div>

ログアウトURLは、ユーザーが認可サーバーからログアウトされた後に、Auth0 が遷移先として利用できる、アプリケーション内の URL です。これは `returnTo` クエリパラメーターで指定します。アプリのログアウトURLは、[Application Settings](https://manage.auth0.com/#/applications) の **許可されたログアウトURL** フィールドに追加する必要があります。このフィールドが設定されていない場合、ユーザーはアプリケーションからログアウトできず、エラーが返されます。

<Info>
  このクイックスタートに沿って作業する場合は、`myapp://callback` を *許可されたログアウトURL* として設定してください。
</Info>

<div id="install-the-auth0-sdk">
  ## Auth0 SDK をインストールする
</div>

Auth0 では、MAUI アプリケーションで Auth0 認証を実装する作業を簡素化するために、[MAUI](https://www.nuget.org/packages/Auth0.OidcClient.MAUI/) 用のソフトウェア開発キット (SDK) を提供しています。

NuGet Package Manager (Tools -&gt; Library Package Manager -&gt; Package Manager Console) を使用して、`Auth0.OidcClient.MAUI` パッケージをインストールします。

または、NuGet Package Manager Console (`Install-Package`) や `dotnet` CLI (`dotnet add`) を使用することもできます。

```
Install-Package Auth0.OidcClient.MAUI
```

```
dotnet add package Auth0.OidcClient.MAUI
```

<div id="platform-specific-configuration">
  ## プラットフォーム固有の設定
</div>

Android および Windows でソフトウェア開発キット (SDK) を使用するには、プラットフォーム固有の設定が必要です。

<div id="android">
  ### Android
</div>

`WebAuthenticatorCallbackActivity` を継承する新しい Activity を作成します。

```cs lines
[Activity(NoHistory = true, LaunchMode = LaunchMode.SingleTop, Exported = true)]
[IntentFilter(new[] { Intent.ActionView },
              Categories = new[] { Intent.CategoryDefault, Intent.CategoryBrowsable },
              DataScheme = CALLBACK_SCHEME)]
public class WebAuthenticatorActivity : Microsoft.Maui.Authentication.WebAuthenticatorCallbackActivity
{
    const string CALLBACK_SCHEME = "myapp";
}
```

上記の作業により、Auth0 がログイン後に Android アプリケーションへリダイレクトしたときに、アプリケーションが `myapp://callback` URL を処理できるようになります。

<div id="windows">
  ### Windows
</div>

リダイレクト後に Auth0 から戻された際にアプリケーションを正しく再アクティブ化できるようにするには、次の 2 つを行う必要があります。

* 対応するプロトコルを `Package.appxmanifest` に追加します。この例では `myapp` に設定されていますが、任意の値に変更できます（関連するすべての Auth0 URL も忘れずに更新してください）。

  ```xml lines
  <Applications>
    <Application Id="App" Executable="$targetnametoken$.exe" EntryPoint="$targetentrypoint$">
      <Extensions>
        <uap:Extension Category="windows.protocol">
          <uap:Protocol Name="myapp"/>
        </uap:Extension>
      </Extensions>
    </Application>
  </Applications>
  ```

* Windows 向けの `App.xaml.cs` ファイル内で `Activator.Default.CheckRedirectionActivation()` を呼び出します。

  ```cs lines
  public App()
  {
    if (Auth0.OidcClient.Platforms.Windows.Activator.Default.CheckRedirectionActivation())
      return;

    this.InitializeComponent();
  }
  ```

<div id="instantiate-the-auth0client">
  ## Auth0Client をインスタンス化する
</div>

アプリケーションに Auth0 を統合するには、Auth0 のドメイン、クライアントID、および必要なスコープを含む `Auth0ClientOptions` のインスタンスを渡して、`Auth0Client` クラスのインスタンスをインスタンス化します。
さらに、Auth0 が設定済みの URL を使用してアプリケーションにリダイレクトできるようにするために、`RedirectUri` と `PostLogoutRedirectUri` も設定する必要があります。

export const codeExample = `using Auth0.OidcClient;

var client = new Auth0Client(new Auth0ClientOptions
{
    Domain = "{yourDomain}",
    ClientId = "{yourDomain}",
    RedirectUri = "myapp://callback",
    PostLogoutRedirectUri = "myapp://callback",
    Scope = "openid profile email"
});`;

<AuthCodeBlock children={codeExample} language="cs" />

デフォルトでは、このソフトウェア開発キット (SDK) は Android では Chrome Custom Tabs、iOS と macOS では ASWebAuthenticationSession を使用し、Windows ではシステム既定のブラウザーを使用します。

<div id="add-login-to-your-application">
  ## アプリケーションにログイン機能を追加する
</div>

Auth0 アプリケーションと Auth0 ソフトウェア開発キット (SDK) の設定が完了したので、プロジェクトにログイン機能を用意する必要があります。これを行うには、SDK の `LoginAsync()` メソッドを使用して、ユーザーを Auth0 Universal Login ページにリダイレクトするログインボタンを作成します。

```cs lines
var loginResult = await client.LoginAsync();
```

エラーが発生していない場合は、`LoginAsync()` から返される `LoginResult` の `User`、`IdentityToken`、`AccessToken`、`RefreshToken` にアクセスできます。

<div id="add-logout-to-your-application">
  ## アプリケーションにログアウト機能を追加する
</div>

アプリケーションにログインしたユーザーには、ログアウトする手段も必要です。ソフトウェア開発キット (SDK) の `LogoutAsync()` メソッドを使用してログアウトボタンを作成します。ユーザーがログアウトすると、Auth0 のログアウトエンドポイントにリダイレクトされ、そこから、このクイックスタートの前の手順で設定したログアウト URL に直ちにリダイレクトされます。

```cs lines
await client.LogoutAsync();
```

<div id="show-user-profile-information">
  ## ユーザーのプロファイル情報を表示する
</div>

ユーザーがログインおよびログアウトできるようになったら、認証されたユーザーに関連付けられた[プロファイル情報](https://auth0.com/docs/users/concepts/overview-user-profile)を取得できるようにしたくなるでしょう。たとえば、ログインしているユーザーの名前やプロファイル画像をプロジェクト内で表示したい場合などです。

MAUI 向け Auth0 ソフトウェア開発キット (SDK) は、`LoginResult.User` プロパティを通じてユーザー情報を提供します。

```cs lines
if (loginResult.IsError == false)
{
    var user = loginResult.User;
    var name = user.FindFirst(c => c.Type == "name")?.Value;
    var email = user.FindFirst(c => c.Type == "email")?.Value;
    var picture = user.FindFirst(c => c.Type == "picture")?.Value;
}
```

<Info>
  ##### 次にできること

  <table>
    <tr>
      <td><a href="/docs/ja-JP/authenticate/identity-providers">その他のアイデンティティ プロバイダーを設定する</a></td>
      <td><a href="/docs/ja-JP/secure/multi-factor-authentication">多要素認証を有効にする</a></td>
    </tr>

    <tr>
      <td><a href="/docs/ja-JP/secure/attack-protection">攻撃保護機能について学ぶ</a></td>
      <td><a href="/docs/ja-JP/customize/rules">Rules について学ぶ</a></td>
    </tr>
  </table>

  [GitHub で編集](https://github.com/auth0/docs/edit/master/articles/quickstart/backend/aspnet-core-webapi/01-authorization.md)
</Info>

***
