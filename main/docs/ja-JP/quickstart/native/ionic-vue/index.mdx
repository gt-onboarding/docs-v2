---
title: "Ionic & Capacitor（Vue）"
permalink: "01-login"
---

import {AuthCodeBlock} from "/snippets/ja-JP/AuthCodeBlock.jsx";

<div id="by-steve-hobbs">
  ##### Steve Hobbs 作
</div>

このチュートリアルでは、Ionic Vue &amp; Capacitor アプリケーションに Auth0 を使用したユーザーログイン機能を追加する方法を説明します。お使いのアカウント向けに構成されたサンプルに沿ってこのクイックスタートを進められるよう、事前にログインしておくことをおすすめします。

{/* <Card title="GitHub で表示" href="https://github.com/auth0-samples/auth0-ionic-samples/tree/main/vue" icon="github">
  システム要件: Node.js および npm (LTS) | Xcode 12 以降（iOS 用）| Android Studio 4 以降（Android 用）
  </Card> */}

<div id="getting-started">
  ## はじめに
</div>

このクイックスタートでは、すでに [Ionic](https://ionicframework.com/) アプリケーションを [Capacitor](https://capacitorjs.com/) と組み合わせて動作させていることを前提としています。まだの場合は、シンプルなアプリから始めるために [Using Capacitor with Ionic Framework ガイド](https://capacitorjs.com/docs/getting-started/with-ionic) を参照するか、[Auth0 のサンプルアプリ](https://github.com/auth0-samples/auth0-ionic-samples) をクローンしてください。

また、[Capacitor の開発ワークフロー](https://capacitorjs.com/docs/basics/workflow) にも慣れておく必要があります。

<Info>
  **認証は初めてですか？** [Auth0 の仕組み](/docs/ja-JP/get-started/auth0-overview)、[ネイティブアプリケーションとの統合方法](/docs/ja-JP/get-started/architecture-scenarios/mobile-api)、および使用する[プロトコル](/docs/ja-JP/get-started/authentication-and-authorization-flow/authorization-code-flow-with-pkce)について学んでください。
</Info>

<div id="configure-auth0">
  ## Auth0 の設定
</div>

<div id="get-your-application-keys">
  ### アプリケーションキーを取得する
</div>

Auth0 にサインアップした際に、新しいアプリケーションが自動的に作成されているか、または自分で新しいアプリケーションを作成しているはずです。Auth0 と通信するには、そのアプリケーションに関するいくつかの情報が必要です。これらの情報は Auth0 Dashboard の [Application Settings](https://manage.auth0.com/#/applications) セクションから取得できます。

<Frame>![App Dashboard](https://cdn2.auth0.com/docs/1.14550.0/media/articles/dashboard/client_settings.png)</Frame>

<Info>
  Default App をネイティブアプリケーションまたはシングルページアプリケーションで使用する場合は、**Token Endpoint Authentication Method** を `None` に変更し、**Application Type** を `SPA` または `Native` のいずれかに設定してください。
</Info>

次の情報が必要です。

* **Domain**
* **Client ID**

<Info>
  このページ上部からサンプルをダウンロードした場合、これらの値はあらかじめ入力されています。
</Info>

<div id="configure-callback-urls">
  ### コールバックURLを設定する
</div>

コールバックURLは、ユーザーが認証を完了した後に Auth0 がリダイレクトする、アプリケーション内のURLです。アプリのコールバックURLは、[Application Settings](https://manage.auth0.com/#/applications) の **Allowed Callback URLs** フィールドに追加する必要があります。このフィールドが設定されていない場合、ユーザーはアプリケーションにログインできず、エラーが発生します。

<Info>
  本記事全体を通して、`YOUR_PACKAGE_ID` はアプリケーションのパッケージIDを表します。これは `capacitor.config.ts` ファイル内の `appId` フィールドで確認および設定できます。詳細は [Capacitor Config schema](https://capacitorjs.com/docs/config#schema) を参照してください。
</Info>

Auth0 Dashboard の [Application Settings](https://manage.auth0.com/#/applications/\{yourClientId}/settings) セクションに移動し、**Allowed Callback URLs** ボックスに **Callback URL** を設定します。

**Allowed Callback URL** には次のURLを設定します。

```
YOUR_PACKAGE_ID://{yourDomain}/capacitor/YOUR_PACKAGE_ID/callback
```

<div id="configure-logout-urls">
  ### ログアウトURLを構成する
</div>

ログアウトURLは、ユーザーが認可サーバーからログアウトした後に、Auth0 が戻り先として使用できる、アプリケーション内の URL です。これは `returnTo` クエリパラメーターで指定します。アプリのログアウトURLは、[Application Settings](https://manage.auth0.com/#/applications) の **許可されたログアウトURL** フィールドに追加する必要があります。このフィールドが設定されていない場合、ユーザーはアプリケーションからログアウトできず、エラーが発生します。

**許可されたログアウトURL** には、次の値を設定する必要があります

```
YOUR_PACKAGE_ID://{yourDomain}/capacitor/YOUR_PACKAGE_ID/callback
```

<div id="configure-origins">
  ### オリジンを設定する
</div>

アプリケーションから Auth0 へのリクエストを行えるようにするには、[Application Settings](https://manage.auth0.com/#/applications/\{yourClientId}/settings) で **Allowed Origins** に次の値を設定します。

```
capacitor://localhost, http://localhost
```

これらのオリジンは、それぞれ iOS と Android 向けに必要です。

最後に、[Application Settings](https://manage.auth0.com/#/applications/\{yourClientId}/settings) で、このアプリケーションの **Application Type** が **Native** に設定されていることを必ず確認してください。

<div id="install-the-auth0-vue-sdk">
  ## Auth0 Vue ソフトウェア開発キット (SDK) のインストール
</div>

プロジェクト ディレクトリで次のコマンドを実行して、Auth0 Vue ソフトウェア開発キット (SDK) をインストールします。

```
npm install @auth0/auth0-vue
```

このソフトウェア開発キット (SDK) では、モジュールや認証サービスなど、Vue アプリケーションに Auth0 を自然な形で統合するのに役立つ複数の型を提供します。

<div id="install-capacitor-plugins">
  ### Capacitor プラグインをインストールする
</div>

このクイックスタートおよびサンプルでは、いくつかの Capacitor 公式プラグインを使用します。以下のコマンドで、これらをアプリにインストールします。

```
npm install @capacitor/browser @capacitor/app
```

* [`@capacitor/browser`](https://capacitorjs.com/docs/apis/browser) - デバイスのシステムブラウザーと連携し、Auth0 の認可エンドポイントの URL を開くために使用されます
* [`@capacitor/app`](https://capacitorjs.com/docs/apis/app) - アプリの高レベルなイベントを購読でき、Auth0 からのコールバック処理に役立ちます

<Info>
  iOS 上の Capacitor の Browser プラグインは [`SFSafariViewController`](https://developer.apple.com/documentation/safariservices/sfsafariviewcontroller) を使用しますが、これは iOS 11 以降ではデバイス上の Safari とクッキーを共有しません。つまり、これらのデバイスでは [SSO](https://auth0.com/docs/sso) は機能しません。SSO が必要な場合は、代わりに [ASWebAuthenticationSession](https://developer.apple.com/documentation/authenticationservices/aswebauthenticationsession) を使用する互換プラグインを使用してください。
</Info>

<div id="configure-the-createauth0-plugin">
  ### createAuth0 プラグインを設定する
</div>

ソフトウェア開発キット (SDK) は `createAuth0` という、SDK が動作するために必要なすべてのサービスを含むコンポーザブルをエクスポートします。これをアプリケーションに登録するには、次のようにします。

`src/main.ts` を開き、`app.use` を使ってプラグインをインストールします。

export const codeExample = `import { createApp } from "vue";
import App from "./App.vue";
import router from "./router";

import { IonicVue } from "@ionic/vue";

import { createAuth0 } from "@auth0/auth0-vue";
import config from "./auth.config";

// ..

// Auth0 がリダイレクトする先の URL を組み立てる
const redirect_uri = \`\${config.appId}://{yourDomain}/capacitor/\${config.appId}/callback\`;

const app = createApp(App).use(IonicVue).use(router);

app.use(
  createAuth0({
    domain: "{yourDomain}",
    clientId: "{yourClientId}",
    useRefreshTokens: true,
    useRefreshTokensFallback: false,
    authorizationParams: {
      redirect_uri
    }
  })
);

router.isReady().then(() => {
  app.mount("#app");
});`;

<AuthCodeBlock children={codeExample} language="js" />

`createAuth0` プラグインは、次の props を受け取ります。

* `domain`: Auth0 Dashboard で作成したアプリケーションの「Settings（設定）」にある「domain」の値、または Auth0 の [Custom Domains 機能](https://auth0.com/docs/custom-domains) を使用している場合のカスタムドメイン
* `clientId`: Auth0 Dashboard で作成したアプリケーションの「Settings（設定）」にある「client ID」の値
* `useRefreshTokens`: auth0-vue を Android および iOS 上の Ionic と併用するには、リフレッシュトークンを有効にする必要があります。
* `useRefreshTokensFallback`: auth0-vue を Android および iOS 上の Ionic と併用するには、iframe フォールバックを無効にする必要があります。
* `authorizationParams.redirect_uri`: ユーザーが Auth0 で認証した後にリダイレクトしたい URL。

<Warning>
  アプリケーションを閉じて再度開いた後も認証状態を保持するには、SDK を構成する際に `cacheLocation` を `localstorage` に設定することを検討してください。ただし、[localstorage にトークンを保存することのリスク](https://auth0.com/docs/libraries/auth0-single-page-app-sdk#change-storage-options) に注意してください。また、Capacitor アプリでは、特定の状況下でデータが意図せず復元される可能性があるため、localstorage は **一時的** なものとして扱う必要があります。[Capacitor ドキュメントにおけるストレージに関するガイダンス](https://capacitorjs.com/docs/guides/storage#why-cant-i-just-use-localstorage-or-indexeddb) も必ずお読みください。

  さらに、この SDK には、より安全で永続的なストレージメカニズムを使用する必要がある場合に、トークンを保存するための[カスタムキャッシュ実装を使用する機能](https://github.com/auth0/auth0-spa-js/blob/master/EXAMPLES.md#creating-a-custom-cache)も備わっています。

  **注意**: トークンの保存に [Capacitor の Storage プラグイン](https://capacitorjs.com/docs/apis/storage) を使用することは推奨しません。このプラグインは iOS と Android でそれぞれ [UserDefaults](https://developer.apple.com/documentation/foundation/userdefaults) と [SharedPreferences](https://developer.android.com/reference/android/content/SharedPreferences) を基盤としているためです。これらの API を使用して保存されたデータは暗号化されず、安全ではなく、クラウドに同期される可能性もあります。
</Warning>

<Note>
  ### チェックポイント

  `createAuth0` プラグインを構成したので、アプリケーションを実行して SDK が正しく初期化されていること、また Auth0 に関連するエラーがアプリケーションで発生していないことを確認してください。
</Note>

<div id="add-login-to-your-application">
  ## アプリケーションにログイン機能を追加する
</div>

Capacitor アプリケーションでは、[Capacitor Browser プラグイン](https://capacitorjs.com/docs/apis/browser) が Auth0 の [Universal Login ページ](https://auth0.com/universal-login) へのリダイレクトを実行します。`loginWithRedirect` 関数の `openUrl` パラメータを設定して `Browser.open` を使用し、URL がデバイスのシステムブラウザーコンポーネント（iOS では [SFSafariViewController](https://developer.apple.com/documentation/safariservices/sfsafariviewcontroller)、Android では [Chrome Custom Tabs](https://developer.chrome.com/docs/android/custom-tabs)）で開かれるようにします。

<Info>
  デフォルトでは、SDK の `loginWithRedirect` メソッドは `window.location.href` を使用して、プラットフォームに適したシステムブラウザーコンポーネントではなく、ユーザーのデバイス上のデフォルトのブラウザーアプリケーション内でログインページに遷移します。その場合、ユーザーは認証のためにアプリケーションから離れることになり、ユーザー体験が最適でなくなる可能性があります。
</Info>

新しいファイル `LoginButton.vue` を追加し、次のコードを記述します。

```html lines
<template>
  <ion-button @click="login">ログイン</ion-button>
</template>

<script lang="ts">
import { defineComponent } from "vue";
import { IonApp, IonRouterOutlet } from "@ionic/vue";

import { useAuth0 } from "@auth0/auth0-vue";
import { App as CapApp } from "@capacitor/app";
import { Browser } from "@capacitor/browser";

export default defineComponent({
  components: {
    IonButton,
  },
  setup() {
    const { loginWithRedirect } = useAuth0();

    const login = async () => {
      await loginWithRedirect({
        openUrl: (url: string) =>
          Browser.open({
            url,
            windowName: "_self",
          }),
      });
    };

    return { login };
  },
});
</script>
```

このコンポーネントは次のことを行います。

* クリックするとユーザーをログインさせるシンプルなボタンを含むテンプレートを定義します
* `loginWithRedirect` を使用して、Auth0 の Universal Login ページでログインを行います
* `openUrl` コールバックを使用して Capacitor の Browser プラグインで URL を開き、ログインページをユーザーに表示します

<div id="handling-the-callback">
  ### コールバックの処理
</div>

ユーザーが Universal Login ページでログインを完了すると、カスタム URL スキームを持つ URL 経由でアプリにリダイレクトされます。`appUrlOpen` イベントはアプリ内で処理する必要があります。認証の state を初期化するために、Auth0 ソフトウェア開発キット (SDK) の `handleRedirectCallback` メソッドを呼び出すことができます。

このメソッドは、Auth0 からのリダイレクト時にのみ使用できます。成功したことを確認するには、URL に `code` と `state` パラメータが含まれているかどうかを確認します。

このイベントが発生したときには、`Browser.close()` メソッドを呼び出してブラウザーを閉じます。

メインの `App` コンポーネントに、次の Capacitor アプリケーションリスナーを追加します。

```html lines
<template>
  <ion-app>
    <ion-router-outlet />
  </ion-app>
</template>

<script lang="ts">
import { useAuth0 } from "@auth0/auth0-vue";
import { IonApp, IonRouterOutlet } from "@ionic/vue";
import { defineComponent } from "vue";
import { App as CapApp } from "@capacitor/app";
import { Browser } from "@capacitor/browser";

export default defineComponent({
  name: "App",
  components: {
    IonApp,
    IonRouterOutlet,
  },
  setup() {
    const { handleRedirectCallback } = useAuth0();

    // 'appUrlOpen' イベントを処理して `handleRedirectCallback` を呼び出す
    CapApp.addListener('appUrlOpen', async ({ url }) => {
      if (url.includes('state') && (url.includes('code') || url.includes('error'))) {
        await handleRedirectCallback(url);
      }
      // Android では何も行わない
      await Browser.close();
    });
  },
});
</script>
```

<Info>
  この記事では、アプリケーション内でコールバックを処理するために Custom URL Schemes を使用することを前提としています。これを行うには、選択したプラットフォームで `YOUR_PACKAGE_ID` を URL スキームとして登録してください。詳細については、iOS の場合は [Defining a Custom URL Scheme](https://developer.apple.com/documentation/xcode/defining-a-custom-url-scheme-for-your-app)、Android の場合は [Create Deep Links to App Content](https://developer.android.com/training/app-links/deep-linking) を参照してください。
</Info>

<Note>
  ### チェックポイント

  `LoginButton` コンポーネントをアプリケーションに追加し、`App` コンポーネントに &quot;appUrlOpen&quot; イベントのハンドラーを追加します。ログインボタンをクリックしたときに、アプリケーションが Auth0 Universal Login ページにリダイレクトされ、ユーザー名とパスワード、またはソーシャルプロバイダーを使ってログインまたはサインアップできることを確認してください。

  これが完了したら、Auth0 がアプリケーションに再度リダイレクトすることを確認してください。
</Note>

<div id="add-logout-to-your-application">
  ## アプリケーションにログアウト機能を追加する
</div>

ユーザーがログインできるようになったので、次に[ログアウトする方法](https://auth0.com/docs/logout/guides/logout-auth0)を設定する必要があります。ブラウザのセッションをクリアするには、ユーザーをブラウザで Auth0 のログアウトエンドポイントにリダイレクトする必要があります。ここでも、Capacitor の Browser プラグインを使用してこのリダイレクトを実行し、ユーザーがアプリを離れず、ユーザー体験が損なわれないようにします。

Ionic と Capacitor を Auth0 のソフトウェア開発キット (SDK) と組み合わせてこれを実現するには、次のようにします。

* ログアウト後に Auth0 がリダイレクト先として使用する、アプリ用の URL を作成します。これは、登録済みのカスタムスキームと Auth0 ドメインを使用する URL です。この URL を Auth0 Dashboard の **許可されたログアウトURL** 設定に追加します。
* `logout` を呼び出して SDK からログアウトし、リダイレクト URL を `logoutParams.returnTo` パラメーターとして渡します。
* `openUrl` パラメーターを、Capacitor の Browser プラグインを使用して `Browser.open` で URL を開くコールバックに設定します。

<Info>
  ログイン手順と同様に、`logout` を呼び出す際に `openUrl` を設定しない場合、SDK はデバイス上のデフォルトのブラウザアプリケーションを使用してユーザーをログアウト URL にリダイレクトしますが、これは最適とは言えないユーザー体験となります。
</Info>

新しいファイル `LogoutButton.vue` を作成し、次のコードをファイルに追加します。その後、`LogoutButton` コンポーネントをアプリに追加します。

```html lines
<template>
  <ion-button @click="onLogout">ログアウト</ion-button>
</template>

<script lang="ts">
import { defineComponent } from "vue";
import { useAuth0 } from "@auth0/auth0-vue";
import { Browser } from "@capacitor/browser";
import { IonButton } from "@ionic/vue";
import { callbackUri } from "../auth.config";

export default defineComponent({
  components: {
    IonButton,
  },
  setup() {
    const { logout } = useAuth0();

    const onLogout = async () => {
      await logout({
        logoutParams: {
          returnTo: callbackUri,
        },
        openUrl: (url: string) =>
          Browser.open({
            url,
            windowName: "_self",
          }),
      });
    };

    return {
      onLogout,
    };
  },
});
</script>
```

<Note>
  ### チェックポイント

  `LogoutButton` コンポーネントをアプリケーションに追加します。クリックしたときに、Ionic アプリケーションが「Settings」の「許可されたログアウトURL」の 1 つとして指定したアドレスにリダイレクトされ、アプリケーションからログアウトされていることを確認してください。
</Note>

<div id="show-user-profile-information">
  ## ユーザーのプロファイル情報を表示する
</div>

Auth0 Vue ソフトウェア開発キット (SDK) を使用すると、ログインしているユーザーに関連付けられている[プロファイル情報](https://auth0.com/docs/users/concepts/overview-user-profile)（名前やプロフィール写真など）を、ユーザーインターフェイスをパーソナライズするために必要な任意のコンポーネント内で、すばやく取得できます。プロファイル情報には、`useAuth0()` composable が公開する `user` プロパティからアクセスできます。次の `UserProfile` コンポーネントは、その使用方法の例です。

```html lines
<template>
  <div v-if="isLoading">読み込み中...</div>
  <div v-else-if="!user"></div>
  <div v-else class="profile-container">
    <ion-avatar>
      <Frame><img :src="user.picture" :alt="user.name" /></Frame>
    </ion-avatar>
    <h2>{{ user.name }}</h2>
    <p>{{ user.email }}</p>
  </div>
</template>

<script lang="ts">
import { defineComponent } from "vue";
import { useAuth0 } from "@auth0/auth0-vue";
import { IonAvatar } from "@ionic/vue";

export default defineComponent({
  components: {
    IonAvatar,
  },
  setup() {
    const { user, isLoading } = useAuth0();

    return { user, isLoading };
  },
});
</script>
```

The `user` プロパティには、ユーザーのアイデンティティに関する機密性の高い情報や関連アーティファクトが含まれます。そのため、その利用可能性はユーザーの認証状態に依存します。レンダリング時のエラーを防ぐため、Vue が `user` プロパティを利用するコンポーネントをレンダリングする前に、`useAuth0()` の `isAuthenticated` プロパティを使って、Auth0 がユーザーを認証済みかどうかを確認してください。また、`isAuthenticated` プロパティにアクセスする前に、`isLoading` が `false` であることを確認し、ソフトウェア開発キット (SDK) の読み込みが完了していることを確認してください。

<Note>
  ### チェックポイント

  `UserProfile` コンポーネントをアプリケーションに追加し、ログイン後にコンポーネント内で `user.name` または [その他の `user` プロパティ](https://auth0.com/docs/users/references/user-profile-structure#user-profile-attributes) を正しく表示できることを確認してください。
</Note>

<Info>
  ##### 次にできること

  <table>
    <tr>
      <td><a href="/docs/ja-JP/authenticate/identity-providers">他のアイデンティティ プロバイダーを設定する</a></td>
      <td><a href="/docs/ja-JP/secure/multi-factor-authentication">多要素認証を有効にする</a></td>
    </tr>

    <tr>
      <td><a href="/docs/ja-JP/secure/attack-protection">攻撃保護について学ぶ</a></td>
      <td><a href="/docs/ja-JP/customize/rules">Rules について学ぶ</a></td>
    </tr>
  </table>

  [GitHub で編集する](https://github.com/auth0/docs/edit/master/articles/quickstart/backend/aspnet-core-webapi/01-authorization.md)
</Info>
