---
title: Capacitor を使用した Ionic Angular アプリケーションにログイン機能を追加する
sidebarTitle: Ionic & Capacitor (Angular)

---

import { Recipe, Content, Section, SideMenu, SideMenuSectionItem, SignUpForm } from "/snippets/ja-JP/recipe.jsx";
import { LoggedInForm } from "/snippets/ja-JP/Login.jsx";
import AppModule from "/snippets/ja-JP/quickstart/native/ionic-angular/app.module.ts.mdx";
import AppComponent from "/snippets/ja-JP/quickstart/native/ionic-angular/app.component.ts.mdx";
import Loginbutton from "/snippets/ja-JP/quickstart/native/ionic-angular/login-button.ts.mdx";
import Logoutbutton from "/snippets/ja-JP/quickstart/native/ionic-angular/logout-button.ts.mdx";
import Userprofile from "/snippets/ja-JP/quickstart/native/ionic-angular/user-profile.ts.mdx";

import {AuthCodeGroup} from "/snippets/ja-JP/AuthCodeGroup.jsx";

export const sections = [
  { id: "getting-started", title: "はじめに" },
  { id: "configure-auth0", title: "Auth0 を構成する" },
  { id: "install-the-auth0-angular-sdk", title: "Auth0 Angular ソフトウェア開発キット (SDK) をインストールする" },
  { id: "register-and-configure-the-authentication-module", title: "認証モジュールを登録して構成する" },
  { id: "add-login-to-your-application", title: "アプリケーションにログイン機能を追加する" },
  { id: "handling-the-login-callback", title: "ログインコールバックを処理する" },
  { id: "add-logout-to-your-application", title: "アプリケーションにログアウト機能を追加する" },
  { id: "show-the-user-profile", title: "ユーザー プロファイルを表示する" }
]

<Recipe isSingleColumn>
  <Content>
    Auth0を使用すると、アプリケーションに認証を迅速に追加し、ユーザープロファイル情報にアクセスできます。このガイドでは、[Auth0 Angular SDK](https://github.com/auth0/auth0-angular)を使用して、Auth0をIonic (Angular) &amp; Capacitorアプリケーションに統合する方法を説明します。

    <Section id={sections[0].id} title={sections[0].title} stepNumber="1" isSingleColumn>
      このクイックスタートでは、すでに [Capacitor](https://capacitorjs.com/) を使用した [Ionic](https://ionicframework.com/) アプリケーションが動作していることを前提としています。まだ用意していない場合は、シンプルなアプリから始めるには [Using
      Capacitor with Ionic Framework guide](https://capacitorjs.com/docs/getting-started/with-ionic) を参照するか、[our sample
      apps](https://github.com/auth0-samples/auth0-ionic-samples) をクローンしてください。

      また、[Capacitor development workflow](https://capacitorjs.com/docs/basics/workflow) にも慣れておいてください。

      <LoggedInForm />
    </Section>

    <Section id={sections[1].id} title={sections[1].title} stepNumber="2" isSingleColumn>
      Auth0 のサービスを使用するには、Auth0 Dashboard でアプリケーションを設定しておく必要があります。Auth0 アプリケーションは、
      プロジェクトで認証をどのように動作させるかを設定する場所です。

      <Info>
        この記事全体を通して、`YOUR_PACKAGE_ID` はアプリケーションのパッケージ ID を指します。これは
        `capacitor.config.ts` ファイル内の `appId` フィールドで確認および設定できます。詳細は
        [Capacitor&#39;s Config schema](https://capacitorjs.com/docs/config#schema) を参照してください。
      </Info>

      ### アプリケーションを設定する

      インタラクティブ セレクターを使用して新しい Auth0 アプリケーションを作成するか、統合したいプロジェクトを表す既存のアプリケーションを選択します。
      Auth0 内の各アプリケーションには英数字で構成された一意のクライアント ID が割り当てられており、
      アプリケーションのコードはこのクライアント ID を使用してソフトウェア開発キット (SDK) 経由で Auth0 API を呼び出します。

      このクイックスタートで設定した内容はすべて、[Dashboard](https://manage.auth0.com/#/) 上の該当アプリケーションに自動的に反映されます。
      今後もここからアプリケーションを管理できます。

      より完全な設定例を確認したい場合は、サンプルアプリケーションを参照してください。

      ### コールバック URL を設定する

      コールバック URL は、ユーザーが認証を完了した後に Auth0 からリダイレクトしたい、
      アプリケーション内の URL です。設定されていない場合、ユーザーはログイン後にアプリケーションへ戻ることができません。

      <Info>
        サンプルプロジェクトに沿って進めている場合は、次の値を設定してください。

        `YOUR_PACKAGE_ID://{yourDomain}/capacitor/YOUR_PACKAGE_ID/callback`
      </Info>

      ### ログアウト URL を設定する

      ログアウト URL は、ユーザーがログアウトした後に Auth0 からリダイレクトしたい、
      アプリケーション内の URL です。設定されていない場合、ユーザーはアプリケーションからログアウトできず、エラーが返されます。

      <Info>
        サンプルプロジェクトに沿って進めている場合は、次の値を設定してください。

        `YOUR_PACKAGE_ID://{yourDomain}/capacitor/YOUR_PACKAGE_ID/callback`
      </Info>

      ### 許可されたオリジンを設定する

      ネイティブアプリケーションから Auth0 へリクエストを送信できるようにするには、
      [Application Settings](https://manage.auth0.com/#/applications/\{yourClientId}/settings) で次の **Allowed Origins** を設定します。

      <Info>
        サンプルプロジェクトに沿って進めている場合は、
        iOS と Android それぞれに対して `capacitor://localhost, http://localhost` を設定してください。
      </Info>

      最後に、[Application Settings](https://manage.auth0.com/#/applications/\{yourClientId}/settings) で、アプリケーションの **Application Type** が **Native** に設定されていることを確認してください。

      <LoggedInForm />
    </Section>

    <Section id={sections[2].id} title={sections[2].title} stepNumber="3" isSingleColumn>
      プロジェクトディレクトリで次のコマンドを実行して、Auth0 Angular ソフトウェア開発キット (SDK) をインストールします。

      ```bash
      npm install @auth0/auth0-angular
      ```

      ソフトウェア開発キット (SDK) は、モジュールや認証サービスを含め、Angular アプリケーションに Auth0 を自然な形で統合するのに役立つ、いくつかの型を提供します。

      ### Capacitor プラグインをインストールする

      このクイックスタートとサンプルでは、Capacitor の公式プラグインをいくつか使用します。以下のコマンドで、これらをアプリにインストールします。

      ```bash
      npm install @capacitor/browser @capacitor/app
      ```

      * [@capacitor/browser](https://capacitorjs.com/docs/apis/browser): デバイスのシステムブラウザーと連携し、Auth0 の認可エンドポイントへの URL を開くために使用します。
      * [@capacitor/app](https://capacitorjs.com/docs/apis/app): アプリの高レベルのイベントを購読でき、Auth0 からのコールバックを処理する際に役立ちます。

      <Info>
        iOS 上の Capacitor の Browser プラグインは [SFSafariViewController](https://developer.apple.com/documentation/safariservices/sfsafariviewcontroller) を使用しますが、これは iOS 11 以降ではデバイス上の Safari と Cookie を共有しません。これは、これらのデバイスでは SSO が機能しないことを意味します。SSO が必要な場合は、代わりに [ASWebAuthenticationSession](https://developer.apple.com/documentation/authenticationservices/aswebauthenticationsession) を使用する互換性のあるプラグインを使用してください。
      </Info>

      <LoggedInForm />
    </Section>

    <Section id={sections[3].id} title={sections[3].title} stepNumber="4" isSingleColumn>
      ソフトウェア開発キット (SDK) は、SDK の動作に必要なすべてのサービスを含むモジュールである `AuthModule` をエクスポートします。このモジュールをアプリケーションに登録し、Auth0 のドメインとクライアントID で設定する必要があります。

      `AuthModule.forRoot` 関数は、次の設定を受け取ります。

      * `domain`: Auth0 Dashboard で作成したアプリケーションの **Settings** セクションにある `domain` の値、または Auth0 のカスタムドメイン機能を使用している場合はカスタムドメイン。
      * `clientId`: Auth0 Dashboard で作成したアプリケーションの **Settings** セクションにある Client ID の値。
      * `useRefreshTokens`: auth0-angular を Android および iOS 上の Ionic と併用するには、
        リフレッシュトークンを有効にする必要があります。
      * `useRefreshTokensFallback`: auth0-angular を Android および iOS 上の Ionic と併用するには、
        iframe フォールバックを無効にする必要があります。
      * `authorizationParams.redirect_uri`: ユーザーが Auth0 で認証を完了した後にリダイレクトする URL。

      <Info>
        アプリケーションを閉じて再度開いた後も認証状態を保持するには、SDK を設定するときに
        `cacheLocation` を `localstorage` に設定することを検討できます。ただし、
        [localstorage にトークンを保存することのリスク](/docs/ja-JP/libraries/auth0-single-page-app-sdk#change-storage-options) に注意してください。また、Capacitor アプリでは、特定の状況下で
        データが予期せず復元される可能性があるため、localstorage は **一時的** なものとして扱う必要があります。Capacitor ドキュメントの [ストレージに関するガイダンス](https://capacitorjs.com/docs/guides/storage#why-cant-i-just-use-localstorage-or-indexeddb) を必ずお読みください。

        さらに、より安全で永続的なストレージメカニズムを使用する必要がある場合は、SDK にはトークンを保存するために
        [カスタムキャッシュ実装を使用する](https://github.com/auth0/auth0-spa-js/blob/master/EXAMPLES.md#creating-a-custom-cache) 機能があります。

        また、トークンの保存に [Capacitor の Storage プラグイン](https://capacitorjs.com/docs/apis/storage) を使用することは **推奨しません**。
        これは iOS と Android でそれぞれ [UserDefaults](https://developer.apple.com/documentation/foundation/userdefaults) と [SharedPreferences](https://developer.android.com/reference/android/content/SharedPreferences) を基盤としているためです。これらの API を使用して保存されたデータは暗号化されておらず、
        安全ではなく、クラウドと同期される可能性もあります。
      </Info>

      <Note>
        ##### チェックポイント

        Auth0 Angular SDK でアプリケーションを構成したら、アプリケーションを実行し、SDK がエラーなく初期化されていること、
        そしてアプリケーションが以前と同様に動作していることを確認してください。
      </Note>

      <AuthCodeGroup>
        <AppModule />

        <AppComponent />

        <Loginbutton />

        <Logoutbutton />

        <Userprofile />
      </AuthCodeGroup>
    </Section>

    <Section id={sections[4].id} title={sections[4].title} stepNumber="5" isSingleColumn>
      Capacitor アプリケーションでは、[Capacitor の Browser プラグイン](https://capacitorjs.com/docs/apis/browser)が Auth0 の [Universal Login ページ](https://auth0.com/universal-login) へのリダイレクトを実行します。`loginWithRedirect` 関数の `openUrl`
      パラメーターを設定して `Browser.open` を使用し、URL がデバイスのシステムブラウザーコンポーネント（iOS では [SFSafariViewController](https://developer.apple.com/documentation/safariservices/sfsafariviewcontroller)、Android では [Chrome
      Custom Tabs](https://developer.chrome.com/docs/android/custom-tabs)）で開かれるようにします。

      <Info>
        デフォルトでは、SDK の `loginWithRedirect` メソッドは `window.location.href` を使用して、
        プラットフォームに適したシステムブラウザーコンポーネントではなく、ユーザーのデバイス上のデフォルトのブラウザーアプリケーションでログインページへ
        遷移します。ユーザーは認証のためにアプリケーションを離れることになり、ユーザーエクスペリエンスが最適でなくなる可能性があります。
      </Info>

      <Note>
        ##### チェックポイント

        `loginWithRedirect` 関数は、`openUrl` パラメーターを設定して `Browser.open` 関数を使用することで、
        プラットフォームのシステムブラウザーコンポーネントでログイン URL を開くようにし、SDK にログインフローの開始を指示します。これにより、ユーザーは
        アプリケーションにログインできるようになります。ユーザーは Auth0 のログインページにリダイレクトされ、エラーは発生しません。
      </Note>

      <AuthCodeGroup>
        <Loginbutton />

        <AppModule />

        <AppComponent />

        <Logoutbutton />

        <Userprofile />
      </AuthCodeGroup>
    </Section>

    <Section id={sections[5].id} title={sections[5].title} stepNumber="6" isSingleColumn>
      ユーザーが Universal Login Page でログインすると、カスタム URL スキームを持つ URL 経由でアプリにリダイレクトされます。`appUrlOpen` イベントはアプリ内で処理する必要があります。Auth0 ソフトウェア開発キット (SDK) の `handleRedirectCallback` メソッドを呼び出して、認証状態を初期化できます。

      このメソッドは、Auth0 からのリダイレクト時にのみ使用できます。成功したことを確認するには、URL 内に `code` と `state` パラメータが存在するか確認してください。

      このイベントが発生したときは、`Browser.close()` メソッドによってブラウザを閉じる必要があります。

      `appUrlOpen` イベントのコールバックは `ngZone.run` でラップされていることに注意してください。`handleRedirectCallback` が実行される際に発生する observable への変更は、Angular アプリによって検出されます。詳細については、[Using Angular with Capacitor](https://capacitorjs.com/docs/guides/angular) を参照してください。そうしないと、ログイン後に認証済みの状態を表示するように画面が更新されません。

      <Info>
        この記事では、アプリケーション内でコールバックを処理するために Custom URL Schemes を使用することを前提としています。そのためには、使用するプラットフォーム向けに `YOUR_PACKAGE_ID` を URL スキームとして登録してください。詳細については、iOS の場合は [Defining a Custom URL Scheme](https://developer.apple.com/documentation/xcode/defining-a-custom-url-scheme-for-your-app)、Android の場合は [Create Deep Links to App Content](https://developer.android.com/training/app-links/deep-linking) を参照してください。
      </Info>

      <Note>
        ##### チェックポイント

        `appUrlOpen` をアプリケーションの `App` コンポーネントに追加してログインしてください。ユーザーが認証されてアプリにログインすると、ブラウザウィンドウが閉じるはずです。
      </Note>

      <AuthCodeGroup>
        <AppComponent />

        <AppModule />

        <Loginbutton />

        <Logoutbutton />

        <Userprofile />
      </AuthCodeGroup>
    </Section>

    <Section id={sections[6].id} title={sections[6].title} stepNumber="7" isSingleColumn>
      ユーザーがログインできるようになったので、ログアウトする手段を設定する必要があります。ユーザーのブラウザーセッションをクリアするには、ブラウザーで Auth0 のログアウトエンドポイントにリダイレクトしなければなりません。ここでも、
      ユーザーがアプリを離れてしまって最適でない体験にならないように、Capacitor の Browser プラグインを使ってこのリダイレクトを実行する必要があります。

      Auth0 SDK と組み合わせて Ionic と Capacitor を使ってこれを実現するには、次のようにします。

      * Auth0 がログアウト後のリダイレクト先として使用する、アプリ用の URL を構成します。これは、登録済みのカスタムスキームと Auth0 ドメインを使用する URL です。この URL を
        Auth0 Dashboard の **許可されたログアウトURL** 設定に追加します。
      * `logout` を呼び出して SDK からログアウトし、リダイレクト URL を `logoutParams.returnTo` パラメータとして渡します。
      * `openUrl` パラメータに、Capacitor の Browser プラグインを使用して `Browser.open` で URL を開くコールバックを設定します。

      <Info>
        ログイン手順と同様に、`logout` を呼び出す際に `openUrl` を設定しない場合、
        SDK はデバイス上のデフォルトのブラウザーアプリケーションを使用してユーザーをログアウト URL にリダイレクトします。この場合、
        ユーザー体験としては最適ではありません。
      </Info>

      <Note>
        ##### チェックポイント

        ユーザーがアプリケーションからログアウトできる手段を提供します。Auth0 へのリダイレクトと、その後
        `returnTo` パラメータで指定したアドレスへのリダイレクトを確認します。ユーザーがアプリケーションに
        もうログインしていないことを必ず確認してください。
      </Note>

      <AuthCodeGroup>
        <Logoutbutton />

        <AppModule />

        <AppComponent />

        <Loginbutton />

        <Userprofile />
      </AuthCodeGroup>
    </Section>

    <Section id={sections[7].id} title={sections[7].title} stepNumber="8" isSingleColumn>
      Auth0 ソフトウェア開発キット (SDK) は、ログイン中のユーザーに関連付けられたプロファイル情報（名前やプロフィール画像など）を、ユーザーインターフェースをパーソナライズするために必要なコンポーネント内で取得します。このプロファイル情報は、`AuthService` が公開している `user$` プロパティを通じて利用できます。

      <Note>
        ##### チェックポイント

        アプリ内でユーザーが自分のプロファイルの詳細を確認できるようにし、ログイン後に画面上で自分のプロファイル情報を取得して表示できることを確認してください。
      </Note>

      <AuthCodeGroup>
        <Userprofile />

        <AppModule />

        <AppComponent />

        <Loginbutton />

        <Logoutbutton />
      </AuthCodeGroup>
    </Section>

    ## 次のステップ

    素晴らしい!ここまで進めたなら、アプリケーションでログイン、ログアウト、およびユーザープロファイル情報が実装されているはずです。

    これでクイックスタートチュートリアルは終了ですが、他にも多くの機能があります。Auth0でできることの詳細については、以下をご確認ください:

    * [Auth0 Dashboard](https://manage.auth0.com/dashboard/us/dev-gja8kxz4ndtex3rq) - Auth0 テナントとアプリケーションの設定・管理方法を学ぶ
    * [Auth0 Marketplace](https://marketplace.auth0.com/) - Auth0 の機能を拡張できる連携機能を見つける
  </Content>
</Recipe>