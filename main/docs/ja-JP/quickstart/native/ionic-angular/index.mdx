---
title: "Ionic & Capacitor（Angular）"
permalink: "01-login"
---

import {AuthCodeBlock} from "/snippets/ja-JP/AuthCodeBlock.jsx";

<div id="by-steve-hobbs">
  ##### 作成者: Steve Hobbs
</div>

このチュートリアルでは、Auth0 を使用して Ionic Angular &amp; Capacitor アプリケーションにユーザーのログイン機能を追加する方法を説明します。アカウント用に構成されたサンプルとあわせてこのクイックスタートを進められるよう、あらかじめログインしておくことをおすすめします。

{/* <Card title="GitHub で表示" href="https://github.com/auth0-samples/auth0-ionic-samples/tree/main/angular" icon="github">
  システム要件：Node および npm (LTS) | Xcode 12 以上（iOS 用）| Android Studio 4 以上（Android 用）
  </Card> */}

<div id="getting-started">
  ## はじめに
</div>

このクイックスタートでは、すでに [Ionic](https://ionicframework.com/) アプリケーションが [Capacitor](https://capacitorjs.com/) とともに動作していることを前提としています。まだ準備できていない場合は、シンプルなアプリから始めるために [Using Capacitor with Ionic Framework ガイド](https://capacitorjs.com/docs/getting-started/with-ionic) を参照するか、[サンプルアプリ](https://github.com/auth0-samples/auth0-ionic-samples) をクローンしてください。

また、[Capacitor の開発ワークフロー](https://capacitorjs.com/docs/basics/workflow) にも慣れておく必要があります。

<Info>
  **認証は初めてですか？** [Auth0 の仕組み](/docs/ja-JP/get-started/auth0-overview)、[ネイティブアプリケーションとの統合方法](/docs/ja-JP/get-started/architecture-scenarios/mobile-api)、および使用される[プロトコル](/docs/ja-JP/get-started/authentication-and-authorization-flow/authorization-code-flow-with-pkce)について学んでください。
</Info>

<div id="configure-auth0">
  ## Auth0 を設定する
</div>

<div id="get-your-application-keys">
  ### アプリケーションキーを取得する
</div>

Auth0 にサインアップすると、新しいアプリケーションが自動的に作成されるか、または自分で新しいアプリケーションを作成できます。Auth0 と通信するには、そのアプリケーションに関するいくつかの設定情報が必要です。これらの情報は Auth0 Dashboard の [Application Settings](https://manage.auth0.com/#/applications) セクションで確認できます。

<Frame>![App Dashboard](https://cdn2.auth0.com/docs/1.14550.0/media/articles/dashboard/client_settings.png)</Frame>

<Info>
  Default App をネイティブアプリケーションまたはシングルページアプリケーションで使用する場合は、**Token Endpoint Authentication Method** を `None` に変更し、**Application Type** を `SPA` または `Native` に設定してください。
</Info>

次の情報が必要です:

* **Domain**
* **Client ID**

<Info>
  このページの先頭からサンプルをダウンロードした場合は、これらの情報はあらかじめ入力されています。
</Info>

<div id="configure-callback-urls">
  ### コールバックURLを設定する
</div>

コールバックURLは、ユーザーが認証を完了した後に、Auth0 がユーザーをリダイレクトするアプリケーション内のURLです。アプリのコールバックURLは、[Application Settings](https://manage.auth0.com/#/applications) の **Allowed Callback URLs** フィールドに追加する必要があります。このフィールドが設定されていない場合、ユーザーはアプリケーションにログインできず、エラーが表示されます。

<Info>
  本記事全体を通して、`YOUR_PACKAGE_ID` はアプリケーションのパッケージIDを指します。これは `capacitor.config.ts` ファイル内の `appId` フィールドで確認および設定できます。詳細は [Capacitors Config schema](https://capacitorjs.com/docs/config#schema) を参照してください。
</Info>

Auth0 Dashboard の [Application Settings](https://manage.auth0.com/#/applications/\{yourClientId}/settings) セクションに移動し、**Allowed Callback URLs** ボックスに **Callback URL** を設定します。

**Allowed Callback URL** には次の値を設定します。

```
YOUR_PACKAGE_ID://{yourDomain}/capacitor/YOUR_PACKAGE_ID/callback
```

<div id="configure-logout-urls">
  ### ログアウトURLを設定する
</div>

ログアウトURLは、ユーザーが認可サーバーからログアウトされた後に、Auth0 がリダイレクト先として戻るアプリケーション内の URL です。これは `returnTo` クエリパラメーターで指定します。アプリのログアウトURLは、[Application Settings](https://manage.auth0.com/#/applications) 内の **許可されたログアウトURL** フィールドに追加しておく必要があります。このフィールドが設定されていない場合、ユーザーはアプリケーションからログアウトできず、エラーが発生します。

**許可されたログアウトURL** には次の値を設定してください。

```
YOUR_PACKAGE_ID://{yourDomain}/capacitor/YOUR_PACKAGE_ID/callback
```

<div id="configure-origins">
  ### オリジンの設定
</div>

アプリケーションから Auth0 にリクエストを送信できるようにするには、[Application Settings](https://manage.auth0.com/#/applications/\{yourClientId}/settings) で次の **Allowed Origins** を設定してください。

```
capacitor://localhost, http://localhost
```

これらのオリジンは、iOS 用と Android 用にそれぞれ必要です。

最後に、アプリケーションの **Application Type** が、[Application Settings](https://manage.auth0.com/#/applications/\{yourClientId}/settings) で **Native** に設定されていることを必ず確認してください。

<div id="install-the-auth0-angular-sdk">
  ## Auth0 Angular ソフトウェア開発キット (SDK) をインストールする
</div>

プロジェクトディレクトリで次のコマンドを実行して、Auth0 Angular ソフトウェア開発キット (SDK) をインストールします。

```bash lines
npm install @auth0/auth0-angular
```

このソフトウェア開発キット (SDK) は、モジュールや認証サービスなど、Auth0 を Angular アプリケーションに自然な形で統合するのに役立つ複数の型を公開しています。

<div id="install-capacitor-plugins">
  ### Capacitor プラグインをインストールする
</div>

このクイックスタートとサンプルアプリでは、いくつかの Capacitor 公式プラグインを使用します。次のコマンドを使用して、これらをアプリにインストールします。

```bash lines
npm install @capacitor/browser @capacitor/app
```

* [`@capacitor/browser`](https://capacitorjs.com/docs/apis/browser) - デバイスのシステムブラウザーと連携し、Auth0 の認可エンドポイントの URL を開くために使用されます
* [`@capacitor/app`](https://capacitorjs.com/docs/apis/app) - アプリの高レベルなイベントを購読でき、Auth0 からのコールバックを処理する際に便利です

<Info>
  iOS 上の Capacitor の Browser プラグインは [`SFSafariViewController`](https://developer.apple.com/documentation/safariservices/sfsafariviewcontroller) を使用しますが、iOS 11 以降ではデバイス上の Safari と Cookie を共有しません。そのため、これらのデバイスでは [SSO](https://auth0.com/docs/sso) は機能しません。SSO が必要な場合は、代わりに [ASWebAuthenticationSession](https://developer.apple.com/documentation/authenticationservices/aswebauthenticationsession) を使用する互換性のあるプラグインを利用してください。
</Info>

<div id="configure-your-app-module">
  ### App モジュールを設定する
</div>

ソフトウェア開発キット (SDK) は `AuthModule` をエクスポートします。これは、SDK が動作するために必要なすべてのサービスを提供するモジュールです。これをアプリケーションに登録するには、次のようにします。

* `app.module.ts` ファイルを開きます
* `@auth0/auth0-angular` パッケージから `AuthModule` 型をインポートします
* `AuthModule.forRoot` を呼び出してアプリケーションに `AuthModule` を追加し、アプリケーションモジュールの `imports` 配列に含めます
* Auth0 Angular SDK の設定を行います

export const codeExample1 = `// SDK から型をインポートする
import { AuthModule } from '@auth0/auth0-angular';
import config from '../../capacitor.config';

// ..

// Auth0 がリダイレクトで戻ってくる先の URL を組み立てる
const redirect_uri = \`\${config.appId}://{yourDomain}/capacitor/\${config.appId}/callback\`;

// AuthModule を AppModule に登録する
@NgModule({
  declarations: [AppComponent],
  entryComponents: [],
  imports: [
    BrowserModule,
    IonicModule.forRoot(),
    AppRoutingModule,
    AuthModule.forRoot({
      domain: "{yourDomain}",
      clientId: "{yourClientId}",
      useRefreshTokens: true,
      useRefreshTokensFallback: false,
      authorizationParams: {
        redirect_uri,
      }
    }),
  ],
  providers: [{ provide: RouteReuseStrategy, useClass: IonicRouteStrategy }],
  bootstrap: [AppComponent],
})`;

<AuthCodeBlock children={codeExample1} language="javascript" />

`AuthModule.forRoot` 関数は、次の設定を受け取ります。

* `domain`: Auth0 Dashboard で作成したアプリケーションの「Settings」タブに表示されている「domain」の値、または Auth0 の [Custom Domains 機能](https://auth0.com/docs/custom-domains)を使用している場合はカスタムドメイン
* `clientId`: Auth0 Dashboard で作成したアプリケーションの「Settings」タブに表示されている「client ID」の値
* `useRefreshTokens`: Android および iOS 上の Ionic で auth0-angular を使用するには、リフレッシュトークンを有効にする必要があります。
* `useRefreshTokensFallback`: Android および iOS 上の Ionic で auth0-angular を使用するには、iframe フォールバックを無効にする必要があります。
* `authorizationParams.redirect_uri`: ユーザーが Auth0 で認証した後にリダイレクトしたい URL。

<Warning>
  アプリケーションを閉じて再度開いた後も認証状態を保持するには、SDK を構成する際に `cacheLocation` を `localstorage` に設定したくなるかもしれませんが、[localstorage にトークンを保存することのリスク](https://auth0.com/docs/libraries/auth0-single-page-app-sdk#change-storage-options)を十分に理解してください。また、Capacitor アプリでは、特定の状況でデータが予期せず復元される可能性があるため、localstorage は **一時的なもの** として扱う必要があります。[Capacitor ドキュメントのストレージに関するガイダンス](https://capacitorjs.com/docs/guides/storage#why-cant-i-just-use-localstorage-or-indexeddb)も参照してください。

  さらに、より安全で永続的なストレージ機構を使用する必要がある場合、SDK にはトークンを保存するために[カスタムキャッシュ実装を使用](https://github.com/auth0/auth0-spa-js/blob/master/EXAMPLES.md#creating-a-custom-cache)する機能も用意されています。

  **注**: トークンの保存に [Capacitor の Storage プラグイン](https://capacitorjs.com/docs/apis/storage)を使用することは **推奨しません**。このプラグインは iOS では [UserDefaults](https://developer.apple.com/documentation/foundation/userdefaults)、Android では [SharedPreferences](https://developer.android.com/reference/android/content/SharedPreferences) を基盤としているためです。これらの API を使って保存されたデータは暗号化されず、安全ではなく、クラウドに同期される可能性もあります。
</Warning>

<Note>
  ### チェックポイント

  Auth0 Angular SDK でアプリを構成できたので、アプリケーションを実行して、SDK がエラーなく初期化されていることと、アプリケーションが以前と同様に動作していることを確認してください。
</Note>

<div id="add-login-to-your-application">
  ## アプリケーションにログイン機能を追加する
</div>

Capacitor アプリケーションでは、[Capacitor Browser プラグイン](https://capacitorjs.com/docs/apis/browser) が Auth0 の [Universal Login Page](https://auth0.com/universal-login) へのリダイレクトを実行します。`loginWithRedirect` 関数の `openUrl` パラメータを設定し、`Browser.open` を使用して、URL がデバイスのシステムブラウザーコンポーネント（iOS では [SFSafariViewController](https://developer.apple.com/documentation/safariservices/sfsafariviewcontroller)、Android では [Chrome Custom Tabs](https://developer.chrome.com/docs/android/custom-tabs)）で開かれるようにします。

<Info>
  既定では、SDK の `loginWithRedirect` メソッドは `window.location.href` を使用して、プラットフォームに適したシステムブラウザーコンポーネントではなく、ユーザーのデバイス上の既定のブラウザーアプリケーションでログインページへ遷移します。その場合、ユーザーはあなたのアプリケーションから離れて認証を行うことになり、ユーザーエクスペリエンスが最適でなくなる可能性があります。
</Info>

次のコードを使用して、アプリケーションに新しい `LoginButton` コンポーネントを追加します。

```javascript lines
import { Component, OnInit } from '@angular/core';
import { AuthService } from '@auth0/auth0-angular';
import { Browser } from '@capacitor/browser';
import { mergeMap } from 'rxjs/operators';

@Component({
  selector: 'app-login-button',
  template: `<ion-button (click)="login()">Login</ion-button>`,
})
export class LoginButtonComponent {
  constructor(public auth: AuthService) {}

  login() {
    this.auth
      .loginWithRedirect({
        async openUrl(url: string) {
          await Browser.open({ url, windowName: '_self' });
        }
      })
      .subscribe();
  }
}
```

このコンポーネントは次のことを行います。

* クリック時にユーザーをログインさせるシンプルなボタンを含むテンプレートを定義します
* `loginWithRedirect` を使用して、Auth0 の Universal Login ページでログイン処理を行います
* `openUrl` コールバックを使って、Capacitor の Browser プラグインで URL を開き、ユーザーにログインページを表示します

<div id="handling-the-callback">
  ### コールバックの処理
</div>

ユーザーが Universal Login ページでログインすると、カスタム URL スキームを持つ URL 経由でアプリにリダイレクトされます。`appUrlOpen` イベントをアプリ内で処理する必要があります。Auth0 のソフトウェア開発キット (SDK) から `handleRedirectCallback` メソッドを呼び出して、認証 state を初期化できます。

このメソッドは、Auth0 からのリダイレクト時にのみ使用してください。成功を確認するには、URL に `code` と `state` パラメーターが存在するかを確認してください。

`Browser.close()` メソッドは、このイベントが発生したときにブラウザーを閉じる必要があります。

`App` コンポーネントを変更し、`ngOnInit` メソッドを使用して Auth0 からのコールバックを処理します。

export const codeExample2 = `import { Component, OnInit, NgZone } from '@angular/core';
import { AuthService } from '@auth0/auth0-angular';
import { mergeMap } from 'rxjs/operators';
import { Browser } from '@capacitor/browser';
import { App } from '@capacitor/app';

const callbackUri = \`\${config.appId}://{yourDomain}/capacitor/\${config.appId}/callback\`;

@Component({
  selector: 'app-root',
  templateUrl: 'app.component.html',
  styleUrls: ['app.component.scss'],
})
export class AppComponent implements OnInit {
  // Auth0 Angular ソフトウェア開発キット (SDK) から AuthService モジュールをインポートします
  constructor(public auth: AuthService, private ngZone: NgZone) {}

  ngOnInit(): void {
    // Capacitor の App プラグインを使用して \`appUrlOpen\` イベントをリッスンします
    App.addListener('appUrlOpen', ({ url }) => {
      // Angular が変更を検知できるように、NgZone 内で処理を実行する必要があります
      // https://capacitorjs.com/docs/guides/angular
      ngZone.run(() => {
        if (url?.startsWith(callbackUri)) {
          // URL が認証コールバック URL の場合...
          if (
            url.includes('state=') &&
            (url.includes('error=') || url.includes('code='))
          ) {
            // handleRedirectCallback を呼び出してブラウザーを閉じます
            this.auth
              .handleRedirectCallback(url)
              .pipe(mergeMap(() => Browser.close()))
              .subscribe();
          } else {
            Browser.close();
          }
        }
      });
    });
  }
}`;

<AuthCodeBlock children={codeExample2} language="javascript" />

`appUrlOpen` イベントコールバックは `ngZone.run` でラップされています。これは、`handleRedirectCallback` の実行時に発生する Observable の変更が Angular アプリに正しく反映されることを意味します。詳しくは、[Using Angular with Capacitor](https://capacitorjs.com/docs/guides/angular) を参照してください。そうしないと、ログイン後に認証済みの状態を表示するために画面が更新されません。

<Info>
  この記事では、アプリケーション内でコールバックを処理するために Custom URL Schemes を使用することを前提としています。そのためには、選択したプラットフォーム向けに `YOUR_PACKAGE_ID` を URL スキームとして登録してください。詳しくは、iOS 向けの [Defining a Custom URL Scheme](https://developer.apple.com/documentation/xcode/defining-a-custom-url-scheme-for-your-app)、または Android 向けの [Create Deep Links to App Content](https://developer.android.com/training/app-links/deep-linking) を参照してください。
</Info>

<Note>
  ### チェックポイント

  `LoginButton` コンポーネントをアプリケーションに追加し、`App` コンポーネントに &quot;appUrlOpen&quot; イベントのハンドラーも追加してください。ログインボタンをクリックしたときに、アプリケーションが Auth0 Universal Login ページにリダイレクトされ、ユーザー名とパスワード、またはソーシャルプロバイダーを使用してログインまたはサインアップできることを確認してください。

  その後、Auth0 がアプリケーションにリダイレクトし直すことを確認してください。
</Note>

<div id="add-logout-to-your-application">
  ## アプリケーションにログアウト機能を追加する
</div>

ユーザーがログインできるようになったので、[ログアウトする方法](https://auth0.com/docs/logout/guides/logout-auth0)を設定する必要があります。ブラウザーセッションをクリアするには、ユーザーをブラウザーで Auth0 のログアウトエンドポイントにリダイレクトしなければなりません。先ほどと同様に、ユーザーがアプリを離れて望ましくないエクスペリエンスにならないように、Capacitor の Browser プラグインを使ってこのリダイレクトを実行する必要があります。

Ionic と Capacitor を Auth0 のソフトウェア開発キット (SDK) と組み合わせて使用してこれを実現するには、次のようにします。

* ログアウト後に Auth0 がリダイレクトに使用する、アプリ向けの URL を構築します。これは、登録済みのカスタムスキームと Auth0 ドメインを使用する URL です。この URL を Auth0 Dashboard の **許可されたログアウトURL** 設定に追加します。
* `logout` を呼び出して SDK からログアウトし、`logoutParams.returnTo` パラメーターとしてリダイレクト URL を渡します。
* `openUrl` パラメーターを、Capacitor のブラウザープラグインを使って `Browser.open` で URL を開くコールバックに設定します。

<Info>
  ログイン手順と同様に、`logout` を呼び出すときに `openUrl` を設定しない場合、SDK はデバイス上のデフォルトのブラウザーアプリケーションを使用してユーザーをログアウト URL にリダイレクトしますが、これは望ましくないユーザーエクスペリエンスとなります。
</Info>

新しい `LogoutButton` コンポーネントを作成し、そのファイルに次のコードを追加します。その後、`LogoutButton` コンポーネントをアプリに追加します。

export const codeExample3 = `import { Component, OnInit } from '@angular/core';
import { AuthService } from '@auth0/auth0-angular';
import { Browser } from '@capacitor/browser';
import { tap } from 'rxjs/operators';

// ログアウト後にアプリに戻るための URL を組み立てます
const returnTo = \`\${config.appId}://{yourDomain}/capacitor/\${config.appId}/callback\`;

@Component({
  selector: 'app-logout-button',
  template: \`<ion-button (click)="logout()">ログアウト</ion-button>\`,
})
export class LogoutButtonComponent {
  // Auth0 Angular ソフトウェア開発キット (SDK) から AuthService モジュールをインポートします
  constructor(public auth: AuthService) {}

   logout() {
    this.auth
      .logout({ 
        logoutParams: {
          returnTo,
        },
        async openUrl(url: string) {
          await Browser.open({ url });
        } 
      })
      .subscribe();
  }
}`;

<AuthCodeBlock children={codeExample3} language="javascript" />

<Note>
  ### チェックポイント

  `LogoutButton` コンポーネントをアプリケーションに追加します。それをクリックしたときに、Ionic アプリケーションが &quot;Settings&quot; の &quot;許可されたログアウトURL&quot; の 1 つとして指定したアドレスにリダイレクトされ、アプリケーションからログアウトされていることを確認してください。
</Note>

<div id="show-user-profile-information">
  ## ユーザー プロファイル情報を表示する
</div>

Auth0 ソフトウェア開発キット (SDK) を使用すると、ログイン済みユーザーに関連付けられた[プロファイル情報](https://auth0.com/docs/users/concepts/overview-user-profile)を、名前やプロファイル画像など、パーソナライズされたユーザーインターフェースを実現するために必要な任意のコンポーネントで、簡単に取得できます。プロファイル情報は、`AuthService` によって公開される `user$` プロパティから利用できます。

新しいコンポーネント `Profile` を作成し、次のコードを使用してアプリ内でユーザー プロファイル情報を表示します。

```javascript lines
import { Component, OnInit } from '@angular/core';
import { AuthService } from '@auth0/auth0-angular';

@Component({
  selector: 'app-profile',
  template: `
  <div *ngIf="auth.user$ | async as user">
    <ion-avatar class="avatar">
      <Frame><img [src]="user.picture" [alt]="user.name" /></Frame>
    </ion-avatar>
    <h2>{{ user.name }}</h2>
    <p>{{ user.email }}</p>
  </div>`,
})
export class ProfileComponent {
  constructor(public auth: AuthService) {}
}
```

<Note>
  ### チェックポイント

  `ProfileComponent` をアプリケーションに追加し、ログイン後にコンポーネント内で `user.name` や [任意の他の `user` プロパティ](https://auth0.com/docs/users/references/user-profile-structure#user-profile-attributes) を正しく表示できることを確認してください。
</Note>

<Info>
  ##### 次にできること

  <table>
    <tr>
      <td><a href="/docs/ja-JP/authenticate/identity-providers">他のアイデンティティ プロバイダーを設定する</a></td>
      <td><a href="/docs/ja-JP/secure/multi-factor-authentication">多要素認証を有効にする</a></td>
    </tr>

    <tr>
      <td><a href="/docs/ja-JP/secure/attack-protection">攻撃からの保護について学ぶ</a></td>
      <td><a href="/docs/ja-JP/customize/rules">Rules 機能について学ぶ</a></td>
    </tr>
  </table>

  [GitHub で編集する](https://github.com/auth0/docs/edit/master/articles/quickstart/backend/aspnet-core-webapi/01-authorization.md)
</Info>

***
