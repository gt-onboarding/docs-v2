---
title: ".NET Android と iOS"
permalink: "01-login"
---

import {AuthCodeBlock} from "/snippets/ja-JP/AuthCodeBlock.jsx";

<div id="by-frederik-prijck">
  ##### Frederik Prijck 著
</div>

このチュートリアルでは、.NET Android または iOS アプリケーションに、Auth0 を使ったユーザーログイン機能を追加する方法を説明します。このクイックスタートを、あなたのアカウント向けに構成されたサンプルと共に進められるよう、事前にログインしておくことをお勧めします。

{/* <Card title="GitHub で表示" href="https://github.com/auth0-samples/auth0-xamarin-oidc-samples/tree/master/Quickstart/01-Login" icon="github">
  システム要件: Visual Studio 2022 以降 または Visual Studio for Mac | Xamarin for Visual Studio | .NET 6 以降
  </Card> */}

<Info>
  このクイックスタートでは `.NET Android` と `iOS` を対象としています。これらは `Xamarin.Android` および `Xamarin.iOS` の次世代プラットフォームです。まだ `Xamarin.Android` や `Xamarin.iOS` を使用している場合でも、統合方法は同じで SDK も互換性があるため、このガイドに従うことができます。
</Info>

<Info>
  **認証が初めての方は**、[Auth0 の仕組み](/docs/ja-JP/get-started/auth0-overview)、[ネイティブアプリケーションとの統合方法](/docs/ja-JP/get-started/architecture-scenarios/mobile-api)、および使用する[プロトコル](/docs/ja-JP/get-started/authentication-and-authorization-flow/authorization-code-flow-with-pkce)について学んでください。
</Info>

<div id="configure-auth0">
  ## Auth0 の設定
</div>

<div id="get-your-application-keys">
  ### アプリケーションキーを取得する
</div>

Auth0 にサインアップすると、新しいアプリケーションが自動的に作成されます（または、自分で新しいアプリケーションを作成している場合もあります）。Auth0 と連携するには、そのアプリケーションに関するいくつかの情報が必要です。これらの情報は Auth0 Dashboard の [Application Settings](https://manage.auth0.com/#/applications) セクションから取得できます。

<Frame>![App Dashboard](https://cdn2.auth0.com/docs/1.14550.0/media/articles/dashboard/client_settings.png)</Frame>

<Info>
  Native アプリケーションまたは Single Page Application で Default App を使用する場合は、**Token Endpoint Authentication Method** を `None` に更新し、**Application Type** を `SPA` または `Native` のいずれかに設定してください。
</Info>

次の情報が必要です。

* **Domain**
* **Client ID**

<Info>
  このページ上部からサンプルをダウンロードした場合、これらの項目はあらかじめ設定されています。
</Info>

<div id="configure-callback-urls">
  ### コールバックURLを設定する
</div>

コールバックURLは、ユーザーが認証を完了した後に Auth0 がユーザーをリダイレクトする、アプリケーション内の URL です。アプリのコールバックURLは、[Application Settings](https://manage.auth0.com/#/applications) 内の **許可されたコールバックURL** フィールドに追加する必要があります。このフィールドが設定されていない場合、ユーザーはアプリケーションにログインできず、エラーが発生します。

コールバックURLは、認証プロセスの後に Auth0 が呼び出す URL です。Auth0 はこの URL にリダイレクトし、IDトークン、アクセストークン、およびリフレッシュトークンと交換される認可コードなどの追加パラメーターを付加します。

コールバックURLは改ざんされる可能性があるため、セキュリティのためにアプリケーションのコールバックURLをアプリケーションの *Allowed Callback URLs* に追加する必要があります。これにより、Auth0 はこれらの URL を有効なものとして認識できるようになります。設定しない場合、認証は成功しません。

* Android の場合、コールバックURLは次の形式になります

  ```
  YOUR_ANDROID_PACKAGE_NAME://{yourDomain}/android/YOUR_ANDROID_PACKAGE_NAME/callback
  ```

  ここで、`YOUR_ANDROID_PACKAGE_NAME` は `com.mycompany.myapplication` のようなアプリケーションのパッケージ名です。
* iOS の場合、コールバックURLは次の形式になります

  ```
  YOUR_BUNDLE_IDENTIFIER://{yourDomain}/ios/YOUR_BUNDLE_IDENTIFIER/callback
  ```

  ここで、`YOUR_BUNDLE_IDENTIFIER` は `com.mycompany.myapplication` のようなアプリケーションのバンドル識別子です。

コールバックURLがすべて小文字であることを確認してください。

<div id="configure-logout-urls">
  ### ログアウトURLを設定する
</div>

ログアウトURLは、ユーザーが認可サーバーからログアウトされた後に、Auth0 がアプリケーションへリダイレクトする先のURLです。これは `returnTo` クエリパラメーターで指定します。アプリケーションのログアウトURLは、[Application Settings](https://manage.auth0.com/#/applications) の **許可されたログアウトURL** フィールドに追加する必要があります。このフィールドが設定されていない場合、ユーザーはアプリケーションからログアウトできず、エラーが発生します。

<Info>
  このページの上部からダウンロードしたサンプルプロジェクトに沿って作業している場合、**許可されたログアウトURL** フィールドに追加する必要があるログアウトURLは、コールバックURLと同じです。
</Info>

<div id="install-dependencies">
  ## 依存関係をインストールする
</div>

Visual Studio を使用している場合は、[表示] &gt; [その他のウィンドウ] &gt; [Package Manager Console] の順に選択して Package Manager Console を開き、パッケージをインストールします。

**Android の場合:**

```
Install-Package Auth0.OidcClient.AndroidX
```

**iOS の場合:**

```
Install-Package Auth0.OidcClient.iOS
```

または、Visual Studio for Mac を使用している場合は、次の手順を実行します。

1. Visual Studio for Mac でプロジェクトを読み込んだ状態で、**Solution Pad** 内のプロジェクトの **Packages** フォルダーを Ctrl+クリック（または右クリック）し、**Add Packages...** を選択します。
2. **Add Packages** ダイアログが表示されます。使用しているプラットフォームに応じて、`Auth0.OidcClient.AndroidX` または `Auth0.OidcClient.iOS` という名前のパッケージを検索して見つけます。
3. パッケージの横にあるチェックボックスをオンにして選択し、**Add Package** ボタンをクリックします。

<div id="trigger-authentication">
  ## 認証を開始する
</div>

アプリケーションに Auth0 のログインを統合するには、`Auth0Client` クラスのインスタンスを作成し、Auth0 ドメインとクライアントIDを設定します。

export const codeExample1 = `using Auth0.OidcClient;

var client = new Auth0Client(new Auth0ClientOptions
{
    Domain = "{yourDomain}",
    ClientId = "{yourClientId}"
}, this);`;

<AuthCodeBlock children={codeExample1} language="cs" />

次に `LoginAsync` メソッドを呼び出します。これにより、ユーザーをログイン画面にリダイレクトします。通常、これはログインボタンなどの UI コントロールのイベントハンドラー内で実行します。

```cs lines
var loginResult = await client.LoginAsync();
```

<div id="handing-the-callback-url">
  ### コールバック URL の処理
</div>

ユーザーがログインした後、事前に登録しておいた **Callback URL** にユーザーはあなたのアプリケーションへリダイレクトされます。Android と iOS の両方で、このコールバックを処理して認証フローを完了する必要があります。

<div id="android">
  ### Android
</div>

このコールバック URL を処理するインテントを登録します。簡単な方法としては、認証フローを開始するために `LoginAsync` メソッドを呼び出したのと同じアクティビティで、そのインテントを登録することです。

export const codeExample2 = `[Activity(Label = "AndroidSample", MainLauncher = true, Icon = "@drawable/icon",
    LaunchMode = LaunchMode.SingleTask)]
[IntentFilter(
    new[] { Intent.ActionView },
    Categories = new[] { Intent.CategoryDefault, Intent.CategoryBrowsable },
    DataScheme = "YOUR_ANDROID_PACKAGE_NAME",
    DataHost = "{yourDomain}",
    DataPathPrefix = "/android/YOUR_ANDROID_PACKAGE_NAME/callback")]
public class MainActivity : Activity
{
    // （コード省略）
}`;

<AuthCodeBlock children={codeExample2} language="cs" />

上記のコードサンプル内の `YOUR_ANDROID_PACKAGE_NAME` を、`com.mycompany.myapplication` のような実際のアプリケーションのパッケージ名に置き換えます。また、`DataScheme`、`DataHost`、`DataPathPrefix` の文字列はすべて小文字にするようにしてください。さらに、`Activity` に対して `LaunchMode = LaunchMode.SingleTask` を設定します。そうしないと、Callback URL が呼び出されるたびにシステムがアクティビティの新しいインスタンスを作成してしまいます。

次に、インテントを処理するコードを書きます。これは `OnNewIntent` メソッドをオーバーライドすることで行えます。メソッド内で、認証フローを完了するために `ActivityMediator` の `Send` メソッドを呼び出す必要があります。

```cs lines
protected override async void OnNewIntent(Intent intent)
{
    base.OnNewIntent(intent);

    Auth0.OidcClient.ActivityMediator.Instance.Send(intent.DataString);
}
```

<div id="ios">
  ### iOS
</div>

アプリケーションで処理するコールバック URL 用の URL スキームを登録します。

1. Visual Studio for Mac でアプリケーションの `Info.plist` ファイルを開き、**Advanced** タブを開きます。
2. **URL Types** で **Add URL Type** ボタンをクリックします。
3. **Identifier** を `Auth0` に、**URL Schemes** をアプリケーションの **Bundle Identifier** と同じ値に、**Role** を `None` に設定します。

URL Type を追加した後の `info.plist` ファイルの XML の例は次のとおりです。

```xml lines
<key>CFBundleURLTypes</key>
<array>
    <dict>
        <key>CFBundleTypeRole</key>
        <string>None</string>
        <key>CFBundleURLName</key>
        <string>Auth0</string>
        <key>CFBundleURLSchemes</key>
        <array>
            <string>YOUR_BUNDLE_IDENTIFIER</string>
        </array>
    </dict>
</array>
```

`AppDelegate` クラスの `OpenUrl` イベントで Callback URL を処理する必要があります。`ActivityMediator` シングルトンの `Send` メソッドを呼び出し、送信された URL をそのまま渡すことで、認証フローを完了するよう Auth0 OIDC クライアントに通知します。

```cs lines
using Auth0.OidcClient;

[Register("AppDelegate")]
public class AppDelegate : UIApplicationDelegate
{
    public override bool OpenUrl(UIApplication application, NSUrl url, string sourceApplication, NSObject annotation)
    {
        ActivityMediator.Instance.Send(url.AbsoluteString);

        return true;
    }
}
```

<div id="run-the-application">
  ### アプリケーションを実行する
</div>

上記のコードを追加すると、ユーザーは Auth0 を使用してこのアプリケーションにログインできるようになります。

<Frame>![Universal Login](https://cdn2.auth0.com/docs/1.14550.0/media/articles/native-platforms/android/login-android.png)</Frame>

<div id="accessing-the-users-information">
  ## ユーザー情報へのアクセス
</div>

返されたログイン結果から認証が成功したかどうかが分かり、成功している場合はユーザーのトークンおよびクレームが含まれます。

<div id="authentication-error">
  ### 認証エラー
</div>

結果の `IsError` プロパティを確認すると、ログインが失敗したかどうかを判別できます。`ErrorMessage` には、発生したエラーに関する詳細な情報が含まれます。

```cs lines
var loginResult = await client.LoginAsync();

if (loginResult.IsError)
{
    Debug.WriteLine($"ログイン中にエラーが発生しました: {loginResult.Error}")
}
```

<div id="accessing-the-tokens">
  ### トークンへのアクセス
</div>

ログインが成功すると、ログイン結果には IDトークンとアクセストークンが、それぞれ `IdentityToken` プロパティと `AccessToken` プロパティに含まれます。

```cs lines
var loginResult = await client.LoginAsync();

if (!loginResult.IsError)
{
    Debug.WriteLine($"id_token: {loginResult.IdentityToken}");
    Debug.WriteLine($"access_token: {loginResult.AccessToken}");
}
```

<div id="obtaining-the-user-information">
  ### ユーザー情報の取得
</div>

ログインに成功すると、ログイン結果の `User` プロパティ（[ClaimsPrincipal](https://msdn.microsoft.com/en-us/library/system.security.claims.claimsprincipal\(v=vs.110\).aspx)）にユーザー情報が含まれます。

ユーザーに関する情報を取得するには、クレームを参照します。たとえば、`name` および `email` クレームからユーザーの名前とメールアドレスを取得できます。

```cs lines
if (!loginResult.IsError)
{
    Debug.WriteLine($"name: {loginResult.User.FindFirst(c => c.Type == "name")?.Value}");
    Debug.WriteLine($"email: {loginResult.User.FindFirst(c => c.Type == "email")?.Value}");
}
```

<Info>
  返されるクレームは、要求したスコープによって異なります。詳細については、Auth0 OIDC アプリケーション ドキュメント内の「[Using Scopes](https://auth0.github.io/auth0-oidc-client-net/documentation/advanced-scenarios/scopes.html)」を参照してください。
</Info>

`Claims` コレクションを反復処理することで、IDトークンに含まれるすべてのクレームの一覧を取得できます。

```cs lines
if (!loginResult.IsError)
{
    foreach (var claim in loginResult.User.Claims)
    {
        Debug.WriteLine($"{claim.Type} = {claim.Value}");
    }
}
```

<div id="logout">
  ## ログアウト
</div>

ユーザーをログアウトさせるには、`LogoutAsync` メソッドを呼び出してください。

```cs lines
BrowserResultType browserResult = await client.LogoutAsync();
```

<Info>
  ##### 次のステップ

  <table>
    <tr>
      <td><a href="/docs/ja-JP/authenticate/identity-providers">他のアイデンティティ プロバイダーを設定する</a></td>
      <td><a href="/docs/ja-JP/secure/multi-factor-authentication">多要素認証を有効にする</a></td>
    </tr>

    <tr>
      <td><a href="/docs/ja-JP/secure/attack-protection">攻撃対策機能について学ぶ</a></td>
      <td><a href="/docs/ja-JP/customize/rules">Rules 機能について学ぶ</a></td>
    </tr>
  </table>

  [GitHub で編集](https://github.com/auth0/docs/edit/master/articles/quickstart/backend/aspnet-core-webapi/01-authorization.md)
</Info>

***
