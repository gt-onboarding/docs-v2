---
title: Android - Facebook ログイン

---

import { Recipe, Content, Section, SideMenu, SideMenuSectionItem, SignUpForm } from "/snippets/ja-JP/recipe.jsx";
import { LoggedInForm } from "/snippets/ja-JP/Login.jsx";
import Performloginsimplecallback from "/snippets/ja-JP/quickstart/native/android-facebook-login/performLogin + SimpleCallback.mdx";
import Oncreate from "/snippets/ja-JP/quickstart/native/android-facebook-login/onCreate.mdx";
import Fetchsessiontoken from "/snippets/ja-JP/quickstart/native/android-facebook-login/fetchSessionToken.mdx";
import Fetchuserprofile from "/snippets/ja-JP/quickstart/native/android-facebook-login/fetchUserProfile.mdx";
import Exchangetokens from "/snippets/ja-JP/quickstart/native/android-facebook-login/exchangeTokens.mdx";
import Performlogin from "/snippets/ja-JP/quickstart/native/android-facebook-login/performLogin.mdx";

import {AuthCodeGroup} from "/snippets/ja-JP/AuthCodeGroup.jsx";

export const sections = [
      { id: "system-requirements", title: "システム要件" },
      { id: "before-you-start", title: "開始する前に" },
      { id: "request-facebook-permissions", title: "Facebook の権限を要求する" },
      { id: "create-performlogin-method", title: "performLogin メソッドを作成する" },
      { id: "call-performlogin-method", title: "performLogin メソッドを呼び出す" },
      { id: "integrate-facebook", title: "Facebook と統合する" },
      { id: "fetch-facebook-session-access-token", title: "Facebook セッションのアクセストークンを取得する" },
      { id: "fetch-facebook-user-profile", title: "Facebook ユーザープロファイルを取得する" },
      { id: "integrate-auth0", title: "Auth0 と統合する" },
      { id: "exchange-the-received-data-for-auth0-tokens", title: "受け取ったデータを Auth0 トークンに交換する" },
      { id: "update-performlogin-method", title: "performLogin メソッドを更新する" }
]


<Recipe isSingleColumn>
  <Content>
    このチュートリアルでは、ネイティブFacebook Loginを使用してAndroidアプリケーションにユーザーログインを追加する方法を説明します。お使いのアカウント用に設定された例でこのクイックスタートを進めるには、ログインすることをお勧めします。

    <Section id={sections[0].id} title={sections[0].title} stepNumber="1" isSingleColumn>
      * Android Studio 3.6.1
      * Android SDK 25
      * エミュレータ - Nexus 5X - Android 6.0

      このチュートリアルでは、[Facebook SDK](https://developers.facebook.com/docs/) を使用してログインを実装する方法を解説します。​

      <LoggedInForm />
    </Section>

    <Section id={sections[1].id} title={sections[1].title} stepNumber="2" isSingleColumn>
      * [Facebook Login SDK](https://developers.facebook.com/docs/facebook-login/) をインストールして設定します。また、[https://developers.facebook.com](https://developers.facebook.com/) で Facebook アプリを作成する手順も行います。**このステップが完了すると、Facebook Login が統合されたモバイルアプリが動作するようになります。**

      ダッシュボードで Auth0 アプリケーションを構成し、Facebook Native Sign In を使用するように設定します。詳しくは、[Add Facebook Login to Native
      Apps](https://auth0.com/docs/connections/nativesocial/facebook) を参照してください。**このステップが完了すると、アプリケーションで Facebook Native Login を実装できるようになります。**

      <LoggedInForm />
    </Section>

    <Section id={sections[2].id} title={sections[2].title} stepNumber="3" isSingleColumn>
      アプリケーションはすでに Facebook でサインインできる状態です。ただし、より豊富なユーザー プロファイルを取得するには、Facebook Login Button を設定したときの権限を更新する必要があります。

      要求する権限を `public_profile` と `email` に設定してください。これにより、ユーザーがアクセス要求を承認した場合、レスポンスにユーザーのメールも含まれるようになります。

      ```kt lines
      loginButton.setPermissions(Arrays.asList("public_profile", "email"));
      ```

      <LoggedInForm />
    </Section>

    <Section id={sections[3].id} title={sections[3].title} stepNumber="4" isSingleColumn>
      さて、Auth0 を使った認証プロセスを開始するために、新しいメソッドを作成し、その中で送信するペイロードを準備します。

      内部コールバックを処理するために、簡単なインターフェースを使用します。

      サンプルでは、メソッドは `performLogin`、インターフェースは `SimpleCallback` という名前が付けられています。
      両方を追加してください。

      <AuthCodeGroup>
        <Performloginsimplecallback />

        <Oncreate />

        <Fetchsessiontoken />

        <Fetchuserprofile />

        <Exchangetokens />

        <Performlogin />
      </AuthCodeGroup>
    </Section>

    <Section id={sections[4].id} title={sections[4].title} stepNumber="5" isSingleColumn>
      次に、Facebook ログインのコールバックの `onSuccess` メソッドから、このメソッドを呼び出します。

      <AuthCodeGroup>
        <Oncreate />

        <Performloginsimplecallback />

        <Fetchsessiontoken />

        <Fetchuserprofile />

        <Exchangetokens />

        <Performlogin />
      </AuthCodeGroup>
    </Section>

    <Section id={sections[5].id} title={sections[5].title} stepNumber="6" isSingleColumn>
      Auth0 で Facebook を使ってサインインすると、バックエンドでは内部的にいくつかのチェックが行われ、
      ユーザーが本人であることを確認します。そのためには、Session Access Token をバックエンドに渡す必要があります。

      さらに、この Facebook ユーザーを表すユーザーを Auth0 上に作成する必要がある場合、バックエンドは
      名前、姓、メールアドレス など、いくつかの情報を必要とします。メールアドレス が提供された場合でも、Auth0 ユーザープロファイル上では
      未検証としてマークされます。

      Session Access Token とユーザープロファイルを取得するには、Facebook API に対して 2 つの追加リクエストを行う必要があります。

      <LoggedInForm />
    </Section>

    <Section id={sections[6].id} title={sections[6].title} stepNumber="7" isSingleColumn>
      Facebook API の `/oauth/access_token` エンドポイントに対して新しい GET リクエストを行います。次の
      クエリパラメーターを使用します:

      * `grant_type`: `fb_attenuate_token`。
      * `fb_exchange_token`: ログイン時に受け取ったアクセストークン。
      * `client_id`: アプリの App ID。これは Facebook for Developers のダッシュボードから取得する値であり、
        Facebook Login を正常に統合している場合は、すでにアプリケーション内で使用されているはずです。

      このステップのロジックは専用のメソッドに切り出してください。前のステップで追加したメソッドから、後でこのメソッドを呼び出します。

      サンプルでは、このリクエストを実行するために Facebook SDK の `GraphRequest` クラスを使用します。

      <AuthCodeGroup>
        <Oncreate />

        <Performloginsimplecallback />

        <Fetchsessiontoken />

        <Fetchuserprofile />

        <Exchangetokens />

        <Performlogin />
      </AuthCodeGroup>
    </Section>

    <Section id={sections[7].id} title={sections[7].title} stepNumber="8" isSingleColumn>
      先ほどの手順と同様に、もう一度 GET リクエストを送信します。エンドポイントパスには、Facebook ログイン結果の User ID の値（例: `/904636746222815`）を指定します。次のパラメータを使用します:

      * `access_token`: ログイン時に受け取ったアクセストークン。
      * `fields`: レスポンスで取得したいユーザープロファイルのフィールド。これらは、最初に設定した Facebook Login Button の権限に直接紐づいています。権限が任意の場合、ユーザーはまずそのアクセスを許可する必要があります。Auth0 でユーザーをサインアップする目的であれば、フルネームとメールがあれば十分です。

      <AuthCodeGroup>
        <Fetchuserprofile />

        <Performloginsimplecallback />

        <Oncreate />

        <Fetchsessiontoken />

        <Exchangetokens />

        <Performlogin />
      </AuthCodeGroup>
    </Section>

    <Section id={sections[8].id} title={sections[8].title} stepNumber="9" isSingleColumn>
      必要なアーティファクトが取得できたので、それらを Auth0 のユーザー認証情報（ID やアクセストークンなど）と交換する準備ができました。ただし、その前に最後のリクエストを行うために Auth0 ソフトウェア開発キット (SDK) を設定する必要があります。

      ### アプリケーションキーを取得する

      1. [Auth0 Dashboard](https://manage.auth0.com/) の **Applications** セクションに移動し、**Sign in with Facebook** を有効にした既存のアプリケーションを選択します。この手順について不明な点がある場合は、この記事の冒頭にある要件セクションを確認してください。
      2. アプリケーション設定ページから **Domain** と **Client ID** の値をコピーします。これらは SDK に必要です。
      3. それらを保存するために、Android アプリケーションの strings.xml ファイルに 2 つの新しいリソースを作成します。キーの名前は、以下で使用しているものと一致している必要があります。

      ```xml lines
      <resources>

            <string name="com_auth0_domain">{yourDomain}</string>

            <string name="com_auth0_client_id">{yourClientId}</string>

      </resources>
      ```

      ### Auth0 ソフトウェア開発キット (SDK) をインストールする

      Android アプリケーションの app/build.gradle ファイルに、次の行を追加します:

      ```text lines
      dependencies {
            implementation 'com.auth0.android:auth0:1.+'
      }
      ```

      ここで Gradle Sync タスクを実行して、プロジェクトとその依存関係を更新します。

      ### Web Authentication 用にマニフェストを更新する

      アプリケーションでソフトウェア開発キット (SDK) が提供する Web Authentication モジュールを使用しない場合は、
      Manifest Placeholder の問題を防ぐために、AndroidManifest.xml ファイルから未使用の activity を削除する必要があります。
      これは、activity 宣言を追加し、tools:node=&quot;remove&quot; 属性を付与することで実現できます。

      ```xml lines
      <application>
      <!-- 以下のアクティビティ宣言行を追加してください -->
      <activity
      android:name="com.auth0.android.provider.AuthenticationActivity"
      tools:node="remove" />
      </application>
      ```

      ただし、Web Authentication をサポートする場合は、Manifest Placeholder の宣言方法について[こちら](https://auth0.com/docs/libraries/auth0-android#authentication-via-universal-login)を参照してください。

      <LoggedInForm />
    </Section>

    <Section id={sections[9].id} title={sections[9].title} stepNumber="10" isSingleColumn>
      SDK は使用前に必ずインスタンス化する必要があります。クラスレベルのフィールドとして定義し、
      `onCreate` メソッド内で初期化します。前の手順で定義した認証情報が
      `Auth0` コンストラクターに渡され、それを使って `AuthenticationAPIClient` の新しいインスタンスが
      作成されることに注意してください。

      ```kt lines
      private AuthenticationAPIClient auth0Client;
      @Override
      public void onCreate(Bundle savedInstanceState) {
      super.onCreate(savedInstanceState);



      setContentView(R.layout.activity_login);



      Auth0 account = new Auth0(getString(R.string.com_auth0_client_id), getString(R.string.com_auth0_domain));

      auth0Client = new AuthenticationAPIClient(account);



      //...

      }
      ```

      取得した 2 つのアーティファクトを Auth0 のユーザー認証情報に交換するロジックを実装するメソッドを作成します。
      サンプルでは、このメソッドは `exchangeTokens` という名前になっています。

      API クライアントは、トークンと subject タイプを受け取るメソッド `loginWithNativeSocialToken` を宣言します。
      前者はセッショントークンに対応し、後者はバックエンドがどのタイプの接続で認証を試みるかを示します。

      ネイティブ Facebook ログインの場合は、次の値を使用します:
      `"http://auth0.com/oauth/token-type/facebook-info-session-access-token"`

      このほかに設定する必要がある値として、ユーザープロファイル（`user_profile` キーを使用）と、
      Auth0 トークンに含めるよう要求するスコープがあります。

      <Info>
        変更されないとわかっている値は、クラスの先頭で定数として保持しておくことが推奨されます。
        サンプルでは、subject トークンタイプ、Facebook のパーミッション、および Auth0 のスコープに定数を使用しています。
        Auth0 のスコープについての詳細は、専用の記事を参照してください。
      </Info>

      <LoggedInForm />
    </Section>

    <Section id={sections[10].id} title={sections[10].title} stepNumber="11" isSingleColumn>
      すべてのステップがそれぞれ個別のメソッドとして定義できたので、ここで `performLogin` メソッドの中にすべてをまとめます。

      ここまでが問題なく完了していれば、Facebook Login SDK を使用してネイティブ認証を行えるようになっているはずです。これは、デバイスに Facebook アプリがインストールされている場合、ブラウザーアプリではなく、そのアプリケーション経由で認証が処理されることを意味します。

      <AuthCodeGroup>
        <Performlogin />

        <Performloginsimplecallback />

        <Oncreate />

        <Fetchsessiontoken />

        <Fetchuserprofile />

        <Exchangetokens />
      </AuthCodeGroup>
    </Section>
  </Content>
</Recipe>