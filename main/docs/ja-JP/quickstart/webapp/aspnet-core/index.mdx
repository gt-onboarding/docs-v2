---
title: "ASP.NET Core MVC"
permalink: "01-login"
---

<div id="by-frederik-prijck">
  ##### Frederik Prijck による
</div>

このチュートリアルでは、ASP.NET Core アプリケーションにユーザー ログイン機能を追加する方法を説明します。ご自身のアカウント向けに構成されたサンプルを使ってこのクイックスタートを進められるよう、事前にログインしておくことをお勧めします。

{/* <Card title="GitHub で表示" href="https://github.com/auth0-samples/auth0-aspnetcore-mvc-samples/tree/master/Quickstart/Sample" icon="github">
  システム要件: .NET 6.0 | .NET 7.0 | .NET 8.0
  </Card> */}

<div id="configure-auth0">
  ## Auth0 の設定
</div>

<div id="get-your-application-keys">
  ### アプリケーションのキーを取得する
</div>

Auth0 にサインアップすると、新しいアプリケーションが自動的に作成されるか、自分で新しいアプリケーションを作成しているはずです。Auth0 と連携するには、そのアプリケーションに関するいくつかの詳細情報が必要です。これらの情報は、Auth0 Dashboard の [Application Settings](https://manage.auth0.com/#/applications) セクションから取得できます。

<Frame>![アプリケーション ダッシュボード](https://cdn2.auth0.com/docs/1.14550.0/media/articles/dashboard/client_settings.png)</Frame>

次の情報が必要です。

* **ドメイン**
* **クライアントID**

<Info>
  このページの上部からサンプルをダウンロードした場合、これらの値はあらかじめ入力されています。
</Info>

<div id="configure-callback-urls">
  ### コールバック URL を設定する
</div>

アプリケーションのコールバック URL は、ユーザーが認証された後に、ソフトウェア開発キット (SDK) が認証処理を完了できるよう Auth0 がリダイレクト先として使用する URL です。

この URL を、[Application Settings](https://manage.auth0.com/#/applications) 内のアプリケーションの Allowed URLs の一覧に追加する必要があります。この URL は通常、`https://YOUR_APPLICATION_URL/callback` という形式になります。

<div id="configure-logout-urls">
  ### ログアウトURLを設定する
</div>

ログアウトURLは、ユーザーが認可サーバーからログアウトされた後に、Auth0 がリダイレクト先として使用する、アプリケーション内のURLです。これは `returnTo` クエリパラメーターで指定されます。アプリのログアウトURLは、[Application Settings](https://manage.auth0.com/#/applications) の **Allowed Logout URLs** フィールドに追加する必要があります。このフィールドが設定されていない場合、ユーザーはアプリケーションからログアウトできず、エラーが発生します。

<Info>
  このページの先頭からダウンロードしたサンプルプロジェクトに沿って作業している場合、**Allowed Logout URLs** フィールドに追加する必要があるログアウトURLは `http://localhost:3000` です。
</Info>

<div id="integrate-auth0">
  ## Auth0 を統合する
</div>

[Universal Login](/docs/ja-JP/authenticate/login/auth0-universal-login) は、アプリケーションに認証を導入する最も簡単な方法です。最良のユーザー エクスペリエンス、最高レベルのセキュリティ、そして最も充実した機能を利用するために、Universal Login の使用を推奨します。本ガイドでは、ASP.NET Core アプリケーションのユーザーがログインできるようにするために Universal Login を使用します。

<div id="install-dependencies">
  ### 依存関係をインストールする
</div>

ASP.NET Core と Auth0 を統合するには、`Auth0.AspNetCore.Authentication` Nuget パッケージをアプリケーションにインストールして、Auth0 のソフトウェア開発キット (SDK) を使用します。

```bash lines
Install-Package Auth0.AspNetCore.Authentication
```

<div id="install-and-configure-the-sdk">
  ### SDK をインストールして設定する
</div>

ASP.NET Core アプリケーションで認証を有効にするには、ソフトウェア開発キット (SDK) が提供するミドルウェアを使用します。`Program.cs` ファイルで `builder.Services.AddAuth0WebAppAuthentication()` を呼び出して、Auth0 ASP.NET Core SDK を設定します。

`Domain` と `ClientId` を必ず設定してください。これらは、SDK がどの Auth0 テナントとアプリケーションを使用するかを認識するために必要な必須フィールドです。

```cs lines
var builder = WebApplication.CreateBuilder(args);
// SameSite=None のクッキーをサポートするための HTTP 用クッキー設定
builder.Services.ConfigureSameSiteNoneCookies();

// HTTPS 用クッキー設定
//  builder.Services.Configure<CookiePolicyOptions>(options =>
//  {
//     options.MinimumSameSitePolicy = SameSiteMode.None;
//  });
builder.Services.AddAuth0WebAppAuthentication(options =>
{
    options.Domain = builder.Configuration["Auth0:Domain"];
    options.ClientId = builder.Configuration["Auth0:ClientId"];
});
builder.Services.AddControllersWithViews();
var app = builder.Build();
```

<Info>
  上記で使用している `ConfigureSameSiteNoneCookies` メソッドは、[サンプルアプリケーション](https://github.com/auth0-samples/auth0-aspnetcore-mvc-samples/blob/master/Quickstart/Sample/Support/SameSiteServiceCollectionExtensions.cs) の一部として、[Chrome を使用している場合に SameSite=None の Cookie を HTTP 上で動作させるため](https://blog.chromium.org/2019/10/developers-get-ready-for-new.html) に追加されたものです。`ConfigureSameSiteNoneCookies` メソッドが不要になるよう、HTTP ではなく HTTPS を使用することを推奨します。
</Info>

Program.cs ファイルで認証と認可を有効にしていることを確認してください。

```cs lines
app.UseAuthentication();
app.UseAuthorization();
```

<div id="login">
  ## ログイン
</div>

`Login` を追加するには、`ChallengeAsync` を呼び出し、認証スキームとして &quot;Auth0&quot;（`Auth0Constants.AuthenticationScheme`）を渡します。これにより、Auth0 のソフトウェア開発キット (SDK) が内部的に登録している OIDC 認証ハンドラーが呼び出されます。

OIDC ミドルウェアがユーザーをサインインさせると、そのユーザーは Cookie ミドルウェアにも自動的にサインインされます。これにより、後続のリクエストでもユーザーを認証済みとして扱うことができます。

```cs lines
using Microsoft.AspNetCore.Authentication;
using Microsoft.AspNetCore.Authentication.Cookies;
using Auth0.AspNetCore.Authentication;

public class AccountController : Controller
{
    public async Task Login(string returnUrl = "/")
    {
        var authenticationProperties = new LoginAuthenticationPropertiesBuilder()
            // ログイン後にAuth0がユーザーをリダイレクトする場所を指定します。
            // 結果として得られる絶対URIは、アプリの
            // **許可されたコールバックURL** 設定に追加する必要があります。
            .WithRedirectUri(returnUrl)
            .Build();

        await HttpContext.ChallengeAsync(Auth0Constants.AuthenticationScheme, authenticationProperties);
    }
}
```

<div id="display-user-profile">
  ## ユーザープロファイルの表示
</div>

ソフトウェア開発キット (SDK) は IDトークンからユーザーの情報を抽出し、コントローラーの `User.Claims` プロパティとして利用できるようにします。

コントローラー内から対応する情報をビューに渡すことで、ユーザーの名前、メールアドレス、プロファイル画像を表示するカスタムのユーザープロファイルページを作成できます。

```cs lines
public class AccountController : Controller
{
    [Authorize]
    public IActionResult Profile()
    {
        return View(new
        {
            Name = User.Identity.Name,
            EmailAddress = User.Claims.FirstOrDefault(c => c.Type == ClaimTypes.Email)?.Value,
            ProfileImage = User.Claims.FirstOrDefault(c => c.Type == "picture")?.Value
        });
    }
}
```

<div id="logout">
  ## ログアウト
</div>

`Logout` 機能を追加するには、Auth0 ミドルウェアと Cookie ミドルウェアの両方からユーザーをサインアウトさせる必要があります。

```cs lines
using Microsoft.AspNetCore.Authentication;
using Microsoft.AspNetCore.Authentication.Cookies;
using Auth0.AspNetCore.Authentication;

public class AccountController : Controller
{
    [Authorize]
    public async Task Logout()
    {
        var authenticationProperties = new LogoutAuthenticationPropertiesBuilder()
            // ログアウト後にAuth0がユーザーをリダイレクトする先をここで指定します。
            // 結果として生成される絶対URIは、アプリの
            // **許可されたログアウトURL** 設定に追加する必要があります。
            .WithRedirectUri(Url.Action("Index", "Home"))
            .Build();

        await HttpContext.SignOutAsync(Auth0Constants.AuthenticationScheme, authenticationProperties);
        await HttpContext.SignOutAsync(CookieAuthenticationDefaults.AuthenticationScheme);
    }
}
```

<div id="whats-next">
  ## 次のステップ
</div>

より高度なユースケースで SDK を使用する方法の例をいくつか用意しています：

* [スコープの構成](https://github.com/auth0/auth0-aspnetcore-authentication/blob/main/EXAMPLES.md#scopes)
* [API を呼び出すためのアクセストークンの取得](https://github.com/auth0/auth0-aspnetcore-authentication/blob/main/EXAMPLES.md#calling-an-api)
* [ロールベースの認可の追加](https://github.com/auth0/auth0-aspnetcore-authentication/blob/main/EXAMPLES.md#roles)

[GitHub で編集](https://github.com/auth0/docs/edit/master/articles/quickstart/webapp/aspnet-core/01-login.md)