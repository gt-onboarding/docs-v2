---
title: "Python"
permalink: "01-login"
---

import {AuthCodeBlock} from "/snippets/ja-JP/AuthCodeBlock.jsx";

<div id="by-evan-sims">
  ##### Evan Sims による執筆
</div>

このチュートリアルでは、Flask フレームワークと Authlib OAuth ライブラリを使用して構築された Python 製 Web アプリケーションに、ユーザーのログイン機能を追加する方法を説明します。ご自身のアカウント向けに設定されたサンプルを利用してこのクイックスタートを進められるよう、あらかじめログインしておくことをお勧めします。

{/* <Card title="GitHub で表示" href="https://github.com/auth0-samples/auth0-python-web-app/tree/master/01-Login" icon="github">
  システム要件：Python 3 | Authlib 1.0 | Flask 2.0
  </Card> */}

<Info>
  **認証が初めての方は** [Auth0 の仕組み](/docs/ja-JP/get-started/auth0-overview)、[通常の Web アプリケーションとの統合方法](/docs/ja-JP/get-started/architecture-scenarios/sso-for-regular-web-apps)、および Auth0 で使用される[プロトコル](/docs/ja-JP/get-started/authentication-and-authorization-flow)について学びましょう。
</Info>

<div id="configure-auth0">
  ## Auth0 を設定する
</div>

<div id="get-your-application-keys">
  ### アプリケーションキーを取得する
</div>

Auth0 にサインアップすると、新しいアプリケーションが自動的に作成されるか、ご自身で新しいアプリケーションを作成しているはずです。Auth0 と連携するには、そのアプリケーションに関するいくつかの設定値が必要です。これらの値は、 Auth0 Dashboard の [Application Settings](https://manage.auth0.com/#/applications) セクションから取得できます。

<Frame>![App Dashboard](https://cdn2.auth0.com/docs/1.14550.0/media/articles/dashboard/client_settings.png)</Frame>

次の情報が必要です。

* **Domain**
* **Client ID**
* **Client Secret**

<Info>
  このページの上部からサンプルをダウンロードした場合は、これらの値はあらかじめ入力されています。
</Info>

<div id="configure-callback-urls">
  ### コールバック URL を設定する
</div>

コールバック URL は、ユーザーが認証された後に Auth0 がリダイレクトする、アプリケーション内の URL です。アプリのコールバック URL は、[Application Settings](https://manage.auth0.com/#/applications) の **Allowed Callback URLs** フィールドに追加する必要があります。このフィールドが設定されていない場合、ユーザーはアプリケーションにログインできず、エラーが発生します。

<Info>
  このページの先頭からダウンロードしたサンプルプロジェクトを利用している場合、**Allowed Callback URLs** フィールドに追加する必要があるコールバック URL は `http://localhost:3000/callback` です。
</Info>

<div id="configure-logout-urls">
  ### ログアウトURLを設定する
</div>

ログアウトURLは、ユーザーが認可サーバーからログアウトされた後に、Auth0 がアプリケーション内でのリダイレクト先として使用できる URL です。これは `returnTo` クエリパラメーターで指定します。アプリのログアウトURLは、[Application Settings](https://manage.auth0.com/#/applications) の **許可されたログアウトURL** フィールドに追加する必要があります。このフィールドが設定されていない場合、ユーザーはアプリケーションからログアウトできず、エラーが発生します。

<Info>
  このページの冒頭からダウンロードしたサンプルプロジェクトに沿って進めている場合、**許可されたログアウトURL** フィールドに追加する必要があるログアウトURLは `http://localhost:3000` です。
</Info>

<div id="install-dependencies">
  ## 依存関係をインストールする
</div>

このサンプルでは、[Authlib](https://authlib.org/) OAuth ライブラリと [Flask](https://flask.palletsprojects.com/en/2.0.x/) を使用します。

まず、プロジェクトディレクトリに `requirements.txt` ファイルを作成します。

```txt lines
# 📁 requirements.txt -----

flask>=2.0.3
python-dotenv>=0.19.2
authlib>=1.0
requests>=2.27.1
```

これらの依存関係をプロジェクトで利用できるようにするために、シェルで `pip install -r requirements.txt` を実行してください。

<div id="configure-your-env-file">
  ## .env ファイルを設定する
</div>

次に、プロジェクトディレクトリに `.env` ファイルを作成します。このファイルに、クライアントキーやその他の設定情報を記述します。

export const codeExample = `# 📁 .env -----

AUTH0_CLIENT_ID={yourClientId}
AUTH0_CLIENT_SECRET={yourClientSecret}
AUTH0_DOMAIN={yourDomain}
APP_SECRET_KEY=`;

<AuthCodeBlock children={codeExample} language="env" />

* シェルから `openssl rand -hex 32` を実行して、`APP_SECRET_KEY` に使用する適切な文字列を生成します。

<div id="setup-your-application">
  ## アプリケーションのセットアップ
</div>

これでアプリケーションの実装を始める準備が整いました。プロジェクトディレクトリに `server.py` ファイルを作成します。このファイルにアプリケーションロジックをすべて記述します。

まず、アプリケーションで使用するすべてのライブラリをインポートします。

```py lines
# 📁 server.py -----

import json
from os import environ as env
from urllib.parse import quote_plus, urlencode

from authlib.integrations.flask_client import OAuth
from dotenv import find_dotenv, load_dotenv
from flask import Flask, redirect, render_template, session, url_for
```

次に、前の手順で作成した `.env` 構成ファイルをアプリケーションが読み込む必要があります。

```env lines
# 👆 上記の手順から続けています。これを server.py ファイルに追記してください。

ENV_FILE = find_dotenv()
if ENV_FILE:
    load_dotenv(ENV_FILE)
```

これで、アプリケーションのニーズに合わせて Flask を設定できるようになりました。

```py lines
# 👆 上記の手順から続けています。これを server.py ファイルに追加してください。

app = Flask(__name__)
app.secret_key = env.get("APP_SECRET_KEY")
```

最後に、Auth0 を使ってアプリケーションの認証を処理するように Authlib を設定します。

```py lines
# 👆 上記の手順から続けています。これを server.py ファイルに追加してください。

oauth = OAuth(app)

oauth.register(
    "auth0",
    client_id=env.get("AUTH0_CLIENT_ID"),
    client_secret=env.get("AUTH0_CLIENT_SECRET"),
    client_kwargs={
        "scope": "openid profile email",
    },
    server_metadata_url=f'https://{env.get("AUTH0_DOMAIN")}/.well-known/openid-configuration'
)
```

Authlib の OAuth `register()` メソッドで利用できる設定オプションの詳細については、[Authlib のドキュメント](https://docs.authlib.org/en/latest/client/frameworks.html#using-oauth-2-0-to-log-in)を参照してください。

<div id="setup-your-routes">
  ## ルートを設定する
</div>

このデモでは、アプリケーションに `login`、`callback`、`logout`、`home` の 4 つのルートを追加します。

<div id="triggering-authentication-with-login">
  ### /login で認証を開始する
</div>

訪問者がアプリの `/login` ルートにアクセスすると、認証フローを開始するために Auth0 にリダイレクトされます。

```py lines
# 👆 上記の手順から続けています。これを server.py ファイルに追加してください。

@app.route("/login")
def login():
    return oauth.auth0.authorize_redirect(
        redirect_uri=url_for("callback", _external=True)
    )
```

<div id="finalizing-authentication-with-callback">
  ### /callback による認証の完了
</div>

ユーザーが Auth0 でのログインを完了すると、アプリケーションの `/callback` ルートにリダイレクトされます。このルートはユーザーのセッションを保存する役割を持ちます。そのため、ユーザーが後で再度アクセスしたときに、最初からサインインし直す必要がなくなります。

```py lines
# 👆 上記の手順から続きます。これを server.py ファイルに追加してください。

@app.route("/callback", methods=["GET", "POST"])
def callback():
    token = oauth.auth0.authorize_access_token()
    session["user"] = token
    return redirect("/")
```

<div id="clearing-a-session-with-logout">
  ### /logout でセッションをクリアする
</div>

想像どおり、このルートはアプリケーションからユーザーをログアウトさせます。アプリ内のユーザーのセッションをクリアしたうえで、セッションが完全にクリアされたことを保証するために、いったん Auth0 の logout エンドポイントに短時間リダイレクトしてから、ホームルート（次のセクションで説明します）に戻します。

```py lines
# 👆 上記の手順から続けています。これを server.py ファイルに追加してください。

@app.route("/logout")
def logout():
    session.clear()
    return redirect(
        "https://" + env.get("AUTH0_DOMAIN")
        + "/v2/logout?"
        + urlencode(
            {
                "returnTo": url_for("home", _external=True),
                "client_id": env.get("AUTH0_CLIENT_ID"),
            },
            quote_via=quote_plus,
        )
    )
```

<div id="theres-no-place-like-home">
  ### /home ほど落ち着く場所はない
</div>

最後に、ホームルートは、認証済みユーザーの詳細情報を表示する場として、または訪問者にサインインを促す場として機能します。

```py lines
# 👆 上記の手順から続けています。これを server.py ファイルに追加してください。

@app.route("/")
def home():
    return render_template("home.html", session=session.get('user'), pretty=json.dumps(session.get('user'), indent=4))
```

<div id="server-instantiation">
  ### サーバーのインスタンス化
</div>

最後に、Flask アプリを実際に実行して接続を受け付けるための、簡単な定型コードをいくつか追加する必要があります。

```py lines
# 👆 上記の手順からの続きです。これを server.py ファイルに追加してください。

if __name__ == "__main__":
    app.run(host="0.0.0.0", port=env.get("PORT", 3000))
```

<div id="add-templates">
  ## テンプレートを追加する
</div>

次に、`about` ルートで使用するシンプルなテンプレートファイルを作成します（`render_template()` 呼び出し時に使用されます）。

プロジェクトフォルダー内に `templates` という名前の新しいサブディレクトリを作成し、その中に `dashboard.html` と `home.html` という 2 つのファイルを作成します。以下の 2 つの欄の内容を、それぞれ対応するファイルにコピー＆ペーストしてください。

```html lines
# 📁 templates/home.html -----

<html>
  <head>
    <meta charset="utf-8" />
    <title>Auth0 Example</title>
  </head>
  <body>
    {% if session %}
        <h1>ようこそ {{session.userinfo.name}} さん!</h1>
        <p><a href="/docs/logout">ログアウト</a></p>
        <div><pre>{{pretty}}</pre></div>
    {% else %}
        <h1>ようこそゲストさん</h1>
        <p><a href="/docs/login">ログイン</a></p>
    {% endif %}
  </body>
</html>
```

<div id="run-your-application">
  ## アプリケーションを実行する
</div>

アプリケーションを実行する準備が整いました。プロジェクトディレクトリでシェルを開き、次を実行します：

```bash lines
python3 server.py
```

これで、ブラウザで `http://localhost:3000` を開けばアプリケーションを起動できるようになっているはずです。

<Note>
  ##### 次にできること

  <table>
    <tr>
      <td><a href="/docs/ja-JP/authenticate/identity-providers">他のアイデンティティ プロバイダーを設定する</a></td>
      <td><a href="/docs/ja-JP/secure/multi-factor-authentication">多要素認証を有効にする</a></td>
    </tr>

    <tr>
      <td><a href="/docs/ja-JP/secure/attack-protection">攻撃保護機能について学ぶ</a></td>
      <td><a href="/docs/ja-JP/customize/rules">Rules について学ぶ</a></td>
    </tr>
  </table>

  [GitHub で編集](https://github.com/auth0/docs/edit/master/articles/quickstart/native/flutter/01-login.md)
</Note>
