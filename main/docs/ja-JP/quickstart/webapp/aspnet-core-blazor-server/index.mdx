---
title: "ASP.NET Core Blazor Server"
permalink: "01-login"
---

<div id="by-frederik-prijck">
  ##### フレデリック・プライク（Frederik Prijck）執筆
</div>

このチュートリアルでは、ASP.NET Core Blazor Server アプリケーションにユーザーのログイン機能を追加する方法を説明します。このクイックスタートに沿って進めるにあたっては、ご自身のアカウント向けに構成されたサンプルを利用できるよう、事前にログインすることをお勧めします。

{/* <Card title="GitHub で見る" href="https://github.com/auth0-samples/auth0-aspnetcore-blazor-server-samples/tree/main/Quickstart/Sample" icon="github">
  システム要件: .NET 6.0 | .NET 7.0 | .NET 8.0
  </Card> */}

<div id="configure-auth0">
  ## Auth0 を設定する
</div>

<div id="get-your-application-keys">
  ### アプリケーションキーを取得する
</div>

Auth0 にサインアップしたときに、新しいアプリケーションが自動的に作成されているか、または自分で新しく作成しているはずです。Auth0 と連携するには、そのアプリケーションに関するいくつかの設定情報が必要です。これらの情報は、Auth0 Dashboard の [Application Settings](https://manage.auth0.com/#/applications) セクションから取得できます。

<Frame>![App Dashboard](https://cdn2.auth0.com/docs/1.14550.0/media/articles/dashboard/client_settings.png)</Frame>

次の情報が必要です。

* **ドメイン**
* **クライアントID**

<Info>
  このページの上部からサンプルをダウンロードした場合、これらの値はあらかじめ入力されています。
</Info>

<div id="configure-callback-urls">
  ### コールバック URL を設定する
</div>

アプリケーションの Callback URL は、ユーザーの認証後に Auth0 がリダイレクトし、ソフトウェア開発キット (SDK) が認証処理を完了するために使用される URL です。

この URL を [Application Settings](https://manage.auth0.com/#/applications) 内で、アプリケーションの Allowed URLs の一覧に追加する必要があります。通常、この URL は `https://YOUR_APPLICATION_URL/callback` の形式になります。

<div id="configure-logout-urls">
  ### ログアウトURLを設定する
</div>

ログアウトURLは、ユーザーが認可サーバーからログアウトされた後に、Auth0 がリダイレクト先として利用できる、アプリケーション内のURLです。これは `returnTo` クエリパラメーターで指定します。アプリのログアウトURLは、[Application Settings](https://manage.auth0.com/#/applications) の **許可されたログアウトURL** フィールドに追加する必要があります。このフィールドが設定されていない場合、ユーザーはアプリケーションからログアウトできず、エラーが発生します。

<Info>
  このページの上部からダウンロードしたサンプルプロジェクトを使用している場合、**許可されたログアウトURL** フィールドに追加する必要があるログアウトURLは `http://localhost:3000` です。
</Info>

<div id="integrate-auth0">
  ## Auth0 を統合する
</div>

[Universal Login](/docs/ja-JP/authenticate/login/auth0-universal-login) は、アプリケーションに認証機能を導入する最も簡単な方法です。最高のエクスペリエンスとセキュリティ、そして最も充実した機能を得るために、Universal Login の使用を推奨します。このガイドでは、Universal Login を使用して、ユーザーが Blazor Server アプリケーションにログインできるようにする方法を説明します。

<div id="install-dependencies">
  ### 依存関係をインストールする
</div>

Blazor Server と Auth0 を統合するには、Auth0 のソフトウェア開発キット (SDK) を利用します。具体的には、`Auth0.AspNetCore.Authentication` NuGet パッケージをアプリケーションにインストールします。

```bash lines
Install-Package Auth0.AspNetCore.Authentication
```

<div id="install-and-configure-the-sdk">
  ### SDK をインストールして構成する
</div>

Blazor Server アプリケーションで認証を有効にするには、ソフトウェア開発キット (SDK) が提供するミドルウェアを使用します。`Program.cs` ファイルで `builder.Services.AddAuth0WebAppAuthentication()` を呼び出して、Auth0 ASP.NET Core SDK を構成します。

`Domain` と `ClientId` を必ず構成してください。これらは必須項目であり、SDK がどの Auth0 テナントとアプリケーションを使用すべきかを認識するために必要です。

```cs lines
var builder = WebApplication.CreateBuilder(args);

builder.Services.AddAuth0WebAppAuthentication(options =>
{
    options.Domain = builder.Configuration["Auth0:Domain"];
    options.ClientId = builder.Configuration["Auth0:ClientId"];
});

var app = builder.Build();
```

`Program.cs` ファイルで認証と認可を有効にしていることを確認してください。

```cs lines
app.UseAuthentication();
app.UseAuthorization();
```

<div id="login">
  ## ログイン
</div>

Blazor Server アプリケーションでユーザーがログインできるようにするには、`Pages` ディレクトリに `LoginModel` を追加します。

`LoginModel` の `OnGet` メソッド内で `HttpContext.ChallengeAsync()` を呼び出し、認証スキームとして `Auth0Constants.AuthenticationScheme` を渡します。これにより、Auth0 のソフトウェア開発キット (SDK) が内部的に登録する OIDC 認証ハンドラーが呼び出されます。併せて、`LoginAuthenticationPropertiesBuilder` を使用して構築できる、対応する `authenticationProperties` も指定してください。

`HttpContext.ChallengeAsync()` の呼び出しが成功すると、ユーザーは Auth0 にリダイレクトされ、その後アプリケーションにリダイレクトされるタイミングで OIDC ミドルウェアと cookie ミドルウェアの両方にサインインされます。これにより、以降のリクエストでもユーザーを認証済みとして扱うことができます。

```cs lines
public class LoginModel : PageModel
{
    public async Task OnGet(string redirectUri)
    {
        var authenticationProperties = new LoginAuthenticationPropertiesBuilder()
            .WithRedirectUri(redirectUri)
            .Build();

        await HttpContext.ChallengeAsync(Auth0Constants.AuthenticationScheme, authenticationProperties);
    }
}
```

<div id="display-user-profile">
  ## ユーザー プロファイルを表示する
</div>

ミドルウェアが Auth0 からトークンの取得に成功すると、IDトークンからユーザーの情報とクレームを抽出し、それらは `AuthenticationState` を通じて利用できるようになります。この `AuthenticationState` は `CascadingParameter` として追加できます。

`AuthenticationState` の `User` プロパティから該当する情報を取得し、Blazor コード内からビューへ渡すことで、ユーザーの名前やその他のクレーム（メールやプロフィール画像など）を表示するためのカスタム ユーザー プロファイル ページを作成できます。

```cs lines
@page "/Profile"
@attribute [Authorize]

<PageTitle>Profile</PageTitle>

<div class="row">
    <div class="col-md-12">
        <div class="row">
            <h2>Profile</h2>
            <div class="col-md-4">
                <h3>@Username</h3>
            </div>
        </div>
    </div>
</div>

@code {
    [CascadingParameter]
    public Task<AuthenticationState> AuthenticationStateTask { get; set; }
    private string Username = "";

    protected override async Task OnInitializedAsync()
    {
        var state = await AuthenticationStateTask;

        Username = state.User.Identity.Name ?? string.Empty;

        await base.OnInitializedAsync();
    }
}
```

<div id="logout">
  ## ログアウト
</div>

自分のアプリケーションからユーザーをログアウトさせるには、`LogoutModel` の `OnGet` メソッド内で、`CookieAuthenticationDefaults.AuthenticationScheme` 認証スキームを指定して `HttpContext.SignOutAsync` を呼び出します。

さらに、Auth0 からもユーザーをログアウトさせたい場合（これにより、シングルサインオンに依存している他のアプリケーションからもログアウトされる *可能性* があります）は、`Auth0Constants.AuthenticationScheme` 認証スキームと、`LogoutAuthenticationPropertiesBuilder` を使用して構築できる適切な `authenticationProperties` を指定して `HttpContext.SignOutAsync` を呼び出します。

<Info>
  自分のアプリケーションからのみユーザーをログアウトし、Auth0 からはログアウトしない場合は、`Redirect("/")` もしくはその他適切なリダイレクト先を返すようにしてください。
</Info>

```cs lines
[Authorize]
public class LogoutModel : PageModel
{
    public async Task OnGet()
    {
        var authenticationProperties = new LogoutAuthenticationPropertiesBuilder()
            .WithRedirectUri("/")
            .Build();

        await HttpContext.SignOutAsync(Auth0Constants.AuthenticationScheme, authenticationProperties);
        await HttpContext.SignOutAsync(CookieAuthenticationDefaults.AuthenticationScheme);
    }
}
```

<div id="whats-next">
  ## 次のステップ
</div>

より高度なユースケースでソフトウェア開発キット (SDK) を使用する方法の例をいくつかご用意しました。

* [スコープの構成](https://github.com/auth0/auth0-aspnetcore-authentication/blob/main/EXAMPLES.md#blazor-server)

[GitHub で編集](https://github.com/auth0/docs/edit/master/articles/quickstart/webapp/aspnet-core-blazor-server/01-login.md)