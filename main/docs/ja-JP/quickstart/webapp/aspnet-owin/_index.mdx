---
title: ASP.NET OWIN アプリケーションにログインを追加する
sidebarTitle: ASP.NET OWIN

---

import {AuthCodeGroup} from "/snippets/ja-JP/AuthCodeGroup.jsx";

import { Recipe, Content, Section, SideMenu, SideMenuSectionItem, SignUpForm } from "/snippets/ja-JP/recipe.jsx"
import WebConfig from "/snippets/ja-JP/quickstart/webapp/aspnet-owin/web-config.mdx"
import AccountController1 from "/snippets/ja-JP/quickstart/webapp/aspnet-owin/AccountController1.mdx"
import AccountController2 from "/snippets/ja-JP/quickstart/webapp/aspnet-owin/AccountController2.mdx"
import AccountController3 from "/snippets/ja-JP/quickstart/webapp/aspnet-owin/AccountController3.mdx"

export const sections = [
  { id: "configure-auth0", title: "Auth0 を設定する" },
  { id: "configure-the-project", title: "プロジェクトを設定する" },
  { id: "configure-the-middleware", title: "ミドルウェアを設定する" },
  { id: "add-login-to-your-application", title: "アプリケーションにログイン機能を追加する" },
  { id: "add-logout-to-your-application", title: "アプリケーションにログアウト機能を追加する" },
  { id: "show-user-profile-information", title: "ユーザー プロファイル情報を表示する" }
]

<Recipe isSingleColumn>
  <Content>
    Auth0を使用すると、アプリケーションに認証を迅速に追加し、ユーザープロファイル情報にアクセスできるようになります。このガイドでは、`Microsoft.Owin.Security.OpenIdConnect` NuGetパッケージを使用して、新規または既存のASP.NET OWINアプリケーションにAuth0を統合する方法を説明します。

    <Section id={sections[0].id} title={sections[0].title} stepNumber="1" isSingleColumn>
      Auth0 のサービスを利用するには、Auth0 Dashboard でアプリケーションを設定しておく必要があります。Auth0 アプリケーションは、開発しているプロジェクトで認証をどのように動作させるかを構成する場所です。

      ### アプリケーションを設定する

      インタラクティブセレクターを使用して、新しい Auth0 アプリケーションを作成するか、連携したいプロジェクトを表す既存のアプリケーションを選択します。Auth0 の各アプリケーションには英数字で構成された一意のクライアントIDが割り当てられており、アプリケーションのコードはこのクライアントIDを使用してソフトウェア開発キット (SDK) 経由で Auth0 API を呼び出します。

      このクイックスタートを使って設定した内容はすべて、[Dashboard](https://manage.auth0.com/#/) 上の Application に自動的に反映されます。ここから、今後も Application を管理できます。

      より完全な設定例を確認したい場合は、代わりにサンプルアプリケーションを参照できます。

      ### コールバック URL を設定する

      コールバック URL は、認証後に Auth0 からユーザーをリダイレクトしたい、アプリケーション内の URL です。設定されていない場合、ユーザーはログイン後にアプリケーションへ戻ることができません。

      <Info>
        サンプルプロジェクトに沿っている場合は、これを `http://localhost:3000/callback` に設定してください。
      </Info>

      ### ログアウト URL を設定する

      ログアウト URL は、ユーザーがログアウトした後に Auth0 からリダイレクトしたい、アプリケーション内の URL です。設定されていない場合、ユーザーはアプリケーションからログアウトできず、エラーが返されます。

      <Info>
        サンプルプロジェクトに沿っている場合は、これを `http://localhost:3000` に設定してください。
      </Info>

      <LoggedInForm />
    </Section>

    <Section id={sections[1].id} title={sections[1].title} stepNumber="2" isSingleColumn>
      ### NuGet からインストール

      Auth0 を ASP.NET OWIN と統合するには、`Microsoft.Owin.Security.OpenIdConnect` と `Microsoft.Owin.Security.Cookies` の NuGet パッケージを使用できます。

      ```text lines
      Install-Package Microsoft.Owin.Security.OpenIdConnect
      Install-Package Microsoft.Owin.Security.Cookies
      ```

      <Info>
        OWIN のクッキー ミドルウェアと System.Web クッキーを同時に構成している場合に問題が発生します。これらの問題を軽減する方法については、[System.Web cookie integration issues doc](https://github.com/aspnet/AspNetKatana/wiki/System.Web-response-cookie-integration-issues) を参照してください。
      </Info>

      ### 資格情報を構成する

      ソフトウェア開発キット (SDK) が正しく動作するようにするには、`Web.config` で次のプロパティを設定します。

      * `auth0:Domain`: Auth0 テナントのドメイン。これは Auth0 Dashboard の対象アプリケーションの **Settings** の Domain フィールドで確認できます。[カスタムドメイン](/docs/ja-JP/customize/custom-domains) を使用している場合は、そのカスタムドメインの値を設定します。
      * `auth0:ClientId`: Auth0 Dashboard で作成した Auth0 アプリケーションの ID。これは Auth0 Dashboard の対象アプリケーションの **Settings** の Client ID フィールドで確認できます。

      <AuthCodeGroup>
        <WebConfig />

        <AccountController1 />
      </AuthCodeGroup>
    </Section>

    <Section id={sections[2].id} title={sections[2].title} stepNumber="3" isSingleColumn>
      ASP.NET OWIN アプリケーションで認証を有効にするには、`Startup` クラスの `Configuration` メソッドに移動して、Cookie ミドルウェアと OIDC ミドルウェアを構成します。

      認証を正しく機能させるには、Cookie ミドルウェアと OpenID Connect ミドルウェアの両方を、この順序で登録することが重要です。OpenID Connect ミドルウェアは Auth0 との認証処理を行います。ユーザーが認証されると、そのユーザーのアイデンティティは Cookie ミドルウェアに保存されます。

      コードスニペットでは、`AuthenticationType` は **Auth0** に設定されています。次のセクションで `AuthenticationType` を使用して OpenID Connect ミドルウェアにチャレンジし、認証フローを開始します。`RedirectToIdentityProvider` 通知イベントは、正しいログアウト URL を組み立てます。

      <AuthCodeGroup>
        <WebConfig />

        <AccountController1 />
      </AuthCodeGroup>
    </Section>

    <Section id={sections[3].id} title={sections[3].title} stepNumber="4" isSingleColumn>
      ASP.NET OWIN アプリケーションでユーザーがログインできるようにするには、コントローラーに `Login` アクションを追加します。

      `HttpContext.GetOwinContext().Authentication.Challenge` を呼び出し、認証スキームとして `"Auth0"` を渡します。これにより、前の手順で登録した OIDC 認証ハンドラーが呼び出されます。`RedirectUri` を含む対応する `AuthenticationProperties` を必ず指定してください。

      `HttpContext.GetOwinContext().Authentication.Challenge` の呼び出しが成功すると、ユーザーは Auth0 にリダイレクトされ、アプリケーションにリダイレクトされて戻ってきたタイミングで、OIDC ミドルウェアと Cookie ミドルウェアの両方でサインイン済みの状態になります。これにより、ユーザーは後続のリクエストでも認証済みとして扱われます。

      <Info>
        ##### チェックポイント

        `Login` を構成したので、アプリケーションを実行して次の点を確認します。

        * `Login` アクションに移動すると Auth0 にリダイレクトされること
        * 認証情報を入力すると、アプリケーションに戻るようにリダイレクトされること
      </Info>

      <AuthCodeGroup>
        <AccountController1 />

        <WebConfig />
      </AuthCodeGroup>
    </Section>

    <Section id={sections[4].id} title={sections[4].title} stepNumber="5" isSingleColumn>
      コントローラーのアクションから、`CookieAuthenticationDefaults.AuthenticationType` 認証スキームを指定して `HttpContext.GetOwinContext().Authentication.SignOut` を呼び出し、アプリケーションからユーザーをログアウトさせます。

      さらに、Auth0 からもユーザーをログアウトさせたい場合（これにより、シングルサインオンに依存している他のアプリケーションからもログアウトされる可能性があります）は、`"Auth0"` 認証スキームを指定して `HttpContext.GetOwinContext().Authentication.SignOut` を呼び出します。

      <Info>
        ##### チェックポイント

        ログアウトを設定したので、アプリケーションを実行し、次の点を確認してください。

        * `Logout` アクションに移動すると、ユーザーがログアウトされること。
        * ログアウト処理の間に Auth0 にリダイレクトされ、その後すぐにアプリケーションへリダイレクトし直されること。
      </Info>

      <AuthCodeGroup>
        <AccountController2 />

        <WebConfig />
      </AuthCodeGroup>
    </Section>

    <Section id={sections[5].id} title={sections[5].title} stepNumber="6" isSingleColumn>
      ミドルウェアが Auth0 から正常にトークンを取得すると、IDトークンからユーザーの情報とクレームを抽出し、それらを `ClaimsIdentity` として利用できるようにします。コントローラーの `User` プロパティを使用して抽出された情報にアクセスします。

      ユーザープロファイルを作成するには、`User` からユーザーの名前、メールアドレス、プロファイル画像を取得し、コントローラー内からビューに渡します。

      <Info>
        ##### チェックポイント

        ユーザーのプロファイルをレンダリングするためのアクションを設定したので、アプリケーションを実行し、次の点を確認します。

        * 正常にログインした後に `Profile` アクションへ移動すると、ユーザーのプロファイルが表示されること。
      </Info>

      <AuthCodeGroup>
        <AccountController3 />

        <WebConfig />
      </AuthCodeGroup>
    </Section>

    ## 次のステップ

    素晴らしい!ここまで進めたなら、アプリケーションでログイン、ログアウト、およびユーザープロファイル情報が実装されているはずです。

    これでクイックスタートチュートリアルは終了ですが、他にも多くの機能があります。Auth0でできることの詳細については、以下をご確認ください:

    * [Auth0 Dashboard](https://manage.auth0.com/) - Auth0 のテナントとアプリケーションの設定・管理方法を学びます
    * [Auth0 Marketplace](https://marketplace.auth0.com/) - Auth0 の機能を拡張する連携機能を見つけましょう
  </Content>
</Recipe>