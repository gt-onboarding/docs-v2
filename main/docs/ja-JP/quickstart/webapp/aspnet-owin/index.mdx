---
title: "ASP.NET (OWIN)"
permalink: "01-login"
---

<div id="by-frederik-prijck">
  ##### Frederik Prijck 著
</div>

このチュートリアルでは、ASP.NET OWIN アプリケーションにユーザーのログイン機能を追加する方法を説明します。ご自身のアカウント向けに設定されたサンプルを使用してこのクイックスタートを進められるよう、あらかじめログインしておくことをお勧めします。

{/* <Card title="GitHub で表示" href="https://github.com/auth0-samples/auth0-aspnet-owin-mvc-samples/tree/master/Quickstart/Sample" icon="github">
  システム要件: Microsoft Visual Studio 2017 | Microsoft.Owin.Security.OpenIdConnect v4.1.0 以降
  </Card> */}

<div id="configure-auth0">
  ## Auth0 の設定
</div>

<div id="get-your-application-keys">
  ### アプリケーションキーを取得する
</div>

Auth0 にサインアップしたときに、新しいアプリケーションが自動的に作成されているか、またはご自身で新しく作成しているはずです。Auth0 と連携するには、そのアプリケーションに関するいくつかの詳細が必要です。これらの情報は Auth0 Dashboard の [Application Settings](https://manage.auth0.com/#/applications) セクションから確認できます。

<Frame>![App Dashboard](https://cdn2.auth0.com/docs/1.14550.0/media/articles/dashboard/client_settings.png)</Frame>

次の情報が必要です。

* **Domain**
* **Client ID**
* **Client Secret**

<Info>
  このページ上部からサンプルをダウンロードした場合、これらの値はあらかじめ入力されています。
</Info>

<div id="configure-callback-urls">
  ## コールバックURLを設定する
</div>

アプリケーションのコールバックURLは、ユーザーの認証が完了した後に Auth0 がリダイレクト先として使用し、OWIN OpenID Connect ミドルウェアが認証処理を完了するための URL です。

この URL を、アプリケーションの許可された URL の一覧に追加する必要があります。シードプロジェクトのコールバックURLは `http://localhost:3000/callback` なので、アプリケーションの **許可されたコールバックURL** セクションに必ず追加してください。あわせて、`http://localhost:3000/` を **許可されたログアウトURL** に追加します。

アプリケーションを別の URL にデプロイする場合は、その URL も **許可されたコールバックURL** と **許可されたログアウトURL** に追加する必要があります。サンプルプロジェクト内の `web.config` にも、これらの URL を指定する `auth0:RedirectUri` と `auth0:PostLogoutRedirectUri` という 2 つのキーが含まれています。こちらも忘れずに変更してください。

これで Auth0 を使い始める準備は完了です。

<div id="install-and-configure-the-openid-connect-middleware">
  ## OpenID Connect ミドルウェアをインストールして構成する
</div>

<Info>
  このクイックスタートでは OWIN ミドルウェアを使用するため、アプリケーションでも OWIN を使用する必要があります。アプリケーションでまだ OWIN を使用していない場合は、Microsoft の [OWIN ドキュメント](https://docs.microsoft.com/en-us/aspnet/aspnet/overview/owin-and-katana/) を参照して、アプリケーションで有効にしてください。
</Info>

ASP.NET MVC アプリケーションで Auth0 を使用した認証を有効にする最も簡単な方法は、OWIN の OpenID Connect ミドルウェアを使用することです。そのため、まずは `Microsoft.Owin.Security.OpenIdConnect` NuGet パッケージをインストールします。

```bash lines
Install-Package Microsoft.Owin.Security.OpenIdConnect
```

プロジェクトで Cookie 認証を有効にするには、次のミドルウェア ライブラリもインストールする必要があります。

```bash lines
Install-Package Microsoft.Owin.Security.Cookies
```

<Info>
  OWIN Cookie ミドルウェアと System.Web クッキーを同時に構成すると問題が発生する場合があります。これらの問題への対処方法については、[System.Web cookie integration issues doc](https://github.com/aspnet/AspNetKatana/wiki/System.Web-response-cookie-integration-issues) を参照してください。
</Info>

`Startup` クラスの `Configuration` メソッドに移動して、Cookie ミドルウェアと Auth0 ミドルウェアの両方を構成します。

```cs lines
// Startup.cs
using Microsoft.IdentityModel.Protocols.OpenIdConnect;
using Microsoft.IdentityModel.Tokens;
using Microsoft.Owin;
using Microsoft.Owin.Host.SystemWeb;
using Microsoft.Owin.Security;
using Microsoft.Owin.Security.Cookies;
using Microsoft.Owin.Security.OpenIdConnect;
using MvcApplication.Support;
using Owin;

public void Configuration(IAppBuilder app)
{
    // Auth0パラメータを設定
    string auth0Domain = ConfigurationManager.AppSettings["auth0:Domain"];
    string auth0ClientId = ConfigurationManager.AppSettings["auth0:ClientId"];
    string auth0RedirectUri = ConfigurationManager.AppSettings["auth0:RedirectUri"];
    string auth0PostLogoutRedirectUri = ConfigurationManager.AppSettings["auth0:PostLogoutRedirectUri"];

    // デフォルトの認証タイプとしてCookieを設定
    app.SetDefaultSignInAsAuthenticationType(CookieAuthenticationDefaults.AuthenticationType);
    app.UseCookieAuthentication(new CookieAuthenticationOptions
    {
        AuthenticationType = CookieAuthenticationDefaults.AuthenticationType,
        LoginPath = new PathString("/Account/Login"),

        // アプリに必要なSameSiteを設定します。ほとんどのシナリオではLaxが適していますが、
        // HTTPSの場合はSameSiteMode.Noneを設定することもできます
        CookieSameSite = SameSiteMode.Lax,

        // CookieManagerを設定する必要がある理由の詳細については、こちらを参照してください: 
        // https://github.com/aspnet/AspNetKatana/wiki/System.Web-response-cookie-integration-issues
        CookieManager = new SameSiteCookieManager(new SystemWebCookieManager())
    });

    // Auth0認証を設定
    app.UseOpenIdConnectAuthentication(new OpenIdConnectAuthenticationOptions
    {
        AuthenticationType = "Auth0",

        Authority = $"https://{auth0Domain}",

        ClientId = auth0ClientId,

        RedirectUri = auth0RedirectUri,
        PostLogoutRedirectUri = auth0PostLogoutRedirectUri,
        Scope = "openid profile email",
        TokenValidationParameters = new TokenValidationParameters
        {
            NameClaimType = "name"
        },

        // CookieManagerを設定する必要がある理由の詳細については、こちらを参照してください: 
        // https://docs.microsoft.com/en-us/aspnet/samesite/owin-samesite
        CookieManager = new SameSiteCookieManager(new SystemWebCookieManager()),

        // RedirectToIdentityProvider通知にフックすることでAuth0のログアウトURLを設定します。
        // この通知はAuth0へのリダイレクトが発生する前にトリガーされます。
        Notifications = new OpenIdConnectAuthenticationNotifications
        {
            RedirectToIdentityProvider = notification =>
            {
                // RequestTypeがOpenIdConnectRequestType.Logoutの場合のみ、ログアウトURLを設定します。
                // その他のRequestTypeは、ログアウト以外のAuth0とのやり取りを意味します。
                if (notification.ProtocolMessage.RequestType == OpenIdConnectRequestType.Logout)
                {
                    var logoutUri = $"https://{auth0Domain}/v2/logout?client_id={auth0ClientId}";

                    var postLogoutUri = notification.ProtocolMessage.PostLogoutRedirectUri;
                    if (!string.IsNullOrEmpty(postLogoutUri))
                    {
                        if (postLogoutUri.StartsWith("/"))
                        {
                            // 絶対パスに変換
                            var request = notification.Request;
                            postLogoutUri = request.Scheme + "://" + request.Host + request.PathBase + postLogoutUri;
                        }
                        logoutUri += $"&returnTo={ Uri.EscapeDataString(postLogoutUri)}";
                    }

                    notification.Response.Redirect(logoutUri);
                    notification.HandleResponse();
                }
                return Task.FromResult(0);
            }
        }
    });
}
```

認証を正しく機能させるには、cookie ミドルウェアと OpenID Connect ミドルウェアの両方を（この順序で）必ず登録する必要があります。OpenID Connect ミドルウェアは Auth0 との認証処理を担当します。ユーザーが認証されると、そのユーザーの識別情報は cookie ミドルウェアに保存されます。

上記のコードスニペットでは、`AuthenticationType` が **Auth0** に設定されている点に注意してください。これは次のセクションで OpenID Connect ミドルウェアにチャレンジし、認証フローを開始するために使用されます。また、正しい[ログアウト URL](/docs/ja-JP/authenticate/login/logout) を組み立てている `RedirectToIdentityProvider` 通知イベント内のコードにも注意してください。

<div id="add-login-to-your-aspnet-owin-application">
  ## ASP.NET OWIN アプリケーションにログインを追加する
</div>

ユーザーが ASP.NET OWIN アプリケーションにログインできるようにするには、コントローラーに `Login` アクションを追加します。

`HttpContext.GetOwinContext().Authentication.Challenge` を呼び出し、認証スキームとして `"Auth0"` を指定します。これにより、前の手順で登録した OIDC 認証ハンドラーが呼び出されます。`RedirectUri` を含む対応する `AuthenticationProperties` を必ず指定してください。

`HttpContext.GetOwinContext().Authentication.Challenge` の呼び出しが成功すると、ユーザーは Auth0 にリダイレクトされ、その後アプリケーションにリダイレクトされるタイミングで、OIDC ミドルウェアと Cookie ミドルウェアの両方にサインインされます。これにより、以降のリクエストでユーザーを認証済みとして扱えるようになります。

```cs lines
public class AccountController : Controller
{
    public ActionResult Login(string returnUrl)
    {
        HttpContext.GetOwinContext().Authentication.Challenge(new AuthenticationProperties
            {
                RedirectUri = returnUrl ?? Url.Action("Index", "Home")
            },
            "Auth0");
        return new HttpUnauthorizedResult();
    }
}
```

<div id="add-logout-to-your-aspnet-owin-application">
  ## ASP.NET OWIN アプリケーションにログアウト機能を追加する
</div>

コントローラーのアクションから、`HttpContext.GetOwinContext().Authentication.SignOut` を `CookieAuthenticationDefaults.AuthenticationType` 認証スキームを指定して呼び出し、アプリケーションからユーザーをログアウトさせます。

さらに、Auth0 からもユーザーをログアウトさせたい場合（これにより、シングルサインオンに依存している他のアプリケーションからもログアウトされる可能性があります）、`"Auth0"` 認証スキームを指定して `HttpContext.GetOwinContext().Authentication.SignOut` を呼び出します。

```cs lines
public class AccountController : Controller
{
    [Authorize]
    public void Logout()
    {
        HttpContext.GetOwinContext().Authentication.SignOut(CookieAuthenticationDefaults.AuthenticationType);
        HttpContext.GetOwinContext().Authentication.SignOut("Auth0");
    }
}
```

<div id="display-the-user-profile">
  ## ユーザープロファイルを表示する
</div>

ミドルウェアが Auth0 からトークンの取得に成功すると、IDトークンからユーザーの情報とクレームを抽出し、それらを `ClaimsIdentity` として利用できるようにします。コントローラーの `User` プロパティを使用して、抽出された情報にアクセスします。

ユーザープロファイルを作成するには、`User.Identity` からユーザーの名前、メールアドレス、プロファイル画像を取得し、コントローラー内からビューに渡します。

```cs lines
// Controllers/AccountController.cs

[Authorize]
public ActionResult UserProfile()
{
    var claimsIdentity = User.Identity as ClaimsIdentity;

    return View(new
    {
        Name = claimsIdentity?.FindFirst(c => c.Type == claimsIdentity.NameClaimType)?.Value,
        EmailAddress = claimsIdentity?.FindFirst(c => c.Type == ClaimTypes.Email)?.Value,
        ProfileImage = claimsIdentity?.FindFirst(c => c.Type == "picture")?.Value
    });
}
```

<div id="what-can-you-do-next">
  ##### 次にできること
</div>

<Note>
  ##### 次にできること

  <table>
    <tr>
      <td><a href="/docs/ja-JP/authenticate/identity-providers">他のアイデンティティ プロバイダーを設定する</a></td>
      <td><a href="/docs/ja-JP/secure/multi-factor-authentication">多要素認証を有効化する</a></td>
    </tr>

    <tr>
      <td><a href="/docs/ja-JP/secure/attack-protection">攻撃対策について詳しく知る</a></td>
      <td><a href="/docs/ja-JP/customize/rules">Rules について詳しく知る</a></td>
    </tr>
  </table>

  [GitHub で編集](https://github.com/auth0/docs/edit/master/articles/quickstart/native/flutter/01-login.md)
</Note>