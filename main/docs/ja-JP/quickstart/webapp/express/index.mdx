---
title: "Express"
permalink: "01-login"
---

import {AuthCodeBlock} from "/snippets/ja-JP/AuthCodeBlock.jsx";


<div id="by-david-patrick">
  ##### 著者: David Patrick
</div>

このチュートリアルでは、Node.js Express アプリケーションにユーザーのログイン、ログアウト、およびプロファイル機能を追加する方法を説明します。自分のアカウント用に設定されたサンプルを使ってこのクイックスタートを進められるよう、あらかじめログインしておくことをお勧めします。

{/* <Card title="GitHub で表示" href="https://github.com/auth0-samples/auth0-express-webapp-sample/tree/master/01-Login" icon="github">
  システム要件: Node.js 10.13+ | Express 4.17+
  </Card> */}


<div id="configure-auth0">
  ## Auth0 を設定する
</div>

ユーザーの認証を開始するには、Auth0 にアプリケーションを登録する必要があります。Auth0 Dashboard の [Applications](https://manage.auth0.com/#/applications) 画面に移動し、新しい **Regular Web Application** を作成して、以下の手順に従ってください。

<div id="1-configure-callback-url">
  ### 1. コールバックURLを設定する
</div>

コールバックURLは、ユーザーが認証を終えた後に Auth0 がリダイレクトするアプリケーションのルートです。このURLを Auth0 に登録しておかないと、ユーザーはアプリケーションにログインできず、「Callback URL mismatch」エラーが表示されます。

このクイックスタートで作成したアプリケーションのコールバックURLは `http://localhost:3000/callback` です。このURLを、先ほど作成したアプリケーションの **Allowed Callback URLs** フィールドに貼り付けてください。

<div id="2-configure-logout-url">
  ### 2. ログアウトURLを設定する
</div>

ログアウトURLは、Auth0がログアウト後にユーザーを戻すことができるアプリケーション内のルートです。このURLはAuth0に登録されている必要があり、登録されていないと、ユーザーはアプリケーションからログアウトできず、"misconfiguration" というエラーが発生します。

このクイックスタートで作成したアプリケーションのログアウトURLは `http://localhost:3000` です。先ほど作成したアプリケーションの **許可されたログアウトURL** フィールドにこの値を貼り付け、ページを下にスクロールして **変更を保存** をクリックします。

<div id="3-get-your-application-keys">
  ### 3. アプリケーションのキーを取得する
</div>

最後に、ステップ 7 で使用するために、アプリケーションから次のフィールドをコピーします。

* **ドメイン**
* **クライアントID**

<div id="integrate-auth0">
  ## Auth0 を統合する
</div>

<div id="4-install-dependencies">
  ### 4. 依存関係をインストールする
</div>

アプリケーションには、Auth0 が提供する Express 向けの OIDC 準拠ライブラリである [`express-openid-connect`](https://github.com/auth0/express-openid-connect) パッケージが必要です。

```bash lines
npm install express express-openid-connect --save
```


<div id="5-configure-router">
  ### 5. Router を設定する
</div>

Express OpenID Connect ライブラリは、認証ルートをアプリケーションに追加するための `auth` ルーターを提供します。次の設定キーを使用してルーターを設定する必要があります。

* `authRequired` - すべてのルートで認証を必須にするかどうかを制御します
* `auth0Logout` - Auth0 のログアウト機能を使用します
* `baseURL` - アプリケーションがホストされている URL
* `secret` - セッション Cookie を暗号化するために使用される長くランダムな文字列
* `issuerBaseURL` - [Application settings](https://manage.auth0.com/#/applications/\{yourClientId}/settings) にある、セキュアな URL（ドメイン）
* `clientID` - [Application settings](https://manage.auth0.com/#/applications/\{yourClientId}/settings) にあるクライアントID

このルーターを使用した設定例は次のとおりです。

export const codeExample = `const { auth } = require('express-openid-connect');

const config = {
  authRequired: false,
  auth0Logout: true,
  baseURL: 'http://localhost:3000',
  clientID: '{yourClientId}',
  issuerBaseURL: 'https://{yourDomain}',
  secret: 'LONG_RANDOM_STRING'
};

// auth ルーターは /login、/logout、/callback の各ルートを baseURL に紐付けます
app.use(auth(config));

// req.isAuthenticated は auth ルーターによって提供されます
app.get('/', (req, res) => {
  res.send(req.oidc.isAuthenticated() ? 'ログイン中' : 'ログアウト中')
});`;

<AuthCodeBlock children={codeExample} language="javascript" />

追加の設定オプションについては、[API ドキュメント](https://auth0.github.io/express-openid-connect)を参照してください。

<Info>
  コマンドラインで `openssl rand -hex 32` を実行すると、`LONG_RANDOM_STRING` に適した文字列を生成できます。
</Info>


<div id="login">
  ## ログイン
</div>

ユーザーは、ライブラリが提供する `/login` ルートにアクセスすることで、アプリケーションにログインできるようになりました。プロジェクトを `localhost:3000` で実行している場合、リンク先は [`http://localhost:3000/login`](http://localhost:3000/login) になります。

<div id="display-user-profile">
  ## ユーザープロファイルの表示
</div>

ユーザーのプロファイルを表示するには、アプリケーションで保護されたルートを設定する必要があります。

認証が必要なルートには `requiresAuth` ミドルウェアを追加します。このミドルウェアを使用するルートでは、有効なユーザーセッションがあるかどうかを確認し、存在しない場合はユーザーをログインするようにリダイレクトします。

```javascript lines
const { requiresAuth } = require('express-openid-connect');

app.get('/profile', requiresAuth(), (req, res) => {
  res.send(JSON.stringify(req.oidc.user));
});
```


<div id="logout">
  ## ログアウト
</div>

ユーザーは、ライブラリが提供する `/logout` ルートにアクセスすることで、アプリケーションからログアウトできます。プロジェクトを `localhost:3000` で実行している場合、そのリンクは [`http://localhost:3000/logout`](http://localhost:3000/logout) になります。

<Info>
Express におけるユーザー認証の実装について詳しくは、[Complete Guide to Node.js User Authentication with Auth0](https://auth0.com/blog/complete-guide-to-nodejs-express-user-authentication/) を参照してください。このガイドでは、サインアップボタンの作成、ルートの保護、API への安全な呼び出しなどの追加の詳細情報を提供しています。
</Info>

<div id="whats-next">
  ## 次のステップ
</div>

より高度なユースケース向けに、[Express OpenID Connect](https://github.com/auth0/express-openid-connect) の使用例をいくつか用意しました。

* [ルートのカスタマイズ](https://github.com/auth0/express-openid-connect/blob/master/EXAMPLES.md#3-route-customization)
* [外部 API 用のアクセストークンの取得](https://github.com/auth0/express-openid-connect/blob/master/EXAMPLES.md#4-obtaining-access-tokens-to-call-external-apis)
* [特定のルートに対して認証を必須にする](https://github.com/auth0/express-openid-connect/blob/master/EXAMPLES.md#2-require-authentication-for-specific-routes)

[GitHub で編集](https://github.com/auth0/docs/edit/master/articles/quickstart/webapp/express/01-login.md)