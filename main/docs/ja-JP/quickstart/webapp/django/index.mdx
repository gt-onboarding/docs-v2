---
title: "Django"
permalink: "01-login"
---

import {AuthCodeBlock} from "/snippets/ja-JP/AuthCodeBlock.jsx";

<div id="by-evan-sims">
  ##### Evan Sims による
</div>

このチュートリアルでは、Django フレームワークと Authlib OAuth ライブラリで構築された Python ウェブアプリケーションに、ユーザーのログイン機能を追加する方法を説明します。ご自身のアカウント向けに設定されたサンプルを使ってこのクイックスタートを進められるよう、事前にログインしておくことをお勧めします。

{/* <Card title="GitHub で表示" href="https://github.com/auth0-samples/auth0-django-web-app/tree/master/01-Login" icon="github">
  システム要件: Python 3 | Authlib 1.0 | Django 4.0
  </Card> */}

<Info>
  **認証が初めての方は**、[Auth0 の仕組み](/docs/ja-JP/get-started/auth0-overview)、[Regular Web Applications との統合方法](/docs/ja-JP/get-started/architecture-scenarios/sso-for-regular-web-apps)、および Auth0 が使用する[プロトコル](/docs/ja-JP/get-started/authentication-and-authorization-flow)を確認してください。
</Info>

<div id="configure-auth0">
  ## Auth0 を設定する
</div>

<div id="get-your-application-keys">
  ### アプリケーションキーを取得する
</div>

Auth0 にサインアップしたときに、自動的に新しいアプリケーションが作成されているか、自分で新しいアプリケーションを作成しているはずです。Auth0 と通信するには、そのアプリケーションに関するいくつかの情報が必要になります。これらの情報は Auth0 Dashboard の [Application Settings](https://manage.auth0.com/#/applications) セクションから取得できます。

<Frame>![App Dashboard](https://cdn2.auth0.com/docs/1.14550.0/media/articles/dashboard/client_settings.png)</Frame>

次の情報が必要です。

* **Domain**
* **Client ID**
* **Client Secret**

<Info>
  このページの上部からサンプルをダウンロードした場合、これらの値はあらかじめ入力されています。
</Info>

<div id="configure-callback-urls">
  ### コールバックURLを設定する
</div>

コールバックURLとは、ユーザーの認証が完了した後に Auth0 がリダイレクトする、アプリケーション内のURLです。アプリケーションのコールバックURLは、[Application Settings](https://manage.auth0.com/#/applications) の **Allowed Callback URLs** フィールドに登録する必要があります。このフィールドが設定されていない場合、ユーザーはアプリケーションにログインできず、エラーが表示されます。

<Info>
  このページの先頭からダウンロードしたサンプルプロジェクトを使用している場合、**Allowed Callback URLs** フィールドに追加する必要があるコールバックURLは `http://localhost:3000/callback` です。
</Info>

<div id="configure-logout-urls">
  ### ログアウトURLを設定する
</div>

ログアウトURLは、ユーザーが認可サーバーからログアウトされた後に、Auth0 がリダイレクト先として使用できるアプリケーション内の URL です。これは `returnTo` クエリパラメーターで指定します。アプリのログアウトURLは、[Application Settings](https://manage.auth0.com/#/applications) 内の **許可されたログアウトURL** フィールドに追加する必要があります。このフィールドが設定されていない場合、ユーザーはアプリケーションからログアウトできず、エラーが発生します。

<Info>
  このページの先頭からダウンロードしたサンプルプロジェクトを使用している場合、**許可されたログアウトURL** フィールドに追加する必要があるログアウトURLは `http://localhost:3000` です。
</Info>

<div id="create-application">
  ## アプリケーションの作成
</div>

このガイドでは、[Django フレームワーク](https://www.djangoproject.com/) と [Authlib](https://authlib.org/) を使用して、Python アプリケーションに Auth0 を統合する方法を説明します。まず、Django がシステムにインストールされていることを確認します。シェルで次のコマンドを実行します。

```bash lines
pip install django~=4.0
```

すでに Python アプリケーションがセットアップ済みの場合は、次のステップに進んでください。まだの場合は、新しいアプリケーションプロジェクトを作成しましょう。シェルから次のコマンドを実行し、新しいプロジェクトフォルダーに移動します。

```bash lines
django-admin startproject webappexample
cd webappexample
```

<div id="install-dependencies">
  ## 依存関係をインストールする
</div>

この連携には、Authlib などの依存ライブラリがいくつか必要です。まず、プロジェクトディレクトリに `requirements.txt` ファイルを作成し、次の内容を追加してください。

```txt lines
# 📁 requirements.txt -----

authlib ~= 1.0
django ~= 4.0
python-dotenv ~= 0.19
requests ~= 2.27
```

これらの依存関係をプロジェクトで利用できるようにするために、シェルで `pip install -r requirements.txt` を実行してください。

<div id="configure-your-env-file">
  ## .env ファイルを設定する
</div>

次に、プロジェクトディレクトリに `.env` ファイルを作成します。このファイルには、クライアントのキーやその他の設定情報を格納します。

export const codeExample = `# 📁 .env -----

AUTH0_CLIENT_ID={yourClientId}
AUTH0_CLIENT_SECRET={yourClientSecret}
AUTH0_DOMAIN={yourDomain}`;

<AuthCodeBlock children={codeExample} language="env" />

<div id="update-settingspy">
  ## settings.py を更新する
</div>

`.env` の値を読み込めるようにするために、`webappexample/settings.py` ファイルにいくつかの小さな変更を加える必要があります。ファイルの先頭に、次の import 文を追加します。

```py lines
# 📁 webappexample/settings.py -----

import os
from dotenv import load_dotenv, find_dotenv
```

次に、`BASE_DIR` の定義の直下に次の内容を追加します。

```py lines
# 📁 webappexample/settings.py -----

# 'BASE_DIR = ...' の後に次の行を追加します
TEMPLATE_DIR = os.path.join(BASE_DIR, "webappexample", "templates")
```

次に、`TEMPLATES` 変数を探し、`DIRS` の値に `TEMPLATE_DIR` 文字列を追加するよう更新します。これにより、テンプレートファイルを作成したあと、Django がそれらをどこで探せばよいかを認識できるようになります。この配列内のほかの内容はそのままにしておいてください。

```py lines
# 📁 webappexample/settings.py -----

TEMPLATES = [
    {
        # 他の行はそのままにして、`DIRS` だけを更新します。
        "DIRS": [TEMPLATE_DIR],
    },
]
```

最後に、このファイルの末尾に次の内容を追加します。

```py lines
# 📁 webappexample/settings.py -----

# 環境定義ファイルを読み込む
ENV_FILE = find_dotenv()
if ENV_FILE:
    load_dotenv(ENV_FILE)


# Auth0 アプリケーション設定をメモリに読み込む
AUTH0_DOMAIN = os.environ.get("AUTH0_DOMAIN")
AUTH0_CLIENT_ID = os.environ.get("AUTH0_CLIENT_ID")
AUTH0_CLIENT_SECRET = os.environ.get("AUTH0_CLIENT_SECRET")
```

<div id="setup-your-application">
  ## アプリケーションをセットアップする
</div>

これでアプリケーションの作成を開始する準備が整いました。プロジェクトディレクトリ内の `webappexample/views.py` ファイルを開きましょう。

まずは、アプリケーションで使用するライブラリをすべてインポートします。

```py lines
# 📁 webappexample/views.py -----

import json
from authlib.integrations.django_client import OAuth
from django.conf import settings
from django.shortcuts import redirect, render
from django.urls import reverse
from urllib.parse import quote_plus, urlencode
```

これで、Auth0 を使ったアプリケーションの認証を Authlib に処理させるよう構成できます。

```py lines
# 👆 上記の手順から続けています。これを webappexample/views.py ファイルに追記してください。

oauth = OAuth()

oauth.register(
    "auth0",
    client_id=settings.AUTH0_CLIENT_ID,
    client_secret=settings.AUTH0_CLIENT_SECRET,
    client_kwargs={
        "scope": "openid profile email",
    },
    server_metadata_url=f"https://{settings.AUTH0_DOMAIN}/.well-known/openid-configuration",
)
```

Authlib の OAuth `register()` メソッドで使用可能な設定オプションの詳細については、[公式ドキュメント](https://docs.authlib.org/en/latest/client/frameworks.html#using-oauth-2-0-to-log-in)を参照してください。

<div id="setup-your-route-handlers">
  ## ルートハンドラーを設定する
</div>

このデモでは、アプリケーションに 4 つのルートを追加します。`login`、`callback`、`logout`、そして `index` の各ルートです。

<div id="triggering-authentication-with-login">
  ### /login による認証の開始
</div>

ユーザーがアプリの `/login` ルートにアクセスすると、認証フローを開始するために Auth0 にリダイレクトされます。

```py lines
# 👆 上記の手順から続けています。これを webappexample/views.py ファイルに追加してください。

def login(request):
    return oauth.auth0.authorize_redirect(
        request, request.build_absolute_uri(reverse("callback"))
    )
```

<div id="finalizing-authentication-with-callback">
  ### /callback による認証の完了
</div>

ユーザーが Auth0 でのログインを完了すると、`/callback` ルートにあるアプリケーションへ戻されます。このルートはユーザーのセッションを保存する役割を持っているため、ユーザーが後で再度アクセスしたときに、毎回サインインし直す必要がなくなります。

```py lines
# 👆 上記の手順から続けています。これを webappexample/views.py ファイルに追加してください。

def callback(request):
    token = oauth.auth0.authorize_access_token(request)
    request.session["user"] = token
    return redirect(request.build_absolute_uri(reverse("index")))
```

<div id="clearing-a-session-with-logout">
  ### /logout でセッションをクリアする
</div>

このルートは、その名前のとおり、アプリケーションからユーザーをログアウトさせるためのものです。アプリ内のユーザーのセッションをクリアしたうえで、セッションが完全にクリアされたことを確実にするために、いったん Auth0 の logout エンドポイントへ短時間リダイレクトし、その後ユーザーをホームルート（次のセクションで説明します）に戻します。

```py lines
# 👆 上記の手順から続けています。これを webappexample/views.py ファイルに追加してください。

def logout(request):
    request.session.clear()

    return redirect(
        f"https://{settings.AUTH0_DOMAIN}/v2/logout?"
        + urlencode(
            {
                "returnTo": request.build_absolute_uri(reverse("index")),
                "client_id": settings.AUTH0_CLIENT_ID,
            },
            quote_via=quote_plus,
        ),
    )
```

<div id="theres-no-place-like-home">
  ### /home ほど落ち着く場所はない
</div>

最後に、ホームルートは、認証済みユーザーの詳細情報を表示したり、訪問者にサインインを促したりする場所として機能します。

```py lines
# 👆 上記の手順から続けています。これを webappexample/views.py ファイルに追加してください。

def index(request):
    return render(
        request,
        "index.html",
        context={
            "session": request.session.get("user"),
            "pretty": json.dumps(request.session.get("user"), indent=4),
        },
    )
```

<div id="register-your-routes">
  ### ルートを登録する
</div>

最後に、これらの新しいルートを Django に認識させる必要があります。`webappexample/urls.py` ファイルの内容を、次のコードに置き換えてください。

```py lines
# 📁 webappexample/urls.py -----

from django.urls import path

from . import views

urlpatterns = [
    path("", views.index, name="index"),
    path("login", views.login, name="login"),
    path("logout", views.logout, name="logout"),
    path("callback", views.callback, name="callback"),
]
```

<div id="add-templates">
  ## テンプレートを追加する
</div>

次に、`render()` 呼び出しで使用されるシンプルなテンプレートファイルを作成します。

`webappexample` フォルダ内に `templates` という名前の新しいサブディレクトリを作成し、その中に `index.html` ファイルを作成します。

```html lines
# 📁 webappexample/templates/index.html -----

<html>
  <head>
    <meta charset="utf-8" />
    <title>Auth0 Example</title>
  </head>
  <body>
    {% if session %}
    <h1>ようこそ、{{session.userinfo.name}}さん!</h1>
    <p><a href="{% url 'logout' %}">ログアウト</a></p>
    <div><pre>{{pretty}}</pre></div>
    {% else %}
    <h1>ようこそ、ゲストさん</h1>
    <p><a href="{% url 'login' %}">ログイン</a></p>
    {% endif %}
  </body>
</html>
```

<div id="run-your-application">
  ## アプリケーションを実行する
</div>

アプリケーションを実行する準備が整いました。プロジェクトディレクトリでシェルを開き、次のコマンドを実行します。

```bash lines
python3 manage.py migrate
python3 manage.py runserver 3000
```

ブラウザーで `http://localhost:3000` を開くと、アプリケーションが起動するはずです。

<Note>
  ##### 次にできること

  <table>
    <tr>
      <td><a href="/docs/ja-JP/authenticate/identity-providers">その他のアイデンティティ プロバイダーを設定する</a></td>
      <td><a href="/docs/ja-JP/secure/multi-factor-authentication">多要素認証を有効にする</a></td>
    </tr>

    <tr>
      <td><a href="/docs/ja-JP/secure/attack-protection">攻撃保護について学ぶ</a></td>
      <td><a href="/docs/ja-JP/customize/rules">Rules について学ぶ</a></td>
    </tr>
  </table>

  [GitHub で編集](https://github.com/auth0/docs/edit/master/articles/quickstart/native/flutter/01-login.md)
</Note>
