---
title: "Java Spring Boot"
permalink: "01-login"
---

import {AuthCodeBlock} from "/snippets/ja-JP/AuthCodeBlock.jsx";

<div id="by-jim-anderson">
  ##### Jim Anderson 著
</div>

Okta Spring Boot Starter を使用すると、Spring Boot アプリケーションにログイン機能を簡単に追加できます。ご利用のアカウントに合わせて設定されたサンプルを使ってこのクイックスタートを進められるよう、ログインすることをお勧めします。

{/* <Card title="GitHub で表示" href="https://github.com/auth0-samples/auth0-spring-boot-login-samples/tree/master/mvc-login" icon="github">
  システム要件：Java 17
  </Card> */}

<Note>
  ### Spring WebFlux を使用していますか？

  このチュートリアルでは [Spring MVC](https://docs.spring.io/spring/docs/current/spring-framework-reference/web.html) を使用します。もし [Spring WebFlux](https://docs.spring.io/spring/docs/current/spring-framework-reference/web-reactive.html#spring-web-reactive) を使用している場合、認証を追加する手順は概ね同じですが、実装の詳細が一部異なります。Spring Boot WebFlux アプリケーションに Auth0 を統合する方法については、[Spring Boot WebFlux サンプルコード](https://github.com/auth0-samples/auth0-spring-boot-login-samples/tree/master/webflux-login) を参照してください。
</Note>

<Info>
  **認証は初めてですか？** [Auth0 の仕組み](/docs/ja-JP/get-started/auth0-overview)、[通常の Web アプリケーションとの統合方法](/docs/ja-JP/get-started/architecture-scenarios/sso-for-regular-web-apps)、および利用している[プロトコル](/docs/ja-JP/get-started/authentication-and-authorization-flow)について学んでください。
</Info>

<div id="configure-auth0">
  ## Auth0 の設定
</div>

<div id="get-your-application-keys">
  ### アプリケーションキーを取得する
</div>

Auth0 にサインアップした際に、新しいアプリケーションが自動的に作成されているか、あるいはご自身で新しいアプリケーションを作成しているはずです。Auth0 と連携するには、そのアプリケーションに関するいくつかの情報が必要です。これらの情報は、 Auth0 Dashboard の [Application Settings](https://manage.auth0.com/#/applications) セクションから取得できます。

<Frame>![App Dashboard](https://cdn2.auth0.com/docs/1.14550.0/media/articles/dashboard/client_settings.png)</Frame>

次の情報が必要です。

* **Domain**
* **Client ID**
* **Client Secret**

<Info>
  このページ上部からサンプルをダウンロードした場合、これらの値はあらかじめ入力されています。
</Info>

<div id="configure-callback-urls">
  ### コールバックURLを設定する
</div>

コールバックURLは、ユーザーが認証を完了した後に Auth0 がリダイレクトする、アプリケーション内の URL です。アプリケーションのコールバックURLは、[Application Settings](https://manage.auth0.com/#/applications) の **Allowed Callback URLs** フィールドに追加する必要があります。このフィールドが設定されていない場合、ユーザーはアプリケーションにログインできず、エラーが発生します。

<Info>
  このページの上部からダウンロードしたサンプルプロジェクトに沿って進めている場合、**Allowed Callback URLs** フィールドに追加する必要があるコールバックURLは `http://localhost:3000/login/oauth2/code/okta` です。
</Info>

<div id="configure-logout-urls">
  ### ログアウトURLを設定する
</div>

ログアウトURLは、ユーザーが認可サーバーからログアウトされた後に、Auth0 がアプリケーションに戻るために使用できるアプリケーション内の URL です。これは `returnTo` クエリパラメータで指定します。アプリケーションのログアウトURLは、[Application Settings](https://manage.auth0.com/#/applications) の **許可されたログアウトURL** フィールドに追加する必要があります。このフィールドが設定されていない場合、ユーザーはアプリケーションからログアウトできず、エラーが発生します。

<Info>
  このページの上部からダウンロードしたサンプルプロジェクトを使って手順を進めている場合、**許可されたログアウトURL** フィールドに追加する必要があるログアウトURLは `http://localhost:3000/` です。
</Info>

<div id="configure-spring-boot-application">
  ## Spring Boot アプリケーションの設定
</div>

<div id="add-dependencies">
  ### 依存関係を追加する
</div>

Spring Boot アプリケーションを Auth0 と統合するには、アプリケーションの依存関係に [Okta Spring Boot Starter](https://github.com/okta/okta-spring-boot/) を含めます。

<Info>
  このガイドでは、ビュー層には [Thymeleaf](https://www.thymeleaf.org/) と [Spring Security integration module](https://github.com/thymeleaf/thymeleaf-extras-springsecurity) を使用します。別のビュー技術を使用していても、Spring Security の設定やコンポーネントは同じです。
</Info>

Gradle を使用している場合は、次のようにこれらの依存関係を追加できます。

```gradle lines
plugins {
    id 'java'
    id 'org.springframework.boot' version '3.1.4'
    id 'io.spring.dependency-management' version '1.1.3'
}

implementation 'com.okta.spring:okta-spring-boot-starter:3.0.5'
implementation 'org.springframework.boot:spring-boot-starter-web'
implementation 'org.springframework.boot:spring-boot-starter-thymeleaf'
implementation 'org.thymeleaf.extras:thymeleaf-extras-springsecurity6'
implementation 'nz.net.ultraq.thymeleaf:thymeleaf-layout-dialect'
```

Maven を使用している場合は:

```xml lines
<parent>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-parent</artifactId>
    <version>3.1.5</version>
    <relativePath/>
</parent>

<dependencies>
    <dependency>
        <groupId>com.okta</groupId>
        <artifactId>okta-spring-boot-starter</artifactId>
        <version>3.0.5</version>
    </dependency>
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-web</artifactId>
    </dependency>
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-oauth2-client</artifactId>
    </dependency>
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-thymeleaf</artifactId>
    </dependency>
    <dependency>
        <groupId>org.thymeleaf.extras</groupId>
        <artifactId>thymeleaf-extras-springsecurity6</artifactId>
    </dependency>
    <dependency>
        <groupId>nz.net.ultraq.thymeleaf</groupId>
        <artifactId>thymeleaf-layout-dialect</artifactId>
    </dependency>
</dependencies>
```

<div id="configure-spring-security">
  ### Spring Security を構成する
</div>

Okta Spring Boot Starter を使用すると、Auth0 と連携するようにアプリケーションを簡単に構成できます。以下のサンプルでは `application.yml` ファイルを使用していますが、プロパティファイルやその他の[サポートされている外部設定メカニズム](https://docs.spring.io/spring-boot/docs/current/reference/htmlsingle/#boot-features-external-config)を使用することもできます。

export const codeExample = `# src/main/resources/application.yml
okta:
  oauth2:
    issuer: https://{yourDomain}/
    client-id: {yourClientId}
    client-secret: {yourClientSecret}

# 上記のサンプルおよび手順では、コールバック URL とログアウト URL の設定にポート 3000 が使用されています。
# 別のポートを使用する場合は、この値を変更し、コールバック URL とログアウト URL が正しいポートで
# 設定されていることを必ず確認してください。
server:
  port: 3000`;

<AuthCodeBlock children={codeExample} language="yml" />

<div id="add-login-to-your-application">
  ## アプリケーションにログイン機能を追加する
</div>

Auth0 を使用したユーザーのログインを有効にするには、[SecurityFilterChain](https://docs.spring.io/spring-security/site/docs/current/api/org/springframework/security/web/SecurityFilterChain.html) を登録するクラスを作成し、そのクラスに `@Configuration` アノテーションを付与します。

```java lines
package com.auth0.example;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.web.SecurityFilterChain;

import static org.springframework.security.config.Customizer.withDefaults;

@Configuration
@EnableWebSecurity
public class SecurityConfig {

    @Bean
    public SecurityFilterChain configure(HttpSecurity http) throws Exception {
        http
            .authorizeHttpRequests(authorize -> authorize
                .anyRequest().authenticated()
            )
            .oauth2Login(withDefaults());
        return http.build();
    }
}
```

<Info>
  [HttpSecurity](https://docs.spring.io/spring-security/site/docs/current/api/org/springframework/security/config/annotation/web/builders/HttpSecurity.html) インスタンスをさらに構成して、すべてのパスまたは特定のパスで認証を必須にできます。たとえば、ホームページ以外のすべてのパスで認証を必須にするには、次のようにします。

  ```java lines
  http
      .authorizeHttpRequests(authorize -> authorize
          .requestMatchers("/").permitAll()
          .anyRequest().authenticated()
      );
  ```
</Info>

Okta Spring Boot Starter は、先ほど定義したクライアント設定を使用して、ユーザーがアプリケーションの `/oauth2/authorization/okta` パスにアクセスしたときのログイン処理を行います。これを利用して、アプリケーション内にログインリンクを作成できます。

```html lines
<!-- src/main/resources/templates/index.html -->
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity5">
    <body>
        <div sec:authorize="!isAuthenticated()">
            <a th:href="@{/oauth2/authorization/okta}">Log In</a>
        </div>
        <div sec:authorize="isAuthenticated()">
            <p>You are logged in!</p>
        </div>
    </body>
</html>
```

ビューをレンダリングするためのコントローラーを新規作成するか、既存のコントローラーを更新してください。

```java lines
package com.auth0.example;

import org.springframework.security.core.annotation.AuthenticationPrincipal;
import org.springframework.security.oauth2.core.oidc.user.OidcUser;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.GetMapping;

/**
 * ホームページのコントローラー。
 */
@Controller
public class HomeController {

    @GetMapping("/")
    public String home(Model model, @AuthenticationPrincipal OidcUser principal) {
        return "index";
    }
}
```

<Note>
  ### チェックポイント

  アプリケーションにログインリンクを追加します。そのリンクをクリックしたときに、アプリケーションが [Auth0 Universal Login](https://auth0.com/universal-login) ページにリダイレクトされ、ユーザー名とパスワード、またはソーシャル プロバイダーを使ってログインまたはサインアップできることを確認してください。

  これが完了したら、Auth0 がアプリケーションにリダイレクトし、自分がログイン済みであることを確認してください。
</Note>

<Frame>![Auth0 Universal Login](https://cdn2.auth0.com/docs/1.14550.0/media/quickstarts/universal-login.png)</Frame>

<Info>
  Auth0 は、新しいテナントではデフォルトで Google ソーシャル プロバイダーを有効にし、[ソーシャル アイデンティティ プロバイダー](https://auth0.com/docs/connections/identity-providers-social) でのログインをテストできる開発者用キーを提供します。ただし、これらの開発者用キーにはいくつかの制限があり、そのためにアプリケーションの動作が通常と異なる場合があります。この動作がどのようなものか、またその対処方法の詳細については、「[Test Social Connections with Auth0 Developer Keys](https://auth0.com/docs/connections/social/devkeys#limitations-of-developer-keys)」ドキュメントを参照してください。
</Info>

<div id="add-logout-to-your-application">
  ## アプリケーションにログアウト機能を追加する
</div>

ユーザーがアプリケーションにログインできるようになったら、次は[ログアウトする手段](https://auth0.com/docs/logout/guides/logout-auth0)が必要です。デフォルトでは、ログアウトが有効な場合、Spring Security はユーザーをアプリケーションからログアウトさせ、セッションをクリアします。Auth0 からのログアウトを正しく行うには、`LogoutHandler` を指定してユーザーを [Auth0 のログアウトエンドポイント](https://auth0.com/docs/api/authentication?javascript#logout)（`https://{yourDomain}/v2/logout`）へリダイレクトし、その後すぐにユーザーをアプリケーションへリダイレクトできるようにします。

`SecurityConfig` クラスで、Auth0 のログアウトエンドポイントへリダイレクトする `LogoutHandler` を用意し、`HttpSecurity` を設定してその `LogoutHandler` を追加します。

```java lines
package com.auth0.example;

import org.springframework.beans.factory.annotation.Value;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.web.SecurityFilterChain;
import org.springframework.security.web.authentication.logout.LogoutHandler;
import org.springframework.web.servlet.support.ServletUriComponentsBuilder;

import java.io.IOException;

import static org.springframework.security.config.Customizer.withDefaults;

@Configuration
@EnableWebSecurity
public class SecurityConfig {

    @Value("${okta.oauth2.issuer}")
    private String issuer;
    @Value("${okta.oauth2.client-id}")
    private String clientId;

    @Bean
    public SecurityFilterChain configure(HttpSecurity http) throws Exception {
        http
            .authorizeHttpRequests(authorize -> authorize
                .requestMatchers("/", "/images/**").permitAll()
                .anyRequest().authenticated()
            )
            .oauth2Login(withDefaults())

            // Auth0でログアウトを構成
            .logout(logout -> logout
                .addLogoutHandler(logoutHandler()));
        return http.build();
    }

    private LogoutHandler logoutHandler() {
        return (request, response, authentication) -> {
            try {
                String baseUrl = ServletUriComponentsBuilder.fromCurrentContextPath().build().toUriString();
                response.sendRedirect(issuer + "v2/logout?client_id=" + clientId + "&returnTo=" + baseUrl);
            } catch (IOException e) {
                throw new RuntimeException(e);
            }
        };
    }
}
```

次に、ビューを更新して `/logout` エンドポイント（Spring Security がデフォルトで提供します）に POST リクエストを送信し、ユーザーがログアウトできるようにします。

```html lines
<div sec:authorize="isAuthenticated()">
    <p>ログイン中です!</p>
    <form name="logoutForm" th:action="@{/logout}" method="post">
        <button type="submit" value="ログアウト"/>
    </form>
</div>
```

<Note>
  ### チェックポイント

  アプリケーションのビューにログアウトリンクを追加します。リンクをクリックしたときに、アプリケーションが「Settings」で「許可されたログアウトURL」の一つとして指定したアドレスにリダイレクトし、アプリケーションからログアウトされていることを確認してください。
</Note>

<div id="show-user-profile-information">
  ## ユーザープロファイル情報を表示する
</div>

ログインしているユーザーに関連付けられた[プロファイル情報](https://auth0.com/docs/users/concepts/overview-user-profile)は、[OidcUser](https://docs.spring.io/spring-security/site/docs/current/api/org/springframework/security/oauth2/core/oidc/user/OidcUser.html) クラスを通じて取得できます。このクラスは、[AuthenticationPrincipal アノテーション](https://docs.spring.io/spring-security/site/docs/current/api/org/springframework/security/core/annotation/AuthenticationPrincipal.html)と併用できます。

コントローラーでは、ユーザーのプロファイル情報をモデルに追加します。

```java lines
@Controller
public class HomeController {

    @GetMapping("/")
    public String home(Model model, @AuthenticationPrincipal OidcUser principal) {
        if (principal != null) {
            model.addAttribute("profile", principal.getClaims());
        }
        return "index";
    }
}
```

その後、このプロファイル情報を以下のようにビューで利用できます。

```html lines
<div sec:authorize="isAuthenticated()">
    <Frame><img th:src="${profile.get('picture')}" th:attr="alt=${profile.get('name')}"/></Frame>
    <h2 th:text="${profile.get('name')}"></h2>
    <p th:text="${profile.get('email')}"></p>
    <a th:href="@{/logout}">ログアウト</a>
</div>
```

<Note>
  ### チェックポイント

  ログイン後に、ユーザー名または[その他の `user` プロパティ](https://auth0.com/docs/users/references/user-profile-structure#user-profile-attributes)を表示できることを確認してください。
</Note>

<Note>
  ##### 次にできること

  <table>
    <tr>
      <td><a href="/docs/ja-JP/authenticate/identity-providers">他のアイデンティティ プロバイダーを設定する</a></td>
      <td><a href="/docs/ja-JP/secure/multi-factor-authentication">多要素認証を有効にする</a></td>
    </tr>

    <tr>
      <td><a href="/docs/ja-JP/secure/attack-protection">攻撃対策について学ぶ</a></td>
      <td><a href="/docs/ja-JP/customize/rules">Rules について学ぶ</a></td>
    </tr>
  </table>

  [GitHub で編集](https://github.com/auth0/docs/edit/master/articles/quickstart/native/flutter/01-login.md)
</Note>
