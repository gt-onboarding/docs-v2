---
title: Go アプリケーションにログインを追加する

sidebarTitle: Go
---

import { Recipe, Content, Section, SideMenu, SideMenuSectionItem, SignUpForm } from "/snippets/ja-JP/recipe.jsx";
import { LoggedInForm } from "/snippets/ja-JP/Login.jsx";

import Auth from "/snippets/ja-JP/quickstart/webapp/golang/auth.go.mdx";
import Callback from "/snippets/ja-JP/quickstart/webapp/golang/callback.go.mdx";
import Env from "/snippets/quickstart/webapp/golang/.env.mdx";
import Go from "/snippets/ja-JP/quickstart/webapp/golang/go.mod.mdx";
import Isauthenticated from "/snippets/ja-JP/quickstart/webapp/golang/isAuthenticated.go.mdx";
import Login from "/snippets/ja-JP/quickstart/webapp/golang/login.go.mdx";
import Logout from "/snippets/ja-JP/quickstart/webapp/golang/logout.go.mdx";
import Main from "/snippets/ja-JP/quickstart/webapp/golang/main.go.mdx";
import Router from "/snippets/ja-JP/quickstart/webapp/golang/router.go.mdx";
import User from "/snippets/ja-JP/quickstart/webapp/golang/user.go.mdx";

import {AuthCodeGroup} from "/snippets/ja-JP/AuthCodeGroup.jsx";

export const sections = [
      { id: "configure-auth0", title: "Auth0 を構成する" },
      { id: "install-dependencies", title: "依存関係をインストールする" },
      { id: "configure-the-environment-variables", title: "環境変数を設定する" },
      { id: "configure-oauth2-and-openid-connect-packages", title: "OAuth2 と OpenID Connect のパッケージを設定する" },
      { id: "set-up-your-application-routes", title: "アプリケーションのルートを設定する" },
      { id: "add-login-to-your-application", title: "アプリケーションにログイン機能を追加する" },
      { id: "handle-authentication-callback", title: "認証コールバックを処理する" },
      { id: "display-user-profile-information", title: "ユーザーのプロファイル情報を表示する" },
      { id: "add-logout-to-your-application", title: "アプリケーションにログアウト機能を追加する" },
      { id: "protect-routes", title: "ルートを保護する" },
      { id: "serve-your-application", title: "アプリケーションを起動する" }
]


<Recipe isSingleColumn>
  <Content>
    Auth0を使用すると、アプリケーションに認証を追加し、ユーザープロファイル情報にアクセスできるようになります。このガイドでは、新規または既存のGo Webアプリケーションに、Auth0を統合する方法を説明します。

    <Section id={sections[0].id} title={sections[0].title} stepNumber="1" isSingleColumn>
      Auth0 のサービスを利用するには、Auth0 Dashboard で Application を設定しておく必要があります。Auth0 Application は、
      開発中のプロジェクトで認証をどのように動作させるかを設定する場所です。

      ### アプリケーションを構成する

      インタラクティブ セレクターを使用して新しい Auth0 Application を作成するか、統合したいプロジェクトを表す既存の Application を選択します。Auth0 のすべての Application には、アプリケーションコードが SDK を通じて Auth0 API を呼び出す際に使用する、英数字で構成された一意のクライアントID が割り当てられます。

      このクイックスタートを使って構成した設定はすべて、[Dashboard](https://manage.auth0.com/dashboard/us/auth0-dsepaid/) 上の Application に自動的に反映されます。ここから、今後も Application を管理できます。

      より完全な構成を確認したい場合は、代わりにサンプルアプリケーションを参照できます。

      ### コールバック URL を構成する

      コールバック URL は、ユーザーが認証された後に Auth0 からリダイレクトしたい、アプリケーション内の URL です。設定されていない場合、ユーザーはログイン後にアプリケーションへ戻ることができません。

      <Info>
        サンプルプロジェクトに沿って進めている場合は、これを
        `http://localhost:3000/callback`
        に設定してください。
      </Info>

      ### ログアウト URL を構成する

      ログアウト URL は、ユーザーがログアウトした後に Auth0 からリダイレクトしたい、アプリケーション内の URL です。設定されていない場合、ユーザーはアプリケーションからログアウトできず、エラーが発生します。

      <Info>
        サンプルプロジェクトに沿って進めている場合は、これを `http://localhost:3000` に設定してください。
      </Info>

      <LoggedInForm />
    </Section>

    <Section id={sections[1].id} title={sections[1].title} stepNumber="2" isSingleColumn>
      アプリケーションで使用するすべての依存関係を一覧するために、`go.mod` ファイルを作成します。

      Go アプリケーションに Auth0 を統合するには、`coreos/go-oidc/v3` と `x/oauth2`
      パッケージを追加します。

      OIDC および OAuth2 パッケージに加えて、`joho/godotenv`、`gin-gonic/gin`、および
      `gin-contrib/sessions` を追加します。

      <Info>
        この例ではルーティングに `gin` を使用していますが、任意のルーターを使用できます。
      </Info>

      必要な依存関係を含めて `go.mod` ファイルを保存し、ターミナルで次のコマンドを実行してインストールします。

      ```text lines
      go mod download
      ```

      <AuthCodeGroup>
        <User />

        <Auth />

        <Callback />

        <Env />

        <Go />

        <Isauthenticated />

        <Login />

        <Logout />

        <Main />

        <Router />
      </AuthCodeGroup>
    </Section>

    <Section id={sections[2].id} title={sections[2].title} stepNumber="3" isSingleColumn>
      プロジェクトディレクトリのルートにある `.env` に、次の環境変数を設定する必要があります。

      * **AUTH0&#95;DOMAIN**: Auth0 テナントのドメインです。Auth0 Dashboard のアプリケーションの Settings の Domain フィールドで Auth0 Domain を確認できます。カスタムドメインを使用する場合は、ここにはカスタムドメインの値を設定します。
      * **AUTH0&#95;CLIENT&#95;ID**: このクイックスタートの前半で設定した Auth0 アプリケーションの ID です。Auth0 Dashboard のアプリケーションの Settings の Client ID フィールドで確認できます。
      * **AUTH0&#95;CLIENT&#95;SECRET**: このクイックスタートの前半で設定した Auth0 アプリケーションのクライアントシークレットです。Auth0 Dashboard のアプリケーションの Settings の Client Secret フィールドで確認できます。
      * **AUTH0&#95;CALLBACK&#95;URL**: 認証が成功した後に Auth0 がユーザーをリダイレクトするために使用する URL です。

      <AuthCodeGroup>
        <Env />

        <Auth />

        <Callback />

        <Go />

        <Isauthenticated />

        <Login />

        <Logout />

        <Main />

        <Router />

        <User />
      </AuthCodeGroup>
    </Section>

    <Section id={sections[3].id} title={sections[3].title} stepNumber="4" isSingleColumn>
      次に、OAuth2 と OpenID Connect のパッケージを設定します。

      `platform/authenticator` フォルダーに `auth.go` というファイルを作成します。このパッケージ内で、[OAuth2](https://godoc.org/golang.org/x/oauth2) と [OIDC](https://godoc.org/github.com/coreos/go-oidc) のクライアントを構成して返すメソッドと、IDトークンを検証するメソッドをそれぞれ作成します。

      <AuthCodeGroup>
        <Auth />

        <Callback />

        <Env />

        <Go />

        <Isauthenticated />

        <Login />

        <Logout />

        <Main />

        <Router />

        <User />
      </AuthCodeGroup>
    </Section>

    <Section id={sections[4].id} title={sections[4].title} stepNumber="5" isSingleColumn>
      `platform/router` フォルダーに `router.go` という名前のファイルを作成します。このパッケージ内で、[github.com/gin-gonic/gin](https://github.com/gin-gonic/gin) を使用してルートを設定し、それらを返すメソッドを作成します。`login` と `callback` ハンドラーで使用するために、`Authenticator` のインスタンスをこのメソッドに渡します。

      <AuthCodeGroup>
        <Router />

        <Auth />

        <Callback />

        <Env />

        <Go />

        <Isauthenticated />

        <Login />

        <Logout />

        <Main />

        <User />
      </AuthCodeGroup>
    </Section>

    <Section id={sections[5].id} title={sections[5].title} stepNumber="6" isSingleColumn>
      ユーザーに認証を行ってもらうには、`/login` ルートを処理するハンドラー関数を作成する必要があります。

      `web/app/login` フォルダーに `login.go` という名前のファイルを作成し、
      `Handler` 関数を追加します。ハンドラーが実行されると、ユーザーは Auth0 にリダイレクトされ、そこで認証情報を入力できるようになります。

      `/login` ルートを呼び出すには、`web/template` ディレクトリ内にある `home.html` テンプレートに `/login` へのリンクを追加します。

      <AuthCodeGroup>
        <Login />

        <Auth />

        <Callback />

        <Env />

        <Go />

        <Isauthenticated />

        <Logout />

        <Main />

        <Router />

        <User />
      </AuthCodeGroup>
    </Section>

    <Section id={sections[6].id} title={sections[6].title} stepNumber="7" isSingleColumn>
      ユーザーが Auth0 の Universal Login ページで認証を完了すると、`/callback` ルートでアプリに戻ります。

      `web/app/callback` フォルダーに `callback.go` というファイルを作成し、`Handler` 関数を追加します。

      このハンドラーは、Auth0 から渡されるクエリ文字列の `code` を受け取り、それを IDトークンと
      アクセストークンに交換します。

      IDトークンが有効であれば、セッションにプロファイル情報とアクセストークンを保存します。プロファイル
      情報は、IDトークンに含まれるクレームに基づきます。アプリケーションは、セッションに保存された情報に
      必要に応じてアクセスできます。

      <AuthCodeGroup>
        <Callback />

        <Auth />

        <Env />

        <Go />

        <Isauthenticated />

        <Login />

        <Logout />

        <Main />

        <Router />

        <User />
      </AuthCodeGroup>
    </Section>

    <Section id={sections[7].id} title={sections[7].title} stepNumber="8" isSingleColumn>
      ユーザーがログインできるようになった今、認証済みユーザーに関連付けられたプロファイル情報を取得して利用したくなるでしょう。

      ニックネームやプロファイル画像などのプロファイル情報には、セッションに保存されている
      `profile` を通じてアクセスできます。

      `web/app/user/user.go` 内で `/user` エンドポイント用のハンドラーを作成し、対応する
      HTML ファイルを返します。`profile` が `ctx.HTML()` に渡されるため、その HTML ファイル内で
      `picture` や `nickname` といったプロファイル情報にアクセスできます。

      そのような HTML ファイルの一例を以下に示しますが、カスタムクレームを含む任意のプロファイル情報を
      取得することができます。

      <AuthCodeGroup>
        <User />

        <Auth />

        <Callback />

        <Env />

        <Go />

        <Isauthenticated />

        <Login />

        <Logout />

        <Main />

        <Router />
      </AuthCodeGroup>
    </Section>

    <Section id={sections[8].id} title={sections[8].title} stepNumber="9" isSingleColumn>
      ユーザーをログアウトさせるには、セッションからデータを消去し、ユーザーを Auth0 のログアウトエンドポイントにリダイレクトします。詳細については、[ログアウトに関するドキュメント](https://auth0.com/docs/logout)を参照してください。

      `web/app/logout` フォルダーに `logout.go` というファイルを作成し、ユーザーを Auth0 のログアウトエンドポイントにリダイレクトする `Handler` 関数を追加します。

      `returnTo` URL は、アプリケーションの設定セクションにある許可されたログアウトURLのリストに含まれている必要があります。詳細については、[ログアウト後にユーザーをリダイレクトする](https://auth0.com/docs/logout/guides/redirect-users-after-logout)を参照してください。

      `web/static/js` フォルダーに `user.js` というファイルを作成し、ログインしているユーザーの Cookie を削除するコードを追加します。

      <AuthCodeGroup>
        <Logout />

        <Auth />

        <Callback />

        <Env />

        <Go />

        <Isauthenticated />

        <Login />

        <Main />

        <Router />

        <User />
      </AuthCodeGroup>
    </Section>

    <Section id={sections[9].id} title={sections[9].title} stepNumber="10" isSingleColumn>
      推奨されるベストプラクティスとしては、特定のルートは認証済みユーザーだけがアクセスできるように制限します。未認証のユーザーが保護されたルートへアクセスしようとした場合、アプリケーションはリダイレクトを行う必要があります。

      このケースでは、HTTP リクエストにフックするためのミドルウェアを実装します。ミドルウェア関数は、
      リクエストをエンドポイントのハンドラーへルーティングするか、リクエストをブロックするかを判定します。

      `platform/middleware` に `isAuthenticated.go` というファイルを作成し、
      `profile` セッションキーに基づいてユーザーが認証済みかどうかをチェックする関数を追加します。ユーザーが
      認証済みでない場合、ミドルウェアはユーザーをアプリケーションのルートパスにリダイレクトします。

      ミドルウェアを作成したら、ルーターに追加することで、認証が必要な任意のルートに対して設定できます。

      <AuthCodeGroup>
        <Isauthenticated />

        <Auth />

        <Callback />

        <Env />

        <Go />

        <Login />

        <Logout />

        <Main />

        <Router />

        <User />
      </AuthCodeGroup>
    </Section>

    <Section id={sections[10].id} title={sections[10].title} stepNumber="11" isSingleColumn>
      authenticator と router の両方の設定が完了したので、アプリケーションのエントリポイントを使ってそれらを連携させます。
      `main.go` 内で authenticator と router のインスタンスを作成し、その router に
      authenticator インスタンスを渡します。

      `.env` ファイルを使用している場合は、`main()` 関数の先頭で必ず `godotenv.Load()` を呼び出す必要があります。

      ターミナルで次のコマンドを実行して、アプリケーションを起動します:

      ```text lines
      go run main.go
      ```

      <AuthCodeGroup>
        <Main />

        <Auth />

        <Callback />

        <Env />

        <Go />

        <Isauthenticated />

        <Login />

        <Logout />

        <Router />

        <User />
      </AuthCodeGroup>
    </Section>

    ## 次のステップ

    素晴らしい!ここまで進めたなら、アプリケーションでログイン、ログアウト、およびユーザープロファイル情報が実装されているはずです。

    これでクイックスタートチュートリアルは終了ですが、他にも多くの機能があります。Auth0でできることの詳細については、以下をご確認ください:

    * [Auth0 Dashboard](https://manage.auth0.com/dashboard/us/dev-gja8kxz4ndtex3rq) - Auth0 テナントやアプリケーションの設定と管理方法を学びます
    * [Auth0 Marketplace](https://marketplace.auth0.com/) - Auth0 の機能を拡張するために有効化できるインテグレーションを見つけましょう
  </Content>
</Recipe>