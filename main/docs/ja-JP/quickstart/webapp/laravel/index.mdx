---
title: "Laravel"
permalink: "01-login"
---

<div id="by-evan-sims">
  ##### Evan Sims 著
</div>

Auth0 の Laravel ソフトウェア開発キット (SDK) を使用すると、Laravel アプリケーションに認証、ユーザープロファイル管理、ルーティングのアクセス制御をすばやく追加できます。このガイドでは、新規または既存の Laravel 9 または 10 アプリケーションに Auth0 を統合する方法を説明します。このクイックスタートに従うにあたっては、ご自身のアカウント向けに構成されたサンプルを利用できるよう、ログインしておくことをおすすめします。

{/* <Card title="GitHub で表示" icon="github" href="https://github.com/auth0-samples/laravel/tree/7.x/sample">
  システム要件：Laravel 9 / 10 | PHP 8.0 以上 | Composer
  </Card> */}


<div id="laravel-installation">
  ## Laravel のインストール
</div>

**まだ Laravel アプリケーションをセットアップしていない場合は**、新しいプロジェクトに適したディレクトリでターミナルを開き、次のコマンドを実行します。

```bash lines
composer create-project --prefer-dist laravel/laravel auth0-laravel-app ^9.0
```

このガイドにあるすべてのコマンドは、Laravel プロジェクトのルートディレクトリから実行することを前提としています。そのため、まず新しいプロジェクトディレクトリに `cd` で移動してください：

```bash lines
cd auth0-laravel-app
```


<div id="sdk-installation">
  ## SDK のインストール
</div>

プロジェクトディレクトリ内で、次のコマンドを実行して [Auth0 Laravel SDK](https://github.com/auth0/laravel-auth0) をインストールします。

```bash lines
composer require auth0/login:^7.8 --update-with-all-dependencies
```

次に、アプリケーション用のソフトウェア開発キット (SDK) の設定ファイルを生成します。

```bash lines
php artisan vendor:publish --tag auth0
```


<div id="sdk-configuration">
  ## SDK の設定
</div>

プロジェクトディレクトリで次のコマンドを実行して、[Auth0 CLI](https://github.com/auth0/auth0-cli) をダウンロードします。

```bash lines
curl -sSfL https://raw.githubusercontent.com/auth0/auth0-cli/main/install.sh | sh -s -- -b .
```

次に、CLI を Auth0 アカウントで認証し、プロンプトが表示されたら「as a user」を選択します。

```bash lines
./auth0 login
```

次に、Auth0 に新しいアプリケーションを作成します。

```bash lines
./auth0 apps create \
  --name "My Laravel Application" \
  --type "regular" \
  --auth-method "post" \
  --callbacks "http://localhost:8000/callback" \
  --logout-urls "http://localhost:8000" \
  --reveal-secrets \
  --no-input \
  --json > .auth0.app.json
```

また、新しい API を作成してください。

```bash lines
./auth0 apis create \
  --name "私のLaravelアプリケーションのAPI" \
  --identifier "https://github.com/auth0/laravel-auth0" \
  --offline-access \
  --no-input \
  --json > .auth0.api.json
```

これにより、ソフトウェア開発キット (SDK) を構成する 2 つのファイルがプロジェクトディレクトリに生成されます。

これらのファイルには認証情報が含まれているため、機密情報として扱うことが重要です。バージョン管理にコミットしないように注意してください。Git を使用している場合は、`.gitignore` ファイルに追加してください。

```bash lines
echo ".auth0.*.json" >> .gitignore
```


<div id="login-routes">
  ## ログインルート
</div>

ソフトウェア開発キット (SDK) は、アプリケーションのユーザーが認証を行うために必要なすべてのルートを自動的に登録します。

<table class="table"><thead>
<tr>
<th>ルート</th>
<th>目的</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>/login</code></td>
<td>認証フローを開始します。</td>
</tr>
<tr>
<td><code>/logout</code></td>
<td>ユーザーをログアウトします。</td>
</tr>
<tr>
<td><code>/callback</code></td>
<td>Auth0 からのコールバックを処理します。</td>
</tr>
</tbody>
</table>

これらをより細かく制御する必要がある場合や、アプリケーション内の既存ルートと競合する場合は、代わりに SDK のコントローラーを手動で登録できます。より高度な統合方法については、[SDK の README](https://github.com/auth0/laravel-auth0) を参照してください。

<div id="access-control">
  ## アクセス制御
</div>

Laravel の認証機能では「ガード」を使用して、各リクエストごとのユーザーの認証方法を定義します。Auth0 のソフトウェア開発キット (SDK) の認証ガードを使用して、アプリケーションのルートへのアクセスを制限できます。

ルートにアクセスする前にユーザーに認証を必須とするには、Laravel の `auth` ミドルウェアを使用できます。

```php lines
Route::get('/private', function () {
  return response('ようこそ！ログインしています。');
})->middleware('auth');
```

また、これを Laravel の `can` ミドルウェアと組み合わせることで、認証済みユーザーに特定の[権限](https://auth0.com/docs/manage-users/access-control/rbac)を持っていることを要求することもできます。

```php lines
Route::get('/scope', function () {
    return response('You have the `read:messages` permissions, and can therefore access this resource.');
})->middleware('auth')->can('read:messages');
```


<div id="user-information">
  ## ユーザー情報
</div>

認証済みユーザーに関する情報は、Laravel の `Auth` ファサードまたは `auth()` ヘルパー関数から取得できます。

たとえば、ユーザーの ID とメールアドレスを取得するには次のようにします。

```php lines
Route::get('/', function () {
  if (! auth()->check()) {
    return response('You are not logged in.');
  }

  $user = auth()->user();
  $name = $user->name ?? 'User';
  $email = $user->email ?? '';

  return response("Hello {$name}! Your email address is {$email}.");
});
```


<div id="user-management">
  ## ユーザー管理
</div>

[Auth0 Management API](https://github.com/auth0/laravel-auth0/blob/main/docs/Management.md) を使用してユーザー情報を更新できます。すべての Management エンドポイントには、ソフトウェア開発キット (SDK) の `management()` メソッドを通じてアクセスできます。

**Management API を呼び出す前に、アプリケーションが Management API と通信できるように設定する必要があります。** これは [Auth0 Dashboard の API ページ](https://manage.auth0.com/#/apis/) から行います。`Auth0 Management API` を選択し、`Machine to Machine Applications` タブを選択します。Laravel アプリケーションを許可し、下向き矢印をクリックして、付与したいスコープを選択します。

次の例では、ユーザーのメタデータを更新し、ランダムな好きな色を割り当てます。そのためには、`read:users` と `update:users` のスコープを付与する必要があります。API エンドポイントと必要なスコープの一覧は、[Management API のドキュメント](https://auth0.com/docs/api/management/v2) に記載されています。

```php lines
use Auth0\Laravel\Facade\Auth0;

Route::get('/colors', function () {
  $endpoint = Auth0::management()->users();

  $colors = ['red', 'blue', 'green', 'black', 'white', 'yellow', 'purple', 'orange', 'pink', 'brown'];

  $endpoint->update(
    id: auth()->id(),
    body: [
        'user_metadata' => [
            'color' => $colors[random_int(0, count($colors) - 1)]
        ]
    ]
  );

  $metadata = $endpoint->get(auth()->id());
  $metadata = Auth0::json($metadata);

  $color = $metadata['user_metadata']['color'] ?? 'unknown';
  $name = auth()->user()->name;

  return response("こんにちは、{$name}さん!あなたのお気に入りの色は{$color}です。");
})->middleware('auth');
```

すべての SDK の Management API メソッドを一覧にしたクイックリファレンスガイドは、[こちら](https://github.com/auth0/laravel-auth0/blob/main/docs/Management.md)で確認できます。


<div id="run-the-application">
  ## アプリケーションを実行する
</div>

これで、Laravel アプリケーションを起動してリクエストを受け付ける準備が整いました。

```bash lines
php artisan serve
```


<div id="checkpoint">
  ### チェックポイント
</div>

Web ブラウザーを開き、次のルートにアクセスしてみてください。

* `http://localhost:8000` にアクセスしてパブリックルートを確認します。
* `http://localhost:8000/private` にアクセスして認証を求められることを確認します。
* `http://localhost:8000` にアクセスして、認証済み状態でパブリックルートを確認します。
* `http://localhost:8000/scope` にアクセスして、`read:messages` [パーミッション](https://auth0.com/docs/manage-users/access-control/rbac)を持っているかどうかを確認します。
* `http://localhost:8000/update` にアクセスして、ユーザーのプロファイルを更新します。
* `http://localhost:8000/logout` にアクセスして、ログアウトします。

問題が発生した場合は、次の点を試してみてください。

* `php artisan optimize:clear` を実行して、Laravel のキャッシュをクリアします。
* `.auth0.app.json` と `.auth0.api.json` ファイルがプロジェクトのルートにあることを確認します。
* Laravel アプリケーションを Machine-to-Machine アプリケーションとして設定し、[Auth0 Dashboard](https://manage.auth0.com/#/apis/) から `Auth0 Management API` に対して必要なすべてのスコープを付与していることを確認します。

問題が解決しない場合は、SDK の[ドキュメント](https://github.com/auth0/laravel-auth0)や[ドキュメント ハブ](https://auth0.com/docs)を参照してください。また、[コミュニティ](https://community.auth0.com)もご活用ください。Auth0 チームや他のコミュニティメンバーが、質問への回答をお手伝いできます。

<div id="additional-reading">
  ### 参考資料
</div>

* [User Repositories and Models](https://github.com/auth0/laravel-auth0/blob/main/docs/Users.md) では、Auth0 Laravel ソフトウェア開発キット (SDK) を拡張してカスタムユーザーモデルを使用する方法と、データベースにユーザーを保存および取得する方法を説明します。
* [Hooking Events](https://github.com/auth0/laravel-auth0/blob/main/docs/Events.md) では、Auth0 Laravel ソフトウェア開発キット (SDK) によって発行されるイベントをリッスンして、統合の動作を細かくカスタマイズする方法を説明します。
* [Management API](https://github.com/auth0/laravel-auth0/blob/main/docs/Management.md) のサポートは Auth0 Laravel ソフトウェア開発キット (SDK) に組み込まれているため、Laravel アプリケーションから Management API を操作できます。

[GitHub で編集](https://github.com/auth0/docs/edit/master/articles/quickstart/webapp/laravel/01-login.md)