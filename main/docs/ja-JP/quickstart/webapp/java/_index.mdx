---
title: Java サーブレット アプリケーションにログイン機能を追加する

sidebarTitle: Java
---

import { Recipe, Content, Section, SideMenu, SideMenuSectionItem, SignUpForm } from "/snippets/ja-JP/recipe.jsx";
import { LoggedInForm } from "/snippets/ja-JP/Login.jsx";

import Web from "/snippets/ja-JP/quickstart/webapp/java/web.xml.mdx";
import Authenticationcontrollerprovider from "/snippets/ja-JP/quickstart/webapp/java/AuthenticationControllerProvider.java.mdx";
import Loginservlet from "/snippets/ja-JP/quickstart/webapp/java/LoginServlet.java.mdx";
import Callbackservlet from "/snippets/ja-JP/quickstart/webapp/java/CallbackServlet.java.mdx";
import Homeservlet from "/snippets/ja-JP/quickstart/webapp/java/HomeServlet.java.mdx";
import Logoutservlet from "/snippets/ja-JP/quickstart/webapp/java/LogoutServlet.java.mdx";

import {AuthCodeGroup} from "/snippets/ja-JP/AuthCodeGroup.jsx";

export const sections = [
      { id: "configure-auth0", title: "Auth0 を設定する" },
      { id: "integrate-auth0-in-your-application", title: "Auth0 をアプリケーションに統合する" },
      { id: "configure-your-java-application", title: "Java アプリケーションを設定する" },
      { id: "create-the-authenticationcontroller", title: "AuthenticationController を作成する" },
      { id: "login-redirection", title: "ログインリダイレクト" },
      { id: "handling-the-tokens", title: "トークンの処理" },
      { id: "display-the-home-page", title: "ホームページを表示する" },
      { id: "handle-logout", title: "ログアウトを処理する" },
      { id: "run-the-sample", title: "サンプルを実行する" }
]


<Recipe isSingleColumn>
  <Content>
    Auth0を使用すると、アプリケーションに認証を素早く追加し、ユーザープロファイル情報にアクセスできます。
    このガイドでは、新規または既存のJava ServletアプリケーションとAuth0を統合する方法を説明します。

    <Section id={sections[0].id} title={sections[0].title} stepNumber="1" isSingleColumn>
      Auth0 サービスを利用するには、Auth0 Dashboard に Auth0 Application を作成しておく必要があります。Auth0 Application は、開発中のプロジェクトで認証をどのように動作させるかを設定する場所です。

      ### アプリケーションを設定する

      インタラクティブセレクターを使用して新しい Auth0 Application を作成するか、統合したいプロジェクトを表す既存の Application を選択します。Auth0 の各 Application には英数字で構成された一意のクライアントID が割り当てられており、アプリケーションコードはこのクライアントID を使用してソフトウェア開発キット (SDK) 経由で Auth0 API を呼び出します。

      このクイックスタートで行った設定はすべて、[Dashboard](https://manage.auth0.com/#/) 上の Application に自動的に反映されます。ここから今後も Application を管理できます。

      より完全な設定を確認したい場合は、代わりにサンプルアプリケーションを参照してください。

      ### Callback URL を設定する

      Callback URL とは、ユーザーが認証された後に Auth0 からリダイレクトしたい、アプリケーション内の URL のことです。設定されていない場合、ユーザーはログイン後にアプリケーションへ戻ることができません。

      <Info>
        サンプルプロジェクトに沿って進めている場合は、これを
        `http://localhost:3000/callback`
        に設定してください。
      </Info>

      ### Logout URL を設定する

      Logout URL とは、ユーザーがログアウトした後に Auth0 からリダイレクトしたい、アプリケーション内の URL のことです。設定されていない場合、ユーザーはアプリケーションからログアウトできず、エラーが返されます。

      <Info>
        サンプルプロジェクトに沿って進めている場合は、これを `http://localhost:3000/` に設定してください。
      </Info>

      <LoggedInForm />
    </Section>

    <Section id={sections[1].id} title={sections[1].title} stepNumber="2" isSingleColumn>
      ### 依存関係のセットアップ

      Java アプリケーションを Auth0 と統合するには、次の依存関係を追加します。

      * **javax.servlet-api**
        : Java Servlet を作成できるようにするライブラリです。その後、Tomcat や Gretty などのサーバー用の依存関係を追加する必要があります。どれを使用するかは任意です。詳細についてはサンプルコードを確認してください。
      * **auth0-java-mvc-commons**: は、サーバーサイドの MVC Web アプリケーションで Java から Auth0 を利用できるようにする [Java ライブラリ](https://github.com/auth0/auth0-java-mvc-common) です。認証を行うために呼び出す必要がある Authorize URL を生成し、コールバックで受け取った結果を検証して、最終的にユーザーを識別する [Auth0 Tokens](https://auth0.com/docs/tokens) を取得します。

      Gradle を使用している場合は、これらを `build.gradle` に追加してください。

      ```text lines
      // build.gradle
      compile 'javax.servlet:javax.servlet-api:3.1.0'
      compile 'com.auth0:mvc-auth-commons:1.+'W
      ```

      Maven を使用している場合は、`pom.xml` に次を追加します:

      ```text lines
      <!-- pom.xml -->
      <dependency>
      <groupId>com.auth0</groupId>
      <artifactId>mvc-auth-commons</artifactId>
      <version>[1.0, 2.0)</version>
      </dependency>
      <dependency>
      <groupId>javax.servlet</groupId>
      <artifactId>javax.servlet-api</artifactId>
      <version>3.1.0</version>
      </dependency>
      ```

      <LoggedInForm />
    </Section>

    <Section id={sections[2].id} title={sections[2].title} stepNumber="3" isSingleColumn>
      Java アプリが Auth0 アカウントに対して認証を行うには、いくつかの情報が必要です。サンプルでは、この情報をデプロイメント記述子ファイル `src/main/webapp/WEB-INF/web.xml` から読み取りますが、これらを別の場所に保存してもかまいません。

      この情報は、**auth0-java-mvc-commons** ライブラリを設定し、ユーザーがアプリケーションにログインできるようにするために使用されます。ライブラリの詳細や、さまざまな設定オプションについては、[ライブラリのドキュメント](https://github.com/auth0/auth0-java-mvc-common/blob/master/README.md)を参照してください。

      ### 設定済み属性の確認

      **Download Sample** ボタンを使用してこのサンプルをダウンロードした場合、`domain`、`clientId`、`clientSecret` の各属性は自動的に設定されています。特に、アカウント内に複数の Auth0 アプリケーションがある場合は、これらの値が正しいかどうかを確認してください。

      ### プロジェクト構成

      **Download Sample** ボタンを使用してダウンロードできるサンプルプロジェクトは、次のような構成になっています。

      ```text lines
      - src
      -- main
      ---- java
      ------ com
      -------- auth0
      ---------- example
      ------------ Auth0Filter.java
      ------------ AuthenticationControllerProvider.java
      ------------ HomeServlet.java
      ------------ CallbackServlet.java
      ------------ LoginServlet.java
      ------------ LogoutServlet.java
      ---- webapp
      ------ WEB-INF
      -------- jsp
      ---------- home.jsp
      -------- web.xml

      build.gradle
      ```

      このプロジェクトには JSP が 1 つだけ含まれています。`home.jsp` で、ログインに成功した後に
      ユーザーに関連付けられたトークンを表示し、ログアウトのオプションを提供します。

      このプロジェクトには WebFilter である `Auth0Filter.java` も含まれており、保護された `/portal/*` パスへの
      アクセスをユーザーに許可する前に、既存のトークンがあるかを確認します。トークンが存在しない場合、
      リクエストは `LoginServlet` にリダイレクトされます。

      このプロジェクトには、さらに次の 4 つのサーブレットが含まれています。

      * `LoginServlet.java`: ユーザーがログインを試行したときに呼び出されます。サーブレットは
        `client_id` と `domain` パラメーターを使用して有効な Authorize URL を作成し、
        ユーザーをそこへリダイレクトします。
      * `CallbackServlet.java`: コールバック URL へのリクエストを受け取り、そのデータを処理して
        資格情報を取得します。ログインが成功すると、資格情報はリクエストの
        HttpSession に保存されます。
      * `HomeServlet.java`: 以前に保存されたトークンを読み取り、それらを
        `home.jsp` リソース上に表示します。
      * `LogoutServlet.java`: ユーザーがログアウトリンクをクリックしたときに呼び出されます。サーブレットは
        ユーザーセッションを無効化し、`LoginServlet` によって処理されるログインページへユーザーをリダイレクトします。
      * `AuthenticationControllerProvider.java`: 単一インスタンスの
        `AuthenticationController` を作成および管理する役割を担います。

      <AuthCodeGroup>
        <Web />

        <Authenticationcontrollerprovider />

        <Loginservlet />

        <Callbackservlet />

        <Homeservlet />

        <Logoutservlet />
      </AuthCodeGroup>
    </Section>

    <Section id={sections[3].id} title={sections[3].title} stepNumber="4" isSingleColumn>
      ユーザーが認証できるようにするには、`domain`、`clientId`、`clientSecret` を使用して、
      `auth0-java-mvc-commons` ソフトウェア開発キット (SDK) が提供する `AuthenticationController` のインスタンスを作成します。サンプルでは、
      `JwkProvider` を指定してトークンの署名検証に使用される公開鍵を取得することで、
      RS256 の非対称署名アルゴリズムで署名されたトークンとコンポーネントを連携させるための設定方法を示しています。追加の設定オプションについては、[jwks-rsa-java リポジトリ](https://github.com/auth0/jwks-rsa-java) を参照してください。
      HS256 を使用している場合は、`JwkProvider` を設定する必要はありません。

      <Info>
        `AuthenticationController` はコンテキストを一切保持せず、再利用されることを意図しています。
        不要にインスタンスを生成すると、余分なリソースが消費され、パフォーマンスに影響を及ぼす可能性があります。
      </Info>

      <AuthCodeGroup>
        <Authenticationcontrollerprovider />

        <Web />

        <Loginservlet />

        <Callbackservlet />

        <Homeservlet />

        <Logoutservlet />
      </AuthCodeGroup>
    </Section>

    <Section id={sections[4].id} title={sections[4].title} stepNumber="5" isSingleColumn>
      ユーザーがログインできるようにするには、アプリケーションはユーザーを Universal Login ページにリダイレクトする必要があります。
      `AuthenticationController` インスタンスを使用し、
      `buildAuthorizeUrl(HttpServletRequest request`, `HttpServletResponse response`,
      `String redirectUrl)` メソッドを呼び出してリダイレクト URL を生成できます。リダイレクト URL は、Auth0 アプリケーションの **Allowed Callback URLs** に追加した URL でなければなりません。

      <AuthCodeGroup>
        <Loginservlet />

        <Web />

        <Authenticationcontrollerprovider />

        <Callbackservlet />

        <Homeservlet />

        <Logoutservlet />
      </AuthCodeGroup>
    </Section>

    <Section id={sections[5].id} title={sections[5].title} stepNumber="6" isSingleColumn>
      ユーザーがログインすると、結果は GET または POST のいずれかの HTTP リクエストとして `CallbackServlet` で受け取られます。Authorization Code Flow（デフォルト）を使用しているため、GET リクエストが送信されます。ライブラリを Implicit Flow 用に構成している場合は、代わりに POST リクエストが送信されます。

      このリクエストには、`AuthenticationController` で Authorize URL を生成する際にライブラリが事前に設定した呼び出しコンテキストが含まれます。これをコントローラーに渡すと、有効な `Tokens` インスタンスか、何が問題だったかを示す Exception のいずれかが返されます。呼び出しが成功した場合は、後でアクセスできるように資格情報をどこかに保存する必要があります。ライブラリに含まれている `SessionsUtils` クラスを使用して、リクエストの `HttpSession` に保存できます。

      <Info>
        トークンをリクエストした時刻と、受信した `expiresIn` の値を保存しておくことを推奨します。そうすることで、次回トークンを使用する際に、すでに有効期限が切れているか、まだ有効かを確認できます。このサンプルでは簡略化のため、その検証は省略します。
      </Info>

      <AuthCodeGroup>
        <Callbackservlet />

        <Web />

        <Authenticationcontrollerprovider />

        <Loginservlet />

        <Homeservlet />

        <Logoutservlet />
      </AuthCodeGroup>
    </Section>

    <Section id={sections[6].id} title={sections[6].title} stepNumber="7" isSingleColumn>
      これでユーザーは認証され（トークンが存在し）、`Auth0Filter` によって保護されたリソースにアクセスできるようになりました。`HomeServlet` では、リクエストのセッションからトークンを取得し、JSP コードから利用できるようにそれらを `userId` 属性として設定します。

      <AuthCodeGroup>
        <Homeservlet />

        <Web />

        <Authenticationcontrollerprovider />

        <Loginservlet />

        <Callbackservlet />

        <Logoutservlet />
      </AuthCodeGroup>
    </Section>

    <Section id={sections[7].id} title={sections[7].title} stepNumber="8" isSingleColumn>
      ログアウトを正しく処理するには、セッションをクリアし、Auth0 からユーザーをログアウトさせる必要があります。これはサンプルアプリケーションの
      `LogoutServlet` で処理します。

      まず、`request.getSession().invalidate()` を呼び出してセッションをクリアします。次に、ログアウト URL を構築し、ログアウト後にユーザーがリダイレクトされる場所を示す `returnTo` クエリパラメーターを必ず含めます。最後に、そのログアウト URL にレスポンスをリダイレクトします。

      <AuthCodeGroup>
        <Logoutservlet />

        <Web />

        <Authenticationcontrollerprovider />

        <Loginservlet />

        <Callbackservlet />

        <Homeservlet />
      </AuthCodeGroup>
    </Section>

    <Section id={sections[8].id} title={sections[8].title} stepNumber="9" isSingleColumn>
      ターミナルからサンプルを実行するには、プロジェクトのルートフォルダーに移動し、次のコマンドを実行します。

      ```text lines
      ./gradlew clean app
      ```

      数秒後、アプリケーションは `http://localhost:3000/` でアクセスできるようになります。
      保護されたリソース [http://localhost:3000/portal/home](http://localhost:3000/portal/home) にアクセスしてみて、
      `Auth0Filter` によって Auth0 のログイン画面にリダイレクトされることを確認してください。
      ウィジェットには、このアプリケーション用に [ダッシュボード](https://manage.auth0.com/#/) で定義したすべてのソーシャルおよびデータベース接続が表示されます。

      <Frame>
        <img src="/docs/images/cdy7uua7fh8z/7L6lZ6xCi1L7sJBFZUPb9g/b7697bfa1bc83a1072c2de2f15cec93c/Login_Screen_-_English.png" />
      </Frame>

      認証に成功すると、ホームページのコンテンツが表示されます。

      <Frame>
        <img src="/docs/images/cdy7uua7fh8z/FzK3jxfSGoeIDYQamxnJl/6b608e39ff39e044644193cfd2ee0f69/java-step-9-2.png" />
      </Frame>

      ホームページ右上の **logout** ボタンをクリックしてログアウトします。

      <LoggedInForm />
    </Section>

    ## 次のステップ

    素晴らしい!ここまで進めたなら、アプリケーションでログイン、ログアウト、およびユーザープロファイル情報が実装されているはずです。

    これでクイックスタートチュートリアルは終了ですが、他にも多くの機能があります。Auth0でできることの詳細については、以下をご確認ください:

    * [Auth0 Dashboard](https://manage.auth0.com/dashboard/us/dev-gja8kxz4ndtex3rq) - Auth0 テナントとアプリケーションの設定および管理方法について学びます
    * [auth0-java-mvc-common ソフトウェア開発キット (SDK)](https://github.com/auth0/auth0-java-mvc-common) - このチュートリアルで使用している SDK をより詳しく確認する
    * [Auth0 Marketplace](https://marketplace.auth0.com/) - Auth0 の機能を拡張できるインテグレーションを見つける
  </Content>
</Recipe>