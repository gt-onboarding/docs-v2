---
title: "Java"
permalink: "01-login"
---

import {AuthCodeBlock} from "/snippets/ja-JP/AuthCodeBlock.jsx";

<div id="by-jim-anderson">
  ##### Jim Anderson 著
</div>

このチュートリアルでは、Java Servlet アプリケーションにユーザー ログイン機能を追加する方法を説明します。ご自身のアカウント向けに設定されたサンプルを使用してこのクイックスタートを進められるよう、事前にログインしておくことをお勧めします。

{/* <Card title="GitHub で表示" href="https://github.com/auth0-samples/auth0-servlet-sample/tree/master/01-Login" icon="github">
  System requirements: Java 8 | Gradle 3.3 or higher
  </Card> */}

<Info>
  **認証は初めてですか？** [Auth0の仕組み](/docs/ja-JP/get-started/auth0-overview)、[通常の Web アプリケーションとの統合方法](/docs/ja-JP/get-started/architecture-scenarios/sso-for-regular-web-apps)、および Auth0 が使用する[プロトコル](/docs/ja-JP/get-started/authentication-and-authorization-flow)について学びましょう。
</Info>

<div id="configure-auth0">
  ## Auth0 を設定する
</div>

<div id="get-your-application-keys">
  ### アプリケーションキーを取得する
</div>

Auth0 にサインアップすると、新しいアプリケーションが自動的に作成されるか、自分で新しいアプリケーションを作成しているはずです。Auth0 と通信するには、そのアプリケーションに関するいくつかの情報が必要になります。これらの情報は、Auth0 Dashboard の [Application Settings](https://manage.auth0.com/#/applications) セクションから取得できます。

<Frame>![App Dashboard](https://cdn2.auth0.com/docs/1.14550.0/media/articles/dashboard/client_settings.png)</Frame>

次の情報が必要です。

* **ドメイン**
* **クライアントID**
* **クライアントシークレット**

<Info>
  このページの上部からサンプルをダウンロードした場合、これらの情報はすでに自動的に入力されています。
</Info>

<div id="configure-callback-urls">
  ### コールバックURLを設定する
</div>

コールバックURLは、ユーザーが認証を完了した後に、Auth0 がユーザーをリダイレクトするアプリケーション内のURLです。アプリのコールバックURLは、[Application Settings](https://manage.auth0.com/#/applications) の **Allowed Callback URLs** フィールドに追加する必要があります。このフィールドが設定されていない場合、ユーザーはアプリケーションにログインできず、エラーが表示されます。

<Info>
  このページの先頭からダウンロードしたサンプルプロジェクトに沿って作業している場合、**Allowed Callback URLs** フィールドに追加する必要があるコールバックURLは `http://localhost:3000/callback` です。
</Info>

<div id="configure-logout-urls">
  ### ログアウトURLを設定する
</div>

ログアウトURLは、ユーザーが認可サーバーからログアウトした後に、Auth0 がアプリケーションへリダイレクトするためのアプリケーション内の URL です。これは `returnTo` クエリパラメーターで指定します。アプリのログアウトURLは、[Application Settings](https://manage.auth0.com/#/applications) の **Allowed Logout URLs** フィールドに追加する必要があります。このフィールドが設定されていない場合、ユーザーはアプリケーションからログアウトできず、エラーが発生します。

<Info>
  このページ上部からダウンロードしたサンプルプロジェクトを利用している場合、**Allowed Logout URLs** フィールドに追加する必要があるログアウトURLは `http://localhost:3000/login` です。
</Info>

<div id="integrate-auth0-in-your-application">
  ## アプリケーションに Auth0 を統合する
</div>

<div id="setup-dependencies">
  ### 依存関係のセットアップ
</div>

Java アプリケーションを Auth0 と統合するには、次の依存関係を追加します。

* **javax.servlet-api**: Java サーブレットを作成できるようにするライブラリです。あわせて、Tomcat や Gretty などのサーバーを依存関係として追加する必要があります。どれを使うかは任意です。詳しくはサンプルコードを確認してください。
* **auth0-java-mvc-commons**: サーバーサイドの MVC Web アプリ向けに、Java で Auth0 を使用できるようにする[Java ライブラリ](https://github.com/auth0/auth0-java-mvc-common)です。認証を行うために呼び出す必要がある Authorize URL を生成し、コールバックで受信した結果を検証して、最終的にユーザーを識別する [Auth0 トークン](/docs/ja-JP/secure/tokens) を取得します。

Gradle を使用している場合は、`build.gradle` にこれらを追加します。

```gradle lines
// build.gradle

compile 'javax.servlet:javax.servlet-api:3.1.0'
compile 'com.auth0:mvc-auth-commons:1.+'
```

Maven を使用している場合は、`pom.xml` に次の依存関係を追加します。

```xml lines
<!-- pom.xml -->

<dependency>
  <groupId>com.auth0</groupId>
  <artifactId>mvc-auth-commons</artifactId>
  <version>[1.0, 2.0)</version>
</dependency>
<dependency>
  <groupId>javax.servlet</groupId>
  <artifactId>javax.servlet-api</artifactId>
  <version>3.1.0</version>
</dependency>
```

<div id="configure-your-java-app">
  ### Java アプリを構成する
</div>

Java アプリが Auth0 アカウントに対して認証を行うには、いくつかの設定情報が必要です。サンプルでは、この情報をデプロイメント記述子ファイル `src/main/webapp/WEB-INF/web.xml` から読み取りますが、別の場所に格納しても構いません。必要な情報は次のとおりです。

export const codeExample = `<!-- src/main/webapp/WEB-INF/web.xml -->

<context-param>
    <param-name>com.auth0.domain</param-name>
    <param-value>{yourDomain}</param-value>
</context-param>

<context-param>
    <param-name>com.auth0.clientId</param-name>
    <param-value>{yourClientId}</param-value>
</context-param>

<context-param>
    <param-name>com.auth0.clientSecret</param-name>
    <param-value>{yourClientSecret}</param-value>
</context-param>`;

<AuthCodeBlock children={codeExample} language="xml" />

この情報は、ユーザーがアプリケーションにログインできるようにするために **auth0-java-mvc-commons** ライブラリを構成する際に使用します。ライブラリおよびそのさまざまな構成オプションの詳細については、[ライブラリのドキュメント](https://github.com/auth0/auth0-java-mvc-common/blob/master/README.md)を参照してください。

<Note>
  ### 設定済み属性の確認

  **Download Sample** ボタンを使ってこのサンプルをダウンロードした場合、`domain`、`clientId`、`clientSecret` の各属性には値が自動的に入力されます。特にアカウント内に複数の Auth0 アプリケーションがある場合は、値が正しいかどうか必ず確認してください。
</Note>

<div id="project-structure">
  ### プロジェクト構成
</div>

Login プロジェクトのサンプルの構成は次のとおりです。

```bash lines
- src
-- main
---- java
------ com
-------- auth0
---------- example
------------ Auth0Filter.java
------------ AuthenticationControllerProvider.java
------------ HomeServlet.java
------------ CallbackServlet.java
------------ LoginServlet.java
------------ LogoutServlet.java
---- webapp
------ WEB-INF
-------- jsp
---------- home.jsp
-------- web.xml
- build.gradle
```

このプロジェクトには JSP が 1 つ含まれています。`home.jsp` は、ログインに成功した後にユーザーに関連付けられたトークンを表示し、ログアウトするオプションを提供します。

このプロジェクトには WebFilter の `Auth0Filter.java` が含まれており、保護された `/portal/*` パスへのユーザーアクセスを許可する前に既存のトークンをチェックします。トークンが存在しない場合、リクエストは `LoginServlet` にリダイレクトされます。

このプロジェクトには、さらに 4 つのサーブレットが含まれています。

* `LoginServlet.java`: ユーザーがログインを試みたときに呼び出されます。サーブレットは `client_id` と `domain` パラメーターを使用して有効な認可用の Authorize URL を作成し、ユーザーをその URL にリダイレクトします。
* `CallbackServlet.java`: コールバック URL へのリクエストを受け取り、認証情報を取得するためにデータを処理します。ログインが成功すると、認証情報はリクエストの HttpSession に保存されます。
* `HomeServlet.java`: 以前に保存されたトークンを読み取り、それらを `home.jsp` リソース上に表示します。
* `LogoutServlet.java`: ユーザーがログアウトリンクをクリックしたときに呼び出されます。サーブレットはユーザーセッションを無効化し、`LoginServlet` によって処理されるログインページにユーザーをリダイレクトします。
* `AuthenticationControllerProvider`: `AuthenticationController` の単一インスタンスを作成および管理する役割を担います。

<div id="create-the-authenticationcontroller">
  ## AuthenticationController の作成
</div>

ユーザーが認証できるようにするには、`domain`、`clientId`、`clientSecret` を使用して、`auth0-java-mvc-commons` ソフトウェア開発キット (SDK) によって提供される `AuthenticationController` のインスタンスを作成します。次のサンプルは、`JwkProvider` を指定してトークンの署名検証に使用される公開鍵を取得することで、RS256 非対称署名アルゴリズムで署名されたトークンでコンポーネントを使用するように構成する方法を示します。追加の構成オプションについては、[jwks-rsa-java リポジトリ](https://github.com/auth0/jwks-rsa-java) を参照してください。HS256 を使用している場合は、`JwkProvider` を構成する必要はありません。

<Info>
  `AuthenticationController` はコンテキストを一切保持せず、再利用されることを想定しています。不必要なインスタンスの作成は、追加のリソースを消費し、パフォーマンスに影響する可能性があります。
</Info>

```java lines
class AuthenticationControllerProvider {

    private AuthenticationControllerProvider() {}

    private static AuthenticationController INSTANCE;

    // 複数のスレッドから呼び出される可能性がある場合は、このメソッドを同期化し、ダブルチェックロッキングを検討してください
    static AuthenticationController getInstance(ServletConfig config) throws UnsupportedEncodingException {
        if (INSTANCE == null) {
            String domain = config.getServletContext().getInitParameter("com.auth0.domain");
            String clientId = config.getServletContext().getInitParameter("com.auth0.clientId");
            String clientSecret = config.getServletContext().getInitParameter("com.auth0.clientSecret");

            if (domain == null || clientId == null || clientSecret == null) {
                throw new IllegalArgumentException("domain、clientId、またはclientSecretが不足しています。src/main/webapp/WEB-INF/web.xmlを更新しましたか?");
            }

            // RS256トークンにはJwkProviderが必要です。HS256を使用する場合は不要です。
            JwkProvider jwkProvider = new JwkProviderBuilder(domain).build();
            INSTANCE = AuthenticationController.newBuilder(domain, clientId, clientSecret)
                    .withJwkProvider(jwkProvider)
                    .build();
        }

        return INSTANCE;
    }
```

<div id="trigger-authentication">
  ## 認証をトリガーする
</div>

ユーザーがログインできるようにするには、アプリケーションから [Universal Login](https://auth0.com/docs/universal-login) ページへリダイレクトします。`AuthenticationController` インスタンスを使用し、`buildAuthorizeUrl(HttpServletRequest request, HttpServletResponse response, String redirectUrl)` メソッドを呼び出すことで、リダイレクト URL を生成できます。リダイレクト URL には、Auth0 アプリケーションの **Allowed Callback URLs** に追加（登録）した URL を指定する必要があります。

```java lines
// src/main/java/com/auth0/example/LoginServlet.java

@Override
protected void doGet(final HttpServletRequest req, final HttpServletResponse res) throws ServletException, IOException {
    String redirectUri = req.getScheme() + "://" + req.getServerName();
    if ((req.getScheme().equals("http") && req.getServerPort() != 80) || (req.getScheme().equals("https") && req.getServerPort() != 443)) {
        redirectUri += ":" + req.getServerPort();
    }
    redirectUri += "/callback";

    String authorizeUrl = authenticationController.buildAuthorizeUrl(req, res, redirectUri)
            .build();
    res.sendRedirect(authorizeUrl);
}
```

ユーザーがログインすると、結果は GET または POST のいずれかの HTTP リクエストとして `CallbackServlet` で受信されます。デフォルトである Authorization Code Flow を使用しているため、GET リクエストが送信されます。ライブラリを Implicit Flow 用に構成している場合は、代わりに POST リクエストが送信されます。

このリクエストには、`AuthenticationController` で Authorize URL を生成する際にライブラリによって設定された呼び出しコンテキストが含まれています。これをコントローラーに渡すと、有効な `Tokens` インスタンスか、何が問題だったかを示す例外のいずれかが返されます。処理が成功した場合は、後でアクセスできるように資格情報をどこかに保存する必要があります。ライブラリに含まれている `SessionsUtils` クラスを使用して、リクエストの `HttpSession` を利用できます。

```java lines
// src/main/java/com/auth0/example/CallbackServlet.java

@Override
public void doGet(HttpServletRequest req, HttpServletResponse res) throws IOException, ServletException {
    handle(req, res);
}

@Override
public void doPost(HttpServletRequest req, HttpServletResponse res) throws IOException, ServletException {
    handle(req, res);
}

private void handle(HttpServletRequest req, HttpServletResponse res) throws IOException {
    try {
        // リクエストを解析する
        Tokens tokens = authenticationController.handle(req, res);
        SessionUtils.set(req, "accessToken", tokens.getAccessToken());
        SessionUtils.set(req, "idToken", tokens.getIdToken());
        res.sendRedirect(redirectOnSuccess);
    } catch (IdentityVerificationException e) {
        e.printStackTrace();
        res.sendRedirect(redirectOnFail);
    }
}
```

<Info>
  トークンをリクエストした時刻と、取得した `expiresIn` の値を保存しておくことを推奨します。そうすることで、次回トークンを使用する際に、すでに期限切れか、まだ有効かを確認できます。このサンプルでは、簡略化のためその検証は省略します。
</Info>

<div id="display-the-home-page">
  ## ホームページを表示する
</div>

ユーザーが認証されてトークンが存在する状態になると、`Auth0Filter` によって保護されたリソースへアクセスできるようになります。`HomeServlet` では、リクエストのセッションからトークンを取得し、JSP コードから利用できるようにそれらを `userId` 属性として設定します。

```java lines
// src/main/java/com/auth0/example/HomeServlet.java

protected void doGet(HttpServletRequest req, HttpServletResponse res) throws ServletException, IOException {
    final String accessToken = (String) SessionUtils.get(req, "accessToken");
    final String idToken = (String) SessionUtils.get(req, "idToken");
    if (accessToken != null) {
        req.setAttribute("userId", accessToken);
    } else if (idToken != null) {
        req.setAttribute("userId", idToken);
    }
    req.getRequestDispatcher("/WEB-INF/jsp/home.jsp").forward(req, res);
}
```

<div id="handle-logout">
  ## ログアウトを処理する
</div>

ログアウトを適切に処理するには、セッションを破棄し、Auth0 からユーザーをログアウトさせる必要があります。これはサンプルアプリケーションの `LogoutServlet` で行います。

まず、`request.getSession().invalidate()` を呼び出してセッションを破棄します。次に、ログアウト URL を構築しますが、その際に `returnTo` クエリパラメーターを必ず含めます。これは、ユーザーがログアウト後にリダイレクトされる場所を指定するためのものです。最後に、レスポンスをログアウト URL へリダイレクトします。

```java lines
// src/main/java/com/auth0/example/LogoutServlet.java

@Override
protected void doGet(final HttpServletRequest request, final HttpServletResponse response) throws ServletException, IOException {
    if (request.getSession() != null) {
        request.getSession().invalidate();
    }

    String returnUrl = String.format("%s://%s", request.getScheme(), request.getServerName());
    if ((request.getScheme().equals("http") && request.getServerPort() != 80) || (request.getScheme().equals("https") && request.getServerPort() != 443)) {
        returnUrl += ":" + request.getServerPort();
    }
    returnUrl += "/login";

    // ログアウトURLを次のように構築:
    // https://{YOUR-DOMAIN}/v2/logout?client_id={YOUR-CLIENT-ID}&returnTo=http://localhost:3000/login
    String logoutUrl = String.format(
            "https://%s/v2/logout?client_id=%s&returnTo=%s",
            domain,
            clientId,
            returnUrl
    );
    response.sendRedirect(logoutUrl);
}
```

<div id="run-the-sample">
  ## サンプルを実行する
</div>

ターミナルからサンプルを実行するには、プロジェクトのルートディレクトリに移動し、次のコマンドを実行します。

```bash lines
./gradlew clean appRun
```

数秒後、アプリケーションは `http://localhost:3000/` でアクセス可能になります。保護されたリソース `http://localhost:3000/portal/home` にアクセスしてみて、`Auth0Filter` によって Auth0 のログインページにリダイレクトされることを確認してください。ウィジェットには、このアプリケーション向けに [ダッシュボード](https://manage.auth0.com/#/) で定義したすべてのソーシャルおよびデータベース接続が表示されます。

<Frame>![Auth0 Universal Login](https://cdn2.auth0.com/docs/1.14550.0/media/quickstarts/universal-login.png)</Frame>

認証に成功すると、ホームページの内容が表示されます。

<Frame>![Display Token](https://cdn2.auth0.com/docs/1.14550.0/media/articles/java/display-token.png)</Frame>

ホームページ右上にある **ログアウト** ボタンをクリックしてログアウトします。

<Note>
  ##### 次にできること

  <table>
    <tr>
      <td><a href="/docs/ja-JP/authenticate/identity-providers">その他のアイデンティティ プロバイダーを設定する</a></td>
      <td><a href="/docs/ja-JP/secure/multi-factor-authentication">多要素認証を有効にする</a></td>
    </tr>

    <tr>
      <td><a href="/docs/ja-JP/secure/attack-protection">攻撃対策について学ぶ</a></td>
      <td><a href="/docs/ja-JP/customize/rules">Rules について学ぶ</a></td>
    </tr>
  </table>

  [GitHub で編集](https://github.com/auth0/docs/edit/master/articles/quickstart/native/flutter/01-login.md)
</Note>
