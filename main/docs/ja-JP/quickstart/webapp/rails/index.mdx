---
title: "Ruby on Rails: ログイン"
permalink: "01-login"
---

import {AuthCodeBlock} from "/snippets/ja-JP/AuthCodeBlock.jsx";

<div id="by-david-patrick">
  ##### David Patrick による
</div>

このチュートリアルでは、Ruby on Rails アプリケーションにユーザーログイン機能を追加する方法を説明します。このクイックスタートを、お使いのアカウント用に構成されたサンプルとともに進められるよう、事前にログインすることをお勧めします。

{/* <Card title="View on Github" href="https://github.com/auth0-samples/auth0-rubyonrails-sample/tree/master/sample" icon="github">
  システム要件: Ruby 2.5.0 以降 | Rails 6.0 以降 または Rails 5.0 以降 または Rails 4.2 以降
  </Card> */}

<Info>
  **認証は初めてですか？** [Auth0 の仕組み](/docs/ja-JP/get-started/auth0-overview)、Auth0 が[通常の Web アプリケーションとどのように統合されるか](/docs/ja-JP/get-started/architecture-scenarios/sso-for-regular-web-apps)、および Auth0 が使用する[プロトコル](/docs/ja-JP/get-started/authentication-and-authorization-flow)について学んでください。
</Info>

<div id="configure-auth0">
  ## Auth0 を設定する
</div>

<div id="get-your-application-keys">
  ### アプリケーションキーを取得する
</div>

Auth0 にサインアップしたときに、新しいアプリケーションが自動的に作成されているか、またはご自身で新しく作成しているはずです。そのアプリケーションから Auth0 と通信するには、いくつかの情報が必要です。これらの情報は Auth0 Dashboard の [Application Settings](https://manage.auth0.com/#/applications) セクションから取得できます。

<Frame>![App Dashboard](https://cdn2.auth0.com/docs/1.14550.0/media/articles/dashboard/client_settings.png)</Frame>

次の情報が必要です。

* **ドメイン**
* **クライアントID**
* **クライアントシークレット**

<Info>
  このページの上部からサンプルをダウンロードした場合、これらの情報はあらかじめ入力されています。
</Info>

<div id="configure-callback-urls">
  ### コールバックURLを設定する
</div>

コールバックURLは、ユーザーの認証が完了した後に Auth0 がアプリケーションにリダイレクトする際のURLです。アプリケーションのコールバックURLは、[Application Settings](https://manage.auth0.com/#/applications) の **Allowed Callback URLs** フィールドに追加する必要があります。このフィールドが設定されていない場合、ユーザーはアプリケーションにログインできず、エラーが返されます。

<Info>
  このページの冒頭からダウンロードしたサンプルプロジェクトに沿って作業している場合、**Allowed Callback URLs** フィールドに追加する必要があるコールバックURLは `http://localhost:3000/auth/auth0/callback` です。
</Info>

<div id="configure-logout-urls">
  ### ログアウトURLを設定する
</div>

ログアウトURLは、ユーザーが認可サーバーからログアウトされた後に、Auth0 がリダイレクト先として使用できる、アプリケーション内のURLです。これは `returnTo` クエリパラメーターで指定します。アプリのログアウトURLは、[Application Settings](https://manage.auth0.com/#/applications) の **許可されたログアウトURL** フィールドに追加する必要があります。このフィールドが設定されていない場合、ユーザーはアプリケーションからログアウトできず、エラーが発生します。

<Info>
  このページの先頭からダウンロードしたサンプルプロジェクトを使用している場合、**許可されたログアウトURL** フィールドに追加する必要があるログアウトURLは `http://localhost:3000` です。
</Info>

<div id="install-the-auth0-sdk">
  ## Auth0 ソフトウェア開発キット (SDK) のインストール
</div>

<div id="install-dependencies">
  ### 依存関係をインストールする
</div>

このチュートリアルでは、認証フローを処理するためのカスタム [OmniAuth ストラテジー](https://github.com/intridea/omniauth#omniauth-standardized-multi-provider-authentication) である `omniauth-auth0` を使用します。次の依存関係を `Gemfile` に追加します：

```bash lines
gem 'omniauth-auth0', '~> 3.0'
gem 'omniauth-rails_csrf_protection', '~> 1.0' # 偽造された認証リクエストを防ぐ
```

Gem を追加したら、`bundle install` を実行して Gem をインストールします:

<div id="initialize-auth0-configuration">
  ### Auth0 設定の初期化
</div>

Auth0 の設定ファイル `./config/auth0.yml` を作成します

export const codeExample = `# ./config/auth0.yml
development:
  auth0_domain: {yourDomain}
  auth0_client_id: {yourClientId}
  auth0_client_secret: <YOUR AUTH0 CLIENT SECRET>`;

<AuthCodeBlock children={codeExample} language="yml" />

次のイニシャライザーファイル `./config/initializers/auth0.rb` を作成し、**OmniAuth** ミドルウェアを[設定](https://github.com/auth0/omniauth-auth0/blob/master/EXAMPLES.md#send-additional-authentication-parameters)します。

```rb lines
# ./config/initializers/auth0.rb
AUTH0_CONFIG = Rails.application.config_for(:auth0)

Rails.application.config.middleware.use OmniAuth::Builder do
  provider(
    :auth0,
    AUTH0_CONFIG['auth0_client_id'],
    AUTH0_CONFIG['auth0_client_secret'],
    AUTH0_CONFIG['auth0_domain'],
    callback_path: '/auth/auth0/callback',
    authorize_params: {
      scope: 'openid profile'
    }
  )
end
```

<div id="add-an-auth0-controller">
  ### Auth0 コントローラーを追加する
</div>

認証コールバックを処理するための Auth0 コントローラーを作成します。コマンド `rails generate controller auth0 callback failure logout --skip-assets --skip-helper --skip-routes --skip-template-engine` を実行します。

callback メソッド内で、`request.env['omniauth.auth']` として返されるユーザー情報のハッシュを現在のセッションに保存します。

```rb lines
# ./app/controllers/auth0_controller.rb
class Auth0Controller < ApplicationController
  def callback
    # OmniAuthは、Auth0とIdP（アイデンティティプロバイダー）から返された情報をrequest.env['omniauth.auth']に保存します。
    # このコードでは、id_tokenから提供されるraw_infoを取得してセッションに割り当てます。
    # 'omniauth.auth'の内容に関する詳細は、https://github.com/auth0/omniauth-auth0/blob/master/EXAMPLES.md#example-of-the-resulting-authentication-hash を参照してください。
    auth_info = request.env['omniauth.auth']
    session[:userinfo] = auth_info['extra']['raw_info']

    # 認証成功後、指定したURLにリダイレクトします
    redirect_to '/dashboard'
  end

  def failure
    # 認証失敗を処理します -- 失敗ページを表示します（リダイレクトで処理することも可能です）
    @error_msg = request.params['message']
  end

  def logout
    # 後のステップで実装します
  end
end
```

次のルートを `./config/routes.rb` ファイルに追加してください：

```rb lines
# ./config/routes.rb
Rails.application.routes.draw do
  # ..
  get '/auth/auth0/callback' => 'auth0#callback'
  get '/auth/failure' => 'auth0#failure'
  get '/auth/logout' => 'auth0#logout'
end
```

<div id="add-login-to-your-application">
  ## アプリケーションにログイン機能を追加する
</div>

ユーザーは `/auth/auth0` エンドポイントにアクセスすることで、アプリケーションにログインできます。

<Warning>
  [不正な認証リクエストを防止する](https://github.com/cookpad/omniauth-rails_csrf_protection)ために、`:post` メソッドを指定して `link_to` または `button_to` ヘルパーメソッドを使用してください。
</Warning>

```erb lines
<!-- アプリケーション内の任意の場所にログインボタンを配置 -->
  <%= button_to 'Login', '/auth/auth0', method: :post, data: { turbo: false } %>
```

<div id="add-logout-to-your-application">
  ## アプリケーションにログアウト機能を追加する
</div>

Rails アプリケーションにログインできるようになったので、次は[ログアウトする方法](https://auth0.com/docs/logout/guides/logout-auth0)が必要です。先ほど作成した Auth0Controller をもう一度開き、そこに追加した logout メソッドを完成させます。

セッションをクリアしてから、ユーザーを Auth0 のログアウトエンドポイントにリダイレクトする必要があります。

セッション内に保存されているすべてのオブジェクトをクリアするには、`auth0_controller/logout` メソッド内で `reset_session` メソッドを呼び出します。[`reset_session` についての詳細はこちらを参照してください](http://api.rubyonrails.org/classes/ActionController/Base.html#M000668)。次のコードを `./app/controllers/auth0_controller.rb` に追加します。

```rb lines
# ./app/controllers/auth0_controller.rb
class Auth0Controller < ApplicationController
  # ..
  # ..以下のコードを挿入
  def logout
    reset_session
    redirect_to logout_url, allow_other_host: true
  end

  private

  def logout_url
    request_params = {
      returnTo: root_url,
      client_id: AUTH0_CONFIG['auth0_client_id']
    }

    URI::HTTPS.build(host: AUTH0_CONFIG['auth0_domain'], path: '/v2/logout', query: request_params.to_query).to_s
  end
end
```

<Info>
  最終的なリダイレクト先URL（`returnTo` の値）は、`許可されたログアウトURL` の一覧に含まれている必要があります。詳細については、[ログアウトに関するドキュメント](/docs/ja-JP/authenticate/login/logout/redirect-users-after-logout)を参照してください。
</Info>

これで、ユーザーは `/auth/logout` エンドポイントにアクセスすることでアプリケーションからログアウトできるようになります。

```erb lines
<!-- アプリケーションの任意の場所にログアウトボタンを配置します -->
  <%= button_to 'Logout', 'auth/logout', method: :get, data: { turbo: false } %>
```

<div id="show-user-profile-information">
  ## ユーザーのプロファイル情報を表示する
</div>

ユーザーのプロファイルを表示するには、アプリケーションで保護されたルートを用意する必要があります。ルートへのアクセス制御には、コントローラーの `concern` を使用できます。次のファイル `./app/controllers/concerns/secured.rb` を作成します。

```rb lines
# ./app/controllers/concerns/secured.rb
module Secured
  extend ActiveSupport::Concern

  included do
    before_action :logged_in_using_omniauth?
  end

  def logged_in_using_omniauth?
    redirect_to '/' unless session[:userinfo].present?
  end
end
```

セキュアな controller concern を作成したら、ログイン済みのユーザーを必要とする任意の controller にそれをインクルードします。その後は、セッションの `session[:userinfo]` からユーザー情報にアクセスできます。

```rb lines
# ./app/controllers/dashboard_controller.rb
class DashboardController < ApplicationController
  include Secured

  def show
    # session[:userinfo] は Auth0Controller#callback で事前に保存されています
    @user = session[:userinfo]
  end
end
```

セッションからユーザーを読み込んだので、それを使ってフロントエンドに情報を表示できます。

```erb lines
<!-- ./app/views/dashboard/show.html.erb -->
<div>
  <p>正規化されたユーザープロファイル:<%= JSON.pretty_generate(@user[:info])%></p>
  <p>完全なユーザープロファイル:<%= JSON.pretty_generate(@user[:extra][:raw_info])%></p>
</div>
```

<Note>
  ##### 次のステップ

  <table>
    <tr>
      <td><a href="/docs/ja-JP/authenticate/identity-providers">他のアイデンティティ プロバイダーを設定する</a></td>
      <td><a href="/docs/ja-JP/secure/multi-factor-authentication">多要素認証を有効にする</a></td>
    </tr>

    <tr>
      <td><a href="/docs/ja-JP/secure/attack-protection">攻撃対策について学ぶ</a></td>
      <td><a href="/docs/ja-JP/customize/rules">Rules について学ぶ</a></td>
    </tr>
  </table>

  [GitHub で編集する](https://github.com/auth0/docs/edit/master/articles/quickstart/native/flutter/01-login.md)
</Note>
