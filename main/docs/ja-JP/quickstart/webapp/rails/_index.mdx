---
title: Ruby on Rails アプリケーションにログインを追加する
sidebarTitle: Ruby on Rails

---

import { Recipe, Content, Section, SideMenu, SideMenuSectionItem, SignUpForm } from "/snippets/ja-JP/recipe.jsx";
import { LoggedInForm } from "/snippets/ja-JP/Login.jsx";
import Auth0Yml from "/snippets/ja-JP/quickstart/webapp/rails/auth0.yml.mdx";
import Auth0 from "/snippets/ja-JP/quickstart/webapp/rails/auth0.rb.mdx";
import Auth0Controller from "/snippets/ja-JP/quickstart/webapp/rails/auth0_controller.rb.mdx";
import Routes from "/snippets/ja-JP/quickstart/webapp/rails/routes.rb.mdx";
import Secured from "/snippets/ja-JP/quickstart/webapp/rails/secured.rb.mdx";

import {AuthCodeGroup} from "/snippets/ja-JP/AuthCodeGroup.jsx";

export const sections = [
      { id: "configure-auth0", title: "Auth0 を設定する" },
      { id: "add-dependencies", title: "依存関係を追加する" },
      { id: "configure-the-sdk", title: "ソフトウェア開発キット (SDK) を設定する" },
      { id: "configure-the-omniauth-middleware", title: "OmniAuth ミドルウェアを設定する" },
      { id: "add-an-auth0-controller", title: "Auth0 コントローラーを追加する" },
      { id: "configure-routes", title: "ルーティングを設定する" },
      { id: "add-login-to-your-application", title: "アプリケーションにログイン機能を追加する" },
      { id: "add-logout-to-your-application", title: "アプリケーションにログアウト機能を追加する" },
      { id: "show-user-profile-information", title: "ユーザー プロファイル情報を表示する" }
]


<Recipe isSingleColumn>
  <Content>
    <Section id={sections[0].id} title={sections[0].title} stepNumber="1" isSingleColumn>
      Auth0 のサービスを利用するには、Auth0 Dashboard でアプリケーションを設定する必要があります。Auth0 のアプリケーションでは、開発中のプロジェクトで認証をどのように動作させるかを構成します。

      ### アプリケーションを設定する

      インタラクティブセレクターを使用して、新しい Auth0 アプリケーションを作成するか、統合したいプロジェクトを表す既存のアプリケーションを選択します。Auth0 の各アプリケーションには英数字の一意なクライアントID が割り当てられており、アプリケーションのコードはこのクライアントID を使用してソフトウェア開発キット (SDK) を通じて Auth0 API を呼び出します。

      このクイックスタートで設定した内容はすべて、[Dashboard](https://manage.auth0.com/#/) 上のアプリケーションに自動的に反映されます。今後のアプリケーション管理もここから行います。

      より完全な設定を確認したい場合は、代わりにサンプルアプリケーションを参照できます。

      ### コールバック URL を設定する

      コールバック URL は、ユーザーが認証を完了した後に Auth0 からリダイレクトさせたい、アプリケーション内の URL です。設定しない場合、ユーザーはログイン後にアプリケーションへ戻れません。

      <Info>
        サンプルプロジェクトに沿って進めている場合は、これを
        `http://localhost:3000/auth/auth0/callback` に設定してください。
      </Info>

      ### ログアウト URL を設定する

      ログアウト URL は、ユーザーがログアウトした後に Auth0 からリダイレクトさせたい、アプリケーション内の URL です。設定しない場合、ユーザーはアプリケーションからログアウトできず、エラーが返されます。

      <Info>
        サンプルプロジェクトに沿って進めている場合は、これを `http://localhost:3000` に設定してください。
      </Info>

      ### 許可された Web オリジンを設定する

      許可された Web オリジン (Allowed Web Origins) は、認証フローへのアクセスを許可したい URL です。ここには、プロジェクトの URL を含める必要があります。正しく設定されていない場合、プロジェクトは認証トークンをサイレントリフレッシュできず、ユーザーは次回アプリケーションにアクセスしたりページをリフレッシュしたときにログアウトされてしまいます。

      <Info>
        サンプルプロジェクトに沿って進めている場合は、これを `http://localhost:3000` に設定してください。
      </Info>

      <LoggedInForm />
    </Section>

    <Section id={sections[1].id} title={sections[1].title} stepNumber="2" isSingleColumn>
      認証フローを処理するには、カスタムの [OmniAuth strategy](https://github.com/intridea/omniauth#omniauth-standardized-multi-provider-authentication) である `omniauth-auth0` を使用します。

      次の依存関係を `Gemfile` に追加します。

      ```gem lines
      gem 'omniauth-auth0', '~> 3.0'
      gem 'omniauth-rails_csrf_protection', '~> 1.0' # 偽造された認証リクエストを防ぐ
      ```

      Gem を追加したら、`bundle install` を実行してインストールします。

      <LoggedInForm />
    </Section>

    <Section id={sections[2].id} title={sections[2].title} stepNumber="3" isSingleColumn>
      設定ファイル `./config/auth0.yml` を作成し、Auth0 のドメイン、クライアントID、およびクライアントシークレットの値を指定します。これらの値は、Auth0 Dashboard のアプリケーションの **Settings** タブにあります。

      <AuthCodeGroup>
        <Auth0Yml />

        <Auth0 />

        <Auth0Controller />

        <Routes />

        <Secured />
      </AuthCodeGroup>
    </Section>

    <Section id={sections[3].id} title={sections[3].title} stepNumber="4" isSingleColumn>
      次の initializer ファイル `./config/initializers/auth0.rb` を作成し、前の手順で作成した設定ファイルを使用して **OmniAuth** ミドルウェアを[設定](https://github.com/auth0/omniauth-auth0/blob/master/EXAMPLES.md#send-additional-authentication-parameters)します。

      `callback_path` が、Auth0 アプリケーションの設定「許可されたコールバックURL」で指定した値と一致していることを確認してください。

      <AuthCodeGroup>
        <Auth0 />

        <Auth0Yml />

        <Auth0Controller />

        <Routes />

        <Secured />
      </AuthCodeGroup>
    </Section>

    <Section id={sections[4].id} title={sections[4].title} stepNumber="5" isSingleColumn>
      認証コールバック、`logout` アクション、およびログアウト URL を構築するためのメソッドを処理する Auth0 コントローラーを作成します。

      次のコマンドを実行します:
      `rails generate controller auth0 callback failure logout --skip-assets --skip-helper --skip-routes --skip-template-engine`.

      `callback` メソッド内で、`request.env['omniauth.auth']` として返されるユーザー情報のハッシュを現在のセッションに保存します。

      ログアウトを設定するには、`logout` アクション内で `reset_session` メソッドを呼び出して、セッション内に保存されているすべてのオブジェクトをクリアします。次に、Auth0 のログアウトエンドポイントへリダイレクトします。`reset_session` について詳しくは、[Ruby on Rails ActionController のドキュメント](http://api.rubyonrails.org/classes/ActionController/Base.html#M000668)を参照してください。

      <AuthCodeGroup>
        <Auth0Controller />

        <Auth0Yml />

        <Auth0 />

        <Routes />

        <Secured />
      </AuthCodeGroup>
    </Section>

    <Section id={sections[5].id} title={sections[5].title} stepNumber="6" isSingleColumn>
      `./config/routes.rb` ファイルに次のルートを追加します。

      Rails がさまざまな Auth0 のコールバック URL を前の手順で作成した Auth0 コントローラーへルーティングできるように、ルートを設定する必要があります。

      <Info>
        ##### チェックポイント

        アプリケーションを実行し、Auth0 に関連するエラーが発生せず、意図したとおりに動作し続けていることを確認してください。
      </Info>

      <AuthCodeGroup>
        <Routes />

        <Auth0Yml />

        <Auth0 />

        <Auth0Controller />

        <Secured />
      </AuthCodeGroup>
    </Section>

    <Section id={sections[6].id} title={sections[6].title} stepNumber="7" isSingleColumn>
      これで、ユーザーは `/auth/auth0` エンドポイントにアクセスしてアプリケーションにログインできるようになりました。

      <Warning>
        [偽造された認証リクエストを防ぐ](https://github.com/cookpad/omniauth-rails_csrf_protection)ために、`link_to` または
        `button_to` ヘルパーメソッドを `:post` メソッドと組み合わせて使用してください。
      </Warning>

      ```ruby lines
      <!-- アプリケーション内の任意の場所にログインボタンを配置します -->
      <%= button_to 'Login', '/auth/auth0', method: :post %>
      ```

      <Note>
        ##### チェックポイント

        クリックされたときにユーザーを `/auth/auth0` エンドポイントへリダイレクトするボタンをアプリケーションに追加します。Auth0 にリダイレクトされてログインし、認証に成功するとアプリに戻ってくることを確認します。
      </Note>

      <LoggedInForm />
    </Section>

    <Section id={sections[7].id} title={sections[7].title} stepNumber="8" isSingleColumn>
      Railsアプリケーションにログインできるようになったので、今度はログアウトする方法も必要です。`auth/logout` アクションにリダイレクトすることでユーザーをログアウトします。このアクションはユーザーを Auth0 のログアウトエンドポイントにリダイレクトします。

      <Info>
        前の手順の後でこれをテストするには、セッションをクリアしてから、ユーザーを
        Auth0 のログアウトエンドポイントに再度リダイレクトする必要がある場合があります。
      </Info>

      ```ruby lines
      <!-- アプリケーション内の任意の場所にログアウトボタンを配置します -->
      <%= button_to 'Logout', 'auth/logout', method: :get %>
      ```

      <Note>
        ##### チェックポイント

        クリックされたときにユーザーを `/auth/logout` エンドポイントにリダイレクトするボタンをアプリケーションに追加します。Auth0 にリダイレクトされてからすぐにアプリケーションに戻ること、そしてログイン状態が解除されていることを確認してください。
      </Note>

      <LoggedInForm />
    </Section>

    <Section id={sections[8].id} title={sections[8].title} stepNumber="9" isSingleColumn>
      ユーザーのプロファイルを表示するには、アプリケーションで保護されたルートを用意する必要があります。複数のコントローラー間で共有できるルートへのアクセスを制御するには、[Concern](https://guides.rubyonrails.org/getting_started.html#using-concerns) を使用できます。Concern は、ユーザーが認証されていない場合は自動的に Auth0 へリダイレクトし、それ以外の場合は現在のユーザーのプロファイルを返す必要があります。

      Concern を作成したら、ログイン済みユーザーを必要とする任意のコントローラーにそれを include します。その後、次の例のように、セッション `session[:userinfo]` からユーザーにアクセスできます。

      ```ruby lines
      class DashboardController < ApplicationController
      include Secured
      def show
      @user = session[:userinfo]

      end
      end
      ```

      セッションからユーザーを読み込んだら、それを使ってフロントエンドで情報を表示します。

      ```html lines
      <div>
      <p>Normalized User Profile:<%= JSON.pretty_generate(@user[:info])%></p>
      <p>Full User Profile:<%= JSON.pretty_generate(@user[:extra][:raw_info])%></p>
      </div>
      ```

      <Note>
        ##### チェックポイント

        アプリに `Secured` concern を追加し、認証済みユーザーのみがアクセスできるようにしたいコントローラーでそれを include します。認証済みユーザーがそのコントローラー内のアクションにアクセスできること、および未認証のユーザーが認証のために Auth0 にリダイレクトされることを確認します。
      </Note>

      <AuthCodeGroup>
        <Secured />

        <Auth0Yml />

        <Auth0 />

        <Auth0Controller />

        <Routes />
      </AuthCodeGroup>
    </Section>

    ## 次のステップ

    素晴らしい!ここまで進めたなら、アプリケーションでログイン、ログアウト、およびユーザープロファイル情報が実装されているはずです。

    これでクイックスタートチュートリアルは終了ですが、他にも多くの機能があります。Auth0でできることの詳細については、以下をご確認ください:

    * [Auth0 Dashboard](https://manage.auth0.com/dashboard/us/dev-gja8kxz4ndtex3rq) - Auth0 テナントとアプリケーションの構成と管理方法を学びます
    * [omniauth-auth0 ソフトウェア開発キット (SDK)](https://github.com/auth0/omniauth-auth0) - このチュートリアルで使用しているソフトウェア開発キット (SDK) をさらに詳しく見てみましょう
    * [Auth0 Marketplace](https://marketplace.auth0.com/) - Auth0 の機能を拡張するためのインテグレーションを探す
  </Content>
</Recipe>