---
title: "PHP"
permalink: "01-login"
---

import {AuthCodeBlock} from "/snippets/ja-JP/AuthCodeBlock.jsx";

<div id="by-evan-sims">
  ##### 著者: Evan Sims
</div>

このガイドでは、Auth0 PHP ソフトウェア開発キット (SDK) を使用して、PHP アプリケーションに Auth0 を統合する方法を説明します。ご利用のアカウント向けに構成されたサンプルを使ってこのクイックスタートを進められるよう、あらかじめログインしておくことをお勧めします。

{/* <Card title="GitHub で表示" href="https://github.com/auth0-samples/auth0-php-web-app/tree/main/app" icon="github">
  システム要件: PHP 7.4 以上 (8.0 推奨) | Auth0-PHP 8.0 | Composer
  </Card> */}

<Info>
  **認証は初めてですか？** [Auth0 の仕組み](/docs/ja-JP/get-started/auth0-overview)、それが[レギュラー Web アプリケーションとどのように統合されるか](/docs/ja-JP/get-started/architecture-scenarios/sso-for-regular-web-apps)、および Auth0 が使用する[プロトコル](/docs/ja-JP/get-started/authentication-and-authorization-flow)について学んでください。
</Info>

<div id="configure-auth0">
  ## Auth0 を構成する
</div>

<div id="get-your-application-keys">
  ### アプリケーションキーを取得する
</div>

Auth0 にサインアップすると、新しいアプリケーションが自動的に作成されるか、自分で新しいアプリケーションを作成しているはずです。Auth0 と連携するには、そのアプリケーションに関するいくつかの情報が必要になります。これらの情報は Auth0 Dashboard の [Application Settings](https://manage.auth0.com/#/applications) セクションで確認できます。

<Frame>![App Dashboard](https://cdn2.auth0.com/docs/1.14550.0/media/articles/dashboard/client_settings.png)</Frame>

次の情報が必要です。

* **Domain**
* **Client ID**
* **Client Secret**

<Info>
  このページの上部からサンプルをダウンロードすると、これらの情報はあらかじめ入力されています。
</Info>

<div id="configure-callback-urls">
  ### コールバックURLを設定する
</div>

コールバックURLは、ユーザーの認証が完了した後に Auth0 がリダイレクトする、アプリケーション内のURLです。アプリケーションのコールバックURLは、[Application Settings](https://manage.auth0.com/#/applications) の **Allowed Callback URLs** フィールドに追加する必要があります。このフィールドが設定されていない場合、ユーザーはアプリケーションにログインできず、エラーが発生します。

<Info>
  このページの上部からダウンロードしたサンプルプロジェクトに沿って進めている場合、**Allowed Callback URLs** フィールドに追加する必要があるコールバックURLは `http://127.0.0.1:3000/` です。
</Info>

<div id="configure-logout-urls">
  ### ログアウトURLを設定する
</div>

ログアウトURLは、ユーザーが認可サーバーからログアウトされた後に、Auth0 がリダイレクト先として使用できるアプリケーション内の URL です。これは `returnTo` クエリパラメーターで指定されます。アプリのログアウトURLは、[Application Settings](https://manage.auth0.com/#/applications) の **許可されたログアウトURL** フィールドに追加する必要があります。このフィールドが設定されていない場合、ユーザーはアプリケーションからログアウトできず、エラーが発生します。

<Info>
  このページの先頭からダウンロードしたサンプルプロジェクトを使用している場合、**許可されたログアウトURL** フィールドに追加する必要があるログアウトURLは `http://127.0.0.1:3000` です。
</Info>

<div id="integrate-your-php-application">
  ## PHP アプリケーションを統合する
</div>

PHP アプリケーションでユーザーを認証するサンプルアプリケーションを作成します。ここでは、この記事の形式に適したシンプルなアプローチを取ります。なお、より堅牢な例については、併せて提供している [GitHub 上のクイックスタートアプリ](https://github.com/auth0-samples/auth0-php-web-app/) も確認してください。

<div id="installing-http-client-and-messaging-factories">
  ### HTTP Client と Messaging Factories のインストール
</div>

Auth0 PHP ソフトウェア開発キット (SDK) は、多くの [PHP-FIG](https://www.php-fig.org) 標準をサポートしており、アーキテクチャに合わせた相互運用性の選択肢を提供します。特に重要なのが [PSR-17](https://www.php-fig.org/psr/psr-17/) と [PSR-18](https://www.php-fig.org/psr/psr-18/) です。これらの標準により、メッセージングとリクエストを処理するために、任意のネットワークコンポーネントを差し替えて利用できます。SDK が利用できるように、プロジェクトに互換性のあるライブラリをインストールする必要があります。

PHP 向けの最も普及しているネットワークライブラリは [Guzzle](https://docs.guzzlephp.org/) ですが、PHP コミュニティには他にも多くの選択肢があります。このサンプルアプリケーションでは Guzzle を使用します。もう一度、プロジェクトディレクトリから次のシェルコマンドを実行してください。

```bash lines
composer require guzzlehttp/guzzle guzzlehttp/psr7 http-interop/http-factory-guzzle
```

<div id="installing-the-php-sdk">
  ### PHP SDK のインストール
</div>

Auth0 PHP SDK を利用するには、PHP の依存関係管理ツールである [Composer](https://getcomposer.org/doc/00-intro.md#installation-linux-unix-macos) が必要です。Composer を使用すると、プロジェクトに必要な依存ライブラリを宣言し、それらをインストールできます。先に進む前に、Composer がインストールされており、シェルから実行可能であることを確認してください。

プロジェクトディレクトリ内で、次のシェルコマンドを実行して Auth0 PHP SDK をインストールします。

```bash lines
composer require auth0/auth0-php
```

これにより、プロジェクト内に `vendor` フォルダーが作成され、Auth0 PHP ソフトウェア開発キット (SDK) を使用するために必要なすべての依存関係がダウンロードされます。また、サンプルで使用される `vendor/autoload.php` ファイルも作成され、アプリケーションが動作するために必要なすべてのクラスを読み込むために使用されます。SDK が正しく動作するように、この autoload ファイルをプロジェクト内で必ず `require` してください。

<div id="configuring-the-sdk">
  ### SDK の設定
</div>

まず、サンプルアプリケーション用の設定を保存するために、プロジェクトのルートディレクトリに `.env` ファイルを作成し、環境変数を記述します。

export const codeExample = `# Auth0 アプリケーションのクライアントID
AUTH0_CLIENT_ID={yourClientId}

# Auth0 テナントドメインの URL
AUTH0_DOMAIN={yourDomain}

# Auth0 アプリケーションのクライアントシークレット
AUTH0_CLIENT_SECRET={yourClientSecret}

# セッションクッキーを暗号化するために使用される長い秘密の値です。
# シェルで \`openssl rand -hex 32\` を実行して生成できます。
AUTH0_COOKIE_SECRET=

# アプリケーションにアクセスできる URL。必要に応じて更新してください。
AUTH0_BASE_URL=http://127.0.0.1:3000`;

<AuthCodeBlock children={codeExample} language="env" />

PHP は単体では `.env` ファイルを読み取ることができないため、それを補助するライブラリをインストールする必要があります。このサンプルアプリケーションでは特定のライブラリを使用しますが、実際のアプリケーションでは任意の好みの「dotenv」ローダーを使用できます。プロジェクトディレクトリで、次のシェルコマンドを実行してライブラリをインストールします。

```bash lines
composer require vlucas/phpdotenv
```

次に、これらのコードサンプルで使用する PHP のソースファイル `index.php` を作成し、サンプルアプリケーション用に Auth0 PHP ソフトウェア開発キット (SDK) のインスタンスを設定しましょう。

```php lines
<?php

// Composer オートローダーをインポートして、SDK クラスにアクセスできるようにします:
require 'vendor/autoload.php';

// .env ファイルから環境変数を読み込みます:
(Dotenv\Dotenv::createImmutable(__DIR__))->load();

// 次に、設定を使用して Auth0 クラスをインスタンス化します:
$auth0 = new \Auth0\SDK\Auth0([
    'domain' => $_ENV['AUTH0_DOMAIN'],
    'clientId' => $_ENV['AUTH0_CLIENT_ID'],
    'clientSecret' => $_ENV['AUTH0_CLIENT_SECRET'],
    'cookieSecret' => $_ENV['AUTH0_COOKIE_SECRET']
]);
```

<div id="setting-up-your-application-routes">
  ### アプリケーションのルートを設定する
</div>

モダンな PHP アプリケーションでは、受信した HTTP リクエストを処理するコードに渡し、ユーザーがアプリ内の特定の「ページ」を訪れたときに何が起こるかを決定するために、ルーティングパターンを使用します。アプリケーションでルーティングを実装する「正しい」やり方が 1 つだけあるわけではなく、実装に利用できるライブラリも数多く存在します。このサンプルアプリケーションでは特定のライブラリを使用しますが、実際のアプリケーションでは自由に任意のライブラリを選択してください。

プロジェクトディレクトリで次のシェルコマンドを実行して、ルーティングライブラリをインストールします。

```bash lines
composer require steampixel/simple-php-router
```

次に、`index.php` をもう一度開き、アプリケーションに生命を吹き込みましょう。まずルーティングライブラリをインポートし、サンプルアプリケーションのルートに対応する完全な URL を、後で扱いやすいよう名前付き定数として定義します。これらはサンプルアプリケーション内のいくつかの箇所で参照する必要があります。

```php lines
// 👆 上記の手順から続けています。これを index.php ファイルに追加してください。

// ルーターライブラリをインポートします:
use Steampixel\Route;

// ルート定数を定義します:
define('ROUTE_URL_INDEX', rtrim($_ENV['AUTH0_BASE_URL'], '/'));
define('ROUTE_URL_LOGIN', ROUTE_URL_INDEX . '/login');
define('ROUTE_URL_CALLBACK', ROUTE_URL_INDEX . '/callback');
define('ROUTE_URL_LOGOUT', ROUTE_URL_INDEX . '/logout');
```

ここからは、アプリケーションのルーティング処理ロジックとソフトウェア開発キット (SDK) の統合を追加していきます。

<div id="checking-for-a-session">
  ## セッションの確認
</div>

Auth0 PHP ソフトウェア開発キット (SDK) には、ユーザーが認証されてプロファイルが返されているかどうかを確認するための便利なメソッド `getCredentials()` があります。これを index ルートで使用して、ユーザーがログインしている場合はユーザープロファイルを出力し、ログインが必要であることを表示するようにしましょう。

```php lines
// 👆 上記の手順から続けています。これを index.php ファイルに追加してください。

Route::add('/', function() use ($auth0) {
  $session = $auth0->getCredentials();

  if ($session === null) {
    // ユーザーはログインしていません。
    echo '<p>Please <a href="/docs/login">log in</a>.</p>';
    return;
  }

  // ユーザーはログインしています。
  echo '<pre>';
  print_r($session->user);
  echo '</pre>';

  echo '<p>You can now <a href="/docs/logout">log out</a>.</p>';
});
```

`user` プロパティのレスポンスは配列であり、そこからユーザーのプロファイルのすべてのプロパティにアクセスできます。たとえば、`$session->user<a href="https://auth0.com/docs/users/user-profile-structure" target="_blank" rel="noreferrer">nickname` を使ってユーザーのニックネームを取得したり、`$session->useremail` からメールアドレスを取得したりできます。この構造は正規化されたユーザープロファイルであり、詳細については[こちら](https://auth0.com/docs/users/normalized-user-profiles)を参照してください。

ユーザープロファイルの内容は、使用するソーシャルプロバイダーによって異なることに注意してください。そのため、アプリケーションロジックの中で特定の値が常に存在すると仮定してはいけません。`isset` や null 合体演算子などの PHP の構文を使用して、値が存在する場合と存在しない場合の両方を適切に処理してください。例:

```php lines
// ✋ サンプルアプリケーションに含める必要はありません。これは単なる例です。
$name = $session->user['name'] ?? $session->user['nickname'] ?? $session->user['email'] ?? 'Unknown';
```

<div id="logging-in">
  ## ログイン
</div>

次に、`/login` ルートを作成します。このルートでは Auth0 PHP ソフトウェア開発キット (SDK) の `login()` メソッドを使用してユーザーセッションを設定し、このユーザーがログインするための Auth0 の Universal Login ページへのカスタム URL を返します。

```php lines
// 👆 上記の手順から続けています。これを index.php ファイルに追加してください。

Route::add('/login', function() use ($auth0) {
    // ネットワークの問題やその他の問題によって以前のログインプロセスが中断された場合に「invalid state」エラーを回避するため、ログイン時には毎回ユーザーセッションをリセットすることをお勧めします:
    $auth0->clear();

    // 最後に、ローカルアプリケーションセッションをセットアップし、ユーザーを Auth0 Universal Login ページにリダイレクトして認証を行います。
    header("Location: " . $auth0->login(ROUTE_URL_CALLBACK));
    exit;
});
```

<div id="handling-authentication-callback">
  ## 認証コールバックの処理
</div>

ユーザーが Auth0 の Universal Login ページでの認証を終えると、コールバック用ルート `/callback` にあるサンプルアプリケーションへ戻ってきます。このステップでは、そのコールバックを処理します。

Auth0 がユーザーをアプリケーションへ戻す際、HTTP リクエストのクエリにいくつかの重要なパラメーターを含めます。Auth0 PHP ソフトウェア開発キット (SDK) の `exchange()` メソッドがそれらの処理を行うため、認証フローの完了は簡単です。

```php lines
// 👆 上記の手順から続けています。これを index.php ファイルに追加してください。

Route::add('/callback', function() use ($auth0) {
    // SDK に認証フローを完了させます:
    $auth0->exchange(ROUTE_URL_CALLBACK);

    // 最後に、エンドユーザーを / インデックスルートにリダイレクトして、ユーザープロファイルを表示します:
    header("Location: " . ROUTE_URL_INDEX);
    exit;
});
```

<div id="logging-out">
  ## ログアウト
</div>

最後になりましたが、ユーザーのログアウト処理を正しく実装しましょう。Auth0 PHP ソフトウェア開発キット (SDK) の `logout()` メソッドは、このサンプルアプリケーションのセッションクッキーを削除し、ユーザーを Auth0 の [/logout endpoint](https://auth0.com/docs/logout)（Auth0 のセッションレイヤーおよび任意のアイデンティティプロバイダーのセッションレイヤーをログアウトします）へリダイレクトし、最後にユーザーを `/` ルートへ戻します。

```php lines
// 👆 We're continuing from the steps above. Append this to your index.php file.

Route::add('/logout', function() use ($auth0) {
    // アプリでのユーザーのローカルセッションをクリアし、Auth0 ログアウトエンドポイントにリダイレクトして Auth0 セッションをクリアします。
    header("Location: " . $auth0->logout(ROUTE_URL_INDEX));
    exit;
});
```

<div id="run-your-app">
  ## アプリを実行しましょう！
</div>

最後のステップとして、ルーティング用ミドルウェアに実際にリクエストをルーティングするよう指示する必要があります。

```php lines
// 👆 上記の手順からの続きです。これをindex.phpファイルに追記してください。

// これにより、ルートの設定が完了し、受信HTTPリクエストのルーティングを開始する準備ができたことをルーターに通知します:
Route::run('/');
```

以上です。これで新しいアプリケーションを実行する準備が整いました。もう一度、プロジェクトディレクトリから次のシェルコマンドを実行します。

```bash lines
php -S 127.0.0.1:3000 index.php
```

ブラウザーで [http://127.0.0.1:3000](https://127.0.0.1:3000) を開き、動作を試してみてください。

<Note>
  ##### 次にできること

  <table>
    <tr>
      <td><a href="/docs/ja-JP/authenticate/identity-providers">他のアイデンティティ プロバイダーを設定する</a></td>
      <td><a href="/docs/ja-JP/secure/multi-factor-authentication">多要素認証を有効にする</a></td>
    </tr>

    <tr>
      <td><a href="/docs/ja-JP/secure/attack-protection">攻撃対策について学ぶ</a></td>
      <td><a href="/docs/ja-JP/customize/rules">Rules について学ぶ</a></td>
    </tr>
  </table>

  [GitHub で編集](https://github.com/auth0/docs/edit/master/articles/quickstart/native/flutter/01-login.md)
</Note>
