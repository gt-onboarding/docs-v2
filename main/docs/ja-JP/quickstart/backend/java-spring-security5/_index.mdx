---
title: Spring Boot アプリケーションに認可を追加する
sidebarTitle: Spring Boot API

---

import { Recipe, Content, Section, SideMenu, SideMenuSectionItem, SignUpForm } from "/snippets/ja-JP/recipe.jsx";
import { LoggedInForm } from "/snippets/ja-JP/Login.jsx";
import Application from "/snippets/ja-JP/quickstart/backend/java-spring-security5/application.yml.mdx";
import Securityconfig from "/snippets/ja-JP/quickstart/backend/java-spring-security5/SecurityConfig.java.mdx";
import Apicontroller from "/snippets/ja-JP/quickstart/backend/java-spring-security5/APIController.java.mdx";

import {AuthCodeGroup} from "/snippets/ja-JP/AuthCodeGroup.jsx";

export const sections = [
  { id: "define-permissions", title: "権限を定義する" },
  { id: "configure-the-sample-project", title: "サンプルプロジェクトを設定する" },
  { id: "install-dependencies", title: "依存関係をインストールする" },
  { id: "configure-the-resource-server", title: "リソースサーバーを設定する" },
  { id: "create-the-domain-object", title: "ドメインオブジェクトを作成する" },
  { id: "create-the-api-controller", title: "API コントローラを作成する" },
  { id: "run-the-application", title: "アプリケーションを実行する" }
]


<Recipe isSingleColumn>
  <Content>
    Auth0を使用すると、アプリケーションに認可機能を迅速に追加できます。このガイドでは、新規または既存のSpring BootアプリケーションにAuth0を統合する方法を説明します。

    Auth0 Dashboard でまだ API を作成していない場合は、インタラクティブセレクターを使用して新しい Auth0 API を作成するか、統合するプロジェクトを表す既存の API を選択してください。

    Auth0 Dashboardで最初のAPIをセットアップするには、[スタートガイド](https://auth0.com/docs/get-started/auth0-overview/set-up-apis)をご確認ください。

    各Auth0 APIはAPI識別子を使用します。アプリケーションはアクセストークンを検証する際にこの識別子が必要です。

    <Info>
      **Auth0 を初めて利用しますか？** [Auth0 の仕組み](https://auth0.com/docs/overview) を確認し、
      OAuth 2.0 フレームワークに基づく [API 認証と認可の実装方法](https://auth0.com/docs/api-auth) をお読みください。
    </Info>

    <Section id={sections[0].id} title={sections[0].title} stepNumber="1" isSingleColumn>
      Permissions では、特定のアクセストークンを持つユーザーに代わってリソースへどのようにアクセスできるかを定義できます。たとえば、ユーザーのアクセスレベルがマネージャーの場合は `messages` リソースへの読み取りアクセス権を付与し、アクセスレベルが管理者の場合はそのリソースへの書き込みアクセス権を付与するといったことができます。

      許可する Permissions は、Auth0 Dashboard の [APIs](https://manage.auth0.com/dashboard/us/dev-1-2s2aq0/apis) セクションにある **Permissions** ビューで定義できます。

      <Frame>
        <img src="/docs/images/cdy7uua7fh8z/1s3Yp5zqJiKiSWqbPSezNO/e61793a2822d095666002c3f65c71ac2/configure-permissions.png" />
      </Frame>

      <Info>
        この例では `read:messages` スコープを使用します。
      </Info>

      <LoggedInForm />
    </Section>

    <Section id={sections[1].id} title={sections[1].title} stepNumber="2" isSingleColumn>
      サンプルプロジェクトでは `/src/main/resources/application.yml` ファイルを使用しており、ここであなたの API 用の正しい Auth0 の **ドメイン** と **API Identifier** が設定されています。このページからコードをダウンロードした場合は、自動的に設定されていますが、GitHub からサンプルをクローンした場合は、自分で値を設定する必要があります。

      <AuthCodeGroup>
        <Application />

        <Securityconfig />

        <Apicontroller />
      </AuthCodeGroup>
    </Section>

    <Section id={sections[2].id} title={sections[2].title} stepNumber="3" isSingleColumn>
      Gradle を使用している場合は、[Spring Boot Gradle Plugin](https://docs.spring.io/spring-boot/docs/current/gradle-plugin/reference/html/) と [Dependency Management Plugin](https://docs.spring.io/dependency-management-plugin/docs/current/reference/html/) を使うことで、依存関係のバージョンを解決しながら必要な依存関係を追加できます。

      ```gradle lines
      // build.gradle
      plugins {

          id 'java'

          id 'org.springframework.boot'

          version '3.1.5'

          id 'io.spring.dependency-management'

          version '1.1.3'

      }

      dependencies {

          implementation 'org.springframework.boot:spring-boot-starter-web'

          implementation 'com.okta.spring:okta-spring-boot-starter:3.0.5'

      }
      ```

      Maven を使用している場合は、`pom.xml` ファイルに Spring の依存関係を追加します。

      ```xml lines
      // pom.xml
      <parent>
      <groupId>org.springframework.boot</groupId>
      <artifactId>spring-boot-starter-parent</artifactId>
      <version>3.1.5</version>
      <relativePath/>
      </parent>
      <dependencies>
      <dependency>
      <groupId>org.springframework.boot</groupId>
      <artifactId>spring-boot-starter-web</artifactId>
      </dependency>
      <dependency>
      <groupId>com.okta.spring</groupId>
      <artifactId>okta-spring-boot-starter</artifactId>
      <version>3.0.5</version>
      </dependency>
      </dependencies>
      ```

      <AuthCodeGroup>
        <Application />

        <Securityconfig />

        <Apicontroller />
      </AuthCodeGroup>
    </Section>

    <Section id={sections[3].id} title={sections[3].title} stepNumber="4" isSingleColumn>
      アプリケーションをリソースサーバーとして構成し JWT を検証するには、`SecurityFilterChain` のインスタンスを提供するクラスを作成し、`@Configuration` アノテーションを追加します。

      ### API エンドポイントを保護する

      次に示すルートは、以下のリクエストで利用できます。

      * `GET /api/public`: 認証されていないリクエストで利用可能
      * `GET /api/private`: 追加のスコープを含まないアクセストークンを持つ、認証済みリクエストで利用可能
      * `GET /api/private-scoped`: `read:messages` スコープが付与されたアクセストークンを持つ、認証済みリクエストで利用可能

      以下の例は、`SecurityConfig` クラスの `filterChain()` メソッドで提供される `HttpSecurity` オブジェクトを使用して API メソッドを保護する方法を示しています。ルートマッチャーは、必要な認可レベルに基づいてアクセスを制限します。

      <Info>
        デフォルトでは、Spring Security は JWT の `scope` クレーム内の各スコープに対して
        `GrantedAuthority` を作成します。この仕組みにより、
        `hasAuthority("SCOPE_read:messages")` メソッドを使用して、有効な JWT のうち
        `read:messages` スコープを含むものだけにアクセスを制限できます。
      </Info>

      <AuthCodeGroup>
        <Securityconfig />

        <Application />

        <Apicontroller />
      </AuthCodeGroup>
    </Section>

    <Section id={sections[4].id} title={sections[4].title} stepNumber="5" isSingleColumn>
      エンドポイントで JSON を返すには、Java のレコードを使用できます。このオブジェクトのメンバー変数は、JSON のキーと値にシリアライズされます。API 呼び出し時の返却用の例として、ドメインオブジェクトである `Message` という新しいレコードを作成します。

      <AuthCodeGroup>
        <Application />

        <Securityconfig />

        <Apicontroller />
      </AuthCodeGroup>
    </Section>

    <Section id={sections[5].id} title={sections[5].title} stepNumber="6" isSingleColumn>
      エンドポイントへのリクエストを処理するために、`APIController` という名前の新しいクラスを作成します。
      `APIController` には、[Protect API Endpoints](https://auth0.com/docs/quickstart/backend/java-spring-security5/interactive#configure-the-resource-server) セクションで定義されている 3 つのルートがあります。
      この例では、`@CrossOrigin` アノテーションを使用して、すべてのオリジンを許可します。
      実運用のアプリケーションでは、ユースケースに合わせて `CORS` を適切に構成する必要があります。

      <AuthCodeGroup>
        <Apicontroller />

        <Securityconfig />

        <Application />
      </AuthCodeGroup>
    </Section>

    <Section id={sections[6].id} title={sections[6].title} stepNumber="7" isSingleColumn>
      サンプルプロジェクトをビルドして実行するには、`bootRun` Gradle タスクを実行します。

      Linux または macOS の場合：

      ```sh lines
      ./gradlew bootRun
      ```

      Windows の場合:

      ```sh lines
      gradlew.bat bootRun
      ```

      Maven と [Spring Boot Maven Plugin](https://docs.spring.io/spring-boot/docs/current/reference/html/build-tool-plugins-maven-plugin.html) を使用して独自のアプリケーションを設定している場合は、
      `spring-boot:run` ゴールを実行できます。

      Linux または macOS では:

      ```sh lines
      mvn spring-boot:run
      ```

      Windows：

      ```sh lines
      mvn.cmd spring-boot:run
      ```

      <Note>
        ##### チェックポイント

        サンプルアプリケーションには `http://localhost:3010/` からアクセスできます。
        API のテスト方法と利用方法については、[Using Your API](https://auth0.com/docs/quickstart/backend/java-spring-security5/02-using) の記事を参照してください。
      </Note>

      <LoggedInForm />
    </Section>
  </Content>
</Recipe>