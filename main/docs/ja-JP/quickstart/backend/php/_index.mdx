---
title: PHPアプリケーションに認可を追加する
sidebarTitle: PHP API

---

import { Recipe, Content, Section, SideMenu, SideMenuSectionItem, SignUpForm } from "/snippets/ja-JP/recipe.jsx";
import { LoggedInForm } from "/snippets/ja-JP/Login.jsx";
import Index from "/snippets/ja-JP/quickstart/backend/php/index.php.mdx";
import Index2 from "/snippets/ja-JP/quickstart/backend/php/index.php2.mdx";
import Router from "/snippets/ja-JP/quickstart/backend/php/router.php.mdx";
import Router2 from "/snippets/ja-JP/quickstart/backend/php/router.php2.mdx";
import Router3 from "/snippets/ja-JP/quickstart/backend/php/router.php3.mdx";

import {AuthCodeGroup} from "/snippets/ja-JP/AuthCodeGroup.jsx";

export const sections = [
      { id: "configure-auth0", title: "Auth0 を構成する" },
      { id: "install-the-auth0-php-sdk", title: "Auth0 PHP ソフトウェア開発キット (SDK) をインストールする" },
      { id: "listen-for-the-bearer-tokens", title: "Bearer トークンを受信する" },
      { id: "create-and-configure-routes", title: "ルートを作成して構成する" },
      { id: "configure-endpoint-authorization", title: "エンドポイントの認可を構成する" },
      { id: "authorize-with-scopes", title: "スコープを使って認可する" }
]


<Recipe isSingleColumn>
  <Content>
    Auth0を使用すると、ほぼすべてのアプリケーションタイプに対して、トークンベースのエンドポイント認可を迅速に追加できます。このガイドでは、Auth0を統合し、トークンベースの認可を追加し、Auth0 PHP SDK を使用してアプリケーションルートを保護する方法を説明します。

    このクイックスタートを使用するには、次のものが必要です:

    <Section id={sections[0].id} title={sections[0].title} stepNumber="1" isSingleColumn>
      Auth0 のサービスを利用するには、Auth0 Dashboard にアプリケーションを登録する必要があります。Auth0 のアプリケーションでは、
      プロジェクトで認証をどのように行うかを設定します。

      ### アプリケーションを設定する

      インタラクティブセレクターを使用して新しい Auth0 アプリケーションを作成するか、統合したいプロジェクトを表す既存のアプリケーションを選択します。
      Auth0 内のすべてのアプリケーションには英数字で構成された一意のクライアントIDが割り当てられ、アプリケーションのコードはそのクライアントIDを使用して、
      ソフトウェア開発キット (SDK) を介して Auth0 API を呼び出します。

      このクイックスタートで行った設定はすべて、自動的にアプリケーションの設定として [Dashboard](https://manage.auth0.com/#/) に反映されます。ここから、
      今後もアプリケーションを管理できます。

      より完成された構成を確認したい場合は、代わりにサンプルアプリケーションを参照できます。

      ### API を設定する

      同様に、統合したいプロジェクトを表す新しい Auth0 API を作成するか、[Dashboard](https://manage.auth0.com/#/) から既存の API を選択する必要があります。
      API 用に一意の識別子を選択し、控えておいてください。以下でアプリケーションを設定する際に、その識別子が必要になります。

      <LoggedInForm />
    </Section>

    <Section id={sections[1].id} title={sections[1].title} stepNumber="2" isSingleColumn>
      Auth0 は、PHP アプリに Auth0 の認証と認可を実装するプロセスを簡素化するために、[PHP ソフトウェア開発キット (SDK)](https://github.com/auth0/auth0-PHP)（Auth0-PHP）を提供しています。

      Auth0 PHP SDK を使用するには、ネットワークリクエストを処理するための互換性のある HTTP ライブラリとして [PSR-17](https://www.php-fig.org/psr/psr-17/) および [PSR-18](https://www.php-fig.org/psr/psr-18/) がインストールされている必要があります。利用可能なライブラリがない場合は、ターミナルで次のコマンドを実行することで、信頼性の高いライブラリをインストールできます。

      ```bash lines
      cd <your-project-directory>
      composer require symfony/http-client nyholm/psr7
      ```

      次に、ターミナルで次のコマンドを実行して、Auth0 用 PHP ソフトウェア開発キット (SDK) をインストールします。

      ```bash lines
      composer require auth0/auth0-php
      ```

      ### Auth0 SDK を設定する

      SDK が正しく動作するようにするには、初期化時に Auth0 SDK で次のプロパティを設定する必要があります。

      * `strategy`: strategy は、アプリのユースケースに応じた SDK の動作方針を決めるための設定です。
        この場合は、次の定数に設定します。

        `Auth0\SDK\Configuration\SdkConfiguration::STRATEGY_API`
      * domain: Auth0 テナントのドメインです。通常、Auth0 Dashboard の Application の
        Settings 内にある Domain フィールドで確認できます。カスタムドメインを使用している場合は、
        そのカスタムドメインの値を設定してください。
      * clientId: このクイックスタートの前の手順で設定した Auth0 Application の ID です。Auth0 Dashboard の
        該当する Application の Settings 内にある Client ID フィールドで確認できます。
      * clientSecret: このクイックスタートの前の手順で作成した Auth0 Application のシークレットです。Client Secret は、
        Auth0 Dashboard の該当する Application の Settings 内にある Client Secret フィールドにあります。
      * audience: 先ほど登録した Auth0 API の識別子です。これは配列として指定する必要があります。

      <Note>
        ##### チェックポイント

        Auth0 SDK は正しく設定されました。アプリケーションを実行して、次の点を確認してください。

        * SDK が正しく初期化されていること。
        * アプリケーションで Auth0 に関連するエラーが発生していないこと。
      </Note>

      <AuthCodeGroup>
        <Index />

        <Router />
      </AuthCodeGroup>
    </Section>

    <Section id={sections[2].id} title={sections[2].title} stepNumber="3" isSingleColumn>
      次に、アプリケーションを拡張して Bearer トークンを取得・処理できるようにします。Bearer トークンは、クライアントがユーザーに代わって API に送信するアクセストークンです。アクセストークンは、アプリケーション内のルートへのアクセスを許可または拒否します。これをエンドポイント認可と呼びます。

      リクエストからアクセストークンを取得する最も簡単な方法は、PHP ソフトウェア開発キット (SDK) の `getBearerToken()` メソッドを使用することです。このメソッドは、GET パラメーター、POST ボディ、リクエストヘッダー、その他の場所からトークンを取得します。この場合、PHP SDK は、GET リクエストの `token` パラメーター、または HTTP `Authorization` ヘッダーで渡されたトークンを処理します。

      <AuthCodeGroup>
        <Index2 />

        <Router />
      </AuthCodeGroup>
    </Section>

    <Section id={sections[3].id} title={sections[3].title} stepNumber="4" isSingleColumn>
      次に、ルーティングライブラリをインストールして、受信リクエストをアプリケーションへ振り分けられるようにします。これは必須の手順ではありませんが、このクイックスタートではアプリケーションの構成を簡素化するために使用します。

      ```bash lines
      composer require steampixel/simple-php-router
      ```

      アプリケーション内に `router.php` という新しいファイルを作成し、ルートを定義します。右側のインタラクティブパネルの **router.php** タブに表示されているコードをコピーしてください。

      <AuthCodeGroup>
        <Router />

        <Index />
      </AuthCodeGroup>
    </Section>

    <Section id={sections[4].id} title={sections[4].title} stepNumber="5" isSingleColumn>
      Auth0 アプリケーションと Auth0 PHP SDK を構成し、アプリケーションがリクエストから Bearer トークンを取得できるようになったので、次のステップとしてプロジェクトのエンドポイントの認可を設定します。先ほど実装した `getBearerToken()` メソッドは、リクエストのアクセスに関する詳細を含む `Token` クラスを返します。

      `getBearerToken()` メソッドは受信リクエストを自動的に検証および確認するため、
      アプリケーションはメソッドのレスポンスを評価することでアクセストークンの詳細を特定します。レスポンスが
      null の場合、有効なトークンは提供されていません。それ以外の場合は、レスポンスの内容を確認して、
      リクエストについてさらに詳しく把握します。

      右側のインタラクティブパネルでは、レスポンスが null かどうかをチェックして、
      `/api/private` ルートへのアクセスを制御している様子を確認できます。

      <AuthCodeGroup>
        <Router2 />

        <Index />
      </AuthCodeGroup>
    </Section>

    <Section id={sections[5].id} title={sections[5].title} stepNumber="6" isSingleColumn>
      場合によっては、アクセストークン内でリクエストされたスコープに基づいて、特定のルートへのアクセスを制限したいことがあります。右側のインタラクティブパネルに示されているように、アクセストークンによって許可されたスコープを確認するために、`getBearerToken()` メソッドのレスポンスに含まれる &#39;scope&#39; プロパティの内容を評価してください。

      <AuthCodeGroup>
        <Router3 />

        <Index />
      </AuthCodeGroup>
    </Section>

    ## 次のステップ

    素晴らしい!ここまで進めたなら、アプリケーションでログイン、ログアウト、およびユーザープロファイル情報が実装されているはずです。

    これでクイックスタートチュートリアルは終了ですが、他にも多くの機能があります。Auth0でできることの詳細については、以下をご確認ください:

    * [Auth0 Dashboard](https://manage.auth0.com/dashboard/us/dev-gja8kxz4ndtex3rq) - Auth0 テナントとアプリケーションの設定および管理方法について学ぶ
    * [Auth0-PHP SDK](https://github.com/auth0/auth0-php) - このチュートリアルで使用するソフトウェア開発キット (SDK) の詳細はこちら
    * [Auth0 Marketplace](https://marketplace.auth0.com/) - Auth0 の機能を拡張できるインテグレーションを見つける
  </Content>
</Recipe>