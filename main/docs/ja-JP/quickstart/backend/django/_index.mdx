---
title: Django の API アプリケーションに認可を追加する
sidebarTitle: Django API

---

import { Recipe, Content, Section, SideMenu, SideMenuSectionItem, SignUpForm } from "/snippets/ja-JP/recipe.jsx";
import { LoggedInForm } from "/snippets/ja-JP/Login.jsx";
import Validator from "/snippets/ja-JP/quickstart/backend/django/validator.py.mdx";
import Views from "/snippets/ja-JP/quickstart/backend/django/views.py.mdx";
import Urls from "/snippets/ja-JP/quickstart/backend/django/urls.py.mdx";

import {AuthCodeGroup} from "/snippets/ja-JP/AuthCodeGroup.jsx";

export const sections = [
  { id: "define-permissions", title: "権限を定義する" },
  { id: "configure-django-to-use-auth0", title: "Auth0 を使用するように Django を設定する" },
  { id: "create-the-jwt-validator", title: "JWT バリデーターを作成する" },
  { id: "create-the-api-views", title: "API ビューを作成する" },
  { id: "add-url-mappings", title: "URL マッピングを追加する" }
]


<Recipe isSingleColumn>
  <Content>
    このガイドでは、[Django](https://www.djangoproject.com/)で構築された新規または既存のPython APIにAuth0を統合する方法を示します。

    Auth0 Dashboard でまだ API を作成していない場合は、インタラクティブセレクターを使用して新しい Auth0 API を作成するか、統合するプロジェクトに対応する既存の API を選択できます。

    または、入門ガイドをお読みいただくこともできます。
    このガイドでは、Auth0 Dashboardを使用して最初のAPIをセットアップする手順を説明しています。

    Auth0のすべてのAPIは、API識別子を使用して設定されます。アプリケーションコードは、この識別子をオーディエンスとして使用してアクセストークンを検証します。

    <Info>
      **Auth0 を初めてお使いですか？** Auth0 の仕組みや、
      OAuth 2.0 フレームワークを使用した API の認証と
      認可の実装方法について学びましょう。
    </Info>

    <Section id={sections[0].id} title={sections[0].title} stepNumber="1" isSingleColumn>
      Permissions を使用すると、あるアクセストークンを持つユーザーに代わって、リソースへどのようにアクセスできるかを定義できます。たとえば、ユーザーが manager アクセスレベルを持つ場合は `messages` リソースへの読み取りアクセスのみを付与し、administrator アクセスレベルを持つ場合は同じリソースへの書き込みアクセスを付与するといったことができます。

      許可する権限は、Auth0 Dashboard の [APIs](https://manage.auth0.com/#/apis) セクションにある **Permissions** ビューで定義できます。次の例では、`read:messages` スコープを使用します。

      <Frame>
        <img src="/docs/images/cdy7uua7fh8z/1s3Yp5zqJiKiSWqbPSezNO/e61793a2822d095666002c3f65c71ac2/configure-permissions.png" />
      </Frame>

      <LoggedInForm />
    </Section>

    <Section id={sections[1].id} title={sections[1].title} stepNumber="2" isSingleColumn>
      ### 依存関係のインストール

      1. 次の依存関係を `requirements.txt` に追加します：
      2. `pip install -r requirements.txt` を実行します。

      ### Django アプリケーションの作成

      <LoggedInForm />
    </Section>

    <Section id={sections[2].id} title={sections[2].title} stepNumber="3" isSingleColumn>
      [Authlib](https://github.com/lepture/authlib) というライブラリを使用して [ResourceProtector](https://docs.authlib.org/en/latest/flask/1/resource-server.html) を作成します。これは、指定したバリデーターを使ってリソース（API ビュー）を保護するための [Django ビュー・デコレーター](https://docs.djangoproject.com/en/4.0/topics/http/decorators/) の一種です。

      このバリデーターは、リソースに渡されたアクセストークンについて、有効な署名とクレームを持っているかどうかを検証します。

      AuthLib の `JWTBearerTokenValidator` バリデーターに少し手を加えることで、[アクセストークンの検証](https://auth0.com/docs/secure/tokens/access-tokens/validate-access-tokens) に関する当社の要件に準拠させることができます。

      `Auth0JWTBearerTokenValidator` を作成するには、`domain` と `audience`（API Identifier）を渡す必要があります。これにより、トークン署名の検証に必要な公開鍵を取得し、それを `JWTBearerTokenValidator` クラスに渡します。

      次に、そのクラスの `claims_options` をオーバーライドして、トークンの `expiry`、`audience`、`issue` クレームが当社の要件に従って検証されるようにします。

      インタラクティブパネルのコードを使用して、`apiexample/validator.py` ファイルを作成します。

      <AuthCodeGroup>
        <Views />

        <Validator />

        <Urls />
      </AuthCodeGroup>
    </Section>

    <Section id={sections[3].id} title={sections[3].title} stepNumber="4" isSingleColumn>
      次に、`apiexample/views.py` に 3 つの API ビューを作成します:

      * `/api/public`: 認証を必要としないパブリックエンドポイント。
      * `/api/private`: 有効な JWT 形式のアクセストークンを必要とするプライベートエンドポイント。
      * `/api/private-scoped`: 有効な JWT 形式のアクセストークンに
        指定された `scope` が含まれていることを必要とするプライベートエンドポイント。

      保護されたルートには `require_auth` デコレーターを使用します。これは、
      前の手順で作成した `Auth0JWTBearerTokenValidator` を使用する `ResourceProtector` です。

      `Auth0JWTBearerTokenValidator` を作成する際には、Auth0 テナントのドメインと、
      先ほど作成した API の API Identifier を渡します。

      `private_scoped` ルートの `require_auth` デコレーターは、追加の引数
      `"read:messages"` を受け取り、先ほど作成したパーミッション（スコープ）がアクセストークンに含まれているかを確認します。

      <AuthCodeGroup>
        <Validator />

        <Views />

        <Urls />
      </AuthCodeGroup>
    </Section>

    <Section id={sections[4].id} title={sections[4].title} stepNumber="5" isSingleColumn>
      前のステップでは、`views.py` ファイルにメソッドを追加しました。次に、Django の [URL ディスパッチャー](https://docs.djangoproject.com/en/4.0/topics/http/urls/)を使用して、これらのメソッドを URL にマッピングします。URL ディスパッチャーは、URL パターンをビューにマッピングする機能です。

      URLパターンを`apiexample/urls.py`ファイルに追加してください。

      ### APIを呼び出す

      APIを呼び出すには、アクセストークンが必要です。テスト目的のアクセストークンは、[API設定](https://manage.auth0.com/#/apis)の**Test**ビューから取得できます。

      <Frame>
        <img src="/docs/images/cdy7uua7fh8z/6jeVBuypOGX5qMRXeJn5ow/5e79037f6c852d2043789d622bdb9562/Quickstart_Example_App_-_English.png" />
      </Frame>

      リクエストの`Authorization`ヘッダーにアクセストークンを指定してください。

      <AuthCodeGroup>
        ```bash cURL lines
        curl --request get \
        --url 'http:///%7ByourDomain%7D.com/api_path' \
        --header 'authorization: Bearer YOUR_ACCESS_TOKEN_HERE'
        ```

        ```csharp C# lines
        var client = new RestClient("http:///%7ByourDomain%7D.com/api_path");
        var request = new RestRequest(Method.GET);
        request.AddHeader("authorization", "Bearer YOUR_ACCESS_TOKEN_HERE");
        IRestResponse response = client.Execute(request);
        ```

        ```go Go lines
        package main
        import (
        "fmt"
        "net/http"
        "io/ioutil"
        )
        func main() {
        url := "http:///%7ByourDomain%7D.com/api_path"
        req, _ := http.NewRequest("get", url, nil)
        req.Header.Add("authorization", "Bearer YOUR_ACCESS_TOKEN_HERE")
        res, _ := http.DefaultClient.Do(req)
        defer res.Body.Close()
        body, _ := ioutil.ReadAll(res.Body)
        fmt.Println(res)
        fmt.Println(string(body))
        }
        ```

        ```java Java lines
        HttpResponse<String> response = Unirest.get("http:///%7ByourDomain%7D.com/api_path")
        .header("authorization", "Bearer YOUR_ACCESS_TOKEN_HERE")
        .asString();
        ```

        ```javascript Node.JS lines
        var axios = require("axios").default;
        var options = {
        method: 'get',
        url: 'http:///%7ByourDomain%7D.com/api_path',
        headers: {authorization: 'Bearer YOUR_ACCESS_TOKEN_HERE'}
        };
        axios.request(options).then(function (response) {
        console.log(response.data);
        }).catch(function (error) {
        console.error(error);
        });
        ```

        ```objc Obj-C lines
        #import <Foundation/Foundation.h>
        NSDictionary *headers = @{ @"authorization": @"Bearer YOUR_ACCESS_TOKEN_HERE" };
        NSMutableURLRequest *request = [NSMutableURLRequest requestWithURL:[NSURL URLWithString:@"http:///%7ByourDomain%7D.com/api_path"]
                                                          cachePolicy:NSURLRequestUseProtocolCachePolicy

                                                      timeoutInterval:10.0];

        [request setHTTPMethod:@"get"];
        [request setAllHTTPHeaderFields:headers];
        NSURLSession *session = [NSURLSession sharedSession];
        NSURLSessionDataTask *dataTask = [session dataTaskWithRequest:request
                                                completionHandler:^(NSData *data, NSURLResponse *response, NSError *error) {

                                                    if (error) {

                                                        NSLog(@&quot;%@&quot;, error);

                                                    } else {

                                                        NSHTTPURLResponse *httpResponse = (NSHTTPURLResponse *) response;

                                                        NSLog(@&quot;%@&quot;, httpResponse);

                                                    }

                                                }];

        [dataTask resume];
        ```

        ```php PHP lines
        $curl = curl_init();
        curl_setopt_array($curl, [
        CURLOPT_URL => "http:///%7ByourDomain%7D.com/api_path",
        CURLOPT_RETURNTRANSFER => true,
        CURLOPT_ENCODING => "",
        CURLOPT_MAXREDIRS => 10,
        CURLOPT_TIMEOUT => 30,
        CURLOPT_HTTP_VERSION => CURL_HTTP_VERSION_1_1,
        CURLOPT_CUSTOMREQUEST => "get",
        CURLOPT_HTTPHEADER => [
        &quot;authorization: Bearer YOUR_ACCESS_TOKEN_HERE&quot;

        ],
        ]);
        $response = curl_exec($curl);
        $err = curl_error($curl);
        curl_close($curl);
        if ($err) {
        echo "cURL Error #:" . $err;
        } else {
        echo $response;
        }
        ```

        ```python Python lines
        import http.client
        conn = http.client.HTTPConnection("")
        headers = { 'authorization': "Bearer YOUR_ACCESS_TOKEN_HERE" }
        conn.request("get", "/{yourDomain}.com/api_path", headers=headers)
        res = conn.getresponse()
        data = res.read()
        print(data.decode("utf-8"))
        ```

        ```ruby Ruby lines
        require 'uri'
        require 'net/http'
        url = URI("http:///%7ByourDomain%7D.com/api_path")
        http = Net::HTTP.new(url.host, url.port)
        request = Net::HTTP::Get.new(url)
        request["authorization"] = 'Bearer YOUR_ACCESS_TOKEN_HERE'
        response = http.request(request)
        puts response.read_body
        ```

        ```swift Swift lines
        import Foundation
        let headers = ["authorization": "Bearer YOUR_ACCESS_TOKEN_HERE"]
        let request = NSMutableURLRequest(url: NSURL(string: "http:///%7ByourDomain%7D.com/api_path")! as URL,
                                            cachePolicy: .useProtocolCachePolicy,

                                        timeoutInterval: 10.0)

        request.httpMethod = "get"
        request.allHTTPHeaderFields = headers
        let session = URLSession.shared
        let dataTask = session.dataTask(with: request as URLRequest, completionHandler: { (data, response, error) -> Void in
        if (error != nil) {
        print(error)

        } else {
        let httpResponse = response as? HTTPURLResponse

        print(httpResponse)

        }
        })
        dataTask.resume()
        ```
      </AuthCodeGroup>

      <AuthCodeGroup>
        <Urls />

        <Validator />

        <Views />
      </AuthCodeGroup>
    </Section>

    ## 次のステップ

    素晴らしい!ここまで進めたなら、アプリケーションでログイン、ログアウト、およびユーザープロファイル情報が実装されているはずです。

    これでクイックスタートチュートリアルは終了ですが、他にも多くの機能があります。Auth0でできることの詳細については、以下をご確認ください:

    * [Auth0 Dashboard](https://manage.auth0.com/dashboard/us/dev-gja8kxz4ndtex3rq) - Auth0 テナントやアプリケーションを設定および管理する方法を学ぶ
    * [Auth0 Marketplace](https://marketplace.auth0.com/) - Auth0 の機能を拡張できる連携機能を見つける
  </Content>
</Recipe>