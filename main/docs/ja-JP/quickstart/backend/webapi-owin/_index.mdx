---
title: ASP.NET OWIN Web API アプリケーションに認可を追加する
sidebarTitle: ASP.NET Web API (OWIN)

---

import { Recipe, Content, Section, SideMenu, SideMenuSectionItem, SignUpForm } from "/snippets/ja-JP/recipe.jsx";
import { LoggedInForm } from "/snippets/ja-JP/Login.jsx";
import Openidconnectsigningkeyresolver from "/snippets/ja-JP/quickstart/backend/webapi-owin/OpenIdConnectSigningKeyResolver.cs.mdx";
import Scopeauthorizeattribute from "/snippets/ja-JP/quickstart/backend/webapi-owin/ScopeAuthorizeAttribute.cs.mdx";
import Apicontroller from "/snippets/ja-JP/quickstart/backend/webapi-owin/ApiController.cs.mdx";

import {AuthCodeGroup} from "/snippets/ja-JP/AuthCodeGroup.jsx";

export const sections = [
      { id: "define-permissions", title: "権限を定義する" },
      { id: "install-dependencies", title: "依存パッケージをインストールする" },
      { id: "configure-the-middleware", title: "ミドルウェアを設定する" },
      { id: "verify-the-token-signature", title: "トークン署名を検証する" },
      { id: "validate-scopes", title: "スコープを検証する" },
      { id: "protect-api-endpoints", title: "API エンドポイントを保護する" }
]


<Recipe isSingleColumn>
  <Content>
    Auth0を使用すると、あらゆる種類のアプリケーションに認可を追加できます。このガイドでは、`Microsoft.Owin.Security.Jwt`パッケージを使用して、新規または既存のASP.NET Owin Web APIアプリケーションにAuth0を統合する方法を説明します。

    Auth0 Dashboard で API をまだ作成していない場合は、インタラクティブセレクターを使用して新しい Auth0 API を作成するか、プロジェクト用の既存の API を選択できます。

    Auth0 Dashboardで最初のAPIをセットアップするには、入門ガイドを参照してください。

    各Auth0 APIはAPI識別子を使用します。アプリケーションはアクセストークンを検証する際にこの識別子が必要です。

    <Info>
      **Auth0 を初めて利用しますか？** Auth0 の仕組みや、
      OAuth 2.0 フレームワークを使用して API の認証と
      認可を実装する方法について学びましょう。
    </Info>

    <Section id={sections[0].id} title={sections[0].title} stepNumber="1" isSingleColumn>
      Permissions を使用すると、特定のアクセストークンを持つユーザーに代わって、リソースにどのようにアクセスできるかを定義できます。たとえば、ユーザーが manager アクセスレベルを持っている場合は `messages` リソースへの読み取りアクセスを許可し、administrator アクセスレベルを持っている場合は、そのリソースへの書き込みアクセスを許可するといったことができます。

      許可する Permissions は、Auth0 Dashboard の [APIs](https://manage.auth0.com/#/apis) セクションにある **Permissions** ビューで定義できます。次の例では `read:messages` スコープを使用します。

      <Frame>
        <img src="/docs/images/cdy7uua7fh8z/1s3Yp5zqJiKiSWqbPSezNO/e61793a2822d095666002c3f65c71ac2/configure-permissions.png" />
      </Frame>

      <LoggedInForm />
    </Section>

    <Section id={sections[1].id} title={sections[1].title} stepNumber="2" isSingleColumn>
      `Microsoft.Owin.Security.Jwt` NuGet パッケージをインストールします。このパッケージには、ASP.NET OWIN Web API で Auth0 のアクセストークンを使用するために必要な OWIN JWT ミドルウェアが含まれています。

      ```ps lines
      Install-Package Microsoft.Owin.Security.Jwt
      ```

      <LoggedInForm />
    </Section>

    <Section id={sections[2].id} title={sections[2].title} stepNumber="3" isSingleColumn>
      `Startup` クラスの `Configuration` メソッドを開き、設定済みの `JwtBearerAuthenticationOptions` を渡して
      `UseJwtBearerAuthentication` を呼び出すコードを追加します。

      `JwtBearerAuthenticationOptions` では、`ValidAudience` プロパティに Auth0 API Identifier を、
      `ValidIssuer` プロパティには Auth0 ドメインの完全な URL を指定する必要があります。
      署名キーを解決するために、`IssuerSigningKeyResolver` を構成して
      `OpenIdConnectSigningKeyResolver` のインスタンスを使用するようにします。

      <Warning>
        **末尾のスラッシュを忘れないでください。**

        `ValidIssuer` に指定する URL には、末尾のスラッシュ（`/`）を含めてください。
        これは JWT の issuer クレームと完全に一致している必要があります。
        この値を誤って構成すると、API 呼び出しは正しく認証されません。
      </Warning>

      <AuthCodeGroup>
        <Openidconnectsigningkeyresolver />

        <Scopeauthorizeattribute />

        <Apicontroller />
      </AuthCodeGroup>
    </Section>

    <Section id={sections[3].id} title={sections[3].title} stepNumber="4" isSingleColumn>
      OWIN JWT ミドルウェアはデフォルトでは OpenID Connect Discovery を使用しないため、カスタムの
      `IssuerSigningKeyResolver` を指定する必要があります。

      `OpenIdConnectSigningKeyResolver` クラスを作成し、`GetSigningKey` を実装して正しい
      `SecurityKey` が返されるようにします。このクラスは、`Startup.cs` でミドルウェアを構成する際に
      `TokenValidationParameters.IssuerSigningKeyResolver` として使用されます。

      <Info>
        このカスタムリゾルバーは非推奨となっており、[現在は利用できません](https://github.com/auth0/auth0-aspnet-owin/blob/master/SECURITY-NOTICE.md)。このカスタムリゾルバーはご自身で実装する必要があります。
      </Info>

      <AuthCodeGroup>
        <Openidconnectsigningkeyresolver />

        <Scopeauthorizeattribute />

        <Apicontroller />
      </AuthCodeGroup>
    </Section>

    <Section id={sections[4].id} title={sections[4].title} stepNumber="5" isSingleColumn>
      JWT ミドルウェアは、リクエストに含まれるアクセストークンが有効であることを検証しますが、トークンが要求されたリソースへアクセスするのに十分な **スコープ** を持っているかを確認する仕組みは、まだ含まれていません。

      `System.Web.Http.AuthorizeAttribute` を継承した `ScopeAuthorizeAttribute` というクラスを作成します。
      この属性は、Auth0 テナントによって発行された `scope` クレームが存在するかを確認し、存在する場合は、その `scope` クレームに要求されているスコープが含まれていることを保証します。

      <AuthCodeGroup>
        <Scopeauthorizeattribute />

        <Openidconnectsigningkeyresolver />

        <Apicontroller />
      </AuthCodeGroup>
    </Section>

    <Section id={sections[5].id} title={sections[5].title} stepNumber="6" isSingleColumn>
      以下のルートは、次のリクエストで利用できます。

      * `GET /api/public`: 認証されていないリクエストで利用できます。
      * `GET /api/private`: 追加のスコープを持たないアクセストークンを含む、認証済みリクエストで利用できます。
      * `GET /api/private-scoped`: `read:messages` スコープが付与されたアクセストークンを含む、認証済みリクエストで利用できます。

      JWT ミドルウェアは標準の ASP.NET 認証および認可メカニズムと統合されているため、エンドポイントを保護するには、コントローラーの Action に `[Authorize]` 属性を付与するだけで済みます。

      `ScopeAuthorize` 属性を使用して Action を更新し、必要な `scope` の名前を `scope` パラメーターに渡します。これにより、特定の API エンドポイントを呼び出すために正しいスコープが利用可能であることが保証されます。

      <Note>
        ##### チェックポイント

        アプリケーションを構成したので、アプリケーションを実行して次のことを確認します。

        * `GET /api/public` は、認証されていないリクエストで利用できます。
        * `GET /api/private` は、認証済みリクエストで利用できます。
        * `GET /api/private-scoped` は、`read:messages` スコープを含む
          アクセストークンを持つ認証済みリクエストで利用できます。
      </Note>

      <AuthCodeGroup>
        <Apicontroller />

        <Openidconnectsigningkeyresolver />

        <Scopeauthorizeattribute />
      </AuthCodeGroup>
    </Section>

    ## 次のステップ

    素晴らしい!ここまで進めたなら、アプリケーションでログイン、ログアウト、およびユーザープロファイル情報が実装されているはずです。

    これでクイックスタートチュートリアルは終了ですが、他にも多くの機能があります。Auth0でできることの詳細については、以下をご確認ください:

    * [Auth0 Dashboard](https://manage.auth0.com/dashboard/us/dev-gja8kxz4ndtex3rq) - Auth0 テナントとアプリケーションの設定と管理について学びます
    * [Auth0 Marketplace](https://marketplace.auth0.com/) - Auth0 の機能を拡張できるインテグレーションを探す
  </Content>
</Recipe>