---
title: Laravel アプリケーションに認可機能を追加する
sidebarTitle: Laravel API

---

import { Recipe, Content, Section, SideMenu, SideMenuSectionItem, SignUpForm } from "/snippets/ja-JP/recipe.jsx";
import { LoggedInForm } from "/snippets/ja-JP/Login.jsx";
import Api from "/snippets/ja-JP/quickstart/backend/laravel/api.php.mdx";
import Api2 from "/snippets/ja-JP/quickstart/backend/laravel/api.php2.mdx";
import Api3 from "/snippets/ja-JP/quickstart/backend/laravel/api.php3.mdx";

export const sections = [
  { id: "laravel-installation", title: "Laravel のインストール" },
  { id: "sdk-installation", title: "SDK のインストール" },
  { id: "sdk-configuration", title: "SDK の設定" },
  { id: "access-control", title: "アクセス制御" },
  { id: "token-information", title: "トークン情報" },
  { id: "retrieve-user-information", title: "ユーザー情報の取得" },
  { id: "run-the-application", title: "アプリケーションの実行" },
  { id: "retrieve-a-test-token", title: "テストトークンの取得" }
]


<Recipe isSingleColumn>
  <Content>
    [Auth0のLaravel SDK](https://github.com/auth0/laravel-auth0)を使用すると、Laravelアプリケーションにトークンベースの認可とルートアクセス制御を迅速に追加できます。このガイドでは、新規（または既存）の[Laravel 9または10](https://github.com/auth0/laravel-auth0#support-policy)アプリケーションにAuth0を統合する方法を説明します。

    **バックエンドアプリケーションは、ユーザー認証を処理せず、ユーザーインターフェースを持たない点で、従来のWebアプリケーションとは異なります。他のアプリケーションが対話できるAPIを提供します。リクエストの**`Authorization`**ヘッダーから**[アクセストークン](https://auth0.com/docs/secure/tokens/access-tokens)**を受け取り、ルートへのアクセスを制御します。**

    これらのタイプのバックエンドと連携するために、通常は別個のフロントエンドアプリケーションが構築されます。[シングルページアプリケーション](https://auth0.com/docs/quickstart/spa)や[ネイティブアプリまたはモバイルアプリ](https://auth0.com/docs/quickstart/native)など、さまざまなものが該当します(これらすべてについて、Auth0 はソフトウェア開発キット (SDK) も提供しています!)

    ユーザーがバックエンドアプリケーションと連携する必要がある場合、まずフロントエンドアプリケーションを使用してAuth0で認証します。その後、フロントエンドアプリケーションはAuth0からアクセストークンを取得し、そのトークンを使用してユーザーに代わってバックエンドアプリケーションにリクエストを送信できます。

    その名が示すとおり、[アクセストークン](https://auth0.com/docs/secure/tokens/access-tokens)はアクセス制御（認可）を目的として設計されており、ユーザーに関する情報は含まれていません。**バックエンドアプリケーションはアクセストークンのみを使用します。**トークンを作成したユーザーに関する情報は、[Management API](https://auth0.com/docs/api/management/v2)を使用して取得できます。これについては後ほど説明します。

    <Section id={sections[0].id} title={sections[0].title} stepNumber="1" isSingleColumn>
      **まだ Laravel アプリケーションをセットアップしていない場合は**、新しいプロジェクト用の任意のディレクトリでシェルを開き、次のコマンドを実行します。

      ```bash lines wrap
      composer create-project --prefer-dist laravel/laravel auth0-laravel-api ^9.0
      ```

      このガイドにあるすべてのコマンドは、Laravel プロジェクトのルートディレクトリで実行していることを前提としています。`cd` コマンドで新しいプロジェクトディレクトリに移動してください。

      ```bash lines
      cd auth0-laravel-api
      ```

      <LoggedInForm />
    </Section>

    <Section id={sections[1].id} title={sections[1].title} stepNumber="2" isSingleColumn>
      プロジェクトディレクトリで次のコマンドを実行して、[Auth0 Laravel ソフトウェア開発キット (SDK)](https://github.com/auth0/laravel-auth0) をインストールします。

      ```bash lines
      composer require auth0/login:^7.8 --update-with-all-dependencies
      ```

      次に、アプリケーション用のソフトウェア開発キット (SDK) の構成ファイルを作成します。

      ```bash lines
      php artisan vendor:publish --tag auth0
      ```

      <LoggedInForm />
    </Section>

    <Section id={sections[2].id} title={sections[2].title} stepNumber="3" isSingleColumn>
      プロジェクトディレクトリで次のコマンドを実行して、[Auth0 CLI](https://github.com/auth0/auth0-cli) をダウンロードします。

      ```bash lines wrap
      curl -sSfL https://raw.githubusercontent.com/auth0/auth0-cli/main/install.sh | sh -s -- -b .
      ```

      次に、Auth0 アカウントを使って CLI で認証し、プロンプトが表示されたら「ユーザーとして」を選択してください。

      ```bash lines
      ./auth0 login
      ```

      次に、Auth0 で新しい Application を作成します。

      ```bash lines
      ./auth0 apps create \
        --name "My Laravel Backend" \
        --type "regular" \
        --auth-method "post" \
        --callbacks "http://localhost:8000/callback" \
        --logout-urls "http://localhost:8000" \
        --reveal-secrets \
        --no-input \
        --json > .auth0.app.json
      ```

      新しい API も作成してください:

      ```bash lines
      ./auth0 apis create \
        --name "My Laravel Backend API" \
        --identifier "https://github.com/auth0/laravel-auth0" \
        --offline-access \
        --no-input \
        --json > .auth0.api.json
      ```

      これにより、ソフトウェア開発キット (SDK) を構成する 2 つのファイルがプロジェクトディレクトリ内に生成されます。

      これらのファイルにはクレデンシャルが含まれるため、機密情報として扱う必要があります。バージョン管理システムにコミットしないようにしてください。Git を使用している場合は、これらのファイルを `.gitignore` ファイルに追加してください。

      ```bash lines
      echo ".auth0.*.json" >> .gitignore
      ```

      <LoggedInForm />
    </Section>

    <Section id={sections[3].id} title={sections[3].title} stepNumber="4" isSingleColumn>
      SDK は `api` ミドルウェアで使用するために、Laravel アプリケーションに認可ガードを自動的に登録します。Laravel はデフォルトで、アプリケーションの `routes/api.php` ファイル内のすべてのルートにこのミドルウェアを適用します。

      <Warning>
        追加の設定なしで SDK を期待どおりに動作させるには、**ルートは
        **`routes/api.php`** ファイル内で定義する必要があります。**
      </Warning>

      Auth0 SDK の認可ガードを使用して、アプリケーションのルートへのアクセスを制限できます。

      `Authorization` ヘッダーに有効なアクセストークンが含まれていないリクエストを拒否するには、Laravel の `auth` ミドルウェアを使用できます。

      ```php lines
      Route::get('/private', function () {
      return response()->json([
      'message' => 'トークンは有効です。認証されました。',
      ]);
      })->middleware('auth');
      ```

      また、これを Laravel の `can` ミドルウェアと組み合わせることで、提供されたトークンが特定の[パーミッション](https://auth0.com/docs/manage-users/access-control/rbac)を持っていることを要求することもできます。

      ```php lines
      Route::get('/scope', function () {
      return response()->json([
      'message' => 'トークンは有効で、read:messages 権限を持っています。認可されました。',
      ]);
      })->middleware('auth')->can('read:messages');
      ```

      <Api />
    </Section>

    <Section id={sections[4].id} title={sections[4].title} stepNumber="5" isSingleColumn>
      提供されたアクセストークンに関する情報は、Laravel の `Auth` ファサード、または
      `auth()` ヘルパー関数を通じて取得できます。

      たとえば、ユーザーの ID とメールアドレスを取得するには次のようにします。

      ```php lines
      Route::get('/', function () {
      if (! auth()->check()) {
      return response()->json([
      'message' => 'You did not provide a valid token.',
      ]);
      }
      return response()->json([
      'message' => 'トークンは有効です。認証されました。',
      'id' => auth()->id(),
      'token' => auth()?->user()?->getAttributes(),
      ]);
      });
      ```

      <Api2 />
    </Section>

    <Section id={sections[5].id} title={sections[5].title} stepNumber="6" isSingleColumn>
      Auth0 の [Auth0 Management API](https://github.com/auth0/laravel-auth0/blob/main/docs/Management.md) を使用すると、アクセストークンを作成したユーザーに関する情報を取得できます。ソフトウェア開発キット (SDK) はこの API 用の便利なラッパーを提供しており、SDK の `management()` メソッドから利用できます。

      **Management API を呼び出す前に、アプリケーションが Management API と通信できるように設定する必要があります。** これは [Auth0 Dashboard の API ページ](https://manage.auth0.com/#/apis/) で `Auth0 Management API` を選択し、「Machine to Machine Applications」タブを選択することで行えます。Laravel アプリケーションを許可 (Authorize) し、その後、下向き矢印をクリックして付与したいスコープを選択します。

      次の例では、`read:users` スコープを付与する必要があります。API エンドポイントと必要なスコープの一覧は、[Management API ドキュメント](https://auth0.com/docs/api/management/v2) にあります。

      ```php lines
      use Auth0\Laravel\Facade\Auth0;
      Route::get('/me', function () {
      $user = auth()->id();
      $profile = cache()->get($user);
      if (null === $profile) {
      $endpoint = Auth0::management()->users();
      $profile = $endpoint->get($user);
      $profile = Auth0::json($profile);
      cache()->put($user, $profile, 120);
      }
      $name = $profile['name'] ?? '不明';
      $email = $profile['email'] ?? '不明';
      return response()->json([
      'name' => $name,
      'email' => $email,
      ]);
      })->middleware('auth');
      ```

      <Info>
        **ユーザー情報は、アプリケーション内で短時間だけキャッシュするようにしてください。** これにより、
        アプリケーションが Auth0 に送信するリクエスト数が減り、パフォーマンスが向上します。長期間にわたって
        アプリケーション内にユーザー情報を保存すると、古いデータを扱うことになりかねないため、避けてください。また、
        永続的なデータベースにはユーザーの識別子以外のユーザー情報を保存しないようにしてください。
      </Info>

      <Api3 />
    </Section>

    <Section id={sections[6].id} title={sections[6].title} stepNumber="7" isSingleColumn>
      これで Laravel アプリケーションを起動し、リクエストを受け付けられるようにする準備が整いました:

      ```bash lines
      php artisan serve
      ```

      <LoggedInForm />
    </Section>

    <Section id={sections[7].id} title={sections[7].title} stepNumber="8" isSingleColumn>
      [アクセストークンの取得方法についてはこちら](https://auth0.com/docs/secure/tokens/access-tokens/get-access-tokens)をご覧ください。ただし、このクイックスタートでは、[API 設定の「test」ビュー](https://manage.auth0.com/#/apis)から
      アクセストークンをそのまま使用できます。

      <Info>
        上で作成した `/me` ルートは、実際のユーザーが関連付けられていないため、テストトークンでは動作しません。
      </Info>

      <Note>
        ##### チェックポイント

        シェルを開き、アプリケーションへのリクエスト送信を試してください。

        まず、パブリックルートにリクエストします：

        `curl --request GET \ --url http://localhost:8000/api \ --header 'Accept: application/json'`

        次に、`Authorization` ヘッダーにアクセストークンを指定して、保護されたルートにリクエストします：

        `curl --request GET \ --url http://localhost:8000/api/private \ --header 'Accept: application/json' \ --header 'Authorization: Bearer YOUR_ACCESS_TOKEN'`

        最後に、スコープで保護されたルートへのリクエストを試します。このルートは、アクセストークンに
        `read:messages` スコープが付与されている場合にのみ成功します：

        `curl --request GET \ --url http://localhost:8000/api/scope \ --header 'Accept: application/json' \ --header 'Authorization: Bearer YOUR_ACCESS_TOKEN'`
      </Note>

      ### 追加資料

      * [User Repositories and Models](https://github.com/auth0/laravel-auth0/blob/main/docs/Users.md) では、Auth0 Laravel ソフトウェア開発キット (SDK) を拡張してカスタムユーザーモデルを使用する方法や、データベースにユーザーを保存し、取得する方法について説明しています。
      * [Hooking Events](https://github.com/auth0/laravel-auth0/blob/main/docs/Events.md) では、Auth0 Laravel ソフトウェア開発キット (SDK) が発行するイベントをリッスンし、統合の動作を自由にカスタマイズする方法について説明しています。
      * [Management API](https://github.com/auth0/laravel-auth0/blob/main/docs/Management.md) のサポートは Auth0 Laravel ソフトウェア開発キット (SDK) に組み込まれており、Laravel アプリケーションから Management API と連携できます。

      <LoggedInForm />
    </Section>

    ## 次のステップ

    素晴らしい!ここまで進めたなら、アプリケーションでログイン、ログアウト、およびユーザープロファイル情報が実装されているはずです。

    これでクイックスタートチュートリアルは終了ですが、他にも多くの機能があります。Auth0でできることの詳細については、以下をご確認ください:

    * [Auth0 Dashboard](https://manage.auth0.com/dashboard/us/dev-gja8kxz4ndtex3rq) - Auth0 テナントとアプリケーションの設定および管理方法について学びます
    * [laravel-auth0 SDK](https://github.com/auth0/laravel-auth0) - このチュートリアルで使用しているソフトウェア開発キット (SDK) について、さらに詳しく学びます
    * [Auth0 Marketplace](https://marketplace.auth0.com/) - Auth0 の機能を拡張できる連携機能を見つける
  </Content>
</Recipe>