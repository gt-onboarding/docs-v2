---
title: "Sender Constraining 用にリソースサーバーを設定する"
permalink: "configure-resource-server-for-sender-constraining"
---

<Callout icon="file-lines" color="#0EA5E9" iconType="regular">
Highly Regulated Identity 機能を使用するには、Highly Regulated Identity アドオン付きの Enterprise プランが必要です。詳細は [Auth0 の料金ページ](https://auth0.com/pricing/) を参照してください。
</Callout>

API で Sender Constraining を有効にすると、クライアントが証明書バインド済みアクセストークンを使用してリソースサーバーを呼び出すたびに、リソースサーバーは Sender Constraining を必ず適用しなければなりません。リソースサーバーは次のようにしてこれを行います。

1. 確立された mTLS 接続からクライアント証明書を要求する
2. クライアント証明書のサムプリントがアクセストークン内のサムプリントと一致することを検証する

Sender Constraining 用にリソースサーバーを設定するには、[Enable Sender Constraining for a resource server](#enable-sender-constraining-for-a-resource-server) を参照してください。

<div id="client-certificate-verification">
  ## クライアント証明書の検証
</div>

認可サーバーやカスタマーエッジとは異なり、リソースサーバーはクライアント証明書の全体の証明書チェーンではなく、サムプリントだけを検証すれば十分です。mTLS Sender Constraining を使用する場合、リソースサーバーはアクセストークンの `cnf` クレームを確認します。

```
"cnf":{"x5t#S256":"A4DtL2JmUMhAsvJj5tKyn64SqzmuXbMrJa0n761y5v0"}
```

この例の `cnf` クレームでは、`x5t#S256` はアクセストークンがサムプリント `A4DtL2JmUMhAsvJj5tKyn64SqzmuXbMrJa0n761y5v0` を持つ mTLS クライアント証明書にバインドされていることを示しています。クライアント証明書の検証を通過するには、リソースサーバーはクライアント証明書がサムプリント `A4DtL2JmUMhAsvJj5tKyn64SqzmuXbMrJa0n761y5v0` と一致していることを検証する必要があります。サムプリントの計算方法の詳細については、RFC 8705 の [JWT Certificate Thumbprint Confirmation Method](https://www.rfc-editor.org/rfc/rfc8705#name-jwt-certificate-thumbprint-) セクションを参照してください。

クライアント証明書が送信されなかった場合、またはクライアント証明書のサムプリントが一致しない場合、リソースサーバーは `HTTP 401` ステータスコードと `invalid_token` エラーコードを使用してリクエストを拒否します。詳細については、RFC 8705 の [Mutual-TLS Client Certificate-Bound Access Tokens](https://www.rfc-editor.org/rfc/rfc8705#name-mutual-tls-client-certifica) と [Resource Servers](https://www.rfc-editor.org/rfc/rfc8705#name-resource-server) の各セクションを参照してください。

段階的にクライアントを mTLS 利用へ移行しているリソースサーバーは、API を 2 つのドメインで公開したい場合があります。1 つは非 mTLS クライアント向けの非 mTLS ドメイン、もう 1 つは mTLS 対応クライアント向けの mTLS が有効なドメインです。別の方法としては、mTLS が有効なドメイン上に、mTLS 専用のリソースサーバーを別途用意することもできます。


<div id="configure-sender-constraining-for-a-resource-server-in-auth0">
  ## Auth0 でリソースサーバーの Sender Constraining を構成する
</div>

Auth0 によって発行されるアクセストークンは、API にアクセスする必要がある送信者（つまりクライアントアプリケーション）に制約することができます。

[Auth0 Dashboard](https://manage.auth0.com/#/apis) または [Management API](https://auth0.com/docs/api/management/v2) を使用して、リソースサーバーに対して Sender Constraining を有効にします。

<Tabs>
  <Tab title="Auth0 Dashboard">
    Token Binding または Sender Constraining を有効にするには、対象 API の **API Settings** を設定します。

    1. [Auth0 Dashboard > Applications > APIs](https://manage.auth0.com/#/apis) に移動します。
    2. 構成する API を選択します。
    3. **Settings** タブで、**Token Sender-Constraining** セクションを探します。
    4. 次の設定を行います。

      1. Sender Constraining Method:

          1. **None:** リソースサーバーに対して Sender Constraining Method を有効にしません。
          2. **mTLS**: リソースサーバーの Sender Constraining Method として mTLS を有効にします。
          3. **DPoP:** リソースサーバーの Sender Constraining Method として DPoP を有効にします。

    B. **Require Token Sender Constraining** をオンに切り替えます。この API に対してアプリケーションに発行されるすべてのアクセストークンは、そのアプリケーションに制限されます。

    <Frame>![Auth0 Dashboard > APIs > Settings > Token binding](/docs/images/cdy7uua7fh8z/3Dv98iZosdpJMcZXfXyurn/823fa368ab874218fbb737aacac9b262/Screenshot_2025-07-28_at_3.59.01_PM.png)</Frame>

  </Tab>
  <Tab title="Management API">
    Management API で Sender Constraining を有効にするには、[リソースサーバーを更新](https://auth0.com/docs/api/management/v2/resource-servers/patch-resource-servers-by-id)する PATCH リクエストを送信します。`proof_of_possession` オブジェクトのパラメーターを次のように設定します。

    <table class="table"><thead>
    <tr>
    <th><strong>Parameter</strong></th>
    <th><strong>Description</strong></th>
    </tr>
    </thead>
    <tbody>
    <tr>
    <td><code>mechanism</code></td>
    <td>Sender Constraining Method を設定します：<code>none</code>、<code>mtls</code>、または <code>dpop</code>。</td>
    </tr>
    <tr>
    <td><code>required</code></td>
    <td><code>true</code> に設定すると、この API に対してアプリケーションに発行されるすべてのアクセストークンは、そのアプリケーションに制限されます。<code>false</code> に設定すると、そのアプリケーションに対して Sender Constraining は必須ではありません。</td>
    </tr>
    </tbody>
    </table>

    次のコードサンプルは、mTLS Sender Constraining 用にリソースサーバーを構成するリクエストボディの例です。

    ```json
    "proof_of_possession": {
        "mechanism": "mtls",
        "required": true
      }
    ```
  </Tab>
</Tabs>