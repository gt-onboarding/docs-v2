```rb app/controllers/concerns/secured.rb lines highlight={}
# frozen_string_literal: true

    module Secured
      extend ActiveSupport::Concern

      REQUIRES_AUTHENTICATION = { message: '認証が必要です' }.freeze
      BAD_CREDENTIALS = {
message: '認証情報が正しくありません'
      }.freeze
      MALFORMED_AUTHORIZATION_HEADER = {
error: 'invalid_request',
error_description: 'Authorizationヘッダーの値は次の形式に従う必要があります: Bearer アクセストークン',
message: '認証情報が正しくありません'
      }.freeze
      INSUFFICIENT_PERMISSIONS = {
error: 'insufficient_permissions',
error_description: 'アクセストークンに必要な権限が含まれていません',
message: '権限がありません'
      }.freeze

      def authorize
token = token_from_request

return if performed?

validation_response = Auth0Client.validate_token(token)

@decoded_token = validation_response.decoded_token

return unless (error = validation_response.error)

render json: { message: error.message }, status: error.status
      end

      def validate_permissions(permissions)
raise 'validate_permissionsはブロックを指定して呼び出す必要があります' unless block_given?
return yield if @decoded_token.validate_permissions(permissions)

render json: INSUFFICIENT_PERMISSIONS, status: :forbidden
      end

      private

      def token_from_request
authorization_header_elements = request.headers['Authorization']&.split

render json: REQUIRES_AUTHENTICATION, status: :unauthorized and return unless authorization_header_elements

unless authorization_header_elements.length == 2
  render json: MALFORMED_AUTHORIZATION_HEADER,
         status: :unauthorized and return
end

scheme, token = authorization_header_elements

render json: BAD_CREDENTIALS, status: :unauthorized and return unless scheme.downcase == 'bearer'

token
      end
    end
```
